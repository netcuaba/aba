{% extends "base.html" %}

{% block title %}Sửa nhân viên - Hệ thống quản lý vận chuyển{% endblock %}

{% block content %}
<div class="page-wrapper">
<div class="page-header">
    <h2><i class="fas fa-user-edit"></i> Sửa thông tin nhân viên</h2>
    <p>Cập nhật thông tin cho nhân viên: <strong>{{ employee.name }}</strong></p>
</div>

<div class="form-section">
    <form method="post" action="/employees/edit/{{ employee.id }}" enctype="multipart/form-data">
        <div class="form-grid">
            <div class="form-group">
                <label for="name">Họ và tên *</label>
                <input type="text" id="name" name="name" required placeholder="Nhập họ và tên nhân viên" value="{{ employee.name }}">
            </div>
            
            <div class="form-group">
                <label for="birth_date">Ngày tháng năm sinh</label>
                <input type="date" id="birth_date" name="birth_date" value="{{ employee.birth_date.strftime('%Y-%m-%d') if employee.birth_date else '' }}">
            </div>
            
            <div class="form-group">
                <label for="phone">Số điện thoại</label>
                <input type="tel" id="phone" name="phone" placeholder="Nhập số điện thoại" value="{{ employee.phone or '' }}">
            </div>
            
            <div class="form-group">
                <label for="cccd">CCCD</label>
                <input type="text" id="cccd" name="cccd" placeholder="Nhập số CCCD" value="{{ employee.cccd or '' }}">
            </div>
            
            <div class="form-group">
                <label for="cccd_issue_date">Ngày cấp CCCD</label>
                <input type="date" id="cccd_issue_date" name="cccd_issue_date" value="{{ employee.cccd_issue_date.strftime('%Y-%m-%d') if employee.cccd_issue_date else '' }}">
            </div>
            
            <div class="form-group">
                <label for="cccd_expiry">Ngày hết hạn CCCD</label>
                <input type="date" id="cccd_expiry" name="cccd_expiry" value="{{ employee.cccd_expiry.strftime('%Y-%m-%d') if employee.cccd_expiry else '' }}">
            </div>
            
            <div class="form-group">
                <label for="employee_status">Trạng thái nhân viên *</label>
                <select id="employee_status" name="employee_status" required>
                    <option value="Đang làm việc" {% if employee.employee_status == 'Đang làm việc' or not employee.employee_status %}selected{% endif %}>Đang làm việc</option>
                    <option value="Đã nghỉ việc" {% if employee.employee_status == 'Đã nghỉ việc' %}selected{% endif %}>Đã nghỉ việc</option>
                    <option value="Nghỉ phép dài hạn" {% if employee.employee_status == 'Nghỉ phép dài hạn' %}selected{% endif %}>Nghỉ phép dài hạn</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="position">Chức vụ *</label>
                <select id="position" name="position" required>
                    <option value="">-- Chọn chức vụ --</option>
                    <option value="Giám đốc" {% if employee.position == 'Giám đốc' %}selected{% endif %}>Giám đốc</option>
                    <option value="Phó Giám đốc" {% if employee.position == 'Phó Giám đốc' %}selected{% endif %}>Phó Giám đốc</option>
                    <option value="Lái xe" {% if employee.position == 'Lái xe' %}selected{% endif %}>Lái xe</option>
                    <option value="Nhân viên văn phòng" {% if employee.position == 'Nhân viên văn phòng' %}selected{% endif %}>Nhân viên văn phòng</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="social_insurance_salary">Mức lương tham gia BHXH</label>
                <input type="number" id="social_insurance_salary" name="social_insurance_salary" 
                       placeholder="Nhập mức lương (số nguyên)" 
                       min="0" step="1" 
                       value="{{ employee.social_insurance_salary if employee.social_insurance_salary else '' }}"
                       oninput="validateIntegerInput(this)">
                <small class="form-help">Chỉ nhập số nguyên dương. Để trống nếu chưa tham gia BHXH.</small>
                <div class="error-message" id="social_insurance_salary-error"></div>
            </div>
            
            <div class="form-group" style="display: none;">
                <label for="driving_license">Hạng bằng lái</label>
                <input type="text" id="driving_license" name="driving_license" placeholder="Nhập hạng bằng lái (VD: B2, C, D)" value="{{ employee.driving_license or '' }}">
            </div>
            
            <div class="form-group" style="display: none;">
                <label for="license_expiry">Ngày hết hạn bằng lái</label>
                <input type="date" id="license_expiry" name="license_expiry" value="{{ employee.license_expiry.strftime('%Y-%m-%d') if employee.license_expiry else '' }}">
            </div>
        </div>
        
        <div class="form-group">
            <label for="documents">Upload giấy tờ mới</label>
            <input type="file" id="documents" name="documents" multiple accept=".pdf,.jpg,.jpeg,.png,.gif" onchange="previewFiles(this)">
            <small class="form-help">Có thể chọn nhiều file (PDF, JPG, PNG, GIF)</small>
            <div id="file-preview" class="file-preview"></div>
            
            {% if employee.documents %}
                <div class="current-documents">
                    <h4>Giấy tờ hiện tại:</h4>
                    <div class="documents-list">
                        {% set documents_list = employee.documents | from_json %}
                        {% for doc in documents_list %}
                            <div class="document-item" id="doc-item-{{ loop.index }}">
                                {% if doc.endswith('.pdf') %}
                                    <i class="fas fa-file-pdf" style="color: #e74c3c; font-size: 1.5em;"></i>
                                    <span>{{ doc }}</span>
                                    <div class="document-actions">
                                        <a href="/static/uploads/{{ doc }}" target="_blank" class="btn btn-sm btn-primary">
                                            <i class="fas fa-external-link-alt"></i> Xem
                                        </a>
                                        <button type="button" class="btn btn-sm btn-danger" onclick="confirmDeleteDocument('{{ doc }}', {{ employee.id }}, {{ loop.index }})">
                                            <i class="fas fa-trash"></i> Xóa
                                        </button>
                                    </div>
                                {% else %}
                                    <img src="/static/uploads/{{ doc }}" alt="{{ doc }}" style="max-width: 50px; max-height: 50px; border-radius: 4px;">
                                    <span>{{ doc }}</span>
                                    <div class="document-actions">
                                        <a href="/static/uploads/{{ doc }}" target="_blank" class="btn btn-sm btn-primary">
                                            <i class="fas fa-external-link-alt"></i> Xem
                                        </a>
                                        <button type="button" class="btn btn-sm btn-danger" onclick="confirmDeleteDocument('{{ doc }}', {{ employee.id }}, {{ loop.index }})">
                                            <i class="fas fa-trash"></i> Xóa
                                        </button>
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-success">
                <i class="fas fa-save"></i> Cập nhật
            </button>
            <a href="/employees" class="btn btn-secondary">
                <i class="fas fa-times"></i> Hủy
            </a>
        </div>
    </form>
</div>

<!-- Confirmation Modal for Document Deletion -->
<div id="deleteDocumentModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle"></i> Xác nhận xóa giấy tờ</h3>
            <span class="close" onclick="closeDeleteDocumentModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p>Bạn có chắc muốn xóa giấy tờ này không?</p>
            <p><strong id="deleteDocumentName"></strong></p>
            <p class="text-warning"><i class="fas fa-warning"></i> Hành động này không thể hoàn tác!</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeDeleteDocumentModal()">
                <i class="fas fa-times"></i> Hủy
            </button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="deleteDocument()">
                <i class="fas fa-trash"></i> Xóa
            </button>
        </div>
    </div>
</div>

<!-- Success/Error Message Container -->
<div id="messageContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;"></div>

<style>
.page-header {
    margin-bottom: 30px;
}

.page-header h2 {
    color: #2c3e50;
    margin-bottom: 10px;
}

.page-header p {
    color: #7f8c8d;
    margin: 0;
}

.form-section {
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    padding: 30px;
}

.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
}

.form-group input,
.form-group select {
    padding: 10px 12px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s;
}

.form-group select {
    background: white;
    cursor: pointer;
}

.form-group input:focus,
.form-group select:focus {
    border-color: #667eea;
    outline: none;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-help {
    color: #6c757d;
    font-size: 12px;
    margin-top: 5px;
}

.error-message {
    color: #e74c3c;
    font-size: 12px;
    margin-top: 5px;
    display: none;
}

.file-preview {
    margin-top: 15px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
}

.file-preview-item {
    position: relative;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 10px;
    text-align: center;
    background: #f8f9fa;
}

.file-preview-item img {
    max-width: 100%;
    max-height: 80px;
    border-radius: 4px;
}

.file-preview-item .file-name {
    font-size: 11px;
    color: #6c757d;
    margin-top: 5px;
    word-break: break-all;
}

.file-preview-item .remove-file {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    cursor: pointer;
}

.current-documents {
    margin-top: 20px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.current-documents h4 {
    color: #2c3e50;
    margin-bottom: 15px;
    font-size: 1.1em;
}

.documents-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
}

.document-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    background: white;
    border-radius: 6px;
    border: 1px solid #dee2e6;
}

.document-item img {
    border-radius: 4px;
}

.document-item span {
    flex: 1;
    font-size: 12px;
    color: #6c757d;
    word-break: break-all;
}

.document-actions {
    display: flex;
    gap: 5px;
    align-items: center;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

/* Modal Styles */
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: white;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 25px;
    border-bottom: 1px solid #e9ecef;
}

.modal-header h3 {
    margin: 0;
    color: #2c3e50;
    font-size: 1.2em;
}

.modal-header .close {
    font-size: 28px;
    font-weight: bold;
    color: #aaa;
    cursor: pointer;
    line-height: 1;
}

.modal-header .close:hover {
    color: #000;
}

.modal-body {
    padding: 25px;
}

.modal-body p {
    margin-bottom: 15px;
    color: #555;
}

.text-warning {
    color: #856404;
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    padding: 10px;
    border-radius: 5px;
    margin-top: 15px;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 20px 25px;
    border-top: 1px solid #e9ecef;
}

/* Message Styles */
.message {
    padding: 15px 20px;
    border-radius: 6px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
    animation: slideIn 0.3s ease-out;
}

.message-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.message-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.form-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    padding-top: 20px;
    border-top: 1px solid #e9ecef;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #218838;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

@media (max-width: 768px) {
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .documents-list {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Validate integer input for social insurance salary
function validateIntegerInput(input) {
    const value = input.value.trim();
    const errorElement = document.getElementById('social_insurance_salary-error');
    
    if (value === '') {
        errorElement.style.display = 'none';
        errorElement.textContent = '';
        return true;
    }
    
    // Check if it's a valid positive integer
    if (!/^\d+$/.test(value) || parseInt(value) <= 0) {
        errorElement.textContent = 'Mức lương tham gia BHXH phải là số nguyên';
        errorElement.style.display = 'block';
        return false;
    }
    
    errorElement.style.display = 'none';
    errorElement.textContent = '';
    return true;
}

// Validate form before submit
document.querySelector('form').addEventListener('submit', function(e) {
    const socialInsuranceSalary = document.getElementById('social_insurance_salary');
    if (!validateIntegerInput(socialInsuranceSalary)) {
        e.preventDefault();
        return false;
    }
});

// Preview files
function previewFiles(input) {
    const preview = document.getElementById('file-preview');
    preview.innerHTML = '';
    
    if (input.files) {
        Array.from(input.files).forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-preview-item';
            
            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                fileItem.appendChild(img);
            } else {
                const icon = document.createElement('div');
                icon.innerHTML = '<i class="fas fa-file-pdf" style="font-size: 2em; color: #e74c3c;"></i>';
                fileItem.appendChild(icon);
            }
            
            const fileName = document.createElement('div');
            fileName.className = 'file-name';
            fileName.textContent = file.name;
            fileItem.appendChild(fileName);
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-file';
            removeBtn.innerHTML = '×';
            removeBtn.onclick = () => removeFile(index);
            fileItem.appendChild(removeBtn);
            
            preview.appendChild(fileItem);
        });
    }
}

// Xóa file khỏi preview
function removeFile(index) {
    const input = document.getElementById('documents');
    const dt = new DataTransfer();
    
    Array.from(input.files).forEach((file, i) => {
        if (i !== index) {
            dt.items.add(file);
        }
    });
    
    input.files = dt.files;
    previewFiles(input);
}

// Global variables for document deletion
let currentDeleteFilename = '';
let currentDeleteEmployeeId = 0;
let currentDeleteItemIndex = 0;

// Show confirmation modal for document deletion
function confirmDeleteDocument(filename, employeeId, itemIndex) {
    currentDeleteFilename = filename;
    currentDeleteEmployeeId = employeeId;
    currentDeleteItemIndex = itemIndex;
    
    document.getElementById('deleteDocumentName').textContent = filename;
    document.getElementById('deleteDocumentModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

// Close delete confirmation modal
function closeDeleteDocumentModal() {
    document.getElementById('deleteDocumentModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    currentDeleteFilename = '';
    currentDeleteEmployeeId = 0;
    currentDeleteItemIndex = 0;
}

// Delete document via AJAX
async function deleteDocument() {
    if (!currentDeleteFilename || !currentDeleteEmployeeId) {
        showErrorMessage('Thông tin xóa không hợp lệ');
        return;
    }
    
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    const originalText = confirmBtn.innerHTML;
    
    try {
        // Show loading state
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xóa...';
        confirmBtn.disabled = true;
        
        // Make DELETE request
        const response = await fetch(`/employees/documents/${currentDeleteEmployeeId}?filename=${encodeURIComponent(currentDeleteFilename)}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Remove document item from UI
            const docItem = document.getElementById(`doc-item-${currentDeleteItemIndex}`);
            if (docItem) {
                docItem.style.transition = 'opacity 0.3s ease-out';
                docItem.style.opacity = '0';
                setTimeout(() => {
                    docItem.remove();
                    
                    // Check if no documents left
                    const documentsList = document.querySelector('.documents-list');
                    const remainingItems = documentsList.querySelectorAll('.document-item');
                    
                    if (remainingItems.length === 0) {
                        // Show "No documents" message
                        documentsList.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #6c757d;">
                                <i class="fas fa-file-alt" style="font-size: 3em; margin-bottom: 15px;"></i>
                                <h4>Chưa có giấy tờ</h4>
                                <p>Nhân viên này chưa upload giấy tờ nào.</p>
                            </div>
                        `;
                    }
                }, 300);
            }
            
            showSuccessMessage(data.message || 'Xóa giấy tờ thành công');
            closeDeleteDocumentModal();
        } else {
            showErrorMessage(data.error || 'Có lỗi xảy ra khi xóa giấy tờ');
        }
        
    } catch (error) {
        console.error('Error deleting document:', error);
        showErrorMessage('Có lỗi xảy ra khi xóa giấy tờ');
    } finally {
        // Reset button state
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    }
}

// Show success message
function showSuccessMessage(message) {
    showMessage(message, 'success');
}

// Show error message
function showErrorMessage(message) {
    showMessage(message, 'error');
}

// Show message with type
function showMessage(message, type) {
    const container = document.getElementById('messageContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${type}`;
    
    const icon = type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle';
    messageDiv.innerHTML = `
        <i class="${icon}"></i>
        <span>${message}</span>
    `;
    
    container.appendChild(messageDiv);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.style.animation = 'slideOut 0.3s ease-in';
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 300);
        }
    }, 5000);
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('deleteDocumentModal');
    if (event.target === modal) {
        closeDeleteDocumentModal();
    }
}

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeDeleteDocumentModal();
    }
});
</script>
</div>
{% endblock %}