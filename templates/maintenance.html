{% extends "base.html" %}

{% block title %}B·∫£o d∆∞·ª°ng xe - H·ªá th·ªëng qu·∫£n l√Ω v·∫≠n chuy·ªÉn{% endblock %}

{% block content %}
<div class="maintenance-page-wrapper">
<h2 class="maintenance-page-title">üîß B·∫£o d∆∞·ª°ng xe</h2>

<h3 class="maintenance-section-title">üìã Danh s√°ch xe</h3>
{% if vehicles %}
<div style="overflow-x: auto;">
    <table class="table">
        <thead>
            <tr>
                <th>STT</th>
                <th>Bi·ªÉn s·ªë xe</th>
                <th>S·ªë km ƒë√£ b·∫£o d∆∞·ª°ng g·∫ßn nh·∫•t</th>
                <th>Ng√†y b·∫£o d∆∞·ª°ng g·∫ßn nh·∫•t</th>
                <th>Chi ti·∫øt</th>
            </tr>
        </thead>
        <tbody>
            {% for vehicle in vehicles %}
            <tr>
                <td>{{ loop.index }}</td>
                <td style="white-space: nowrap;"><strong>{{ vehicle.license_plate }}</strong></td>
                <td>
                    {% if vehicle.last_maintenance_km %}
                        {{ "{:,.0f}".format(vehicle.last_maintenance_km) }} km
                    {% else %}
                        <span style="color: #95a5a6;">Ch∆∞a c√≥ d·ªØ li·ªáu</span>
                    {% endif %}
                </td>
                <td>
                    {% if vehicle.last_maintenance_date %}
                        {% set days_diff = (today - vehicle.last_maintenance_date).days %}
                        {% if days_diff > 50 %}
                            <span class="maintenance-warning">{{ vehicle.last_maintenance_date.strftime('%d/%m/%Y') }}</span>
                        {% else %}
                            {{ vehicle.last_maintenance_date.strftime('%d/%m/%Y') }}
                        {% endif %}
                    {% else %}
                        <span style="color: #95a5a6;">Ch∆∞a c√≥ d·ªØ li·ªáu</span>
                    {% endif %}
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-primary" onclick="openDetailModal({{ vehicle.id }}, '{{ vehicle.license_plate }}')" style="padding: 5px 10px; font-size: 12px;">
                        Chi ti·∫øt
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div style="text-align: center; padding: 40px; color: #7f8c8d;">
    <h3>üöö Ch∆∞a c√≥ xe n√†o</h3>
    <p>Ch∆∞a c√≥ xe lo·∫°i "Xe Nh√†" trong h·ªá th·ªëng</p>
</div>
{% endif %}
</div>

<!-- Modal Chi ti·∫øt b·∫£o d∆∞·ª°ng -->
<div id="detailModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 1000px;">
        <div class="modal-header">
            <h3 id="detailModalTitle">Chi ti·∫øt b·∫£o d∆∞·ª°ng</h3>
            <span class="close" onclick="closeDetailModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 20px;">
                <button type="button" class="btn btn-success" onclick="openAddMaintenanceModal()">
                    ‚ûï Th√™m m·ªõi
                </button>
            </div>
            
            <div id="maintenanceList">
                <!-- Danh s√°ch b·∫£o d∆∞·ª°ng s·∫Ω ƒë∆∞·ª£c load b·∫±ng JavaScript -->
                <div style="text-align: center; padding: 20px; color: #7f8c8d;">
                    ƒêang t·∫£i...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Th√™m m·ªõi b·∫£o d∆∞·ª°ng -->
<div id="addMaintenanceModal" class="modal" style="display: none;">
    <div class="modal-content modal-fullscreen">
        <div class="modal-header">
            <h3>‚ûï Th√™m m·ªõi b·∫£o d∆∞·ª°ng</h3>
            <span class="close" onclick="closeAddMaintenanceModal()" title="ƒê√≥ng">&times;</span>
        </div>
        <div class="modal-body modal-body-fullscreen">
            <form id="addMaintenanceForm">
                <input type="hidden" id="maintenance_vehicle_id" name="vehicle_id">
                
                <!-- B∆∞·ªõc 1 - Th√¥ng tin b·∫Øt bu·ªôc -->
                <div id="step1Section" style="margin-bottom: 30px;">
                    <h4 style="color: #1976d2; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #42a5f5; background: #e3f2fd; padding: 12px 15px; border-radius: 6px;">
                        B∆∞·ªõc 1 - Th√¥ng tin b·∫Øt bu·ªôc
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label for="maintenance_date">Ng√†y b·∫£o d∆∞·ª°ng *</label>
                            <input type="date" id="maintenance_date" name="maintenance_date" required>
                        </div>
                        <div class="form-group">
                            <label for="maintenance_km">S·ªë km b·∫£o d∆∞·ª°ng *</label>
                            <input type="number" id="maintenance_km" name="maintenance_km" step="0.1" required placeholder="VD: 50000">
                        </div>
                    </div>
                </div>
                
                <!-- B∆∞·ªõc 2 - Danh s√°ch h·∫°ng m·ª•c b·∫£o d∆∞·ª°ng (ch·ªâ hi·ªÉn th·ªã sau khi nh·∫≠p xong b∆∞·ªõc 1) -->
                <div id="step2Section" style="display: none; margin-bottom: 30px;">
                    <h4 style="color: #1976d2; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #42a5f5; background: #e3f2fd; padding: 12px 15px; border-radius: 6px;">
                        B∆∞·ªõc 2 - Danh s√°ch h·∫°ng m·ª•c b·∫£o d∆∞·ª°ng
                    </h4>
                    
                    <div id="maintenanceItemsContainer">
                        <!-- C√°c d√≤ng h·∫°ng m·ª•c s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                    </div>
                    
                    <button type="button" class="btn btn-info" onclick="addMaintenanceItem()" style="margin-top: 15px;">
                        ‚ûï Th√™m d√≤ng +
                    </button>
                    
                    <!-- T·ªïng h·ª£p chi ph√≠ -->
                    <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 10px; border: 2px solid #90caf9;">
                        <h4 style="color: #1565c0; margin-bottom: 15px; font-weight: 600;">T·ªïng h·ª£p chi ph√≠</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="font-weight: 600; color: #1976d2;">T·ªïng c·ªông:</label>
                                <div id="totalAmount" style="font-size: 18px; font-weight: bold; color: #1565c0; margin-top: 5px;">
                                    0 VNƒê
                                </div>
                            </div>
                            <div>
                                <label for="vat_rate" style="font-weight: 600; color: #1976d2;">VAT:</label>
                                <select id="vat_rate" name="vat_rate" onchange="calculateTotal()" style="width: 100%; padding: 8px; border: 2px solid #90caf9; border-radius: 4px; margin-top: 5px; background: white;">
                                    <option value="0">0%</option>
                                    <option value="5">5%</option>
                                    <option value="8">8%</option>
                                    <option value="10">10%</option>
                                </select>
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <label style="font-weight: 600; color: #1976d2;">T·ªïng c·ªông (bao g·ªìm VAT):</label>
                                <div id="totalWithVat" style="font-size: 20px; font-weight: bold; color: #1565c0; margin-top: 5px; padding: 10px; background: white; border-radius: 6px; border: 2px solid #42a5f5;">
                                    0 VNƒê
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer" style="margin-top: 20px; text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddMaintenanceModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-success" id="submitBtn" disabled>L∆∞u</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal X√°c nh·∫≠n ƒë√≥ng form -->
<div id="closeConfirmationModal" class="modal" style="display: none; z-index: 2000;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">
            <h3>‚ö†Ô∏è X√°c nh·∫≠n ƒë√≥ng form</h3>
            <span class="close" onclick="closeConfirmationModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p style="font-size: 16px; line-height: 1.6; color: #2c3e50;">
                B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë√≥ng?<br>
                <strong style="color: #e74c3c;">D·ªØ li·ªáu ƒë√£ nh·∫≠p s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u.</strong>
            </p>
        </div>
        <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end;">
            <button type="button" class="btn btn-primary" onclick="continueEditing()" style="background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);">
                Ti·∫øp t·ª•c nh·∫≠p
            </button>
            <button type="button" class="btn btn-danger" onclick="confirmCloseWithoutSave()" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                ƒê√≥ng & kh√¥ng l∆∞u
            </button>
        </div>
    </div>
</div>

<!-- Modal S·ª≠a b·∫£o d∆∞·ª°ng -->
<div id="editMaintenanceModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <h3>‚úèÔ∏è S·ª≠a b·∫£o d∆∞·ª°ng</h3>
            <span class="close" onclick="closeEditMaintenanceModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editMaintenanceForm">
                <input type="hidden" id="edit_maintenance_id" name="maintenance_id">
                
                <!-- B∆∞·ªõc 1 - Th√¥ng tin b·∫Øt bu·ªôc -->
                <div id="editStep1Section" style="margin-bottom: 30px;">
                    <h4 style="color: #1976d2; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #42a5f5; background: #e3f2fd; padding: 12px 15px; border-radius: 6px;">
                        B∆∞·ªõc 1 - Th√¥ng tin b·∫Øt bu·ªôc
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label for="edit_maintenance_date">Ng√†y b·∫£o d∆∞·ª°ng *</label>
                            <input type="date" id="edit_maintenance_date" name="maintenance_date" required>
                        </div>
                        <div class="form-group">
                            <label for="edit_maintenance_km">S·ªë km b·∫£o d∆∞·ª°ng *</label>
                            <input type="number" id="edit_maintenance_km" name="maintenance_km" step="0.1" required placeholder="VD: 50000">
                        </div>
                    </div>
                </div>
                
                <!-- B∆∞·ªõc 2 - Danh s√°ch h·∫°ng m·ª•c b·∫£o d∆∞·ª°ng -->
                <div id="editStep2Section" style="margin-bottom: 30px;">
                    <h4 style="color: #1976d2; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #42a5f5; background: #e3f2fd; padding: 12px 15px; border-radius: 6px;">
                        B∆∞·ªõc 2 - Danh s√°ch h·∫°ng m·ª•c b·∫£o d∆∞·ª°ng
                    </h4>
                    
                    <div id="editMaintenanceItemsContainer">
                        <!-- C√°c d√≤ng h·∫°ng m·ª•c s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                    </div>
                    
                    <button type="button" class="btn btn-info" onclick="addEditMaintenanceItem()" style="margin-top: 15px;">
                        ‚ûï Th√™m h·∫°ng m·ª•c
                    </button>
                    
                    <!-- T·ªïng h·ª£p chi ph√≠ -->
                    <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 10px; border: 2px solid #90caf9;">
                        <h4 style="color: #1565c0; margin-bottom: 15px; font-weight: 600;">T·ªïng h·ª£p chi ph√≠</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="font-weight: 600; color: #1976d2;">T·ªïng c·ªông:</label>
                                <div id="editTotalAmount" style="font-size: 18px; font-weight: bold; color: #1565c0; margin-top: 5px;">
                                    0 VNƒê
                                </div>
                            </div>
                            <div>
                                <label for="edit_vat_rate" style="font-weight: 600; color: #1976d2;">VAT:</label>
                                <select id="edit_vat_rate" name="vat_rate" onchange="calculateEditTotal()" style="width: 100%; padding: 8px; border: 2px solid #90caf9; border-radius: 4px; margin-top: 5px; background: white;">
                                    <option value="0">0%</option>
                                    <option value="5">5%</option>
                                    <option value="8">8%</option>
                                    <option value="10">10%</option>
                                </select>
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <label style="font-weight: 600; color: #1976d2;">T·ªïng c·ªông (bao g·ªìm VAT):</label>
                                <div id="editTotalWithVat" style="font-size: 20px; font-weight: bold; color: #1565c0; margin-top: 5px; padding: 10px; background: white; border-radius: 6px; border: 2px solid #42a5f5;">
                                    0 VNƒê
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer" style="margin-top: 20px; text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditMaintenanceModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-success">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* ===== MAINTENANCE PAGE LIGHT BLUE THEME ===== */
.maintenance-page-wrapper {
    background: linear-gradient(135deg, #e3f2fd 0%, #f5f7fa 100%);
    padding: 25px;
    border-radius: 12px;
    margin: -25px;
    min-height: calc(100vh - 100px);
}

.maintenance-page-title {
    color: #1565c0;
    font-size: 28px;
    font-weight: 600;
    margin-bottom: 20px;
    padding: 15px 20px;
    background: linear-gradient(135deg, #90caf9 0%, #64b5f6 100%);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);
    text-align: center;
}

.maintenance-section-title {
    color: #1976d2;
    font-size: 20px;
    font-weight: 600;
    margin: 25px 0 15px 0;
    padding: 12px 18px;
    background: #e1f5fe;
    border-left: 4px solid #42a5f5;
    border-radius: 6px;
}

/* Table styling with light blue theme */
.maintenance-page-wrapper .table {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(25, 118, 210, 0.1);
}

.maintenance-page-wrapper .table thead {
    background: linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%);
}

.maintenance-page-wrapper .table th {
    background: linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%);
    color: white;
    font-weight: 600;
    padding: 14px;
    border: none;
    text-align: center;
}

.maintenance-page-wrapper .table tbody tr {
    background: white;
    transition: background-color 0.2s ease;
}

.maintenance-page-wrapper .table tbody tr:hover {
    background: #e3f2fd;
}

.maintenance-page-wrapper .table td {
    padding: 12px;
    border-bottom: 1px solid #e1f5fe;
    text-align: center;
}

/* Button styling */
.maintenance-page-wrapper .btn-primary {
    background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);
    border: none;
    box-shadow: 0 2px 6px rgba(33, 150, 243, 0.3);
    transition: all 0.3s ease;
}

.maintenance-page-wrapper .btn-primary:hover {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4);
    transform: translateY(-1px);
}

.maintenance-page-wrapper .btn-success {
    background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%);
    box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
}

.maintenance-page-wrapper .btn-success:hover {
    background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
    box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4);
}

/* Empty state styling */
.maintenance-page-wrapper .no-data {
    background: #e1f5fe;
    border: 2px dashed #90caf9;
    border-radius: 8px;
    padding: 40px;
    text-align: center;
    color: #1976d2;
}

.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 0;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-fullscreen {
    width: 95vw;
    height: 95vh;
    margin: 2.5vh auto;
    max-width: none;
    max-height: none;
    display: flex;
    flex-direction: column;
}

.modal-body-fullscreen {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #64b5f6 0%, #42a5f5 50%, #2196f3 100%);
    color: white;
    border-radius: 10px 10px 0 0;
    box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
}

.modal-header h3 {
    margin: 0;
    color: white;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid #ddd;
    background: #e3f2fd;
    border-radius: 0 0 10px 10px;
}

.close {
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.close:hover {
    opacity: 0.7;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #2c3e50;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #42a5f5;
    box-shadow: 0 0 0 3px rgba(66, 165, 245, 0.15);
}

.maintenance-item-row {
    display: grid;
    grid-template-columns: 4fr 0.8fr 0.8fr 1.2fr 0.8fr 1.2fr auto;
    gap: 8px;
    align-items: end;
    padding: 10px;
    background: #e3f2fd;
    border-radius: 8px;
    margin-bottom: 5px;
    border: 1px solid #bbdefb;
    transition: background-color 0.2s ease;
}

.maintenance-item-row:hover {
    background: #bbdefb;
}

.maintenance-item-row input {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 13px;
}

.btn-remove-item {
    background: #e74c3c;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.btn-remove-item:hover {
    background: #c0392b;
}

.maintenance-record {
    border: 2px solid #90caf9;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%);
    box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
    transition: box-shadow 0.3s ease;
}

.maintenance-record:hover {
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
}

.maintenance-record-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #bbdefb;
}

.maintenance-record-info {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 15px;
}

.maintenance-items-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.maintenance-items-table th,
.maintenance-items-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #e1f5fe;
}

.maintenance-items-table tbody tr:hover {
    background: #e3f2fd;
}

.maintenance-items-table th {
    background: linear-gradient(135deg, #90caf9 0%, #64b5f6 100%);
    font-weight: 600;
    color: white;
    border-bottom: 2px solid #42a5f5;
}

.maintenance-total {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 2px solid #42a5f5;
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    color: #1565c0;
}

.maintenance-warning {
    color: #e74c3c;
    font-weight: bold;
    animation: blink-red 1.5s infinite;
    padding: 4px 8px;
    border-radius: 4px;
    display: inline-block;
}

@keyframes blink-red {
    0%, 100% {
        background-color: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
    }
    50% {
        background-color: rgba(231, 76, 60, 0.5);
        color: #c0392b;
    }
}
</style>

<script>
let currentVehicleId = null;
let currentLicensePlate = null;
let itemCounter = 0;
let addMaintenanceFormInitialState = null; // L∆∞u tr·∫°ng th√°i ban ƒë·∫ßu c·ªßa form
let pendingCloseAction = null; // L∆∞u h√†nh ƒë·ªông ƒë√≥ng ƒëang ch·ªù x√°c nh·∫≠n

// M·ªü modal chi ti·∫øt
async function openDetailModal(vehicleId, licensePlate) {
    currentVehicleId = vehicleId;
    currentLicensePlate = licensePlate;
    
    document.getElementById('detailModalTitle').textContent = `Chi ti·∫øt b·∫£o d∆∞·ª°ng - ${licensePlate}`;
    document.getElementById('detailModal').style.display = 'block';
    
    // Load danh s√°ch b·∫£o d∆∞·ª°ng
    await loadMaintenanceList(vehicleId);
}

// ƒê√≥ng modal chi ti·∫øt
function closeDetailModal() {
    document.getElementById('detailModal').style.display = 'none';
    currentVehicleId = null;
    currentLicensePlate = null;
}

// Load danh s√°ch b·∫£o d∆∞·ª°ng
async function loadMaintenanceList(vehicleId) {
    const container = document.getElementById('maintenanceList');
    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #7f8c8d;">ƒêang t·∫£i...</div>';
    
    try {
        const response = await fetch(`/maintenance/detail/${vehicleId}`);
        const data = await response.json();
        
        if (data.success) {
            if (data.maintenances.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><p>Ch∆∞a c√≥ l·∫ßn b·∫£o d∆∞·ª°ng n√†o</p></div>';
            } else {
                let html = '';
                data.maintenances.forEach(maintenance => {
                    html += `
                        <div class="maintenance-record">
                            <div class="maintenance-record-header">
                                <div>
                                    <h4 style="margin: 0; color: #1976d2; font-weight: 600;">Ng√†y: ${formatDate(maintenance.maintenance_date)}</h4>
                                    <span style="color: #42a5f5; font-weight: 500;">S·ªë km: ${formatNumber(maintenance.maintenance_km)} km</span>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button type="button" class="btn btn-sm btn-warning" onclick="openEditMaintenanceModal(${maintenance.id})" style="padding: 5px 15px; font-size: 12px;">
                                        ‚úèÔ∏è S·ª≠a
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger" onclick="confirmDeleteMaintenance(${maintenance.id})" style="padding: 5px 15px; font-size: 12px;">
                                        üóëÔ∏è X√≥a
                                    </button>
                                </div>
                            </div>
                            <div class="maintenance-record-info">
                                <div>
                                    <strong>VAT:</strong> ${maintenance.vat_rate}%
                                </div>
                                <div>
                                    <strong>T·ªïng c·ªông:</strong> ${formatCurrency(maintenance.total_amount)}
                                </div>
                                <div>
                                    <strong>T·ªïng c√≥ VAT:</strong> ${formatCurrency(maintenance.total_with_vat)}
                                </div>
                            </div>
                            <table class="maintenance-items-table">
                                <thead>
                                    <tr>
                                        <th>N·ªôi dung b·∫£o d∆∞·ª°ng</th>
                                        <th>ƒêVT</th>
                                        <th>SL</th>
                                        <th>ƒê∆°n gi√°</th>
                                        <th>Gi·∫£m gi√° (%)</th>
                                        <th>Th√†nh ti·ªÅn</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${maintenance.items.map(item => `
                                        <tr>
                                            <td>${item.content}</td>
                                            <td>${item.unit || ''}</td>
                                            <td>${formatNumber(item.quantity)}</td>
                                            <td>${formatCurrency(item.unit_price)}</td>
                                            <td>${formatNumber(item.discount_percent || 0)}%</td>
                                            <td>${formatCurrency(item.total_price)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                });
                container.innerHTML = html;
            }
        } else {
            container.innerHTML = `<div style="text-align: center; padding: 20px; color: #e74c3c;">L·ªói: ${data.error}</div>`;
        }
    } catch (error) {
        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #e74c3c;">L·ªói khi t·∫£i d·ªØ li·ªáu: ${error.message}</div>`;
    }
}

// L∆∞u tr·∫°ng th√°i ban ƒë·∫ßu c·ªßa form (ch·ªâ l∆∞u m·ªôt l·∫ßn, kh√¥ng c·∫≠p nh·∫≠t l·∫°i)
function saveAddMaintenanceFormState() {
    // Ch·ªâ l∆∞u n·∫øu ch∆∞a c√≥ tr·∫°ng th√°i ban ƒë·∫ßu
    if (addMaintenanceFormInitialState !== null) {
        return;
    }
    
    const dateValue = document.getElementById('maintenance_date').value;
    const kmValue = document.getElementById('maintenance_km').value;
    const vatValue = document.getElementById('vat_rate').value;
    const itemsContainer = document.getElementById('maintenanceItemsContainer');
    
    // L∆∞u c√°c items
    const items = [];
    const rows = itemsContainer.querySelectorAll('.maintenance-item-row');
    rows.forEach(row => {
        items.push({
            content: row.querySelector('.item-content').value.trim(),
            unit: row.querySelector('.item-unit').value.trim(),
            quantity: row.querySelector('.item-quantity').value,
            unitPrice: row.querySelector('.item-unit-price').value,
            discount: row.querySelector('.item-discount').value
        });
    });
    
    addMaintenanceFormInitialState = {
        date: dateValue,
        km: kmValue,
        vat: vatValue,
        items: items,
        itemCount: itemCounter
    };
}

// C·∫≠p nh·∫≠t tr·∫°ng th√°i ban ƒë·∫ßu (ch·ªâ d√πng khi t·ª± ƒë·ªông t·∫°o items m·∫∑c ƒë·ªãnh)
function updateAddMaintenanceFormInitialState() {
    const dateValue = document.getElementById('maintenance_date').value;
    const kmValue = document.getElementById('maintenance_km').value;
    const vatValue = document.getElementById('vat_rate').value;
    const itemsContainer = document.getElementById('maintenanceItemsContainer');
    
    // L∆∞u c√°c items
    const items = [];
    const rows = itemsContainer.querySelectorAll('.maintenance-item-row');
    rows.forEach(row => {
        items.push({
            content: row.querySelector('.item-content').value.trim(),
            unit: row.querySelector('.item-unit').value.trim(),
            quantity: row.querySelector('.item-quantity').value,
            unitPrice: row.querySelector('.item-unit-price').value,
            discount: row.querySelector('.item-discount').value
        });
    });
    
    addMaintenanceFormInitialState = {
        date: dateValue,
        km: kmValue,
        vat: vatValue,
        items: items,
        itemCount: itemCounter
    };
}

// Ki·ªÉm tra xem form c√≥ thay ƒë·ªïi kh√¥ng
function hasAddMaintenanceFormChanged() {
    if (!addMaintenanceFormInitialState) return false;
    
    const currentDate = document.getElementById('maintenance_date').value || '';
    const currentKm = document.getElementById('maintenance_km').value || '';
    const currentVat = document.getElementById('vat_rate').value || '0';
    const itemsContainer = document.getElementById('maintenanceItemsContainer');
    
    const savedDate = addMaintenanceFormInitialState.date || '';
    const savedKm = addMaintenanceFormInitialState.km || '';
    const savedVat = addMaintenanceFormInitialState.vat || '0';
    
    // Ki·ªÉm tra c√°c tr∆∞·ªùng c∆° b·∫£n
    if (currentDate !== savedDate ||
        currentKm !== savedKm ||
        currentVat !== savedVat ||
        itemCounter !== addMaintenanceFormInitialState.itemCount) {
        return true;
    }
    
    // Ki·ªÉm tra c√°c items
    const currentRows = itemsContainer.querySelectorAll('.maintenance-item-row');
    if (currentRows.length !== addMaintenanceFormInitialState.items.length) {
        return true;
    }
    
    for (let i = 0; i < currentRows.length; i++) {
        const row = currentRows[i];
        const savedItem = addMaintenanceFormInitialState.items[i];
        
        const currentContent = (row.querySelector('.item-content').value || '').trim();
        const currentUnit = (row.querySelector('.item-unit').value || '').trim();
        const currentQuantity = row.querySelector('.item-quantity').value || '0';
        const currentUnitPrice = row.querySelector('.item-unit-price').value || '0';
        const currentDiscount = row.querySelector('.item-discount').value || '0';
        
        const savedContent = (savedItem.content || '').trim();
        const savedUnit = (savedItem.unit || '').trim();
        const savedQuantity = savedItem.quantity || '0';
        const savedUnitPrice = savedItem.unitPrice || '0';
        const savedDiscount = savedItem.discount || '0';
        
        if (currentContent !== savedContent ||
            currentUnit !== savedUnit ||
            currentQuantity !== savedQuantity ||
            currentUnitPrice !== savedUnitPrice ||
            currentDiscount !== savedDiscount) {
            return true;
        }
    }
    
    return false;
}

// Hi·ªÉn th·ªã modal x√°c nh·∫≠n ƒë√≥ng
function showCloseConfirmation(closeAction) {
    pendingCloseAction = closeAction;
    document.getElementById('closeConfirmationModal').style.display = 'block';
}

// ƒê√≥ng modal x√°c nh·∫≠n
function closeConfirmationModal() {
    document.getElementById('closeConfirmationModal').style.display = 'none';
    pendingCloseAction = null;
}

// Ti·∫øp t·ª•c ch·ªânh s·ª≠a (quay l·∫°i form)
function continueEditing() {
    closeConfirmationModal();
}

// X√°c nh·∫≠n ƒë√≥ng v√† kh√¥ng l∆∞u
function confirmCloseWithoutSave() {
    // L∆∞u h√†nh ƒë·ªông ƒë√≥ng v√†o bi·∫øn t·∫°m tr∆∞·ªõc khi ƒë√≥ng modal
    const actionToExecute = pendingCloseAction;
    closeConfirmationModal();
    // Th·ª±c thi h√†nh ƒë·ªông ƒë√≥ng form sau khi ƒë√≥ng modal x√°c nh·∫≠n
    if (actionToExecute) {
        actionToExecute();
    }
}

// M·ªü modal th√™m m·ªõi
function openAddMaintenanceModal() {
    if (!currentVehicleId) {
        alert('Vui l√≤ng ch·ªçn xe tr∆∞·ªõc');
        return;
    }
    
    // Reset tr·∫°ng th√°i ban ƒë·∫ßu tr∆∞·ªõc khi m·ªü form m·ªõi
    addMaintenanceFormInitialState = null;
    
    document.getElementById('maintenance_vehicle_id').value = currentVehicleId;
    document.getElementById('addMaintenanceForm').reset();
    document.getElementById('step2Section').style.display = 'none';
    document.getElementById('maintenanceItemsContainer').innerHTML = '';
    document.getElementById('submitBtn').disabled = true;
    itemCounter = 0;
    calculateTotal();
    
    // L∆∞u tr·∫°ng th√°i ban ƒë·∫ßu (sau khi reset form)
    saveAddMaintenanceFormState();
    
    document.getElementById('addMaintenanceModal').style.display = 'block';
    
    // Ki·ªÉm tra khi nh·∫≠p xong b∆∞·ªõc 1
    const dateInput = document.getElementById('maintenance_date');
    const kmInput = document.getElementById('maintenance_km');
    
    function checkStep1() {
        if (dateInput.value && kmInput.value) {
            document.getElementById('step2Section').style.display = 'block';
            document.getElementById('submitBtn').disabled = false;
                // T·ª± ƒë·ªông t·∫°o 5 d√≤ng m·∫∑c ƒë·ªãnh n·∫øu ch∆∞a c√≥
                if (itemCounter === 0) {
                    for (let i = 0; i < 5; i++) {
                        addMaintenanceItem();
                    }
                    // C·∫≠p nh·∫≠t l·∫°i tr·∫°ng th√°i ban ƒë·∫ßu sau khi th√™m items (v√¨ ƒë√¢y l√† tr·∫°ng th√°i ban ƒë·∫ßu th·ª±c s·ª±)
                    updateAddMaintenanceFormInitialState();
                }
        } else {
            document.getElementById('step2Section').style.display = 'none';
            document.getElementById('submitBtn').disabled = true;
        }
    }
    
    dateInput.onchange = checkStep1;
    kmInput.oninput = checkStep1;
}

// ƒê√≥ng modal th√™m m·ªõi (h√†m th·ª±c s·ª± ƒë√≥ng form)
function closeAddMaintenanceModal(force = false) {
    if (!force && hasAddMaintenanceFormChanged()) {
        // C√≥ thay ƒë·ªïi, hi·ªÉn th·ªã popup x√°c nh·∫≠n
        showCloseConfirmation(() => {
            closeAddMaintenanceModal(true);
        });
        return;
    }
    
    // Kh√¥ng c√≥ thay ƒë·ªïi ho·∫∑c ƒë√£ x√°c nh·∫≠n, ƒë√≥ng form
    document.getElementById('addMaintenanceModal').style.display = 'none';
    document.getElementById('addMaintenanceForm').reset();
    document.getElementById('step2Section').style.display = 'none';
    document.getElementById('maintenanceItemsContainer').innerHTML = '';
    itemCounter = 0;
    addMaintenanceFormInitialState = null;
}

// Th√™m d√≤ng h·∫°ng m·ª•c
function addMaintenanceItem() {
    itemCounter++;
    const container = document.getElementById('maintenanceItemsContainer');
    const itemId = `item_${itemCounter}`;
    
    const row = document.createElement('div');
    row.className = 'maintenance-item-row';
    row.id = itemId;
    row.innerHTML = `
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">N·ªôi dung b·∫£o d∆∞·ª°ng</label>
            <input type="text" class="item-content" placeholder="Nh·∫≠p n·ªôi dung b·∫£o d∆∞·ª°ng" required>
        </div>
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">ƒêVT</label>
            <input type="text" class="item-unit" placeholder="VD: c√°i, l√≠t">
        </div>
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">SL</label>
            <input type="number" class="item-quantity" step="0.01" value="0" oninput="calculateItemTotal('${itemId}')">
        </div>
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">ƒê∆°n gi√°</label>
            <input type="number" class="item-unit-price" step="0.01" value="0" oninput="calculateItemTotal('${itemId}')">
        </div>
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">Gi·∫£m gi√° (%)</label>
            <input type="number" class="item-discount" step="0.01" value="0" min="0" max="100" oninput="calculateItemTotal('${itemId}')">
        </div>
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">Th√†nh ti·ªÅn</label>
            <input type="text" class="item-total" readonly style="background: #f8f9fa;">
        </div>
        <div>
            <button type="button" class="btn-remove-item" onclick="removeMaintenanceItem('${itemId}')">X√≥a</button>
        </div>
    `;
    
    container.appendChild(row);
    calculateItemTotal(itemId);
}

// X√≥a d√≤ng h·∫°ng m·ª•c
function removeMaintenanceItem(itemId) {
    const row = document.getElementById(itemId);
    if (row) {
        row.remove();
        calculateTotal();
    }
}

// T√≠nh th√†nh ti·ªÅn cho m·ªôt h·∫°ng m·ª•c
function calculateItemTotal(itemId) {
    const row = document.getElementById(itemId);
    if (!row) return;
    
    const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
    const unitPrice = parseFloat(row.querySelector('.item-unit-price').value) || 0;
    const discountPercent = parseFloat(row.querySelector('.item-discount').value) || 0;
    // Th√†nh ti·ªÅn = SL √ó ƒê∆°n gi√° √ó (1 ‚àí Gi·∫£m gi√° / 100)
    const total = quantity * unitPrice * (1 - discountPercent / 100);
    
    row.querySelector('.item-total').value = formatCurrency(total);
    calculateTotal();
}

// T√≠nh t·ªïng
function calculateTotal() {
    let total = 0;
    const rows = document.querySelectorAll('.maintenance-item-row');
    
    rows.forEach(row => {
        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const unitPrice = parseFloat(row.querySelector('.item-unit-price').value) || 0;
        const discountPercent = parseFloat(row.querySelector('.item-discount').value) || 0;
        // Th√†nh ti·ªÅn = SL √ó ƒê∆°n gi√° √ó (1 ‚àí Gi·∫£m gi√° / 100)
        const itemTotal = quantity * unitPrice * (1 - discountPercent / 100);
        total += itemTotal;
    });
    
    const vatRate = parseFloat(document.getElementById('vat_rate').value) || 0;
    const vatAmount = total * (vatRate / 100);
    const totalWithVat = total + vatAmount;
    
    document.getElementById('totalAmount').textContent = formatCurrency(total);
    document.getElementById('totalWithVat').textContent = formatCurrency(totalWithVat);
}

// Submit form
document.getElementById('addMaintenanceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const vehicleId = parseInt(document.getElementById('maintenance_vehicle_id').value);
    const maintenanceDate = document.getElementById('maintenance_date').value;
    const maintenanceKm = parseFloat(document.getElementById('maintenance_km').value);
    const vatRate = parseFloat(document.getElementById('vat_rate').value) || 0;
    
    // Thu th·∫≠p items
    const items = [];
    const rows = document.querySelectorAll('.maintenance-item-row');
    
    rows.forEach(row => {
        const content = row.querySelector('.item-content').value.trim();
        if (!content) return;
        
        items.push({
            content: content,
            unit: row.querySelector('.item-unit').value.trim(),
            quantity: parseFloat(row.querySelector('.item-quantity').value) || 0,
            unit_price: parseFloat(row.querySelector('.item-unit-price').value) || 0,
            discount_percent: parseFloat(row.querySelector('.item-discount').value) || 0
        });
    });
    
    if (items.length === 0) {
        alert('Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt h·∫°ng m·ª•c b·∫£o d∆∞·ª°ng');
        return;
    }
    
    // T·∫°o FormData
    const formData = new FormData();
    formData.append('vehicle_id', vehicleId);
    formData.append('maintenance_date', maintenanceDate);
    formData.append('maintenance_km', maintenanceKm);
    formData.append('vat_rate', vatRate);
    formData.append('items', JSON.stringify(items));
    
    try {
        const response = await fetch('/maintenance/add', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('ƒê√£ th√™m b·∫£o d∆∞·ª°ng th√†nh c√¥ng!');
            closeAddMaintenanceModal(true); // Force close v√¨ ƒë√£ l∆∞u th√†nh c√¥ng
            await loadMaintenanceList(vehicleId);
            // Reload trang ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë km g·∫ßn nh·∫•t
            location.reload();
        } else {
            alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ th√™m b·∫£o d∆∞·ª°ng'));
        }
    } catch (error) {
        alert('L·ªói khi th√™m b·∫£o d∆∞·ª°ng: ' + error.message);
    }
});

// ƒê√≥ng modal khi click b√™n ngo√†i
window.onclick = function(event) {
    const detailModal = document.getElementById('detailModal');
    const addModal = document.getElementById('addMaintenanceModal');
    const editModal = document.getElementById('editMaintenanceModal');
    const confirmationModal = document.getElementById('closeConfirmationModal');
    
    // N·∫øu click v√†o modal x√°c nh·∫≠n, kh√¥ng l√†m g√¨
    if (event.target === confirmationModal) {
        return;
    }
    
    if (event.target === detailModal) {
        closeDetailModal();
    }
    if (event.target === addModal) {
        // Ki·ªÉm tra thay ƒë·ªïi tr∆∞·ªõc khi ƒë√≥ng
        closeAddMaintenanceModal();
    }
    if (event.target === editModal) {
        closeEditMaintenanceModal();
    }
}

// M·ªü modal s·ª≠a b·∫£o d∆∞·ª°ng
async function openEditMaintenanceModal(maintenanceId) {
    try {
        // L·∫•y th√¥ng tin b·∫£o d∆∞·ª°ng
        const response = await fetch(`/maintenance/detail/${currentVehicleId}`);
        const data = await response.json();
        
        if (!data.success) {
            alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin b·∫£o d∆∞·ª°ng'));
            return;
        }
        
        const maintenance = data.maintenances.find(m => m.id === maintenanceId);
        if (!maintenance) {
            alert('Kh√¥ng t√¨m th·∫•y b·∫£o d∆∞·ª°ng');
            return;
        }
        
        // ƒêi·ªÅn th√¥ng tin v√†o form
        document.getElementById('edit_maintenance_id').value = maintenance.id;
        document.getElementById('edit_maintenance_date').value = maintenance.maintenance_date;
        document.getElementById('edit_maintenance_km').value = maintenance.maintenance_km;
        document.getElementById('edit_vat_rate').value = maintenance.vat_rate;
        
        // X√≥a c√°c items c≈©
        document.getElementById('editMaintenanceItemsContainer').innerHTML = '';
        editItemCounter = 0;
        
        // Th√™m c√°c items
        maintenance.items.forEach(item => {
            addEditMaintenanceItemWithData(item);
        });
        
        // T√≠nh t·ªïng
        calculateEditTotal();
        
        // Hi·ªÉn th·ªã modal
        document.getElementById('editMaintenanceModal').style.display = 'block';
    } catch (error) {
        alert('L·ªói khi t·∫£i th√¥ng tin b·∫£o d∆∞·ª°ng: ' + error.message);
    }
}

// ƒê√≥ng modal s·ª≠a b·∫£o d∆∞·ª°ng
function closeEditMaintenanceModal() {
    document.getElementById('editMaintenanceModal').style.display = 'none';
    document.getElementById('editMaintenanceForm').reset();
    document.getElementById('editMaintenanceItemsContainer').innerHTML = '';
    editItemCounter = 0;
}

let editItemCounter = 0;

// Th√™m d√≤ng h·∫°ng m·ª•c cho form s·ª≠a
function addEditMaintenanceItem() {
    addEditMaintenanceItemWithData(null);
}

// Th√™m d√≤ng h·∫°ng m·ª•c v·ªõi d·ªØ li·ªáu (d√πng khi load form s·ª≠a)
function addEditMaintenanceItemWithData(itemData) {
    editItemCounter++;
    const container = document.getElementById('editMaintenanceItemsContainer');
    const itemId = `edit_item_${editItemCounter}`;
    
    const row = document.createElement('div');
    row.className = 'maintenance-item-row';
    row.id = itemId;
    row.innerHTML = `
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">N·ªôi dung b·∫£o d∆∞·ª°ng</label>
            <input type="text" class="item-content" placeholder="Nh·∫≠p n·ªôi dung b·∫£o d∆∞·ª°ng" value="${itemData ? (itemData.content || '') : ''}" required>
        </div>
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">ƒêVT</label>
            <input type="text" class="item-unit" placeholder="VD: c√°i, l√≠t" value="${itemData ? (itemData.unit || '') : ''}">
        </div>
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">SL</label>
            <input type="number" class="item-quantity" step="0.01" value="${itemData ? (itemData.quantity || 0) : 0}" oninput="calculateEditItemTotal('${itemId}')">
        </div>
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">ƒê∆°n gi√°</label>
            <input type="number" class="item-unit-price" step="0.01" value="${itemData ? (itemData.unit_price || 0) : 0}" oninput="calculateEditItemTotal('${itemId}')">
        </div>
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">Gi·∫£m gi√° (%)</label>
            <input type="number" class="item-discount" step="0.01" value="${itemData ? (itemData.discount_percent || 0) : 0}" min="0" max="100" oninput="calculateEditItemTotal('${itemId}')">
        </div>
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">Th√†nh ti·ªÅn</label>
            <input type="text" class="item-total" readonly style="background: #f8f9fa;" value="${itemData ? formatCurrency(itemData.total_price || 0) : '0 VNƒê'}">
        </div>
        <div>
            <button type="button" class="btn-remove-item" onclick="removeEditMaintenanceItem('${itemId}')">X√≥a</button>
        </div>
    `;
    
    container.appendChild(row);
    calculateEditItemTotal(itemId);
}

// X√≥a d√≤ng h·∫°ng m·ª•c trong form s·ª≠a
function removeEditMaintenanceItem(itemId) {
    const row = document.getElementById(itemId);
    if (row) {
        row.remove();
        calculateEditTotal();
    }
}

// T√≠nh th√†nh ti·ªÅn cho m·ªôt h·∫°ng m·ª•c trong form s·ª≠a
function calculateEditItemTotal(itemId) {
    const row = document.getElementById(itemId);
    if (!row) return;
    
    const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
    const unitPrice = parseFloat(row.querySelector('.item-unit-price').value) || 0;
    const discountPercent = parseFloat(row.querySelector('.item-discount').value) || 0;
    const total = quantity * unitPrice * (1 - discountPercent / 100);
    
    row.querySelector('.item-total').value = formatCurrency(total);
    calculateEditTotal();
}

// T√≠nh t·ªïng cho form s·ª≠a
function calculateEditTotal() {
    let total = 0;
    const rows = document.querySelectorAll('#editMaintenanceItemsContainer .maintenance-item-row');
    
    rows.forEach(row => {
        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const unitPrice = parseFloat(row.querySelector('.item-unit-price').value) || 0;
        const discountPercent = parseFloat(row.querySelector('.item-discount').value) || 0;
        const itemTotal = quantity * unitPrice * (1 - discountPercent / 100);
        total += itemTotal;
    });
    
    const vatRate = parseFloat(document.getElementById('edit_vat_rate').value) || 0;
    const vatAmount = total * (vatRate / 100);
    const totalWithVat = total + vatAmount;
    
    document.getElementById('editTotalAmount').textContent = formatCurrency(total);
    document.getElementById('editTotalWithVat').textContent = formatCurrency(totalWithVat);
}

// X√°c nh·∫≠n x√≥a b·∫£o d∆∞·ª°ng
function confirmDeleteMaintenance(maintenanceId) {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi b·∫£o d∆∞·ª°ng n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
        deleteMaintenance(maintenanceId);
    }
}

// X√≥a b·∫£o d∆∞·ª°ng
async function deleteMaintenance(maintenanceId) {
    try {
        const response = await fetch(`/maintenance/delete/${maintenanceId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('ƒê√£ x√≥a b·∫£o d∆∞·ª°ng th√†nh c√¥ng!');
            await loadMaintenanceList(currentVehicleId);
            // Reload trang ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë km g·∫ßn nh·∫•t
            location.reload();
        } else {
            alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ x√≥a b·∫£o d∆∞·ª°ng'));
        }
    } catch (error) {
        alert('L·ªói khi x√≥a b·∫£o d∆∞·ª°ng: ' + error.message);
    }
}

// Submit form s·ª≠a
document.getElementById('editMaintenanceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const maintenanceId = parseInt(document.getElementById('edit_maintenance_id').value);
    const maintenanceDate = document.getElementById('edit_maintenance_date').value;
    const maintenanceKm = parseFloat(document.getElementById('edit_maintenance_km').value);
    const vatRate = parseFloat(document.getElementById('edit_vat_rate').value) || 0;
    
    // Thu th·∫≠p items
    const items = [];
    const rows = document.querySelectorAll('#editMaintenanceItemsContainer .maintenance-item-row');
    
    rows.forEach(row => {
        const content = row.querySelector('.item-content').value.trim();
        if (!content) return;
        
        items.push({
            content: content,
            unit: row.querySelector('.item-unit').value.trim(),
            quantity: parseFloat(row.querySelector('.item-quantity').value) || 0,
            unit_price: parseFloat(row.querySelector('.item-unit-price').value) || 0,
            discount_percent: parseFloat(row.querySelector('.item-discount').value) || 0
        });
    });
    
    if (items.length === 0) {
        alert('Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt h·∫°ng m·ª•c b·∫£o d∆∞·ª°ng');
        return;
    }
    
    // T·∫°o FormData
    const formData = new FormData();
    formData.append('maintenance_date', maintenanceDate);
    formData.append('maintenance_km', maintenanceKm);
    formData.append('vat_rate', vatRate);
    formData.append('items', JSON.stringify(items));
    
    try {
        const response = await fetch(`/maintenance/edit/${maintenanceId}`, {
            method: 'PUT',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('ƒê√£ c·∫≠p nh·∫≠t b·∫£o d∆∞·ª°ng th√†nh c√¥ng!');
            closeEditMaintenanceModal();
            await loadMaintenanceList(currentVehicleId);
            // Reload trang ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë km g·∫ßn nh·∫•t
            location.reload();
        } else {
            alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t b·∫£o d∆∞·ª°ng'));
        }
    } catch (error) {
        alert('L·ªói khi c·∫≠p nh·∫≠t b·∫£o d∆∞·ª°ng: ' + error.message);
    }
});

// Helper functions
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('vi-VN');
}

function formatNumber(num) {
    return new Intl.NumberFormat('vi-VN').format(num);
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN').format(amount) + ' VNƒê';
}
</script>
{% endblock %}

