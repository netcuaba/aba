{% extends "base.html" %}

{% block title %}Qu·∫£n l√Ω t√†i kho·∫£n & Ph√¢n quy·ªÅn - H·ªá th·ªëng qu·∫£n l√Ω v·∫≠n chuy·ªÉn{% endblock %}

{% block content %}
<div class="page-wrapper">
<div class="page-header">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
        <div>
            <h2>üë§ Qu·∫£n l√Ω t√†i kho·∫£n & Ph√¢n quy·ªÅn</h2>
            <p>Qu·∫£n l√Ω ng∆∞·ªùi d√πng, t√†i kho·∫£n v√† ph√¢n quy·ªÅn trong h·ªá th·ªëng (Ch·ªâ d√†nh cho Admin)</p>
        </div>
        <button type="button" class="btn btn-primary btn-lg" onclick="openAddAccountModal()">
            <i class="fas fa-user-plus"></i> Th√™m t√†i kho·∫£n
        </button>
    </div>
</div>

<!-- Danh s√°ch t√†i kho·∫£n -->
<div class="table-section">
    {% if accounts %}
    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Username</th>
                    <th>H·ªç t√™n</th>
                    <th>Email</th>
                    <th>SƒêT</th>
                    <th>Vai tr√≤</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>L·∫ßn ƒëƒÉng nh·∫≠p cu·ªëi</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody>
                {% for account in accounts %}
                <tr class="{% if account.is_locked == 1 %}locked-row{% endif %}">
                    <td>{{ (page - 1) * per_page + loop.index }}</td>
                    <td><strong>{{ account.username }}</strong></td>
                    <td>{{ account.full_name or '-' }}</td>
                    <td>{{ account.email or '-' }}</td>
                    <td>{{ account.phone or '-' }}</td>
                    <td>
                        <span class="role-badge role-{{ account.role.lower() }}">
                            {{ account.role }}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge status-{{ account.status.lower() }}">
                            {% if account.is_locked == 1 %}
                                üîí Kho√°
                            {% else %}
                                {{ account.status }}
                            {% endif %}
                        </span>
                    </td>
                    <td>
                        {% if account.last_login %}
                            {{ account.last_login|to_local_time }}
                        {% else %}
                            Ch∆∞a ƒëƒÉng nh·∫≠p
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button type="button" class="btn btn-sm btn-info" onclick="openEditModal({{ account.id }}, '{{ account.username }}', '{{ account.full_name or '' }}', '{{ account.email or '' }}', '{{ account.phone or '' }}', '{{ account.role }}', '{{ account.status }}')" title="S·ª≠a">
                                <i class="fas fa-edit"></i>
                            </button>
                            {% if account.role != "Admin" %}
                            <button type="button" class="btn btn-sm btn-primary" onclick="openPermissionsModal({{ account.id }}, '{{ account.username }}')" title="Ph√¢n quy·ªÅn">
                                <i class="fas fa-user-shield"></i>
                            </button>
                            {% endif %}
                            <button type="button" class="btn btn-sm btn-warning" onclick="openResetPasswordModal({{ account.id }}, '{{ account.username }}')" title="Reset m·∫≠t kh·∫©u">
                                <i class="fas fa-key"></i>
                            </button>
                            {% if account.is_locked == 1 %}
                                <button type="button" class="btn btn-sm btn-success" onclick="unlockAccount({{ account.id }}, '{{ account.username }}')" title="M·ªü kho√°">
                                    <i class="fas fa-unlock"></i>
                                </button>
                            {% else %}
                                <button type="button" class="btn btn-sm btn-secondary" onclick="lockAccount({{ account.id }}, '{{ account.username }}')" title="Kho√°">
                                    <i class="fas fa-lock"></i>
                                </button>
                            {% endif %}
                            {% if account.status == "Active" %}
                                <button type="button" class="btn btn-sm btn-danger" onclick="deleteAccount({{ account.id }}, '{{ account.username }}')" title="X√≥a">
                                    <i class="fas fa-trash"></i>
                                </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Ph√¢n trang -->
    {% if total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
            <a href="?page={{ page - 1 }}" class="btn btn-sm">
                <i class="fas fa-chevron-left"></i> Tr∆∞·ªõc
            </a>
        {% endif %}
        
        <span class="page-info">Trang {{ page }} / {{ total_pages }} (T·ªïng: {{ total }} t√†i kho·∫£n)</span>
        
        {% if page < total_pages %}
            <a href="?page={{ page + 1 }}" class="btn btn-sm">
                Sau <i class="fas fa-chevron-right"></i>
            </a>
        {% endif %}
    </div>
    {% endif %}
    {% else %}
    <div class="no-data">
        <div class="no-data-icon">üë§</div>
        <h3>Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n n√†o</h3>
        <p>H√£y th·ª≠ l·∫°i v·ªõi b·ªô l·ªçc kh√°c ho·∫∑c th√™m t√†i kho·∫£n m·ªõi</p>
    </div>
    {% endif %}
</div>

<!-- Modal Th√™m t√†i kho·∫£n m·ªõi -->
<div id="addAccountModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user-plus"></i> Th√™m t√†i kho·∫£n m·ªõi</h3>
            <span class="close" onclick="closeAddAccountModal()">&times;</span>
        </div>
        <form id="addAccountForm">
            <div class="modal-body">
                <div class="form-group">
                    <label for="username">Username *</label>
                    <input type="text" id="username" name="username" required placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p">
                    <div class="error-message" id="username-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="full_name">H·ªç t√™n</label>
                    <input type="text" id="full_name" name="full_name" placeholder="Nh·∫≠p h·ªç t√™n">
                </div>
                
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" placeholder="Nh·∫≠p email">
                </div>
                
                <div class="form-group">
                    <label for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="text" id="phone" name="phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                </div>
                
                <div class="form-group">
                    <label for="role">Vai tr√≤ (Role) *</label>
                    <select id="role" name="role" required>
                        <option value="">-- Ch·ªçn vai tr√≤ --</option>
                        <option value="Admin">Admin (Qu·∫£n tr·ªã h·ªá th·ªëng)</option>
                        <option value="Manager">Manager (Qu·∫£n l√Ω)</option>
                        <option value="User">User (Nh√¢n vi√™n)</option>
                    </select>
                    <div class="error-message" id="role-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="status">Tr·∫°ng th√°i *</label>
                    <select id="status" name="status" required>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="auto_generate_password" name="auto_generate_password" value="true" onchange="togglePasswordField()">
                        T·ª± ƒë·ªông t·∫°o m·∫≠t kh·∫©u
                    </label>
                </div>
                
                <div class="form-group" id="password-group">
                    <label for="password">M·∫≠t kh·∫©u *</label>
                    <input type="password" id="password" name="password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
                    <small class="form-help">
                        M·∫≠t kh·∫©u ph·∫£i c√≥: √≠t nh·∫•t 8 k√Ω t·ª±, 1 ch·ªØ in hoa (A-Z), 1 ch·ªØ th∆∞·ªùng (a-z), 1 ch·ªØ s·ªë (0-9)
                    </small>
                    <div class="error-message" id="password-error"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAddAccountModal()">H·ªßy</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> L∆∞u
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal S·ª≠a t√†i kho·∫£n -->
<div id="editAccountModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> S·ª≠a th√¥ng tin t√†i kho·∫£n</h3>
            <span class="close" onclick="closeEditModal()">&times;</span>
        </div>
        <form id="editAccountForm">
            <input type="hidden" id="edit_account_id" name="account_id">
            <div class="modal-body">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="edit_username" disabled style="background-color: #f5f5f5;">
                    <small class="form-help">Username kh√¥ng th·ªÉ thay ƒë·ªïi</small>
                </div>
                
                <div class="form-group">
                    <label for="edit_full_name">H·ªç t√™n</label>
                    <input type="text" id="edit_full_name" name="full_name" placeholder="Nh·∫≠p h·ªç t√™n">
                </div>
                
                <div class="form-group">
                    <label for="edit_email">Email</label>
                    <input type="email" id="edit_email" name="email" placeholder="Nh·∫≠p email">
                </div>
                
                <div class="form-group">
                    <label for="edit_phone">S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="text" id="edit_phone" name="phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                </div>
                
                <div class="form-group">
                    <label for="edit_role">Vai tr√≤ (Role) *</label>
                    <select id="edit_role" name="role" required>
                        <option value="Admin">Admin (Qu·∫£n tr·ªã h·ªá th·ªëng)</option>
                        <option value="Manager">Manager (Qu·∫£n l√Ω)</option>
                        <option value="User">User (Nh√¢n vi√™n)</option>
                    </select>
                    <div class="error-message" id="edit-role-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="edit_status">Tr·∫°ng th√°i *</label>
                    <select id="edit_status" name="status" required>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">H·ªßy</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> L∆∞u
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Reset m·∫≠t kh·∫©u -->
<div id="resetPasswordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-key"></i> Reset / ƒê·ªïi m·∫≠t kh·∫©u</h3>
            <span class="close" onclick="closeResetPasswordModal()">&times;</span>
        </div>
        <form id="resetPasswordForm">
            <input type="hidden" id="reset_account_id" name="account_id">
            <div class="modal-body">
                <div class="form-group">
                    <label>T√†i kho·∫£n</label>
                    <input type="text" id="reset_username" disabled style="background-color: #f5f5f5;">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="reset_auto_generate" name="auto_generate" value="true" onchange="toggleResetPasswordField()">
                        T·ª± ƒë·ªông t·∫°o m·∫≠t kh·∫©u
                    </label>
                </div>
                
                <div class="form-group" id="reset-password-group">
                    <label for="reset_new_password">M·∫≠t kh·∫©u m·ªõi *</label>
                    <input type="password" id="reset_new_password" name="new_password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi">
                    <small class="form-help">
                        M·∫≠t kh·∫©u ph·∫£i c√≥: √≠t nh·∫•t 8 k√Ω t·ª±, 1 ch·ªØ in hoa (A-Z), 1 ch·ªØ th∆∞·ªùng (a-z), 1 ch·ªØ s·ªë (0-9)
                    </small>
                    <div class="error-message" id="reset-password-error"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeResetPasswordModal()">H·ªßy</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> ƒê·ªïi m·∫≠t kh·∫©u
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.page-header {
    margin-bottom: 30px;
}

.page-header h2 {
    color: #2c3e50;
    margin-bottom: 10px;
}

.page-header p {
    color: #7f8c8d;
    margin: 0;
}

.btn-lg {
    padding: 12px 24px;
    font-size: 16px;
    border-radius: 8px;
}

.filter-section {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-group label {
    font-size: 12px;
    font-weight: 600;
    color: #555;
}

.filter-group input,
.filter-group select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

.table-section {
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th {
    background: #34495e;
    color: white;
    padding: 15px 12px;
    text-align: left;
    font-weight: 600;
    border: none;
}

.data-table td {
    padding: 12px;
    border-bottom: 1px solid #ecf0f1;
    vertical-align: middle;
}

.data-table tbody tr:hover {
    background-color: #f8f9fa;
}

.data-table tbody tr.locked-row {
    background-color: #fff3cd;
    opacity: 0.8;
}

.data-table tbody tr:last-child td {
    border-bottom: none;
}

.role-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.role-admin {
    background-color: #e74c3c;
    color: white;
}

.role-manager {
    background-color: #f39c12;
    color: white;
}

.role-user {
    background-color: #3498db;
    color: white;
}

.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
}

.status-active {
    background-color: #27ae60;
    color: white;
}

.status-inactive {
    background-color: #95a5a6;
    color: white;
}

.action-buttons {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background-color: #3498db;
    color: white;
}

.btn-primary:hover {
    background-color: #2980b9;
}

.btn-secondary {
    background-color: #95a5a6;
    color: white;
}

.btn-secondary:hover {
    background-color: #7f8c8d;
}

.btn-danger {
    background-color: #e74c3c;
    color: white;
}

.btn-danger:hover {
    background-color: #c0392b;
}

.btn-info {
    background-color: #17a2b8;
    color: white;
}

.btn-info:hover {
    background-color: #138496;
}

.btn-warning {
    background-color: #ffc107;
    color: #212529;
}

.btn-warning:hover {
    background-color: #e0a800;
}

.btn-success {
    background-color: #28a745;
    color: white;
}

.btn-success:hover {
    background-color: #218838;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
    padding: 20px;
    background: #f8f9fa;
}

.page-info {
    font-size: 14px;
    color: #555;
}

.no-data {
    text-align: center;
    padding: 60px 20px;
    color: #7f8c8d;
}

.no-data-icon {
    font-size: 64px;
    margin-bottom: 20px;
}

.no-data h3 {
    color: #34495e;
    margin-bottom: 10px;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 0;
    border: 1px solid #888;
    width: 90%;
    max-width: 600px;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.modal-header {
    padding: 20px;
    background: #34495e;
    color: white;
    border-radius: 10px 10px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 18px;
}

.close {
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.close:hover,
.close:focus {
    color: #ecf0f1;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 15px 20px;
    background: #f8f9fa;
    border-top: 1px solid #ddd;
    border-radius: 0 0 10px 10px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #2c3e50;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
    transition: border-color 0.2s;
    box-sizing: border-box;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #3498db;
}

.form-help {
    display: block;
    margin-top: 5px;
    font-size: 12px;
    color: #7f8c8d;
}

.error-message {
    color: #e74c3c;
    font-size: 12px;
    margin-top: 5px;
    display: none;
}

.error-message.show {
    display: block;
}

.permissions-table-wrapper {
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 8px;
}

.permissions-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
}

.permissions-table thead {
    position: sticky;
    top: 0;
    background: #34495e;
    z-index: 10;
}

.permissions-table th {
    padding: 12px 15px;
    text-align: left;
    font-weight: 600;
    color: white;
    border-bottom: 2px solid #2c3e50;
}

.permissions-table tbody tr {
    border-bottom: 1px solid #ecf0f1;
    transition: background-color 0.2s;
}

.permissions-table tbody tr:hover {
    background-color: #f8f9fa;
}

.permissions-table tbody tr:last-child {
    border-bottom: none;
}

.permissions-table td {
    padding: 12px 15px;
    vertical-align: middle;
}

.permissions-table td:first-child {
    font-weight: 500;
    color: #2c3e50;
}

.permissions-table td:last-child {
    text-align: center;
}

.permissions-table input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: #3498db;
}
</style>

<script>
// Toggle password field
function togglePasswordField() {
    const autoGen = document.getElementById('auto_generate_password').checked;
    const passwordGroup = document.getElementById('password-group');
    const passwordInput = document.getElementById('password');
    
    if (autoGen) {
        passwordGroup.style.display = 'none';
        passwordInput.removeAttribute('required');
    } else {
        passwordGroup.style.display = 'block';
        passwordInput.setAttribute('required', 'required');
    }
}

function toggleResetPasswordField() {
    const autoGen = document.getElementById('reset_auto_generate').checked;
    const passwordGroup = document.getElementById('reset-password-group');
    const passwordInput = document.getElementById('reset_new_password');
    
    if (autoGen) {
        passwordGroup.style.display = 'none';
        passwordInput.removeAttribute('required');
    } else {
        passwordGroup.style.display = 'block';
        passwordInput.setAttribute('required', 'required');
    }
}

// Modal functions - Add Account
function openAddAccountModal() {
    document.getElementById('addAccountModal').style.display = 'block';
    document.getElementById('addAccountForm').reset();
    document.getElementById('password-group').style.display = 'block';
    document.getElementById('password').setAttribute('required', 'required');
    document.querySelectorAll('.error-message').forEach(el => {
        el.classList.remove('show');
        el.textContent = '';
    });
}

function closeAddAccountModal() {
    document.getElementById('addAccountModal').style.display = 'none';
}

// Modal functions - Edit Account
function openEditModal(id, username, fullName, email, phone, role, status) {
    document.getElementById('editAccountModal').style.display = 'block';
    document.getElementById('edit_account_id').value = id;
    document.getElementById('edit_username').value = username;
    document.getElementById('edit_full_name').value = fullName || '';
    document.getElementById('edit_email').value = email || '';
    document.getElementById('edit_phone').value = phone || '';
    document.getElementById('edit_role').value = role;
    document.getElementById('edit_status').value = status;
    document.querySelectorAll('.error-message').forEach(el => {
        el.classList.remove('show');
        el.textContent = '';
    });
}

function closeEditModal() {
    document.getElementById('editAccountModal').style.display = 'none';
}

// Modal functions - Reset Password
function openResetPasswordModal(id, username) {
    document.getElementById('resetPasswordModal').style.display = 'block';
    document.getElementById('reset_account_id').value = id;
    document.getElementById('reset_username').value = username;
    document.getElementById('resetPasswordForm').reset();
    document.getElementById('reset-password-group').style.display = 'block';
    document.getElementById('reset_new_password').setAttribute('required', 'required');
    document.querySelectorAll('.error-message').forEach(el => {
        el.classList.remove('show');
        el.textContent = '';
    });
}

function closeResetPasswordModal() {
    document.getElementById('resetPasswordModal').style.display = 'none';
}

// Validate password
function validatePassword(password) {
    const errors = [];
    
    if (password.length < 8) {
        errors.push('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±');
    }
    
    if (!/[A-Z]/.test(password)) {
        errors.push('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 1 ch·ªØ in hoa (A-Z)');
    }
    
    if (!/[a-z]/.test(password)) {
        errors.push('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 1 ch·ªØ th∆∞·ªùng (a-z)');
    }
    
    if (!/[0-9]/.test(password)) {
        errors.push('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 1 ch·ªØ s·ªë (0-9)');
    }
    
    return errors;
}

// Form handlers
document.getElementById('addAccountForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    document.querySelectorAll('.error-message').forEach(el => {
        el.classList.remove('show');
        el.textContent = '';
    });
    
    const formData = new FormData();
    formData.append('username', document.getElementById('username').value.trim());
    formData.append('full_name', document.getElementById('full_name').value.trim());
    formData.append('email', document.getElementById('email').value.trim());
    formData.append('phone', document.getElementById('phone').value.trim());
    formData.append('role', document.getElementById('role').value);
    formData.append('status', document.getElementById('status').value);
    
    const autoGen = document.getElementById('auto_generate_password').checked;
    formData.append('auto_generate_password', autoGen ? 'true' : 'false');
    
    if (!autoGen) {
        const password = document.getElementById('password').value;
        if (!password) {
            document.getElementById('password-error').textContent = 'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u';
            document.getElementById('password-error').classList.add('show');
            return;
        }
        const passwordErrors = validatePassword(password);
        if (passwordErrors.length > 0) {
            document.getElementById('password-error').textContent = passwordErrors[0];
            document.getElementById('password-error').classList.add('show');
            return;
        }
        formData.append('password', password);
    }
    
    try {
        const response = await fetch('/accounts/add', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (result.data && result.data.password) {
                alert(`T√†i kho·∫£n ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!\n\nUsername: ${result.data.username}\nPassword: ${result.data.password}\n\nVui l√≤ng l∆∞u l·∫°i th√¥ng tin n√†y!`);
            } else {
                alert(result.message);
            }
            closeAddAccountModal();
            location.reload();
        } else {
            if (result.message.includes('username') || result.message.includes('Username')) {
                document.getElementById('username-error').textContent = result.message;
                document.getElementById('username-error').classList.add('show');
            } else if (result.message.includes('password') || result.message.includes('M·∫≠t kh·∫©u')) {
                document.getElementById('password-error').textContent = result.message;
                document.getElementById('password-error').classList.add('show');
            } else {
                alert(result.message);
            }
        }
    } catch (error) {
        alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
    }
});

document.getElementById('editAccountForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    document.querySelectorAll('.error-message').forEach(el => {
        el.classList.remove('show');
        el.textContent = '';
    });
    
    const accountId = document.getElementById('edit_account_id').value;
    const formData = new FormData();
    formData.append('full_name', document.getElementById('edit_full_name').value.trim());
    formData.append('email', document.getElementById('edit_email').value.trim());
    formData.append('phone', document.getElementById('edit_phone').value.trim());
    formData.append('role', document.getElementById('edit_role').value);
    formData.append('status', document.getElementById('edit_status').value);
    
    try {
        const response = await fetch(`/accounts/update/${accountId}`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            closeEditModal();
            location.reload();
        } else {
            alert(result.message);
        }
    } catch (error) {
        alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
    }
});

document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    document.querySelectorAll('.error-message').forEach(el => {
        el.classList.remove('show');
        el.textContent = '';
    });
    
    const accountId = document.getElementById('reset_account_id').value;
    const formData = new FormData();
    
    const autoGen = document.getElementById('reset_auto_generate').checked;
    formData.append('auto_generate', autoGen ? 'true' : 'false');
    
    if (!autoGen) {
        const password = document.getElementById('reset_new_password').value;
        if (!password) {
            document.getElementById('reset-password-error').textContent = 'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u m·ªõi';
            document.getElementById('reset-password-error').classList.add('show');
            return;
        }
        const passwordErrors = validatePassword(password);
        if (passwordErrors.length > 0) {
            document.getElementById('reset-password-error').textContent = passwordErrors[0];
            document.getElementById('reset-password-error').classList.add('show');
            return;
        }
        formData.append('new_password', password);
    }
    
    try {
        const response = await fetch(`/accounts/reset-password/${accountId}`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (result.data && result.data.password) {
                alert(`M·∫≠t kh·∫©u ƒë√£ ƒë∆∞·ª£c ƒë·ªïi th√†nh c√¥ng!\n\nPassword m·ªõi: ${result.data.password}\n\nVui l√≤ng l∆∞u l·∫°i th√¥ng tin n√†y!`);
            } else {
                alert(result.message);
            }
            closeResetPasswordModal();
            location.reload();
        } else {
            alert(result.message);
        }
    } catch (error) {
        alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
    }
});

// Account actions
async function lockAccount(accountId, username) {
    if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën kho√° t√†i kho·∫£n "${username}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/accounts/lock/${accountId}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            location.reload();
        } else {
            alert(result.message);
        }
    } catch (error) {
        alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
    }
}

async function unlockAccount(accountId, username) {
    if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën m·ªü kho√° t√†i kho·∫£n "${username}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/accounts/unlock/${accountId}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            location.reload();
        } else {
            alert(result.message);
        }
    } catch (error) {
        alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
    }
}

async function deleteAccount(accountId, username) {
    if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n "${username}"?\n\nL∆∞u √Ω: T√†i kho·∫£n s·∫Ω b·ªã v√¥ hi·ªáu h√≥a (soft delete).`)) {
        return;
    }
    
    try {
        const response = await fetch(`/accounts/delete/${accountId}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            location.reload();
        } else {
            alert(result.message);
        }
    } catch (error) {
        alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
    }
}

// Permission Management Functions
let currentPermissionAccountId = null;
let originalPermissions = null; // L∆∞u tr·∫°ng th√°i ban ƒë·∫ßu ƒë·ªÉ h·ªßy

function openPermissionsModal(accountId, username) {
    currentPermissionAccountId = accountId;
    originalPermissions = null; // Reset
    document.getElementById('permissionsModal').style.display = 'block';
    document.getElementById('perm_username').value = username;
    document.getElementById('permissions-loading').style.display = 'block';
    document.getElementById('permissions-content').style.display = 'none';
    document.getElementById('permissions-admin-notice').style.display = 'none';
    document.getElementById('save-permissions-btn').style.display = 'block';
    
    // Load permissions
    loadUserPermissions(accountId);
}

function closePermissionsModal() {
    document.getElementById('permissionsModal').style.display = 'none';
    currentPermissionAccountId = null;
}

async function loadUserPermissions(accountId) {
    try {
        const response = await fetch(`/accounts/${accountId}/permissions`);
        const result = await response.json();
        
        document.getElementById('permissions-loading').style.display = 'none';
        
        if (result.success) {
            if (result.data.is_admin) {
                document.getElementById('permissions-admin-notice').style.display = 'block';
                document.getElementById('permissions-content').style.display = 'none';
                document.getElementById('save-permissions-btn').style.display = 'none';
            } else {
                document.getElementById('permissions-content').style.display = 'block';
                renderPermissionsCheckboxes(result.data.permissions);
            }
        } else {
            alert('L·ªói khi t·∫£i permissions: ' + result.message);
        }
    } catch (error) {
        document.getElementById('permissions-loading').style.display = 'none';
        alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
    }
}

function renderPermissionsCheckboxes(permissions) {
    const container = document.getElementById('permissions-checkboxes');
    container.innerHTML = '';
    
    if (permissions.length === 0) {
        container.innerHTML = '<tr><td colspan="2" style="text-align: center; padding: 20px;">Kh√¥ng c√≥ permissions n√†o ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a.</td></tr>';
        return;
    }
    
    // L∆∞u tr·∫°ng th√°i ban ƒë·∫ßu ƒë·ªÉ c√≥ th·ªÉ h·ªßy
    originalPermissions = permissions.map(p => ({
        id: p.id,
        has_permission: p.has_permission
    }));
    
    // S·∫Øp x·∫øp permissions theo t√™n page
    const sortedPermissions = [...permissions].sort((a, b) => {
        const nameA = (a.description || a.name || '').toLowerCase();
        const nameB = (b.description || b.name || '').toLowerCase();
        return nameA.localeCompare(nameB);
    });
    
    // Render d·∫°ng b·∫£ng
    sortedPermissions.forEach(perm => {
        const row = document.createElement('tr');
        
        // C·ªôt Page
        const pageCell = document.createElement('td');
        const pageName = document.createElement('span');
        pageName.textContent = perm.description || perm.name;
        pageName.style.fontWeight = '500';
        pageName.style.color = '#2c3e50';
        pageCell.appendChild(pageName);
        
        const pagePath = document.createElement('span');
        pagePath.textContent = ` (${perm.page_path})`;
        pagePath.style.color = '#7f8c8d';
        pagePath.style.fontSize = '12px';
        pageCell.appendChild(pagePath);
        
        // C·ªôt Truy c·∫≠p
        const accessCell = document.createElement('td');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `perm_${perm.id}`;
        checkbox.value = perm.id;
        // M·∫∑c ƒë·ªãnh: n·∫øu user ch∆∞a c√≥ permission n√†o, t·∫•t c·∫£ ƒë·ªÅu ƒë∆∞·ª£c tick
        // N·∫øu user ƒë√£ c√≥ permissions, d√πng gi√° tr·ªã t·ª´ database
        checkbox.checked = perm.has_permission !== false; // M·∫∑c ƒë·ªãnh true n·∫øu undefined/null
        checkbox.setAttribute('data-permission-id', perm.id);
        
        accessCell.appendChild(checkbox);
        accessCell.style.textAlign = 'center';
        
        row.appendChild(pageCell);
        row.appendChild(accessCell);
        container.appendChild(row);
    });
}

function cancelPermissionsChanges() {
    if (!originalPermissions) {
        closePermissionsModal();
        return;
    }
    
    // Kh√¥i ph·ª•c tr·∫°ng th√°i ban ƒë·∫ßu
    originalPermissions.forEach(origPerm => {
        const checkbox = document.getElementById(`perm_${origPerm.id}`);
        if (checkbox) {
            checkbox.checked = origPerm.has_permission !== false;
        }
    });
    
    // ƒê√≥ng modal
    closePermissionsModal();
}

async function savePermissions() {
    if (!currentPermissionAccountId) {
        alert('Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n');
        return;
    }
    
    // L·∫•y t·∫•t c·∫£ c√°c checkbox (c·∫£ checked v√† unchecked)
    const allCheckboxes = document.querySelectorAll('#permissions-checkboxes input[type="checkbox"]');
    const checkedCheckboxes = document.querySelectorAll('#permissions-checkboxes input[type="checkbox"]:checked');
    
    // L·∫•y danh s√°ch permission IDs ƒë∆∞·ª£c ch·ªçn
    const permissionIds = Array.from(checkedCheckboxes).map(cb => {
        const value = cb.value;
        const parsed = parseInt(value);
        if (isNaN(parsed)) {
            console.error('Invalid permission ID:', value);
            return null;
        }
        return parsed;
    }).filter(id => id !== null);
    
    console.log('Saving permissions for user:', currentPermissionAccountId);
    console.log('Selected permission IDs:', permissionIds);
    console.log('Total checkboxes:', allCheckboxes.length);
    console.log('Checked checkboxes:', checkedCheckboxes.length);
    
    // Disable button ƒë·ªÉ tr√°nh double submit
    const saveBtn = document.getElementById('save-permissions-btn');
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang l∆∞u...';
    
    try {
        const response = await fetch(`/accounts/${currentPermissionAccountId}/permissions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                permission_ids: permissionIds
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            const message = result.message || 'ƒê√£ c·∫≠p nh·∫≠t permissions th√†nh c√¥ng';
            if (result.data) {
                console.log('Permissions updated:', {
                    deleted: result.data.deleted_count,
                    added: result.data.added_count,
                    total: result.data.total_permissions
                });
            }
            alert(message);
            closePermissionsModal();
            // Reload trang ƒë·ªÉ ƒë·∫£m b·∫£o d·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t
            setTimeout(() => {
                location.reload();
            }, 500);
        } else {
            alert('L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t permissions'));
            console.error('Error response:', result);
        }
    } catch (error) {
        console.error('Error saving permissions:', error);
        alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
    } finally {
        // Restore button
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
    }
}

// Close modals when clicking outside
window.onclick = function(event) {
    const modals = ['addAccountModal', 'editAccountModal', 'resetPasswordModal', 'permissionsModal'];
    modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (event.target == modal) {
            if (modalId === 'addAccountModal') closeAddAccountModal();
            if (modalId === 'editAccountModal') closeEditModal();
            if (modalId === 'resetPasswordModal') closeResetPasswordModal();
            if (modalId === 'permissionsModal') closePermissionsModal();
        }
    });
}
</script>
</div>
{% endblock %}
