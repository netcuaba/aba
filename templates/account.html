{% extends "base.html" %}

{% block title %}Qu·∫£n l√Ω t√†i kho·∫£n - H·ªá th·ªëng qu·∫£n l√Ω v·∫≠n chuy·ªÉn{% endblock %}

{% block content %}
<div class="page-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h2>üë§ Qu·∫£n l√Ω t√†i kho·∫£n</h2>
            <p>Qu·∫£n l√Ω t√†i kho·∫£n ng∆∞·ªùi d√πng trong h·ªá th·ªëng (Ch·ªâ d√†nh cho Admin)</p>
        </div>
        <button type="button" class="btn btn-primary btn-lg" onclick="openAddAccountModal()">
            <i class="fas fa-user-plus"></i> Th√™m t√†i kho·∫£n
        </button>
    </div>
</div>

<!-- Danh s√°ch t√†i kho·∫£n -->
<div class="table-section">
    {% if accounts %}
    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Username</th>
                    <th>Password</th>
                    <th>Ph√¢n quy·ªÅn (Role)</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody>
                {% for account in accounts %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td><strong>{{ account.username }}</strong></td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="password-display" id="password-{{ account.id }}" data-password="{{ account.password }}">
                                ********
                            </span>
                            <button type="button" class="btn-icon" onclick="togglePassword({{ account.id }})" title="Hi·ªÉn th·ªã/·∫®n m·∫≠t kh·∫©u">
                                <i class="fas fa-eye" id="eye-icon-{{ account.id }}"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <span class="role-badge role-{{ account.role.lower() }}">
                            {{ account.role }}
                        </span>
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-danger" onclick="deleteAccount({{ account.id }}, '{{ account.username }}')">
                            <i class="fas fa-trash"></i> X√≥a
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="no-data">
        <div class="no-data-icon">üë§</div>
        <h3>Ch∆∞a c√≥ t√†i kho·∫£n n√†o</h3>
        <p>H√£y th√™m t√†i kho·∫£n ƒë·∫ßu ti√™n b·∫±ng n√∫t "Th√™m t√†i kho·∫£n" b√™n tr√™n</p>
    </div>
    {% endif %}
</div>

<!-- Modal Th√™m t√†i kho·∫£n m·ªõi -->
<div id="addAccountModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user-plus"></i> Th√™m t√†i kho·∫£n m·ªõi</h3>
            <span class="close" onclick="closeAddAccountModal()">&times;</span>
        </div>
        <form id="addAccountForm">
            <div class="modal-body">
                <div class="form-group">
                    <label for="username">Username *</label>
                    <input type="text" id="username" name="username" required placeholder="Nh·∫≠p t√™n ƒëƒÉng nh·∫≠p">
                    <div class="error-message" id="username-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="password">Password *</label>
                    <input type="password" id="password" name="password" required placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
                    <small class="form-help">
                        M·∫≠t kh·∫©u ph·∫£i c√≥: √≠t nh·∫•t 8 k√Ω t·ª±, 1 ch·ªØ in hoa (A-Z), 1 ch·ªØ th∆∞·ªùng (a-z), 1 ch·ªØ s·ªë (0-9)
                    </small>
                    <div class="error-message" id="password-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="role">Ph√¢n quy·ªÅn (Role) *</label>
                    <select id="role" name="role" required>
                        <option value="">-- Ch·ªçn ph√¢n quy·ªÅn --</option>
                        <option value="Admin">Admin</option>
                        <option value="User">User</option>
                        <option value="Guest">Guest</option>
                    </select>
                    <div class="error-message" id="role-error"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAddAccountModal()">H·ªßy</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> L∆∞u
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.page-header {
    margin-bottom: 30px;
}

.page-header h2 {
    color: #2c3e50;
    margin-bottom: 10px;
}

.page-header p {
    color: #7f8c8d;
    margin: 0;
}

.btn-lg {
    padding: 12px 24px;
    font-size: 16px;
    border-radius: 8px;
}

.table-section {
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th {
    background: #34495e;
    color: white;
    padding: 15px 12px;
    text-align: left;
    font-weight: 600;
    border: none;
}

.data-table td {
    padding: 12px;
    border-bottom: 1px solid #ecf0f1;
    vertical-align: middle;
}

.data-table tbody tr:hover {
    background-color: #f8f9fa;
}

.data-table tbody tr:last-child td {
    border-bottom: none;
}

.password-display {
    font-family: monospace;
    font-size: 14px;
    color: #333;
    min-width: 100px;
    display: inline-block;
}

.btn-icon {
    background: none;
    border: none;
    cursor: pointer;
    color: #3498db;
    padding: 4px 8px;
    font-size: 16px;
    transition: color 0.2s;
}

.btn-icon:hover {
    color: #2980b9;
}

.role-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.role-admin {
    background-color: #e74c3c;
    color: white;
}

.role-user {
    background-color: #3498db;
    color: white;
}

.role-guest {
    background-color: #95a5a6;
    color: white;
}

.no-data {
    text-align: center;
    padding: 60px 20px;
    color: #7f8c8d;
}

.no-data-icon {
    font-size: 64px;
    margin-bottom: 20px;
}

.no-data h3 {
    color: #34495e;
    margin-bottom: 10px;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 0;
    border: 1px solid #888;
    width: 90%;
    max-width: 500px;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.modal-header {
    padding: 20px;
    background: #34495e;
    color: white;
    border-radius: 10px 10px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 18px;
}

.close {
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.close:hover,
.close:focus {
    color: #ecf0f1;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 15px 20px;
    background: #f8f9fa;
    border-top: 1px solid #ddd;
    border-radius: 0 0 10px 10px;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #2c3e50;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
    transition: border-color 0.2s;
}

.form-group input:focus,
.form-group select:focus {
    outline: none;
    border-color: #3498db;
}

.form-help {
    display: block;
    margin-top: 5px;
    font-size: 12px;
    color: #7f8c8d;
}

.error-message {
    color: #e74c3c;
    font-size: 12px;
    margin-top: 5px;
    display: none;
}

.error-message.show {
    display: block;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s;
    text-decoration: none;
    display: inline-block;
}

.btn-primary {
    background-color: #3498db;
    color: white;
}

.btn-primary:hover {
    background-color: #2980b9;
}

.btn-secondary {
    background-color: #95a5a6;
    color: white;
}

.btn-secondary:hover {
    background-color: #7f8c8d;
}

.btn-danger {
    background-color: #e74c3c;
    color: white;
}

.btn-danger:hover {
    background-color: #c0392b;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}
</style>

<script>
// Toggle hi·ªÉn th·ªã/·∫©n m·∫≠t kh·∫©u
function togglePassword(accountId) {
    const passwordDisplay = document.getElementById(`password-${accountId}`);
    const eyeIcon = document.getElementById(`eye-icon-${accountId}`);
    const actualPassword = passwordDisplay.getAttribute('data-password');
    
    if (passwordDisplay.textContent === '********') {
        // Hi·ªÉn th·ªã m·∫≠t kh·∫©u
        passwordDisplay.textContent = actualPassword;
        eyeIcon.classList.remove('fa-eye');
        eyeIcon.classList.add('fa-eye-slash');
    } else {
        // ·∫®n m·∫≠t kh·∫©u
        passwordDisplay.textContent = '********';
        eyeIcon.classList.remove('fa-eye-slash');
        eyeIcon.classList.add('fa-eye');
    }
}

// M·ªü modal th√™m t√†i kho·∫£n
function openAddAccountModal() {
    document.getElementById('addAccountModal').style.display = 'block';
    // Reset form
    document.getElementById('addAccountForm').reset();
    // Clear errors
    document.querySelectorAll('.error-message').forEach(el => {
        el.classList.remove('show');
        el.textContent = '';
    });
}

// ƒê√≥ng modal th√™m t√†i kho·∫£n
function closeAddAccountModal() {
    document.getElementById('addAccountModal').style.display = 'none';
}

// Validate password policy
function validatePassword(password) {
    const errors = [];
    
    if (password.length < 8) {
        errors.push('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 8 k√Ω t·ª±');
    }
    
    if (!/[A-Z]/.test(password)) {
        errors.push('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 1 ch·ªØ in hoa (A-Z)');
    }
    
    if (!/[a-z]/.test(password)) {
        errors.push('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 1 ch·ªØ th∆∞·ªùng (a-z)');
    }
    
    if (!/[0-9]/.test(password)) {
        errors.push('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 1 ch·ªØ s·ªë (0-9)');
    }
    
    return errors;
}

// X·ª≠ l√Ω submit form th√™m t√†i kho·∫£n
document.getElementById('addAccountForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Clear previous errors
    document.querySelectorAll('.error-message').forEach(el => {
        el.classList.remove('show');
        el.textContent = '';
    });
    
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const role = document.getElementById('role').value;
    
    let hasError = false;
    
    // Validate username
    if (!username) {
        const errorEl = document.getElementById('username-error');
        errorEl.textContent = 'Vui l√≤ng nh·∫≠p username';
        errorEl.classList.add('show');
        hasError = true;
    }
    
    // Validate password
    if (!password) {
        const errorEl = document.getElementById('password-error');
        errorEl.textContent = 'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u';
        errorEl.classList.add('show');
        hasError = true;
    } else {
        const passwordErrors = validatePassword(password);
        if (passwordErrors.length > 0) {
            const errorEl = document.getElementById('password-error');
            errorEl.textContent = passwordErrors[0];
            errorEl.classList.add('show');
            hasError = true;
        }
    }
    
    // Validate role
    if (!role) {
        const errorEl = document.getElementById('role-error');
        errorEl.textContent = 'Vui l√≤ng ch·ªçn ph√¢n quy·ªÅn';
        errorEl.classList.add('show');
        hasError = true;
    }
    
    if (hasError) {
        return;
    }
    
    // Submit form
    try {
        const formData = new FormData();
        formData.append('username', username);
        formData.append('password', password);
        formData.append('role', role);
        
        const response = await fetch('/accounts/add', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            closeAddAccountModal();
            location.reload();
        } else {
            // Hi·ªÉn th·ªã l·ªói t·ª´ server
            if (result.message.includes('username') || result.message.includes('Username')) {
                const errorEl = document.getElementById('username-error');
                errorEl.textContent = result.message;
                errorEl.classList.add('show');
            } else if (result.message.includes('password') || result.message.includes('M·∫≠t kh·∫©u')) {
                const errorEl = document.getElementById('password-error');
                errorEl.textContent = result.message;
                errorEl.classList.add('show');
            } else {
                alert(result.message);
            }
        }
    } catch (error) {
        alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
    }
});

// X√≥a t√†i kho·∫£n
async function deleteAccount(accountId, username) {
    if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n "${username}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/accounts/delete/${accountId}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            location.reload();
        } else {
            alert(result.message);
        }
    } catch (error) {
        alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
    }
}

// ƒê√≥ng modal khi click b√™n ngo√†i
window.onclick = function(event) {
    const modal = document.getElementById('addAccountModal');
    if (event.target == modal) {
        closeAddAccountModal();
    }
}
</script>
{% endblock %}

