{% extends "base.html" %}

{% block title %}Qu·∫£n l√Ω doanh thu - H·ªá th·ªëng qu·∫£n l√Ω v·∫≠n chuy·ªÉn{% endblock %}

{% block content %}
<h2>üí∞ Qu·∫£n l√Ω doanh thu</h2>

<!-- Date Selector -->
<div style="margin-bottom: 30px; padding: 15px; background: rgba(52, 152, 219, 0.1); border-radius: 8px;">
    <form method="get" action="/revenue" style="display: inline-block;">
        <label for="selected_date" style="color: #2c3e50; margin-right: 10px; font-weight: bold;">Ch·ªçn ng√†y:</label>
        <input type="date" 
               id="selected_date" 
               name="selected_date" 
               value="{{ filter_date.strftime('%Y-%m-%d') }}" 
               style="padding: 8px; border: 2px solid #3498db; border-radius: 5px; font-size: 14px;"
               onchange="this.form.submit()">
        <button type="submit" style="margin-left: 10px; padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
            üîç Xem
        </button>
    </form>
    <div style="margin-top: 10px; color: #7f8c8d; font-size: 12px;">
        Hi·ªÉn th·ªã doanh thu ng√†y: <strong>{{ filter_date.strftime('%d/%m/%Y') }}</strong>
        {% if filter_date == today %}
            (H√¥m nay)
        {% endif %}
    </div>
</div>

<!-- Form nh·∫≠p doanh thu -->
<div style="background: rgba(243, 156, 18, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 30px;">
    <h3 style="color: #f39c12; margin-bottom: 15px;">üìù Nh·∫≠p Doanh Thu Theo M√£ Tuy·∫øn</h3>
    
    <form method="post" action="/revenue/add" id="revenue-form">
        <input type="hidden" name="date" value="{{ filter_date.strftime('%Y-%m-%d') }}">
        
        {% if routes %}
        <div class="table-container">
            <table class="table" style="background: white; margin-bottom: 0;">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>M√£ tuy·∫øn</th>
                        <th>Kho·∫£ng c√°ch (km)</th>
                        <th>ƒê∆°n gi√° (VNƒê/km)</th>
                        <th>Ph√≠ c·∫ßu ƒë∆∞·ªùng (VNƒê)</th>
                        <th>Ph√≠ d·ª´ng t·∫£i (VNƒê)</th>
                        <th>Tr·ªÖ Ontime (VNƒê)</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Th√†nh ti·ªÅn (VNƒê)</th>
                        <th>Ghi ch√∫</th>
                    </tr>
                </thead>
                <tbody>
                    {% for route in routes %}
                    {% set existing_records = revenue_dict.get(route.id) %}
                    {% if existing_records is iterable and existing_records is not string %}
                        {# V·ªõi "TƒÉng c∆∞·ªùng", l·∫•y record cu·ªëi c√πng ƒë·ªÉ hi·ªÉn th·ªã gi√° tr·ªã m·∫∑c ƒë·ªãnh #}
                        {% set existing_record = existing_records[-1] if existing_records else None %}
                    {% else %}
                        {# V·ªõi tuy·∫øn th∆∞·ªùng #}
                        {% set existing_record = existing_records %}
                    {% endif %}
                    <tr>
                        <td style="text-align: center; font-weight: bold;">{{ loop.index }}</td>
                        <td style="white-space: nowrap;">
                            <strong>{{ route.route_code }}</strong>
                        </td>
                        <td>
                            <input type="number" 
                                   name="distance_km_{{ route.id }}" 
                                   step="0.1" 
                                   min="0"
                                   value="{{ existing_record.distance_km if existing_record else (default_values.get(route.id, {}).get('distance_km') if default_values.get(route.id) else (route.distance if route.distance else '')) }}"
                                   placeholder="{{ route.distance if route.distance else '0' }}"
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;"
                                   onchange="calculateTotal({{ route.id }})">
                        </td>
                        <td>
                            <input type="number" 
                                   name="unit_price_{{ route.id }}" 
                                   min="0"
                                   value="{{ existing_record.unit_price if existing_record and existing_record.unit_price else (default_values.get(route.id, {}).get('unit_price') if default_values.get(route.id) else '') }}"
                                   placeholder="0"
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;"
                                   onchange="calculateTotal({{ route.id }})">
                        </td>
                        <td>
                            <input type="number" 
                                   name="bridge_fee_{{ route.id }}" 
                                   min="0"
                                   value="{{ existing_record.bridge_fee if existing_record and existing_record.bridge_fee else (default_values.get(route.id, {}).get('bridge_fee') if default_values.get(route.id) else '') }}"
                                   placeholder="0"
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;"
                                   onchange="calculateTotal({{ route.id }})">
                        </td>
                        <td>
                            <input type="number" 
                                   name="loading_fee_{{ route.id }}" 
                                   min="0"
                                   value="{{ existing_record.loading_fee if existing_record and existing_record.loading_fee else (default_values.get(route.id, {}).get('loading_fee') if default_values.get(route.id) else '') }}"
                                   placeholder="0"
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;"
                                   onchange="calculateTotal({{ route.id }})">
                        </td>
                        <td>
                            <input type="number" 
                                   name="late_penalty_{{ route.id }}" 
                                   min="0"
                                   value="{{ existing_record.late_penalty if existing_record and existing_record.late_penalty else (default_values.get(route.id, {}).get('late_penalty') if default_values.get(route.id) else '') }}"
                                   placeholder="0"
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;"
                                   onchange="calculateTotal({{ route.id }})">
                        </td>
                        <td>
                            <select name="status_{{ route.id }}" 
                                    style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;"
                                    onchange="toggleFieldsBasedOnStatus({{ route.id }})">
                                {% set default_status = default_values.get(route.id, {}).get('status') if default_values.get(route.id) else 'Online' %}
                                <option value="Online" {{ 'selected' if (not existing_record and default_status == 'Online') or (existing_record and existing_record.status == 'Online') else '' }}>Online</option>
                                <option value="Offline" {{ 'selected' if (not existing_record and default_status == 'Offline') or (existing_record and existing_record.status == 'Offline') else '' }}>Offline</option>
                            </select>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <!-- Th√†nh ti·ªÅn t·ª± ƒë·ªông t√≠nh -->
                                <span id="total_{{ route.id }}" style="font-weight: bold; color: #27ae60; font-size: 12px;">
                                    {% if existing_record and existing_record.manual_total > 0 %}
                                        {{ "{:,.0f}".format(existing_record.manual_total) }}
                                    {% elif existing_record %}
                                        {{ "{:,.0f}".format(existing_record.total_amount) }}
                                    {% else %}
                                        0
                                    {% endif %}
                                </span>
                                <!-- Tr∆∞·ªùng nh·∫≠p th√†nh ti·ªÅn th·ªß c√¥ng -->
                                <input type="number" 
                                       name="manual_total_{{ route.id }}" 
                                       min="0"
                                       value="{{ existing_record.manual_total if existing_record and existing_record.manual_total > 0 else '' }}"
                                       placeholder="Nh·∫≠p th·ªß c√¥ng"
                                       style="width: 100%; padding: 3px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px;"
                                       onchange="handleManualTotal({{ route.id }})">
                            </div>
                        </td>
                        <td>
                            <input type="text" 
                                   name="notes_{{ route.id }}" 
                                   value="{{ existing_record.notes if existing_record else (default_values.get(route.id, {}).get('notes') if default_values.get(route.id) else '') }}"
                                   placeholder="Ghi ch√∫..."
                                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div style="text-align: center;">
            <button type="submit" class="btn btn-success" style="padding: 10px 30px; font-size: 16px;">
                üíæ L∆∞u doanh thu
            </button>
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px; background: rgba(39, 174, 96, 0.1); border-radius: 10px; border-left: 4px solid #27ae60;">
            <h4 style="color: #27ae60; margin-bottom: 10px;">‚úÖ Ho√†n th√†nh nh·∫≠p doanh thu!</h4>
            <p style="color: #2c3e50; margin: 0;">
                T·∫•t c·∫£ tuy·∫øn ƒë√£ ƒë∆∞·ª£c nh·∫≠p doanh thu cho ng√†y {{ filter_date.strftime('%d/%m/%Y') }}.<br>
                B·∫°n c√≥ th·ªÉ xem danh s√°ch doanh thu ƒë√£ ghi nh·∫≠n b√™n d∆∞·ªõi.
            </p>
        </div>
        {% endif %}
    </form>
</div>

<!-- Doanh thu ƒë√£ ghi nh·∫≠n -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <h3 style="margin: 0;">üìä Doanh thu ƒë√£ ghi nh·∫≠n</h3>
    {% if revenue_dict %}
    <button onclick="deleteAllRevenue()" 
            class="btn btn-danger" 
            style="background: #e74c3c; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.2s;"
            onmouseover="this.style.background='#c0392b'; this.style.transform='scale(1.05)'"
            onmouseout="this.style.background='#e74c3c'; this.style.transform='scale(1)'"
            title="X√≥a t·∫•t c·∫£ doanh thu trong ng√†y">
        üóëÔ∏è Xo√° t·∫•t c·∫£
    </button>
    {% endif %}
</div>

<!-- Success message for delete all -->
{% if deleted_all == 'true' %}
<div style="background: rgba(39, 174, 96, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #27ae60;">
    <p style="margin: 0; color: #27ae60; font-weight: bold;">
        ‚úÖ ƒê√£ xo√° t·∫•t c·∫£ doanh thu trong ng√†y {{ filter_date.strftime('%d/%m/%Y') }}
    </p>
</div>
{% endif %}

{% if revenue_dict %}
<div style="background: rgba(39, 174, 96, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
    <p style="margin: 0; color: #27ae60; font-weight: bold;">
        ‚úÖ ƒê√£ ghi nh·∫≠n {{ revenue_dict|length }} tuy·∫øn doanh thu ng√†y {{ filter_date.strftime('%d/%m/%Y') }}
    </p>
</div>

<div class="table-container">
    <table class="table">
        <thead>
            <tr>
                <th>STT</th>
                <th>M√£ tuy·∫øn</th>
                <th>Kho·∫£ng c√°ch (km)</th>
                <th>ƒê∆°n gi√° (VNƒê/km)</th>
                <th>Ph√≠ c·∫ßu ƒë∆∞·ªùng (VNƒê)</th>
                <th>Ph√≠ d·ª´ng t·∫£i (VNƒê)</th>
                <th>Tr·ªÖ Ontime (VNƒê)</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Th√†nh ti·ªÅn (VNƒê)</th>
                <th>Ghi ch√∫</th>
                <th>Thao t√°c</th>
            </tr>
        </thead>
        <tbody>
            {% set revenue_list = [] %}
            {% for route in all_routes %}
                {% if revenue_dict.get(route.id) %}
                    {% set records = revenue_dict[route.id] %}
                    {% if records is iterable and records is not string %}
                        {# Nhi·ªÅu records cho "TƒÉng c∆∞·ªùng" #}
                        {% for record in records %}
                            {% set _ = revenue_list.append((route, record, loop.index)) %}
                        {% endfor %}
                    {% else %}
                        {# M·ªôt record cho tuy·∫øn th∆∞·ªùng #}
                        {% set _ = revenue_list.append((route, records, 1)) %}
                    {% endif %}
                {% endif %}
            {% endfor %}
            
            {% for route, record, tang_cuong_index in revenue_list %}
            <tr>
                <td style="text-align: center; font-weight: bold;">{{ loop.index }}</td>
                <td style="white-space: nowrap;">
                    {% if route.route_code and route.route_code.strip() == "TƒÉng C∆∞·ªùng" and tang_cuong_index > 1 %}
                        <strong>{{ route.route_code }} #{{ tang_cuong_index }}</strong>
                    {% else %}
                        <strong>{{ route.route_code }}</strong>
                    {% endif %}
                </td>
                <td class="number">{{ "{:,.1f}".format(record.distance_km) if record.distance_km else "-" }}</td>
                <td class="number">{{ "{:,.0f}".format(record.unit_price) if record.unit_price else "-" }}</td>
                <td class="number">{{ "{:,.0f}".format(record.bridge_fee) if record.bridge_fee else "-" }}</td>
                <td class="number">{{ "{:,.0f}".format(record.loading_fee) if record.loading_fee else "-" }}</td>
                <td class="number">{{ "{:,.0f}".format(record.late_penalty) if record.late_penalty else "-" }}</td>
                <td style="text-align: center;">
                    <span style="padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; 
                                 background-color: {{ '#d4edda' if record.status == 'Online' else '#f8d7da' }};
                                 color: {{ '#155724' if record.status == 'Online' else '#721c24' }};">
                        {{ record.status }}
                    </span>
                </td>
                <td class="number" style="font-weight: bold; color: #27ae60;">
                    {% if record.manual_total > 0 %}
                        {{ "{:,.0f}".format(record.manual_total) }}
                    {% else %}
                        {{ "{:,.0f}".format(record.total_amount) }}
                    {% endif %}
                </td>
                <td>{{ record.notes if record.notes else "Kh√¥ng c√≥" }}</td>
                <td>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <a href="/revenue/edit/{{ record.id }}" 
                           class="btn btn-sm" 
                           style="background: #3498db; color: white; padding: 3px 8px; font-size: 11px; text-decoration: none; border-radius: 3px; transition: all 0.2s;"
                           onmouseover="this.style.background='#2980b9'; this.style.transform='scale(1.05)'"
                           onmouseout="this.style.background='#3498db'; this.style.transform='scale(1)'"
                           title="S·ª≠a doanh thu">
                            ‚úèÔ∏è S·ª≠a
                        </a>
                        <button onclick="deleteRevenue({{ record.id }})" 
                                class="btn btn-sm btn-danger" 
                                style="padding: 3px 8px; font-size: 11px; border: none; border-radius: 3px; transition: all 0.2s;"
                                onmouseover="this.style.transform='scale(1.05)'"
                                onmouseout="this.style.transform='scale(1)'"
                                title="X√≥a doanh thu">
                            üóëÔ∏è X√≥a
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
            
        </tbody>
    </table>
</div>

<div style="margin-top: 20px; padding: 20px; background: rgba(39, 174, 96, 0.1); border-radius: 10px; border-left: 4px solid #27ae60;">
    <h4 style="color: #27ae60; margin-bottom: 10px;">üìä T·ªïng k·∫øt:</h4>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div>
            <strong>S·ªë tuy·∫øn:</strong> {{ revenue_dict|length }}
        </div>
        <div>
            <strong>T·ªïng doanh thu:</strong> 
            {% set revenue_amounts = [] %}
            {% for route, record, tang_cuong_index in revenue_list %}
                {% if record.manual_total > 0 %}
                    {% set _ = revenue_amounts.append(record.manual_total) %}
                {% else %}
                    {% set _ = revenue_amounts.append(record.total_amount) %}
                {% endif %}
            {% endfor %}
            {{ "{:,.0f}".format(revenue_amounts | sum) }} VNƒê
        </div>
        <div>
            <strong>Tr·∫°ng th√°i Online:</strong> {{ revenue_list|selectattr('1.status', 'equalto', 'Online')|list|length }}
        </div>
        <div>
            <strong>Tr·∫°ng th√°i Offline:</strong> {{ revenue_list|selectattr('1.status', 'equalto', 'Offline')|list|length }}
        </div>
    </div>
</div>
{% else %}
<div style="text-align: center; padding: 40px; color: #7f8c8d;">
    <h3>üìä Ch∆∞a c√≥ d·ªØ li·ªáu doanh thu ng√†y {{ filter_date.strftime('%d/%m/%Y') }}</h3>
    <p>H√£y nh·∫≠p d·ªØ li·ªáu doanh thu b·∫±ng form b√™n tr√™n</p>
</div>
{% endif %}

<!-- H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng - ƒê√£ ·∫©n -->
<div style="display: none; margin-top: 30px; padding: 20px; background: rgba(241, 196, 15, 0.1); border-radius: 10px; border-left: 4px solid #f1c40f;">
    <h4 style="color: #f39c12; margin-bottom: 10px;">üí° H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng:</h4>
    <ul style="color: #2c3e50; line-height: 1.6;">
        <li><strong>Ch·ªçn ng√†y:</strong> S·ª≠ d·ª•ng b·ªô ch·ªçn ng√†y ƒë·ªÉ xem/nh·∫≠p doanh thu cho ng√†y c·ª• th·ªÉ</li>
        <li><strong>T·ª± ƒë·ªông ƒëi·ªÅn:</strong> Khi t·∫°o b·∫£n ghi doanh thu cho ng√†y m·ªõi, h·ªá th·ªëng t·ª± ƒë·ªông ƒëi·ªÅn s·∫µn c√°c gi√° tr·ªã t·ª´ ng√†y g·∫ßn nh·∫•t c√≥ d·ªØ li·ªáu kh√°c 0</li>
        <li><strong>Kho·∫£ng c√°ch:</strong> L·∫•y gi√° tr·ªã m·∫∑c ƒë·ªãnh t·ª´ tuy·∫øn ƒë∆∞·ªùng ho·∫∑c ng√†y g·∫ßn nh·∫•t, c√≥ th·ªÉ ch·ªânh s·ª≠a khi thay ƒë·ªïi l·ªô tr√¨nh</li>
        <li><strong>ƒê∆°n gi√°:</strong> Nh·∫≠p ƒë∆°n gi√° VNƒê/km (s·ªë nguy√™n, kh√¥ng c·∫ßn l√†m tr√≤n ngh√¨n)</li>
        <li><strong>Ph√≠ c·∫ßu ƒë∆∞·ªùng:</strong> Nh·∫≠p ph√≠ c·∫ßu ƒë∆∞·ªùng (s·ªë nguy√™n)</li>
        <li><strong>Ph√≠ d·ª´ng t·∫£i:</strong> Nh·∫≠p ph√≠ d·ª´ng t·∫£i (s·ªë nguy√™n)</li>
        <li><strong>Tr·ªÖ Ontime:</strong> Nh·∫≠p ph√≠ ph·∫°t tr·ªÖ gi·ªù (s·ªë nguy√™n)</li>
        <li><strong>Th√†nh ti·ªÅn:</strong> ƒê∆∞·ª£c t√≠nh t·ª± ƒë·ªông = (Kho·∫£ng c√°ch √ó ƒê∆°n gi√°) + Ph√≠ c·∫ßu ƒë∆∞·ªùng + Ph√≠ d·ª´ng t·∫£i ‚Äì Tr·ªÖ Ontime</li>
        <li><strong>Nh·∫≠p th·ªß c√¥ng:</strong> C√≥ th·ªÉ nh·∫≠p th√†nh ti·ªÅn th·ªß c√¥ng, s·∫Ω ghi ƒë√® c√¥ng th·ª©c t·ª± ƒë·ªông</li>
        <li><strong>T·ª± ƒë·ªông ƒëi·ªÅn:</strong> C√°c tuy·∫øn NA_005, NA_005-1, NA_013-02, NA_013-03, NA_013-04, NA_013-02-1, NA_014 s·∫Ω t·ª± ƒë·ªông ƒëi·ªÅn gi√° tr·ªã 227,273 VNƒê</li>
        <li><strong>Tr·∫°ng th√°i Online:</strong> Cho ph√©p nh·∫≠p t·∫•t c·∫£ c√°c tr∆∞·ªùng, t√≠nh to√°n theo c√¥ng th·ª©c</li>
        <li><strong>Tr·∫°ng th√°i Offline:</strong> Kh√≥a t·∫•t c·∫£ tr∆∞·ªùng nh·∫≠p li·ªáu, ch·ªâ cho ph√©p nh·∫≠p th√†nh ti·ªÅn th·ªß c√¥ng v√† ghi ch√∫ (ƒë·ªÉ ghi l√Ω do offline)</li>
        <li><strong>Ch·ªânh s·ª≠a:</strong> T·∫•t c·∫£ c√°c √¥ nh·∫≠p ƒë·ªÅu cho ph√©p ch·ªânh s·ª≠a th·ªß c√¥ng sau khi t·ª± ƒë·ªông ƒëi·ªÅn</li>
        <li><strong>L∆∞u d·ªØ li·ªáu:</strong> Ch·ªâ c·∫ßn nh·∫≠p v√†o c√°c tr∆∞·ªùng c√≥ d·ªØ li·ªáu, b·ªè tr·ªëng nh·ªØng tuy·∫øn kh√¥ng ch·∫°y</li>
    </ul>
</div>

{% if not all_routes and not revenue_dict %}
<div style="margin-top: 20px; padding: 20px; background: rgba(231, 76, 60, 0.1); border-radius: 10px; border-left: 4px solid #e74c3c;">
    <h4 style="color: #e74c3c; margin-bottom: 10px;">‚ö†Ô∏è Ch∆∞a c√≥ tuy·∫øn n√†o:</h4>
    <p style="color: #2c3e50;">C·∫ßn t·∫°o tuy·∫øn ƒë∆∞·ªùng tr∆∞·ªõc khi ghi nh·∫≠n doanh thu. <a href="/routes" style="color: #3498db;">T·∫°o tuy·∫øn ngay</a></p>
</div>
{% endif %}

<script>
// H√†m t√≠nh to√°n th√†nh ti·ªÅn t·ª± ƒë·ªông theo c√¥ng th·ª©c m·ªõi
function calculateTotal(routeId) {
    const statusSelect = document.querySelector(`select[name="status_${routeId}"]`);
    const manualTotalInput = document.querySelector(`input[name="manual_total_${routeId}"]`);
    const totalSpan = document.getElementById(`total_${routeId}`);
    
    // N·∫øu c√≥ nh·∫≠p th·ªß c√¥ng th√†nh ti·ªÅn, ∆∞u ti√™n s·ª≠ d·ª•ng
    if (manualTotalInput.value && parseFloat(manualTotalInput.value) > 0) {
        const manualTotal = parseFloat(manualTotalInput.value) || 0;
        totalSpan.textContent = manualTotal.toLocaleString('vi-VN', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });
        return;
    }
    
    // N·∫øu tr·∫°ng th√°i l√† Offline v√† kh√¥ng c√≥ manual total, hi·ªÉn th·ªã 0
    if (statusSelect.value === 'Offline') {
        totalSpan.textContent = '0';
        return;
    }
    
    // T√≠nh to√°n t·ª± ƒë·ªông cho tr·∫°ng th√°i Online
    const distanceInput = document.querySelector(`input[name="distance_km_${routeId}"]`);
    const priceInput = document.querySelector(`input[name="unit_price_${routeId}"]`);
    const bridgeFeeInput = document.querySelector(`input[name="bridge_fee_${routeId}"]`);
    const loadingFeeInput = document.querySelector(`input[name="loading_fee_${routeId}"]`);
    const latePenaltyInput = document.querySelector(`input[name="late_penalty_${routeId}"]`);
    
    const distance = parseFloat(distanceInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;
    const bridgeFee = parseFloat(bridgeFeeInput.value) || 0;
    const loadingFee = parseFloat(loadingFeeInput.value) || 0;
    const latePenalty = parseFloat(latePenaltyInput.value) || 0;
    
    // C√¥ng th·ª©c: Th√†nh ti·ªÅn = (Kho·∫£ng c√°ch x ƒê∆°n gi√°) + Ph√≠ c·∫ßu ƒë∆∞·ªùng + Ph√≠ d·ª´ng t·∫£i ‚Äì Tr·ªÖ Ontime
    const total = Math.max(0, (distance * price) + bridgeFee + loadingFee - latePenalty);
    
    // ƒê·ªãnh d·∫°ng s·ªë v·ªõi d·∫•u ph·∫©y
    totalSpan.textContent = total.toLocaleString('vi-VN', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    });
}

// H√†m x·ª≠ l√Ω khi thay ƒë·ªïi tr·∫°ng th√°i Online/Offline
function toggleFieldsBasedOnStatus(routeId) {
    const statusSelect = document.querySelector(`select[name="status_${routeId}"]`);
    const distanceInput = document.querySelector(`input[name="distance_km_${routeId}"]`);
    const priceInput = document.querySelector(`input[name="unit_price_${routeId}"]`);
    const bridgeFeeInput = document.querySelector(`input[name="bridge_fee_${routeId}"]`);
    const loadingFeeInput = document.querySelector(`input[name="loading_fee_${routeId}"]`);
    const latePenaltyInput = document.querySelector(`input[name="late_penalty_${routeId}"]`);
    const notesInput = document.querySelector(`input[name="notes_${routeId}"]`);
    const manualTotalInput = document.querySelector(`input[name="manual_total_${routeId}"]`);
    
    const isOffline = statusSelect.value === 'Offline';
    
    // Kh√≥a/m·ªü c√°c tr∆∞·ªùng nh·∫≠p li·ªáu (tr·ª´ notes - lu√¥n cho ph√©p nh·∫≠p)
    distanceInput.disabled = isOffline;
    priceInput.disabled = isOffline;
    bridgeFeeInput.disabled = isOffline;
    loadingFeeInput.disabled = isOffline;
    latePenaltyInput.disabled = isOffline;
    notesInput.disabled = false; // Lu√¥n cho ph√©p nh·∫≠p ghi ch√∫
    
    // Thay ƒë·ªïi m√†u n·ªÅn ƒë·ªÉ hi·ªÉn th·ªã tr·∫°ng th√°i kh√≥a
    const disabledStyle = 'background-color: #f5f5f5; color: #999;';
    const enabledStyle = 'background-color: white; color: black;';
    
    const style = isOffline ? disabledStyle : enabledStyle;
    distanceInput.style.cssText += style;
    priceInput.style.cssText += style;
    bridgeFeeInput.style.cssText += style;
    loadingFeeInput.style.cssText += style;
    latePenaltyInput.style.cssText += style;
    // Notes lu√¥n c√≥ style enabled
    notesInput.style.cssText += enabledStyle;
    
    // N·∫øu chuy·ªÉn sang Offline, ƒë·∫∑t t·∫•t c·∫£ tr∆∞·ªùng v·ªÅ 0 (tr·ª´ notes)
    if (isOffline) {
        distanceInput.value = '0';
        priceInput.value = '0';
        bridgeFeeInput.value = '0';
        loadingFeeInput.value = '0';
        latePenaltyInput.value = '0';
        manualTotalInput.value = '0';
        // Kh√¥ng x√≥a notes - cho ph√©p nh·∫≠p l√Ω do offline
    }
    
    // T√≠nh l·∫°i th√†nh ti·ªÅn
    calculateTotal(routeId);
}

// H√†m x·ª≠ l√Ω khi nh·∫≠p th√†nh ti·ªÅn th·ªß c√¥ng
function handleManualTotal(routeId) {
    calculateTotal(routeId);
}

// Danh s√°ch c√°c tuy·∫øn c√≥ gi√° tr·ªã m·∫∑c ƒë·ªãnh 227,273
const defaultAmountRoutes = ['NA_005', 'NA_005-1', 'NA_013-02', 'NA_013-03', 'NA_013-04', 'NA_013-02-1', 'NA_014'];

// H√†m t·ª± ƒë·ªông ƒëi·ªÅn gi√° tr·ªã m·∫∑c ƒë·ªãnh cho c√°c tuy·∫øn ƒë·∫∑c bi·ªát
function autoFillDefaultAmount(routeId, routeCode) {
    if (defaultAmountRoutes.includes(routeCode)) {
        const manualTotalInput = document.querySelector(`input[name="manual_total_${routeId}"]`);
        if (manualTotalInput && !manualTotalInput.value) {
            manualTotalInput.value = '227273';
            calculateTotal(routeId);
        }
    }
}

// T·ª± ƒë·ªông t√≠nh to√°n khi trang load
document.addEventListener('DOMContentLoaded', function() {
    // T√≠nh to√°n v√† thi·∫øt l·∫≠p tr·∫°ng th√°i cho t·∫•t c·∫£ c√°c tuy·∫øn trong form nh·∫≠p
    {% for route in routes %}
    toggleFieldsBasedOnStatus({{ route.id }});
    calculateTotal({{ route.id }});
    autoFillDefaultAmount({{ route.id }}, '{{ route.route_code }}');
    {% endfor %}
});

// H√†m x√≥a m·ªôt doanh thu
function deleteRevenue(revenueId) {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a doanh thu n√†y?')) {
        // T·∫°o form ƒë·ªÉ submit POST request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/revenue/delete/' + revenueId;
        document.body.appendChild(form);
        form.submit();
    }
}

// H√†m x√≥a t·∫•t c·∫£ doanh thu trong ng√†y
function deleteAllRevenue() {
    const selectedDate = '{{ filter_date.strftime('%d/%m/%Y') }}';
    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° t·∫•t c·∫£ doanh thu ƒë√£ ghi nh·∫≠n trong ng√†y ${selectedDate} kh√¥ng?`)) {
        // T·∫°o form ƒë·ªÉ submit POST request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/revenue/delete-all';
        
        // Th√™m input hidden cho ng√†y
        const dateInput = document.createElement('input');
        dateInput.type = 'hidden';
        dateInput.name = 'date';
        dateInput.value = '{{ filter_date.strftime('%Y-%m-%d') }}';
        form.appendChild(dateInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>

{% endblock %}