{% extends "base.html" %}

{% block title %}Qu·∫£n l√Ω nh√¢n vi√™n - H·ªá th·ªëng qu·∫£n l√Ω v·∫≠n chuy·ªÉn{% endblock %}

{% block content %}
<div class="page-wrapper">
<div class="page-header">
    <h2>üë• Qu·∫£n l√Ω nh√¢n vi√™n</h2>
    <p>Qu·∫£n l√Ω th√¥ng tin nh√¢n vi√™n v√† l√°i xe trong h·ªá th·ªëng</p>
</div>

<!-- N√∫t Th√™m m·ªõi -->
<div class="action-section">
    <button type="button" class="btn btn-primary btn-lg" onclick="openAddEmployeeModal()">
        <i class="fas fa-plus"></i> Th√™m m·ªõi +
    </button>
</div>

<!-- Danh s√°ch nh√¢n vi√™n -->
<div class="table-section">
    {% if employees %}
    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>H·ªç t√™n</th>
                    <th>SƒêT</th>
                    <th>Ch·ª©c v·ª•</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Gi·∫•y t·ªù</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody>
                {% for employee in employees %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td><strong>{{ employee.name }}</strong></td>
                    <td>{{ employee.phone or 'Ch∆∞a c·∫≠p nh·∫≠t' }}</td>
                    <td>{{ employee.position or 'Ch∆∞a c·∫≠p nh·∫≠t' }}</td>
                    <td>
                        {% if employee.employee_status == 'ƒêang l√†m vi·ªác' %}
                            <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; background: #27ae60; color: white;">
                                {{ employee.employee_status or 'ƒêang l√†m vi·ªác' }}
                            </span>
                        {% elif employee.employee_status == 'Ngh·ªâ ph√©p d√†i h·∫°n' %}
                            <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; background: #5dade2; color: white;">
                                {{ employee.employee_status }}
                            </span>
                        {% elif employee.employee_status == 'ƒê√£ ngh·ªâ vi·ªác' %}
                            <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; background: #e74c3c; color: white;">
                                {{ employee.employee_status }}
                            </span>
                        {% else %}
                            <span style="padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; background: #27ae60; color: white;">
                                ƒêang l√†m vi·ªác
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        {% set documents_list = employee.documents | from_json %}
                        {% if documents_list and documents_list|length > 0 %}
                            <button type="button" class="btn btn-sm btn-info" onclick="viewDocuments({{ employee.id }})">
                                <i class="fas fa-eye"></i> Xem ({{ documents_list|length }})
                            </button>
                        {% else %}
                            <span class="text-muted">Ch∆∞a upload</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="/employees/edit/{{ employee.id }}" class="btn btn-sm btn-primary">
                                <i class="fas fa-edit"></i> S·ª≠a
                            </a>
                            <button type="button" class="btn btn-sm btn-danger" onclick="deleteEmployee({{ employee.id }}, '{{ employee.name }}')">
                                <i class="fas fa-trash"></i> X√≥a
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="no-data">
        <div class="no-data-icon">üë•</div>
        <h3>Ch∆∞a c√≥ nh√¢n vi√™n n√†o</h3>
        <p>H√£y th√™m nh√¢n vi√™n ƒë·∫ßu ti√™n b·∫±ng n√∫t "Th√™m m·ªõi +" b√™n tr√™n</p>
    </div>
    {% endif %}
</div>
</div>

<!-- Modal Th√™m nh√¢n vi√™n m·ªõi -->
<div id="addEmployeeModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user-plus"></i> Th√™m nh√¢n vi√™n m·ªõi</h3>
            <span class="close" onclick="closeAddEmployeeModal()">&times;</span>
        </div>
        <form id="addEmployeeForm" enctype="multipart/form-data">
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label for="name">H·ªç v√† t√™n *</label>
                        <input type="text" id="name" name="name" required placeholder="Nh·∫≠p h·ªç v√† t√™n nh√¢n vi√™n">
                        <div class="error-message" id="name-error"></div>
                    </div>
                    <div class="form-group">
                        <label for="birth_date">Ng√†y th√°ng nƒÉm sinh</label>
                        <input type="date" id="birth_date" name="birth_date">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="tel" id="phone" name="phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                    </div>
                    <div class="form-group">
                        <label for="cccd">CCCD</label>
                        <input type="text" id="cccd" name="cccd" placeholder="Nh·∫≠p s·ªë CCCD">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="employee_status">Tr·∫°ng th√°i nh√¢n vi√™n *</label>
                        <select id="employee_status" name="employee_status" required>
                            <option value="ƒêang l√†m vi·ªác" selected>ƒêang l√†m vi·ªác</option>
                            <option value="ƒê√£ ngh·ªâ vi·ªác">ƒê√£ ngh·ªâ vi·ªác</option>
                            <option value="Ngh·ªâ ph√©p d√†i h·∫°n">Ngh·ªâ ph√©p d√†i h·∫°n</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="position">Ch·ª©c v·ª• *</label>
                        <select id="position" name="position" required>
                            <option value="">-- Ch·ªçn ch·ª©c v·ª• --</option>
                            <option value="Gi√°m ƒë·ªëc">Gi√°m ƒë·ªëc</option>
                            <option value="Ph√≥ Gi√°m ƒë·ªëc">Ph√≥ Gi√°m ƒë·ªëc</option>
                            <option value="L√°i xe">L√°i xe</option>
                            <option value="Nh√¢n vi√™n vƒÉn ph√≤ng">Nh√¢n vi√™n vƒÉn ph√≤ng</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="social_insurance_salary">M·ª©c l∆∞∆°ng tham gia BHXH</label>
                        <input type="number" id="social_insurance_salary" name="social_insurance_salary" 
                               placeholder="Nh·∫≠p m·ª©c l∆∞∆°ng (s·ªë nguy√™n)" 
                               min="0" step="1" 
                               oninput="validateIntegerInput(this)">
                        <small class="form-help">Ch·ªâ nh·∫≠p s·ªë nguy√™n d∆∞∆°ng. ƒê·ªÉ tr·ªëng n·∫øu ch∆∞a tham gia BHXH.</small>
                        <div class="error-message" id="social_insurance_salary-error"></div>
                    </div>
                </div>
                
                <div class="form-row" style="display: none;">
                    <div class="form-group">
                        <label for="cccd_issue_date">Ng√†y c·∫•p CCCD</label>
                        <input type="date" id="cccd_issue_date" name="cccd_issue_date">
                    </div>
                    <div class="form-group">
                        <label for="driving_license">H·∫°ng b·∫±ng l√°i</label>
                        <input type="text" id="driving_license" name="driving_license" placeholder="Nh·∫≠p h·∫°ng b·∫±ng l√°i (VD: B2, C, D)">
                    </div>
                    <div class="form-group">
                        <label for="license_expiry">Ng√†y h·∫øt h·∫°n b·∫±ng l√°i</label>
                        <input type="date" id="license_expiry" name="license_expiry">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="documents">Upload gi·∫•y t·ªù</label>
                    <input type="file" id="documents" name="documents" multiple accept=".pdf,.jpg,.jpeg,.png,.gif" onchange="previewFiles(this)">
                    <small class="form-help">C√≥ th·ªÉ ch·ªçn nhi·ªÅu file (PDF, JPG, PNG, GIF)</small>
                    <div id="file-preview" class="file-preview"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAddEmployeeModal()">H·ªßy</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> L∆∞u
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal Xem gi·∫•y t·ªù -->
<div id="viewDocumentsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-file-alt"></i> Gi·∫•y t·ªù nh√¢n vi√™n</h3>
            <span class="close" onclick="closeViewDocumentsModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="documents-gallery"></div>
        </div>
    </div>
</div>

<!-- Form ·∫©n ƒë·ªÉ x√≥a nh√¢n vi√™n -->
<form id="deleteEmployeeForm" method="post" style="display: none;">
    <input type="hidden" name="employee_id" id="deleteEmployeeId">
</form>

<style>
.page-header {
    margin-bottom: 30px;
}

.page-header h2 {
    color: #2c3e50;
    margin-bottom: 10px;
}

.page-header p {
    color: #7f8c8d;
    margin: 0;
}

.action-section {
    margin-bottom: 30px;
}

.btn-lg {
    padding: 12px 24px;
    font-size: 16px;
    border-radius: 8px;
}

.table-section {
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th {
    background: #34495e;
    color: white;
    padding: 15px 12px;
    text-align: left;
    font-weight: 600;
    border: none;
}

.data-table td {
    padding: 12px;
    border-bottom: 1px solid #ecf0f1;
    vertical-align: middle;
}

.data-table tbody tr:hover {
    background-color: #f8f9fa;
}

.data-table tbody tr:last-child td {
    border-bottom: none;
}

.action-buttons {
    display: flex;
    gap: 8px;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
    border-radius: 4px;
}

.no-data {
    text-align: center;
    padding: 60px 20px;
}

.no-data-icon {
    font-size: 4em;
    margin-bottom: 20px;
    color: #bdc3c7;
}

.no-data h3 {
    color: #7f8c8d;
    margin-bottom: 15px;
}

.no-data p {
    color: #95a5a6;
    margin: 0;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    animation: fadeIn 0.3s;
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 10px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideIn 0.3s;
}

.modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 10px 10px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    font-size: 1.3em;
}

.close {
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.close:hover {
    opacity: 0.7;
}

.modal-body {
    padding: 30px;
}

.modal-footer {
    padding: 20px 30px;
    border-top: 1px solid #ecf0f1;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 8px;
}

.form-group input,
.form-group select {
    padding: 10px 12px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s;
}

.form-group select {
    background: white;
    cursor: pointer;
}

.form-group input:focus,
.form-group select:focus {
    border-color: #667eea;
    outline: none;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-group select {
    padding: 10px 12px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s;
    background: white;
    cursor: pointer;
}

.form-help {
    color: #6c757d;
    font-size: 12px;
    margin-top: 5px;
}

.error-message {
    color: #e74c3c;
    font-size: 12px;
    margin-top: 5px;
    display: none;
}

.file-preview {
    margin-top: 15px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
}

.file-preview-item {
    position: relative;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 10px;
    text-align: center;
    background: #f8f9fa;
}

.file-preview-item img {
    max-width: 100%;
    max-height: 80px;
    border-radius: 4px;
}

.file-preview-item .file-name {
    font-size: 11px;
    color: #6c757d;
    margin-top: 5px;
    word-break: break-all;
}

.file-preview-item .remove-file {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    cursor: pointer;
}

.documents-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    padding: 20px 0;
}

.document-item {
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    background: #f8f9fa;
    transition: all 0.3s ease;
    position: relative;
}

.document-item:hover {
    border-color: #007bff;
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.1);
    transform: translateY(-2px);
}

.document-icon {
    margin-bottom: 15px;
}

.document-image {
    margin-bottom: 15px;
}

.document-image img {
    max-width: 100%;
    max-height: 200px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
}

.document-image img:hover {
    transform: scale(1.05);
}

.document-name {
    font-size: 13px;
    color: #495057;
    word-break: break-all;
    margin-bottom: 15px;
    font-weight: 500;
}

.document-actions {
    display: flex;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
}

.document-actions .btn {
    padding: 6px 12px;
    font-size: 11px;
    border-radius: 4px;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    transition: all 0.3s ease;
}

.document-actions .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        width: 95%;
        margin: 10% auto;
    }
    
    .data-table {
        font-size: 0.9em;
    }
    
    .action-buttons {
        flex-direction: column;
    }
}
</style>

<script>
// M·ªü modal th√™m nh√¢n vi√™n
function openAddEmployeeModal() {
    document.getElementById('addEmployeeModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

// ƒê√≥ng modal th√™m nh√¢n vi√™n
function closeAddEmployeeModal() {
    document.getElementById('addEmployeeModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    document.getElementById('addEmployeeForm').reset();
    document.getElementById('file-preview').innerHTML = '';
    clearErrors();
}

// X√≥a l·ªói validation
function clearErrors() {
    const errorElements = document.querySelectorAll('.error-message');
    errorElements.forEach(element => {
        element.style.display = 'none';
        element.textContent = '';
    });
}

// Preview files
function previewFiles(input) {
    const preview = document.getElementById('file-preview');
    preview.innerHTML = '';
    
    if (input.files) {
        Array.from(input.files).forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-preview-item';
            
            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                fileItem.appendChild(img);
            } else {
                const icon = document.createElement('div');
                icon.innerHTML = '<i class="fas fa-file-pdf" style="font-size: 2em; color: #e74c3c;"></i>';
                fileItem.appendChild(icon);
            }
            
            const fileName = document.createElement('div');
            fileName.className = 'file-name';
            fileName.textContent = file.name;
            fileItem.appendChild(fileName);
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-file';
            removeBtn.innerHTML = '√ó';
            removeBtn.onclick = () => removeFile(index);
            fileItem.appendChild(removeBtn);
            
            preview.appendChild(fileItem);
        });
    }
}

// X√≥a file kh·ªèi preview
function removeFile(index) {
    const input = document.getElementById('documents');
    const dt = new DataTransfer();
    
    Array.from(input.files).forEach((file, i) => {
        if (i !== index) {
            dt.items.add(file);
        }
    });
    
    input.files = dt.files;
    previewFiles(input);
}

// Xem gi·∫•y t·ªù
async function viewDocuments(employeeId) {
    try {
        // Hi·ªÉn th·ªã loading
        const gallery = document.getElementById('documents-gallery');
        gallery.innerHTML = '<div style="text-align: center; padding: 40px;"><i class="fas fa-spinner fa-spin" style="font-size: 2em; color: #007bff;"></i><br><br>ƒêang t·∫£i gi·∫•y t·ªù...</div>';
        
        // Hi·ªÉn th·ªã modal tr∆∞·ªõc
        document.getElementById('viewDocumentsModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
        
        // G·ªçi API ƒë·ªÉ l·∫•y th√¥ng tin gi·∫•y t·ªù
        const response = await fetch(`/employees/documents/${employeeId}`);
        const data = await response.json();
        
        if (!data.success) {
            showErrorMessage(data.error || 'C√≥ l·ªói x·∫£y ra khi t·∫£i gi·∫•y t·ªù');
            closeViewDocumentsModal();
            return;
        }
        
        if (!data.documents || data.documents.length === 0) {
            gallery.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #6c757d;">
                    <i class="fas fa-file-alt" style="font-size: 3em; margin-bottom: 15px;"></i>
                    <h4>Ch∆∞a c√≥ gi·∫•y t·ªù</h4>
                    <p>Nh√¢n vi√™n n√†y ch∆∞a upload gi·∫•y t·ªù n√†o.</p>
                </div>
            `;
            return;
        }
        
        // Hi·ªÉn th·ªã danh s√°ch gi·∫•y t·ªù
        gallery.innerHTML = '';
        
        data.documents.forEach((doc, index) => {
            if (!doc.exists) {
                // File kh√¥ng t·ªìn t·∫°i
                const docItem = document.createElement('div');
                docItem.className = 'document-item';
                docItem.style.borderColor = '#dc3545';
                docItem.innerHTML = `
                    <div class="document-icon">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3em; color: #dc3545; margin-bottom: 10px;"></i>
                    </div>
                    <div class="document-name">${doc.filename}</div>
                    <div style="color: #dc3545; font-size: 12px; margin-top: 10px;">
                        <i class="fas fa-times-circle"></i> File kh√¥ng t·ªìn t·∫°i
                    </div>
                `;
                gallery.appendChild(docItem);
                return;
            }
            
            const docItem = document.createElement('div');
            docItem.className = 'document-item';
            
            // X√°c ƒë·ªãnh lo·∫°i file
            const fileExtension = doc.extension.toLowerCase();
            const isPdf = fileExtension === '.pdf';
            const isImage = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp'].includes(fileExtension);
            
            // Format file size
            const formatFileSize = (bytes) => {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            };
            
            if (isPdf) {
                docItem.innerHTML = `
                    <div class="document-icon">
                        <i class="fas fa-file-pdf" style="font-size: 3em; color: #e74c3c; margin-bottom: 10px;"></i>
                    </div>
                    <div class="document-name">${doc.filename}</div>
                    <div style="font-size: 11px; color: #6c757d; margin-bottom: 15px;">
                        ${formatFileSize(doc.size)}
                    </div>
                    <div class="document-actions">
                        <a href="${doc.url}" target="_blank" class="btn btn-sm btn-primary">
                            <i class="fas fa-external-link-alt"></i> M·ªü file
                        </a>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="downloadFile('${doc.filename}')">
                            <i class="fas fa-download"></i> T·∫£i v·ªÅ
                        </button>
                    </div>
                `;
            } else if (isImage) {
                docItem.innerHTML = `
                    <div class="document-image">
                        <img src="${doc.url}" alt="${doc.filename}" onerror="handleImageError(this)">
                    </div>
                    <div class="document-name">${doc.filename}</div>
                    <div style="font-size: 11px; color: #6c757d; margin-bottom: 15px;">
                        ${formatFileSize(doc.size)}
                    </div>
                    <div class="document-actions">
                        <button type="button" class="btn btn-sm btn-primary" onclick="openImageModal('${doc.url}', '${doc.filename}')">
                            <i class="fas fa-expand"></i> Xem l·ªõn
                        </button>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="downloadFile('${doc.filename}')">
                            <i class="fas fa-download"></i> T·∫£i v·ªÅ
                        </button>
                    </div>
                `;
            } else {
                // File kh√°c
                docItem.innerHTML = `
                    <div class="document-icon">
                        <i class="fas fa-file" style="font-size: 3em; color: #6c757d; margin-bottom: 10px;"></i>
                    </div>
                    <div class="document-name">${doc.filename}</div>
                    <div style="font-size: 11px; color: #6c757d; margin-bottom: 15px;">
                        ${formatFileSize(doc.size)}
                    </div>
                    <div class="document-actions">
                        <a href="${doc.url}" target="_blank" class="btn btn-sm btn-primary">
                            <i class="fas fa-external-link-alt"></i> M·ªü file
                        </a>
                        <button type="button" class="btn btn-sm btn-secondary" onclick="downloadFile('${doc.filename}')">
                            <i class="fas fa-download"></i> T·∫£i v·ªÅ
                        </button>
                    </div>
                `;
            }
            
            gallery.appendChild(docItem);
        });
        
    } catch (e) {
        console.error('L·ªói khi hi·ªÉn th·ªã gi·∫•y t·ªù:', e);
        showErrorMessage('C√≥ l·ªói x·∫£y ra khi hi·ªÉn th·ªã gi·∫•y t·ªù. Vui l√≤ng th·ª≠ l·∫°i sau.');
        closeViewDocumentsModal();
    }
}

// ƒê√≥ng modal xem gi·∫•y t·ªù
function closeViewDocumentsModal() {
    document.getElementById('viewDocumentsModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// X√≥a nh√¢n vi√™n
function deleteEmployee(id, name) {
    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a nh√¢n vi√™n "${name}"?`)) {
        document.getElementById('deleteEmployeeId').value = id;
        document.getElementById('deleteEmployeeForm').action = `/employees/delete/${id}`;
        document.getElementById('deleteEmployeeForm').submit();
    }
}

// Validate integer input for social insurance salary
function validateIntegerInput(input) {
    const value = input.value.trim();
    const errorElement = document.getElementById('social_insurance_salary-error');
    
    if (value === '') {
        errorElement.style.display = 'none';
        errorElement.textContent = '';
        return true;
    }
    
    // Check if it's a valid positive integer
    if (!/^\d+$/.test(value) || parseInt(value) <= 0) {
        errorElement.textContent = 'M·ª©c l∆∞∆°ng tham gia BHXH ph·∫£i l√† s·ªë nguy√™n';
        errorElement.style.display = 'block';
        return false;
    }
    
    errorElement.style.display = 'none';
    errorElement.textContent = '';
    return true;
}

// X·ª≠ l√Ω form submit
document.getElementById('addEmployeeForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Clear previous errors
    clearErrors();
    
    // Validate required fields
    const name = document.getElementById('name').value.trim();
    if (!name) {
        showError('name-error', 'H·ªç v√† t√™n l√† b·∫Øt bu·ªôc');
        return;
    }
    
    // Validate social insurance salary
    const socialInsuranceSalary = document.getElementById('social_insurance_salary');
    if (!validateIntegerInput(socialInsuranceSalary)) {
        return;
    }
    
    // Show loading
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang l∆∞u...';
    submitBtn.disabled = true;
    
    try {
        const formData = new FormData(this);
        
        const response = await fetch('/employees/add', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            // Show success message
            showSuccessMessage('Th√™m nh√¢n vi√™n th√†nh c√¥ng!');
            
            // Close modal and reload page
            closeAddEmployeeModal();
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            throw new Error('C√≥ l·ªói x·∫£y ra khi th√™m nh√¢n vi√™n');
        }
    } catch (error) {
        alert('C√≥ l·ªói x·∫£y ra: ' + error.message);
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
});

// Hi·ªÉn th·ªã l·ªói
function showError(elementId, message) {
    const errorElement = document.getElementById(elementId);
    errorElement.textContent = message;
    errorElement.style.display = 'block';
}

// Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
function showSuccessMessage(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success';
    alert.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        padding: 15px 20px;
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        border-radius: 5px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        animation: slideInRight 0.3s;
    `;
    alert.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 3000);
}

// Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
function showErrorMessage(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-error';
    alert.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        padding: 15px 20px;
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
        border-radius: 5px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        animation: slideInRight 0.3s;
    `;
    alert.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 4000);
}

// X·ª≠ l√Ω l·ªói ·∫£nh
function handleImageError(img) {
    img.style.display = 'none';
    const parent = img.parentElement;
    parent.innerHTML = `
        <div class="document-icon">
            <i class="fas fa-image" style="font-size: 3em; color: #6c757d; margin-bottom: 10px;"></i>
        </div>
        <div class="document-name">Kh√¥ng th·ªÉ hi·ªÉn th·ªã ·∫£nh</div>
        <div class="document-actions">
            <a href="${img.src}" target="_blank" class="btn btn-sm btn-primary">
                <i class="fas fa-external-link-alt"></i> M·ªü file
            </a>
        </div>
    `;
}

// T·∫£i file
function downloadFile(filename) {
    const link = document.createElement('a');
    link.href = `/static/uploads/${filename}`;
    link.download = filename;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// M·ªü ·∫£nh trong modal l·ªõn
function openImageModal(imageSrc, imageName) {
    const modal = document.createElement('div');
    modal.className = 'image-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s;
    `;
    
    modal.innerHTML = `
        <div style="position: relative; max-width: 90%; max-height: 90%;">
            <img src="${imageSrc}" alt="${imageName}" style="max-width: 100%; max-height: 100%; border-radius: 8px;">
            <button onclick="this.parentElement.parentElement.remove()" style="
                position: absolute;
                top: -40px;
                right: 0;
                background: rgba(255, 255, 255, 0.8);
                border: none;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                font-size: 20px;
                cursor: pointer;
                color: #333;
            ">&times;</button>
            <div style="
                position: absolute;
                bottom: -40px;
                left: 0;
                right: 0;
                text-align: center;
                color: white;
                font-size: 14px;
            ">${imageName}</div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // ƒê√≥ng modal khi click outside
    modal.onclick = function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    };
}

// ƒê√≥ng modal khi click outside
window.onclick = function(event) {
    const addModal = document.getElementById('addEmployeeModal');
    const viewModal = document.getElementById('viewDocumentsModal');
    
    if (event.target === addModal) {
        closeAddEmployeeModal();
    }
    if (event.target === viewModal) {
        closeViewDocumentsModal();
    }
}

// CSS cho animation
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}