{% extends "base.html" %}

{% block title %}Chi ti·∫øt b·∫£ng ch·∫•m c√¥ng - H·ªá th·ªëng qu·∫£n l√Ω v·∫≠n chuy·ªÉn{% endblock %}

{% block content %}
<div class="page-wrapper">
<div class="page-header">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2>üìã {{ timekeeping_table.name }}</h2>
            <p style="color: #7f8c8d; margin: 5px 0 0 0;">
                T·ª´ ng√†y: <strong>{{ timekeeping_table.from_date.strftime('%d/%m/%Y') }}</strong> - 
                ƒê·∫øn ng√†y: <strong>{{ timekeeping_table.to_date.strftime('%d/%m/%Y') }}</strong>
            </p>
        </div>
        <a href="/timekeeping-v1" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Quay l·∫°i
        </a>
    </div>
</div>

<!-- Th√¥ng tin b·∫£ng ch·∫•m c√¥ng -->
<div class="info-card">
    <div class="info-item">
        <span class="info-label">T√™n b·∫£ng ch·∫•m c√¥ng:</span>
        <span class="info-value">{{ timekeeping_table.name }}</span>
    </div>
    <div class="info-item">
        <span class="info-label">Kho·∫£ng th·ªùi gian:</span>
        <span class="info-value">
            {{ timekeeping_table.from_date.strftime('%d/%m/%Y') }} - {{ timekeeping_table.to_date.strftime('%d/%m/%Y') }}
        </span>
    </div>
    <div class="info-item">
        <span class="info-label">Ng√†y t·∫°o:</span>
        <span class="info-value">{{ timekeeping_table.created_at.strftime('%d/%m/%Y %H:%M:%S') }}</span>
    </div>
</div>

<!-- Sheet theo tuy·∫øn -->
<div class="sheet-layout">
    <div class="sheet-toolbar">
        <div id="sheetTabs" class="sheet-tabs"></div>
        <div class="sheet-actions">
            <button class="btn btn-secondary" onclick="copyFirstRowDown()" id="copyDownBtn">
                <i class="fas fa-copy"></i> Copy d√≤ng 1 xu·ªëng
            </button>
            <button class="btn btn-secondary" onclick="saveCurrentSheet()" id="saveSheetBtn">
                <i class="fas fa-save"></i> L∆∞u sheet
            </button>
            <button class="btn btn-primary" onclick="saveAllSheets()" id="saveAllBtn">
                <i class="fas fa-cloud-upload-alt"></i> L∆∞u to√†n b·ªô
            </button>
        </div>
    </div>

    <div class="table-section">
        <div id="sheetMeta" class="sheet-meta"></div>
        <div id="sheetContainer"></div>
    </div>
</div>

<style>
.page-header {
    margin-bottom: 30px;
}

.page-header h2 {
    color: #2c3e50;
    margin-bottom: 10px;
}

.info-card {
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    padding: 20px;
    margin-bottom: 30px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.info-label {
    font-size: 12px;
    color: #7f8c8d;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-value {
    font-size: 16px;
    color: #2c3e50;
    font-weight: 500;
}

.sheet-layout {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.sheet-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
    position: sticky;
    top: 70px;
    background: white;
    padding: 15px 20px;
    z-index: 100;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    border-radius: 10px;
    margin-bottom: 12px;
}

.sheet-tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.sheet-tab {
    padding: 8px 12px;
    border-radius: 6px;
    background: #ecf0f1;
    color: #2c3e50;
    border: 1px solid #dfe6e9;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s ease;
}

.sheet-tab.active {
    background: #667eea;
    color: #fff;
    border-color: #667eea;
    box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
}

.sheet-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}

.table-section {
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    padding: 20px;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table th {
    background: #34495e;
    color: white;
    padding: 8px 4px;
    text-align: left;
    font-weight: 600;
    font-size: 12px;
    border: none;
    position: sticky;
    top: 0;
    z-index: 1;
}

/* Column width adjustments */
.data-table th:nth-child(1), .data-table td:nth-child(1) { width: 45px; min-width: 45px; } /* STT */
.data-table th:nth-child(2), .data-table td:nth-child(2) { width: 90px; min-width: 90px; } /* Ng√†y */
.data-table th:nth-child(3), .data-table td:nth-child(3) { width: 135px; min-width: 135px; } /* Bi·ªÉn s·ªë xe */
.data-table th:nth-child(4), .data-table td:nth-child(4) { width: 95px; min-width: 95px; } /* M√£ tuy·∫øn */
/* Status column */
.data-table th.status-column,
.data-table td[data-field="status"] { 
    width: 75px; 
    min-width: 75px; 
}
/* Lo·∫°i tuy·∫øn - ·∫©n m·∫∑c ƒë·ªãnh cho c√°c sheet kh√¥ng ph·∫£i TƒÉng c∆∞·ªùng */
.data-table td[data-field="route_type"] {
    display: none !important;
}
/* Lo·∫°i tuy·∫øn - hi·ªÉn th·ªã cho sheet TƒÉng c∆∞·ªùng */
.data-table.sheet-tang-cuong td[data-field="route_type"] {
    display: table-cell !important;
    width: 140px;
    min-width: 140px;
}
.data-table.sheet-tang-cuong th:nth-child(5) {
    width: 140px;
    min-width: 140px;
}
/* L·ªô tr√¨nh - fixed width ~300px v·ªõi wrap text v√† auto height */
/* Header cho c·ªôt L·ªô tr√¨nh */
.data-table thead th.itinerary-column {
    width: 300px;
    min-width: 300px;
    max-width: 300px;
    vertical-align: top;
}
/* Cell cho c·ªôt L·ªô tr√¨nh */
.data-table td[data-field="itinerary"] {
    width: 300px;
    min-width: 300px;
    max-width: 300px;
    padding: 6px 4px;
    vertical-align: top;
    position: static;
    word-break: break-word;
    overflow-wrap: break-word;
    white-space: normal;
    overflow: visible;
}
.data-table td[data-field="itinerary"] .input-control,
.data-table td[data-field="itinerary"] textarea {
    width: 100%;
    max-width: 100%;
    font-size: 12px;
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    min-height: 50px;
    height: auto;
    resize: vertical;
    box-sizing: border-box;
    padding: 4px 6px;
    margin: 0;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    display: block;
    position: static;
    overflow: visible;
}
/* C√°c c·ªôt c√≤n l·∫°i */
/* Km chuy·∫øn - tƒÉng ƒë·ªô r·ªông ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß */
.data-table th.distance-column,
.data-table td[data-field="distance_km"] { width: 90px; min-width: 90px; }
/* ƒê∆°n gi√° - gi·∫£m ƒë·ªô r·ªông */
.data-table th.unit-price-column,
.data-table td[data-field="unit_price"] { width: 85px; min-width: 85px; }
.data-table td[data-field="bridge_fee"] { width: 105px; min-width: 105px; }
.data-table td[data-field="loading_fee"] { width: 95px; min-width: 95px; }
.data-table td[data-total] { width: 115px; min-width: 115px; }
/* L√°i xe - tƒÉng ƒë·ªô r·ªông ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß t√™n */
.data-table th.driver-column,
.data-table td[data-field="driver_name"] { 
    width: 190px; 
    min-width: 190px; 
    white-space: nowrap;
    overflow: visible;
    text-overflow: clip;
}
.data-table td[data-field="driver_name"] .select-control {
    width: 100%;
    overflow: visible;
}
.data-table td[data-field="trip_code"] { width: 170px; min-width: 170px; }
.data-table td[data-field="notes"] { width: 170px; min-width: 170px; }

/* Style cho c√°c field b·ªã kh√≥a khi Status = OFF */
.data-table td .input-control:disabled,
.data-table td .select-control:disabled {
    background-color: #f5f5f5;
    cursor: not-allowed;
    opacity: 0.6;
}

/* Style cho date picker wrapper */
.date-picker-wrapper {
    position: relative;
    display: inline-block;
    width: 100%;
    min-height: 32px;
}

.date-picker-hidden {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
    z-index: 10;
    pointer-events: auto;
    margin: 0;
    padding: 0;
}

.date-display {
    cursor: pointer;
    background-color: white;
    user-select: none;
    pointer-events: none;
    position: relative;
    z-index: 1;
}

.date-display:focus {
    outline: 2px solid #667eea;
    outline-offset: 2px;
}

.data-table tbody tr {
    min-height: 45px;
    height: auto;
}

.data-table td {
    padding: 6px 4px;
    border-bottom: 1px solid #ecf0f1;
    vertical-align: middle;
    font-size: 12px;
    min-height: 45px;
    height: auto;
}

/* ƒê·∫£m b·∫£o khi c·ªôt L·ªô tr√¨nh cao, c·ªôt L·ªô tr√¨nh cƒÉn top */
.data-table tbody tr td[data-field="itinerary"] {
    vertical-align: top;
}

/* ƒê·∫£m b·∫£o textarea trong c·ªôt L·ªô tr√¨nh kh√¥ng c√≥ scrollbar v√† hi·ªÉn th·ªã ƒë√∫ng */
.data-table td[data-field="itinerary"] textarea {
    overflow: visible;
    overflow-y: visible;
    overflow-x: visible;
}

.data-table tbody tr:last-child td {
    border-bottom: none;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
}

.btn-secondary {
    background: #95a5a6;
    color: white;
}

.btn-secondary:hover {
    background: #7f8c8d;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(149, 165, 166, 0.3);
}

.btn-primary {
    background: #667eea;
    color: #fff;
}

.btn-primary:hover {
    background: #5568d3;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.table-wrapper {
    width: 100%;
    overflow-x: auto;
}

.sheet-meta {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 10px;
    color: #7f8c8d;
    font-size: 14px;
}

.input-control, .select-control {
    width: 100%;
    padding: 4px 6px;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    font-size: 12px;
    background: #fff;
}

.input-control:focus, .select-control:focus {
    border-color: #667eea;
    outline: none;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.input-control[data-field="itinerary"],
textarea[data-field="itinerary"] {
    width: 100%;
    min-height: 50px;
    height: auto;
    resize: vertical;
    font-family: inherit;
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    box-sizing: border-box;
    padding: 6px 8px;
}

.number-cell {
    text-align: right;
    font-size: 12px;
}

.tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 999px;
    background: #eef2ff;
    color: #4338ca;
    font-weight: 600;
    font-size: 13px;
}

.total-cell {
    font-weight: 700;
    color: #1e293b;
    text-align: right;
    font-size: 12px;
}

.total-summary-row {
    background-color: #f8f9fa;
}

.total-summary-row td {
    border-top: 2px solid #667eea !important;
    font-weight: 700;
}

.total-summary-cell {
    font-size: 14px !important;
    color: #667eea !important;
}

.toast {
    position: fixed;
    top: 16px;
    right: 16px;
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    color: #fff;
    display: flex;
    align-items: center;
    gap: 8px;
    z-index: 9999;
    animation: slideIn 0.2s ease;
}

.toast.success { background: #16a34a; }
.toast.error { background: #dc2626; }

@keyframes slideIn {
    from { transform: translateX(20px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@media (max-width: 768px) {
    .info-card {
        grid-template-columns: 1fr;
    }
    
    .page-header > div {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }

    .sheet-toolbar {
        flex-direction: column;
        align-items: flex-start;
    }
}
</style>

<script>
const timekeepingTable = {
    id: {{ timekeeping_table.id }},
    from_date: "{{ timekeeping_table.from_date.isoformat() }}",
    to_date: "{{ timekeeping_table.to_date.isoformat() }}",
    name: "{{ timekeeping_table.name }}"
};

const routes = {{ routes | tojson }};
const dateRange = {{ date_range | tojson }};
const employees = {{ employees | tojson }};
const vehicles = {{ vehicles | tojson }};
const savedDetails = {{ timekeeping_details | tojson }};

let sheetData = {};
let activeSheetKey = null;

document.addEventListener('DOMContentLoaded', () => {
    initSheets();
});

// H√†m chuy·ªÉn ƒë·ªïi t·ª´ YYYY-MM-DD sang dd/mm/yyyy
function formatDateToDDMMYYYY(dateStr) {
    if (!dateStr) return "";
    // N·∫øu ƒë√£ l√† format dd/mm/yyyy, tr·∫£ v·ªÅ lu√¥n
    if (typeof dateStr === 'string' && dateStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
        return dateStr;
    }
    // Convert t·ª´ YYYY-MM-DD ho·∫∑c ISO format
    let date;
    if (typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{2}-\d{2}/)) {
        const parts = dateStr.split('T')[0].split('-');
        date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
    } else {
        date = new Date(dateStr);
    }
    if (isNaN(date.getTime())) return "";
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

// H√†m chuy·ªÉn ƒë·ªïi t·ª´ dd/mm/yyyy sang YYYY-MM-DD
function parseDateFromDDMMYYYY(dateStr) {
    if (!dateStr) return "";
    // N·∫øu ƒë√£ l√† YYYY-MM-DD, tr·∫£ v·ªÅ lu√¥n
    if (typeof dateStr === 'string' && dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
        return dateStr;
    }
    // Parse t·ª´ dd/mm/yyyy
    const match = dateStr.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if (!match) return "";
    const day = parseInt(match[1], 10);
    const month = parseInt(match[2], 10);
    const year = parseInt(match[3], 10);
    // Validate date
    const date = new Date(year, month - 1, day);
    if (date.getDate() !== day || date.getMonth() !== month - 1 || date.getFullYear() !== year) {
        return "";
    }
    return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
}

// H√†m t·ª± ƒë·ªông format ng√†y khi ng∆∞·ªùi d√πng nh·∫≠p (t·ª± ƒë·ªông th√™m d·∫•u /)
function autoFormatDateInput(input) {
    let value = input.value.replace(/\D/g, ''); // Ch·ªâ gi·ªØ s·ªë
    if (value.length >= 2) {
        value = value.substring(0, 2) + '/' + value.substring(2);
    }
    if (value.length >= 5) {
        value = value.substring(0, 5) + '/' + value.substring(5, 9);
    }
    input.value = value;
}

function buildOptions(list, valueKey, labelKey, selectedValue, placeholder) {
    const options = [`<option value="">${placeholder}</option>`];
    list.forEach(item => {
        const value = item[valueKey] || "";
        const label = item[labelKey] || value;
        const selected = value === selectedValue ? "selected" : "";
        
        // ƒê·∫∑c bi·ªát x·ª≠ l√Ω cho driver_name: ch·ªâ hi·ªÉn th·ªã employees c√≥ is_active = true
        // Nh∆∞ng v·∫´n hi·ªÉn th·ªã selectedValue n·∫øu n√≥ ƒë√£ ƒë∆∞·ª£c ch·ªçn (gi·ªØ d·ªØ li·ªáu l·ªãch s·ª≠)
        if (valueKey === "name" && labelKey === "name") {
            // ƒê√¢y l√† dropdown l√°i xe
            const isActive = item.is_active === true; // Ch·ªâ true n·∫øu explicitly set
            const isSelected = value === selectedValue && selectedValue !== "";
            
            // Ch·ªâ th√™m v√†o dropdown n·∫øu:
            // 1. is_active = true (cho ph√©p ch·ªçn m·ªõi - ch·ªâ "ƒêang l√†m vi·ªác")
            // 2. HO·∫∂C ƒë√¢y l√† gi√° tr·ªã ƒë√£ ƒë∆∞·ª£c ch·ªçn (gi·ªØ d·ªØ li·ªáu l·ªãch s·ª≠)
            if (isActive || isSelected) {
                // N·∫øu kh√¥ng active nh∆∞ng ƒë∆∞·ª£c ch·ªçn, th√™m disabled ƒë·ªÉ kh√¥ng cho ch·ªçn l·∫°i
                const disabledAttr = (!isActive && isSelected) ? " disabled" : "";
                options.push(`<option value="${value}" ${selected}${disabledAttr}>${label}</option>`);
            }
        } else {
            // C√°c dropdown kh√°c gi·ªØ nguy√™n logic c≈©
            options.push(`<option value="${value}" ${selected}>${label}</option>`);
        }
    });
    return options.join('');
}

function initSheets() {
    // Kh·ªüi t·∫°o d·ªØ li·ªáu sheet t·ª´ routes + d·ªØ li·ªáu ƒë√£ l∆∞u
    routes.forEach(route => {
        const key = route.route_code || route.route_name || "Sheet";
        sheetData[key] = buildRowsForRoute(key, route);
    });

    // N·∫øu c√≥ sheet l∆∞u m√† kh√¥ng c√≤n trong routes v·∫´n gi·ªØ l·∫°i
    Object.keys(savedDetails || {}).forEach(key => {
        if (!sheetData[key]) {
            sheetData[key] = buildRowsFromSaved(key);
        }
    });

    // Th√™m sheet "B·ªô l·ªçc" ·ªü ƒë·∫ßu danh s√°ch
    sheetData["B·ªô l·ªçc"] = null;
    
    // Th√™m sheet Total (kh√¥ng c√≥ d·ªØ li·ªáu, ch·ªâ ƒë·ªÉ hi·ªÉn th·ªã t·ªïng h·ª£p)
    sheetData["Total"] = null;

    const sheetKeys = Object.keys(sheetData);
    if (sheetKeys.length > 0) {
        activeSheetKey = "B·ªô l·ªçc"; // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã sheet "B·ªô l·ªçc" ƒë·∫ßu ti√™n
    }

    renderTabs();
    renderActiveSheet();
}

function buildRowsForRoute(sheetKey, route) {
    // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho sheet "TƒÉng c∆∞·ªùng"
    const isTangCuong = (sheetKey || "").toUpperCase().includes("TƒÇNG C∆Ø·ªúNG") || 
                        (route.route_code || "").toUpperCase().includes("TƒÇNG C∆Ø·ªúNG");
    
    if (isTangCuong) {
        // V·ªõi TƒÉng c∆∞·ªùng, ch·ªâ load d·ªØ li·ªáu ƒë√£ l∆∞u (kh√¥ng t·∫°o theo ng√†y)
        const saved = savedDetails && savedDetails[sheetKey] ? savedDetails[sheetKey] : [];
        return saved.map(item => {
            const row = {
                sheet_name: sheetKey,
                route_code: item.route_code || route.route_code || sheetKey,
                route_name: item.route_name || route.route_name || sheetKey,
                route_type: item.route_type || route.route_type || "",
                itinerary: item.itinerary || "",
                date: item.date || dateRange[0] || "",
                license_plate: item.license_plate || "",
                driver_name: item.driver_name || "",
                trip_code: item.trip_code || "",
                notes: item.notes || "",
                distance_km: item.distance_km || 0,
                unit_price: item.unit_price || 0,
                bridge_fee: item.bridge_fee || 0,
                loading_fee: item.loading_fee || 0
            };
            row.total_amount = calculateTotal(row);
            return row;
        });
    }
    
    // C√°c sheet kh√°c: t·∫°o theo ng√†y nh∆∞ c≈©
    const savedByDate = indexSaved(sheetKey);
    // Ng√†y hi·ªáu l·ª±c gi√° m·ªõi: 18/12/2025
    const newPriceEffectiveDate = "2025-12-18";
    
    return dateRange.map((d) => {
        const saved = savedByDate[d] || {};
        // X√°c ƒë·ªãnh ƒë∆°n gi√°: n·∫øu ng√†y >= 18/12/2025 v√† ch∆∞a c√≥ gi√° ƒë√£ l∆∞u, s·ª≠ d·ª•ng gi√° m·ªõi t·ª´ route
        // N·∫øu c√≥ gi√° ƒë√£ l∆∞u, gi·ªØ nguy√™n (cho ph√©p override th·ªß c√¥ng)
        let unitPrice = route.unit_price || 0;
        if (d >= newPriceEffectiveDate && !saved.unit_price) {
            // S·ª≠ d·ª•ng gi√° m·ªõi t·ª´ RoutePrice cho ng√†y >= 18/12/2025
            unitPrice = route.unit_price || 0;
        } else if (saved.unit_price !== undefined && saved.unit_price !== null) {
            // N·∫øu ƒë√£ c√≥ gi√° ƒë√£ l∆∞u, s·ª≠ d·ª•ng gi√° ƒë√≥
            unitPrice = saved.unit_price;
        }
        
        const base = {
            sheet_name: sheetKey,
            route_code: route.route_code || sheetKey,
            route_name: route.route_name || sheetKey,
            route_type: route.route_type || "",
            itinerary: route.route_name || "",
            date: d,
            license_plate: "",
            driver_name: "",
            trip_code: "",
            notes: "",
            status: "Onl", // M·∫∑c ƒë·ªãnh l√† Onl
            distance_km: route.distance || 0,
            unit_price: unitPrice,
            bridge_fee: route.bridge_fee || 0,
            loading_fee: route.loading_fee || 0
        };
        const row = {...base, ...saved};
        // ƒê·∫£m b·∫£o status c√≥ gi√° tr·ªã
        if (!row.status) row.status = "Onl";
        row.total_amount = calculateTotal(row);
        return row;
    });
}

function buildRowsFromSaved(sheetKey) {
    // X·ª≠ l√Ω ƒë·∫∑c bi·ªát cho sheet "TƒÉng c∆∞·ªùng"
    const isTangCuong = (sheetKey || "").toUpperCase().includes("TƒÇNG C∆Ø·ªúNG");
    
    if (isTangCuong) {
        // V·ªõi TƒÉng c∆∞·ªùng, ch·ªâ load d·ªØ li·ªáu ƒë√£ l∆∞u
        const saved = savedDetails && savedDetails[sheetKey] ? savedDetails[sheetKey] : [];
        return saved.map(item => {
            const row = {
                sheet_name: sheetKey,
                route_code: item.route_code || sheetKey,
                route_name: item.route_name || sheetKey,
                route_type: item.route_type || "",
                itinerary: item.itinerary || "",
                date: item.date || dateRange[0] || "",
                license_plate: item.license_plate || "",
                driver_name: item.driver_name || "",
                trip_code: item.trip_code || "",
                notes: item.notes || "",
                distance_km: item.distance_km || 0,
                unit_price: item.unit_price || 0,
                bridge_fee: item.bridge_fee || 0,
                loading_fee: item.loading_fee || 0
            };
            row.total_amount = calculateTotal(row);
            return row;
        });
    }
    
    // C√°c sheet kh√°c: t·∫°o theo ng√†y nh∆∞ c≈©
    const savedByDate = indexSaved(sheetKey);
    // Ng√†y hi·ªáu l·ª±c gi√° m·ªõi: 18/12/2025
    const newPriceEffectiveDate = "2025-12-18";
    // T√¨m route t∆∞∆°ng ·ª©ng t·ª´ routes array
    const matchingRoute = routes.find(r => 
        (r.route_code || "").trim() === sheetKey.trim() || 
        (r.route_name || "").trim() === sheetKey.trim()
    );
    
    return dateRange.map(d => {
        const saved = savedByDate[d] || {};
        // X√°c ƒë·ªãnh ƒë∆°n gi√°: n·∫øu ng√†y >= 18/12/2025 v√† ch∆∞a c√≥ gi√° ƒë√£ l∆∞u, s·ª≠ d·ª•ng gi√° m·ªõi t·ª´ route
        let unitPrice = saved.unit_price || 0;
        if (d >= newPriceEffectiveDate && !saved.unit_price && matchingRoute) {
            // S·ª≠ d·ª•ng gi√° m·ªõi t·ª´ RoutePrice cho ng√†y >= 18/12/2025
            unitPrice = matchingRoute.unit_price || 0;
        } else if (saved.unit_price !== undefined && saved.unit_price !== null) {
            // N·∫øu ƒë√£ c√≥ gi√° ƒë√£ l∆∞u, s·ª≠ d·ª•ng gi√° ƒë√≥
            unitPrice = saved.unit_price;
        }
        
        const base = {
            sheet_name: sheetKey,
            route_code: saved.route_code || sheetKey,
            route_name: saved.route_name || sheetKey,
            route_type: saved.route_type || "",
            itinerary: saved.itinerary || "",
            date: d,
            license_plate: "",
            driver_name: "",
            trip_code: saved.trip_code || "",
            notes: saved.notes || "",
            status: "Onl", // M·∫∑c ƒë·ªãnh l√† Onl
            distance_km: saved.distance_km || 0,
            unit_price: unitPrice,
            bridge_fee: saved.bridge_fee || 0,
            loading_fee: saved.loading_fee || 0
        };
        const row = {...base, ...saved};
        // ƒê·∫£m b·∫£o status c√≥ gi√° tr·ªã
        if (!row.status) row.status = "Onl";
        row.total_amount = calculateTotal(row);
        return row;
    });
}

function indexSaved(sheetKey) {
    const saved = savedDetails && savedDetails[sheetKey] ? savedDetails[sheetKey] : [];
    const idx = {};
    saved.forEach(item => {
        if (item.date) idx[item.date] = item;
    });
    return idx;
}

function renderTabs() {
    const tabContainer = document.getElementById('sheetTabs');
    tabContainer.innerHTML = '';
    
    // S·∫Øp x·∫øp sheets: B·ªô l·ªçc ·ªü ƒë·∫ßu, TƒÉng c∆∞·ªùng ·ªü cu·ªëi danh s√°ch tuy·∫øn, Total ·ªü cu·ªëi c√πng
    const sheetKeys = Object.keys(sheetData);
    const sortedKeys = sheetKeys.sort((a, b) => {
        const aIsBoLoc = a === "B·ªô l·ªçc";
        const bIsBoLoc = b === "B·ªô l·ªçc";
        const aIsTangCuong = (a || "").toUpperCase().includes("TƒÇNG C∆Ø·ªúNG");
        const bIsTangCuong = (b || "").toUpperCase().includes("TƒÇNG C∆Ø·ªúNG");
        const aIsTotal = a === "Total";
        const bIsTotal = b === "Total";
        
        // B·ªô l·ªçc lu√¥n ·ªü ƒë·∫ßu
        if (aIsBoLoc && !bIsBoLoc) return -1;
        if (!aIsBoLoc && bIsBoLoc) return 1;
        
        // Total lu√¥n ·ªü cu·ªëi
        if (aIsTotal && !bIsTotal) return 1;
        if (!aIsTotal && bIsTotal) return -1;
        
        // TƒÉng c∆∞·ªùng ·ªü cu·ªëi (tr∆∞·ªõc Total)
        if (aIsTangCuong && !bIsTangCuong && !bIsTotal) return 1;
        if (!aIsTangCuong && bIsTangCuong && !aIsTotal) return -1;
        
        // C√°c sheet kh√°c gi·ªØ nguy√™n th·ª© t·ª±
        return 0;
    });
    
    sortedKeys.forEach(key => {
        const tab = document.createElement('div');
        tab.className = `sheet-tab ${key === activeSheetKey ? 'active' : ''}`;
        tab.textContent = key;
        tab.onclick = () => {
            activeSheetKey = key;
            renderTabs();
            renderActiveSheet();
        };
        tabContainer.appendChild(tab);
    });
}

function renderActiveSheet() {
    if (!activeSheetKey) return;
    const rows = sheetData[activeSheetKey] || [];
    const container = document.getElementById('sheetContainer');
    const meta = document.getElementById('sheetMeta');

    // Ki·ªÉm tra n·∫øu l√† sheet "B·ªô l·ªçc"
    const isBoLocSheet = activeSheetKey === "B·ªô l·ªçc";
    
    // Ki·ªÉm tra n·∫øu l√† sheet "Total"
    const isTotalSheet = activeSheetKey === "Total";
    
    // Ki·ªÉm tra n·∫øu l√† sheet "TƒÉng c∆∞·ªùng"
    const isTangCuong = (activeSheetKey || "").toUpperCase().includes("TƒÇNG C∆Ø·ªúNG");
    
    // Render sheet B·ªô l·ªçc
    if (isBoLocSheet) {
        meta.innerHTML = `
            <span class="tag"><i class="fas fa-filter"></i> T√¨m ki·∫øm v√† l·ªçc d·ªØ li·ªáu</span>
        `;
        renderFilterSheet().then(html => {
            container.innerHTML = html;
        });
        return;
    }
    
    // Render sheet Total
    if (isTotalSheet) {
        meta.innerHTML = `
            <span class="tag"><i class="fas fa-calculator"></i> T·ªïng h·ª£p doanh thu</span>
            <span class="tag"><i class="fas fa-chart-line"></i> T·∫•t c·∫£ tuy·∫øn</span>
        `;
        container.innerHTML = renderTotalSheet();
        return;
    }
    
    const sample = rows[0] || {};
    if (!isTangCuong) {
        meta.innerHTML = `
            <span class="tag"><i class="fas fa-route"></i> ${sample.route_code || activeSheetKey}</span>
            <span class="tag"><i class="fas fa-info-circle"></i> ${sample.route_type || '---'}</span>
            <span class="tag"><i class="fas fa-calendar-day"></i> ${dateRange.length} ng√†y</span>
        `;
    } else {
        meta.innerHTML = `
            <span class="tag"><i class="fas fa-route"></i> ${sample.route_code || activeSheetKey}</span>
            <span class="tag"><i class="fas fa-info-circle"></i> ${sample.route_type || 'TƒÉng c∆∞·ªùng'}</span>
            <span class="tag"><i class="fas fa-list"></i> ${rows.length} chuy·∫øn</span>
        `;
    }

    const tableHtml = `
        <div class="table-wrapper">
        <table class="data-table ${isTangCuong ? 'sheet-tang-cuong' : ''}">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Ng√†y</th>
                    <th>Bi·ªÉn s·ªë xe</th>
                    <th>M√£ tuy·∫øn</th>
                    ${isTangCuong ? '<th>Lo·∫°i tuy·∫øn</th>' : ''}
                    ${!isTangCuong ? '<th class="status-column">Status</th>' : ''}
                    <th class="itinerary-column">L·ªô tr√¨nh</th>
                    <th class="distance-column">Km chuy·∫øn</th>
                    <th class="unit-price-column">ƒê∆°n gi√°</th>
                    <th>Ph√≠ c·∫ßu ƒë∆∞·ªùng</th>
                    <th>Ph√≠ ch·ªù t·∫£i</th>
                    <th>Th√†nh ti·ªÅn</th>
                    <th class="driver-column">L√°i xe</th>
                    <th>M√£ chuy·∫øn</th>
                    <th>Ghi ch√∫</th>
                    ${isTangCuong ? '<th>Thao t√°c</th>' : ''}
                </tr>
            </thead>
            <tbody>
                ${rows.length > 0 ? rows.map((row, idx) => renderRow(row, idx, isTangCuong)).join('') : ''}
                ${renderTotalRow(rows, isTangCuong)}
                ${isTangCuong ? renderAddButtonRow(isTangCuong) : ''}
            </tbody>
        </table>
        </div>
    `;
    container.innerHTML = tableHtml;
    bindEvents();
    
    // ƒêi·ªÅu ch·ªânh chi·ªÅu cao cho t·∫•t c·∫£ textarea trong c·ªôt L·ªô tr√¨nh sau khi render
    setTimeout(() => {
        const itineraryTextareas = document.querySelectorAll('textarea[data-field="itinerary"]');
        itineraryTextareas.forEach(textarea => {
            autoResizeTextarea(textarea);
        });
        // C·∫≠p nh·∫≠t d√≤ng t·ªïng sau khi render
        updateTotalSummaryRow();
    }, 100);
}

function renderRow(row, idx, isTangCuong = false) {
    // V·ªõi TƒÉng c∆∞·ªùng, ng√†y c√≥ th·ªÉ ch·ªçn ƒë∆∞·ª£c b·∫±ng date picker
    let dateInput;
    if (isTangCuong) {
        let dateValue = ""; // Gi√° tr·ªã YYYY-MM-DD cho input date
        let dateDisplay = ""; // Gi√° tr·ªã dd/mm/yyyy ƒë·ªÉ hi·ªÉn th·ªã
        if (row.date) {
            // L·∫•y gi√° tr·ªã YYYY-MM-DD
            if (typeof row.date === 'string' && row.date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                dateValue = row.date;
            } else {
                dateValue = new Date(row.date).toISOString().split('T')[0];
            }
            dateDisplay = formatDateToDDMMYYYY(dateValue);
        } else {
            // M·∫∑c ƒë·ªãnh d√πng ng√†y ƒë·∫ßu ti√™n trong dateRange
            dateValue = dateRange[0] || timekeepingTable.from_date.split('T')[0];
            dateDisplay = formatDateToDDMMYYYY(dateValue);
        }
        // L·∫•y min v√† max date ƒë·ªÉ validate
        const minDate = timekeepingTable.from_date.includes('T') ? timekeepingTable.from_date.split('T')[0] : timekeepingTable.from_date;
        const maxDate = timekeepingTable.to_date.includes('T') ? timekeepingTable.to_date.split('T')[0] : timekeepingTable.to_date;
        dateInput = `
            <div class="date-picker-wrapper" style="position: relative; display: inline-block; width: 100%; min-height: 32px;">
                <input type="date" 
                       class="date-picker-hidden" 
                       data-field="date" 
                       data-row="${idx}" 
                       value="${dateValue}" 
                       min="${minDate}" 
                       max="${maxDate}"
                       style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; pointer-events: auto;">
                <input type="text" 
                       class="input-control date-display" 
                       data-field="date-display" 
                       data-row="${idx}" 
                       value="${dateDisplay}" 
                       readonly
                       style="max-width: 120px; cursor: pointer; background-color: white; pointer-events: none; position: relative; z-index: 1;"
                       title="Click ƒë·ªÉ ch·ªçn ng√†y">
            </div>
        `;
    } else {
        const dateLabel = new Date(row.date).toLocaleDateString('vi-VN');
        dateInput = dateLabel;
    }
    
    const deleteButton = isTangCuong ? `
        <td>
            <button class="btn btn-secondary" onclick="deleteTangCuongRow(${idx})" style="padding: 6px 12px; font-size: 12px;">
                <i class="fas fa-trash"></i> X√≥a
            </button>
        </td>
    ` : '';
    
    return `
    <tr data-row="${idx}">
        <td>${idx + 1}</td>
        <td>${dateInput}</td>
        <td>
            <select class="select-control" data-field="license_plate" data-row="${idx}">
                ${buildOptions(vehicles, "license_plate", "license_plate", row.license_plate, "-- Ch·ªçn xe --")}
            </select>
        </td>
        <td><input class="input-control" data-field="route_code" data-row="${idx}" value="${row.route_code || ''}" readonly></td>
        ${isTangCuong ? `
        <td>
            <select class="select-control" data-field="route_type" data-row="${idx}">
                <option value="">-- Ch·ªçn lo·∫°i tuy·∫øn --</option>
                <option value="N·ªôi th√†nh" ${(row.route_type || '') === 'N·ªôi th√†nh' ? 'selected' : ''}>N·ªôi th√†nh</option>
                <option value="TƒÉng c∆∞·ªùng N·ªôi T·ªânh" ${(row.route_type || '') === 'TƒÉng c∆∞·ªùng N·ªôi T·ªânh' ? 'selected' : ''}>TƒÉng c∆∞·ªùng N·ªôi T·ªânh</option>
                <option value="TƒÉng c∆∞·ªùng Li√™n T·ªânh" ${(row.route_type || '') === 'TƒÉng c∆∞·ªùng Li√™n T·ªânh' ? 'selected' : ''}>TƒÉng c∆∞·ªùng Li√™n T·ªânh</option>
            </select>
        </td>
        ` : ''}
        ${!isTangCuong ? `
        <td>
            <select class="select-control" data-field="status" data-row="${idx}">
                <option value="Onl" ${(row.status || 'Onl') === 'Onl' ? 'selected' : ''}>Onl</option>
                <option value="OFF" ${(row.status || 'Onl') === 'OFF' ? 'selected' : ''}>OFF</option>
            </select>
        </td>
        ` : ''}
        <td><textarea class="input-control" data-field="itinerary" data-row="${idx}" rows="2">${row.itinerary || ''}</textarea></td>
        <td><input type="number" step="0.01" class="input-control number-cell" data-field="distance_km" data-row="${idx}" value="${row.distance_km ?? 0}"></td>
        <td><input type="number" step="0.01" class="input-control number-cell" data-field="unit_price" data-row="${idx}" value="${row.unit_price ?? 0}"></td>
        <td><input type="number" step="0.01" class="input-control number-cell" data-field="bridge_fee" data-row="${idx}" value="${row.bridge_fee ?? 0}"></td>
        <td><input type="number" step="0.01" class="input-control number-cell" data-field="loading_fee" data-row="${idx}" value="${row.loading_fee ?? 0}"></td>
        <td class="total-cell" data-total="${activeSheetKey}-${idx}">${formatNumber(row.total_amount || 0)}</td>
        <td>
            <select class="select-control" data-field="driver_name" data-row="${idx}">
                ${buildOptions(employees, "name", "name", row.driver_name, "-- Ch·ªçn l√°i xe --")}
            </select>
        </td>
        <td><input class="input-control" data-field="trip_code" data-row="${idx}" value="${row.trip_code || ''}" placeholder="Nh·∫≠p m√£ chuy·∫øn"></td>
        <td><input class="input-control" data-field="notes" data-row="${idx}" value="${row.notes || ''}" placeholder="Nh·∫≠p ghi ch√∫"></td>
        ${deleteButton}
    </tr>
    `;
}

function renderTotalRow(rows, isTangCuong = false) {
    // T√≠nh t·ªïng th√†nh ti·ªÅn c·ªßa t·∫•t c·∫£ c√°c d√≤ng
    const totalAmount = (rows || []).reduce((sum, row) => {
        return sum + (parseFloat(row.total_amount || 0) || 0);
    }, 0);
    
    // ƒê·∫øm s·ªë c·ªôt: STT(1), Ng√†y(2), Bi·ªÉn s·ªë xe(3), M√£ tuy·∫øn(4), [Lo·∫°i tuy·∫øn(5) n·∫øu TƒÉng c∆∞·ªùng ho·∫∑c Status(5) n·∫øu kh√¥ng ph·∫£i TƒÉng c∆∞·ªùng], L·ªô tr√¨nh(6), Km chuy·∫øn(7), ƒê∆°n gi√°(8), Ph√≠ c·∫ßu ƒë∆∞·ªùng(9), Ph√≠ ch·ªù t·∫£i(10)
    // Th√†nh ti·ªÅn l√† c·ªôt th·ª© 11
    const colSpanBeforeTotal = 10; // S·ªë c·ªôt tr∆∞·ªõc c·ªôt "Th√†nh ti·ªÅn" (gi·ªëng nhau cho c·∫£ hai lo·∫°i sheet)
    // Sau Th√†nh ti·ªÅn: L√°i xe, M√£ chuy·∫øn, Ghi ch√∫, [Thao t√°c n·∫øu TƒÉng c∆∞·ªùng]
    const colSpanAfterTotal = isTangCuong ? 4 : 3; // S·ªë c·ªôt sau c·ªôt "Th√†nh ti·ªÅn"
    
    return `
    <tr class="total-summary-row">
        <td colspan="${colSpanBeforeTotal}" style="text-align: right; font-weight: 700; padding: 12px 8px; background-color: #f8f9fa; border-top: 2px solid #667eea;">
            <strong>T·ªîNG C·ªòNG:</strong>
        </td>
        <td class="total-cell total-summary-cell" style="font-weight: 700; font-size: 14px; padding: 12px 8px; background-color: #f8f9fa; border-top: 2px solid #667eea; text-align: right;">
            ${formatInteger(totalAmount)}
        </td>
        <td colspan="${colSpanAfterTotal}" style="background-color: #f8f9fa; border-top: 2px solid #667eea;"></td>
    </tr>
    `;
}

function renderAddButtonRow(isTangCuong = false) {
    // T√≠nh t·ªïng s·ªë c·ªôt: STT(1), Ng√†y(2), Bi·ªÉn s·ªë xe(3), M√£ tuy·∫øn(4), Lo·∫°i tuy·∫øn(5) [ch·ªâ TƒÉng c∆∞·ªùng], Status(5) [kh√¥ng TƒÉng c∆∞·ªùng], 
    // L·ªô tr√¨nh(6), Km chuy·∫øn(7), ƒê∆°n gi√°(8), Ph√≠ c·∫ßu ƒë∆∞·ªùng(9), Ph√≠ ch·ªù t·∫£i(10), Th√†nh ti·ªÅn(11), L√°i xe(12), M√£ chuy·∫øn(13), Ghi ch√∫(14), Thao t√°c(15) [ch·ªâ TƒÉng c∆∞·ªùng]
    // V·ªõi TƒÉng c∆∞·ªùng: 14 c·ªôt (kh√¥ng c√≥ Status, c√≥ Lo·∫°i tuy·∫øn v√† Thao t√°c)
    // Kh√¥ng TƒÉng c∆∞·ªùng: 13 c·ªôt (c√≥ Status, kh√¥ng c√≥ Lo·∫°i tuy·∫øn v√† Thao t√°c)
    const totalCols = isTangCuong ? 14 : 13;
    
    return `
    <tr class="add-button-row">
        <td colspan="${totalCols}" style="padding: 20px; text-align: center; background-color: #f8f9fa; border-top: 1px solid #e9ecef;">
            <button class="btn btn-primary" onclick="addTangCuongRow()" id="addTangCuongBtn" style="padding: 12px 24px; font-size: 14px;">
                <i class="fas fa-plus"></i> T·∫°o chuy·∫øn tƒÉng c∆∞·ªùng +
            </button>
        </td>
    </tr>
    `;
}

// T√≠nh t·ªïng s·ªë ti·ªÅn c·ªßa m·ªôt sheet
function getSheetTotal(sheetKey) {
    const rows = sheetData[sheetKey] || [];
    return rows.reduce((sum, row) => {
        return sum + (parseFloat(row.total_amount || 0) || 0);
    }, 0);
}

// L·∫•y danh s√°ch t·∫•t c·∫£ c√°c sheet tuy·∫øn (kh√¥ng bao g·ªìm Total)
function getAllRouteSheets() {
    const allSheets = Object.keys(sheetData).filter(key => key !== "Total");
    
    // S·∫Øp x·∫øp: TƒÉng c∆∞·ªùng ·ªü cu·ªëi
    return allSheets.sort((a, b) => {
        const aIsTangCuong = (a || "").toUpperCase().includes("TƒÇNG C∆Ø·ªúNG");
        const bIsTangCuong = (b || "").toUpperCase().includes("TƒÇNG C∆Ø·ªúNG");
        
        if (aIsTangCuong && !bIsTangCuong) return 1;
        if (!aIsTangCuong && bIsTangCuong) return -1;
        return 0;
    });
}

// Render sheet Total
function renderTotalSheet() {
    const routeSheets = getAllRouteSheets();
    
    // T√≠nh t·ªïng c·ªông
    const tongCong = routeSheets.reduce((sum, sheetKey) => {
        return sum + getSheetTotal(sheetKey);
    }, 0);
    
    // T√≠nh c√°c kho·∫£n chi·∫øt kh·∫•u v√† thu·∫ø
    const chietKhauGHN = tongCong * 0.05;
    const chietKhauVoGia = (tongCong - chietKhauGHN) * 0.05;
    const conLai = tongCong - chietKhauGHN - chietKhauVoGia;
    const thueGTGT = conLai * 0.08;
    const tongDoanhThu = conLai + thueGTGT;
    
    return `
        <div class="table-wrapper">
            <table class="data-table" style="max-width: 800px; margin: 0 auto;">
                <thead>
                    <tr>
                        <th style="width: 60px;">STT</th>
                        <th>T√™n tuy·∫øn</th>
                        <th style="width: 150px; text-align: right;">S·ªë ti·ªÅn</th>
                        <th style="width: 120px;">Chi ti·∫øt</th>
                    </tr>
                </thead>
                <tbody>
                    ${routeSheets.map((sheetKey, idx) => {
                        const sheetTotal = getSheetTotal(sheetKey);
                        return `
                            <tr>
                                <td style="text-align: center;">${idx + 1}</td>
                                <td><strong>${sheetKey}</strong></td>
                                <td style="text-align: right; font-weight: 600;">${formatInteger(sheetTotal)}</td>
                                <td style="text-align: center;">
                                    <button class="btn btn-secondary" onclick="navigateToSheet('${sheetKey}')" style="padding: 6px 12px; font-size: 12px;">
                                        <i class="fas fa-eye"></i> Chi ti·∫øt
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                    <tr class="total-summary-row">
                        <td colspan="2" style="text-align: right; font-weight: 700; padding: 12px 8px; background-color: #f8f9fa; border-top: 2px solid #667eea;">
                            <strong>T·ªïng c·ªông</strong>
                        </td>
                        <td class="total-summary-cell" style="font-weight: 700; font-size: 14px; padding: 12px 8px; background-color: #f8f9fa; border-top: 2px solid #667eea; text-align: right;">
                            ${formatInteger(tongCong)}
                        </td>
                        <td style="background-color: #f8f9fa; border-top: 2px solid #667eea;"></td>
                    </tr>
                    <tr class="total-summary-row">
                        <td colspan="2" style="text-align: right; font-weight: 600; padding: 10px 8px; background-color: #fff3cd; border-top: 1px solid #ffc107;">
                            Chi·∫øt kh·∫•u GHN (5%)
                        </td>
                        <td style="text-align: right; font-weight: 600; padding: 10px 8px; background-color: #fff3cd; border-top: 1px solid #ffc107;">
                            ${formatInteger(chietKhauGHN)}
                        </td>
                        <td style="background-color: #fff3cd; border-top: 1px solid #ffc107;"></td>
                    </tr>
                    <tr class="total-summary-row">
                        <td colspan="2" style="text-align: right; font-weight: 600; padding: 10px 8px; background-color: #fff3cd; border-top: 1px solid #ffc107;">
                            Chi·∫øt kh·∫•u V√µ Gia (5%)
                        </td>
                        <td style="text-align: right; font-weight: 600; padding: 10px 8px; background-color: #fff3cd; border-top: 1px solid #ffc107;">
                            ${formatInteger(chietKhauVoGia)}
                        </td>
                        <td style="background-color: #fff3cd; border-top: 1px solid #ffc107;"></td>
                    </tr>
                    <tr class="total-summary-row">
                        <td colspan="2" style="text-align: right; font-weight: 600; padding: 10px 8px; background-color: #d1ecf1; border-top: 1px solid #17a2b8;">
                            C√≤n l·∫°i
                        </td>
                        <td style="text-align: right; font-weight: 600; padding: 10px 8px; background-color: #d1ecf1; border-top: 1px solid #17a2b8;">
                            ${formatInteger(conLai)}
                        </td>
                        <td style="background-color: #d1ecf1; border-top: 1px solid #17a2b8;"></td>
                    </tr>
                    <tr class="total-summary-row">
                        <td colspan="2" style="text-align: right; font-weight: 600; padding: 10px 8px; background-color: #d4edda; border-top: 1px solid #28a745;">
                            Thu·∫ø GTGT 8%
                        </td>
                        <td style="text-align: right; font-weight: 600; padding: 10px 8px; background-color: #d4edda; border-top: 1px solid #28a745;">
                            ${formatInteger(thueGTGT)}
                        </td>
                        <td style="background-color: #d4edda; border-top: 1px solid #28a745;"></td>
                    </tr>
                    <tr class="total-summary-row">
                        <td colspan="2" style="text-align: right; font-weight: 700; padding: 15px 8px; background-color: #667eea; color: white; border-top: 3px solid #5568d3; font-size: 16px;">
                            <strong>T·ªïng doanh thu (Bao g·ªìm VAT)</strong>
                        </td>
                        <td style="text-align: right; font-weight: 700; padding: 15px 8px; background-color: #667eea; color: white; border-top: 3px solid #5568d3; font-size: 16px;">
                            <strong>${formatInteger(tongDoanhThu)}</strong>
                        </td>
                        <td style="background-color: #667eea; border-top: 3px solid #5568d3;"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    `;
}

// Bi·∫øn l∆∞u k·∫øt qu·∫£ l·ªçc
let filteredResults = [];

async function renderFilterSheet() {
    // L·∫•y danh s√°ch l√°i xe, m√£ tuy·∫øn, bi·ªÉn s·ªë t·ª´ d·ªØ li·ªáu
    const allDetails = await getAllTimekeepingDetails();
    
    // L·∫•y danh s√°ch unique cho dropdowns
    const uniqueDrivers = [...new Set(allDetails.map(d => d.driver_name).filter(Boolean))].sort();
    const uniqueRouteCodes = [...new Set(allDetails.map(d => d.route_code).filter(Boolean))].sort();
    const uniqueLicensePlates = [...new Set(allDetails.map(d => d.license_plate).filter(Boolean))].sort();
    
    return `
        <div class="filter-section">
            <div class="filter-form">
                <h3 style="margin-bottom: 20px; color: #2c3e50;">
                    <i class="fas fa-filter"></i> B·ªô l·ªçc t√¨m ki·∫øm
                </h3>
                <div class="filter-row">
                    <div class="filter-group">
                        <label for="filterDriver">L√°i xe:</label>
                        <select id="filterDriver" class="select-control">
                            <option value="">T·∫•t c·∫£</option>
                            ${uniqueDrivers.map(driver => `<option value="${driver}">${driver}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterRouteCode">M√£ tuy·∫øn:</label>
                        <select id="filterRouteCode" class="select-control">
                            <option value="">T·∫•t c·∫£</option>
                            ${uniqueRouteCodes.map(route => `<option value="${route}">${route}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterLicensePlate">Bi·ªÉn s·ªë xe:</label>
                        <select id="filterLicensePlate" class="select-control">
                            <option value="">T·∫•t c·∫£</option>
                            ${uniqueLicensePlates.map(plate => `<option value="${plate}">${plate}</option>`).join('')}
                        </select>
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-primary" onclick="applyFilter()">
                            <i class="fas fa-search"></i> T√¨m ki·∫øm
                        </button>
                        <button class="btn btn-secondary" onclick="resetFilter()">
                            <i class="fas fa-redo"></i> ƒê·∫∑t l·∫°i
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="filterResults" class="filter-results" style="margin-top: 30px;">
                <div class="no-results" style="text-align: center; padding: 40px; color: #7f8c8d;">
                    <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                    <p>Vui l√≤ng ch·ªçn ƒëi·ªÅu ki·ªán l·ªçc v√† nh·∫•n "T√¨m ki·∫øm" ƒë·ªÉ xem k·∫øt qu·∫£</p>
                </div>
            </div>
        </div>
        
        <style>
        .filter-section {
            padding: 20px;
        }
        
        .filter-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
        }
        
        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .filter-results {
            background: white;
            border-radius: 10px;
            padding: 20px;
        }
        
        .filter-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .filter-results-header h4 {
            margin: 0;
            color: #2c3e50;
        }
        
        .filter-results-count {
            color: #7f8c8d;
            font-size: 14px;
        }
        </style>
    `;
}

async function getAllTimekeepingDetails() {
    // L·∫•y t·∫•t c·∫£ d·ªØ li·ªáu t·ª´ API (d·ªØ li·ªáu ƒë√£ l∆∞u trong database)
    try {
        const response = await fetch(`/api/timekeeping-v1/${timekeepingTable.id}/filter`);
        const result = await response.json();
        if (result.success) {
            return result.data || [];
        }
    } catch (error) {
        console.error('Error loading timekeeping details:', error);
    }
    return [];
}

async function applyFilter() {
    const driver = document.getElementById('filterDriver')?.value || "";
    const routeCode = document.getElementById('filterRouteCode')?.value || "";
    const licensePlate = document.getElementById('filterLicensePlate')?.value || "";
    
    // G·ªçi API ƒë·ªÉ l·ªçc d·ªØ li·ªáu
    try {
        const params = new URLSearchParams();
        if (driver) params.append('driver_name', driver);
        if (routeCode) params.append('route_code', routeCode);
        if (licensePlate) params.append('license_plate', licensePlate);
        
        const response = await fetch(`/api/timekeeping-v1/${timekeepingTable.id}/filter?${params.toString()}`);
        const result = await response.json();
        
        if (result.success) {
            filteredResults = result.data || [];
            renderFilterResults();
        } else {
            showToast(result.message || 'C√≥ l·ªói x·∫£y ra khi l·ªçc d·ªØ li·ªáu', 'error');
        }
    } catch (error) {
        showToast('C√≥ l·ªói x·∫£y ra: ' + error.message, 'error');
    }
}

function resetFilter() {
    document.getElementById('filterDriver').value = "";
    document.getElementById('filterRouteCode').value = "";
    document.getElementById('filterLicensePlate').value = "";
    filteredResults = [];
    document.getElementById('filterResults').innerHTML = `
        <div class="no-results" style="text-align: center; padding: 40px; color: #7f8c8d;">
            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
            <p>Vui l√≤ng ch·ªçn ƒëi·ªÅu ki·ªán l·ªçc v√† nh·∫•n "T√¨m ki·∫øm" ƒë·ªÉ xem k·∫øt qu·∫£</p>
        </div>
    `;
}

function renderFilterResults() {
    const resultsDiv = document.getElementById('filterResults');
    
    if (!filteredResults || filteredResults.length === 0) {
        resultsDiv.innerHTML = `
            <div class="no-results" style="text-align: center; padding: 40px; color: #7f8c8d;">
                <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                <p>Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p v·ªõi ƒëi·ªÅu ki·ªán l·ªçc</p>
            </div>
        `;
        return;
    }
    
    // S·∫Øp x·∫øp theo M√£ tuy·∫øn
    const sortedResults = [...filteredResults].sort((a, b) => {
        const routeA = (a.route_code || "").toLowerCase();
        const routeB = (b.route_code || "").toLowerCase();
        return routeA.localeCompare(routeB);
    });
    
    const totalAmount = sortedResults.reduce((sum, item) => sum + (item.total_amount || 0), 0);
    
    resultsDiv.innerHTML = `
        <div class="filter-results-header">
            <div>
                <h4><i class="fas fa-list"></i> K·∫øt qu·∫£ t√¨m ki·∫øm</h4>
                <div class="filter-results-count">T√¨m th·∫•y ${sortedResults.length} b·∫£n ghi</div>
            </div>
            <button class="btn btn-success" onclick="exportFilteredExcel()">
                <i class="fas fa-file-excel"></i> Xu·∫•t Excel
            </button>
        </div>
        <div class="table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Ng√†y</th>
                        <th>Bi·ªÉn s·ªë xe</th>
                        <th>M√£ tuy·∫øn</th>
                        <th>Status</th>
                        <th>L·ªô tr√¨nh</th>
                        <th>Km chuy·∫øn</th>
                        <th>ƒê∆°n gi√°</th>
                        <th>Ph√≠ c·∫ßu ƒë∆∞·ªùng</th>
                        <th>Ph√≠ ch·ªù t·∫£i</th>
                        <th>Th√†nh ti·ªÅn</th>
                        <th>L√°i xe</th>
                        <th>M√£ chuy·∫øn</th>
                        <th>Ghi ch√∫</th>
                    </tr>
                </thead>
                <tbody>
                    ${sortedResults.map((item, idx) => `
                        <tr>
                            <td style="text-align: center;">${idx + 1}</td>
                            <td>${formatDateToDDMMYYYY(item.date)}</td>
                            <td>${item.license_plate || ""}</td>
                            <td>${item.route_code || ""}</td>
                            <td style="text-align: center;">${item.status || "Onl"}</td>
                            <td>${item.itinerary || ""}</td>
                            <td style="text-align: right;">${formatNumber(item.distance_km || 0, 3)}</td>
                            <td style="text-align: right;">${formatInteger(item.unit_price || 0)}</td>
                            <td style="text-align: right;">${formatInteger(item.bridge_fee || 0)}</td>
                            <td style="text-align: right;">${formatInteger(item.loading_fee || 0)}</td>
                            <td style="text-align: right; font-weight: 600;">${formatInteger(item.total_amount || 0)}</td>
                            <td>${item.driver_name || ""}</td>
                            <td>${item.trip_code || ""}</td>
                            <td>${item.notes || ""}</td>
                        </tr>
                    `).join('')}
                    <tr class="total-summary-row">
                        <td colspan="10" style="text-align: right; font-weight: 700; padding: 12px 8px; background-color: #f8f9fa; border-top: 2px solid #667eea;">
                            <strong>T·ªïng c·ªông</strong>
                        </td>
                        <td class="total-summary-cell" style="font-weight: 700; font-size: 14px; padding: 12px 8px; background-color: #f8f9fa; border-top: 2px solid #667eea; text-align: right;">
                            ${formatInteger(totalAmount)}
                        </td>
                        <td colspan="3" style="background-color: #f8f9fa; border-top: 2px solid #667eea;"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    `;
}

function exportFilteredExcel() {
    const driver = document.getElementById('filterDriver')?.value || "";
    const routeCode = document.getElementById('filterRouteCode')?.value || "";
    const licensePlate = document.getElementById('filterLicensePlate')?.value || "";
    
    const params = new URLSearchParams();
    if (driver) params.append('driver_name', driver);
    if (routeCode) params.append('route_code', routeCode);
    if (licensePlate) params.append('license_plate', licensePlate);
    
    window.location.href = `/api/timekeeping-v1/${timekeepingTable.id}/export-filtered-excel?${params.toString()}`;
}

// H√†m ƒëi·ªÅu h∆∞·ªõng ƒë·∫øn sheet c·ª• th·ªÉ
function navigateToSheet(sheetKey) {
    if (sheetData[sheetKey] !== undefined) {
        activeSheetKey = sheetKey;
        renderTabs();
        renderActiveSheet();
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function autoResizeTextarea(textarea) {
    // Reset height ƒë·ªÉ t√≠nh to√°n ch√≠nh x√°c
    textarea.style.height = 'auto';
    // Set height d·ª±a tr√™n scrollHeight, t·ªëi thi·ªÉu 50px
    textarea.style.height = Math.max(50, textarea.scrollHeight) + 'px';
}

function bindEvents() {
    const inputs = document.querySelectorAll('[data-field]');
    inputs.forEach(el => {
        const field = el.dataset.field;
        const fields = ["distance_km","unit_price","bridge_fee","loading_fee","itinerary","license_plate","driver_name","route_type","trip_code","notes","date","status"];
        if (fields.includes(field)) {
            el.addEventListener('input', onCellChange);
            el.addEventListener('change', onCellChange);
            
            // T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu cao cho textarea trong c·ªôt L·ªô tr√¨nh
            if (field === 'itinerary' && el.tagName === 'TEXTAREA') {
                autoResizeTextarea(el);
                el.addEventListener('input', function() {
                    autoResizeTextarea(this);
                });
            }
        }
    });
    
    // X·ª≠ l√Ω date picker cho sheet TƒÉng c∆∞·ªùng
    const datePickers = document.querySelectorAll('.date-picker-hidden');
    datePickers.forEach(datePicker => {
        const rowIndex = Number(datePicker.dataset.row);
        const displayInput = document.querySelector(`input[data-field="date-display"][data-row="${rowIndex}"]`);
        const wrapper = datePicker.closest('.date-picker-wrapper');
        
        // Khi date picker thay ƒë·ªïi, c·∫≠p nh·∫≠t display v√† l∆∞u v√†o data
        datePicker.addEventListener('change', function() {
            const dateValue = this.value; // YYYY-MM-DD
            if (dateValue && displayInput) {
                const formattedDate = formatDateToDDMMYYYY(dateValue);
                displayInput.value = formattedDate;
                
                // L∆∞u v√†o sheetData v√† trigger validation
                const rows = sheetData[activeSheetKey];
                if (rows && rows[rowIndex]) {
                    rows[rowIndex].date = dateValue;
                }
                
                // Trigger onCellChange ƒë·ªÉ x·ª≠ l√Ω validation
                const changeEvent = new Event('change', { bubbles: true });
                datePicker.dispatchEvent(changeEvent);
            }
        });
        
        // ƒê·∫£m b·∫£o date picker c√≥ th·ªÉ nh·∫≠n click tr·ª±c ti·∫øp
        datePicker.addEventListener('click', function(e) {
            e.stopPropagation();
            // N·∫øu tr√¨nh duy·ªát h·ªó tr·ª£ showPicker, s·ª≠ d·ª•ng n√≥
            if (this.showPicker) {
                try {
                    this.showPicker();
                } catch (err) {
                    // Fallback n·∫øu showPicker kh√¥ng ho·∫°t ƒë·ªông
                    this.click();
                }
            }
        });
        
        // Khi click v√†o wrapper ho·∫∑c display input, trigger click v√†o date picker
        if (wrapper) {
            wrapper.addEventListener('click', function(e) {
                // Ch·ªâ trigger n·∫øu click kh√¥ng ph·∫£i v√†o date picker tr·ª±c ti·∫øp
                if (e.target !== datePicker) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (datePicker.showPicker) {
                        try {
                            datePicker.showPicker();
                        } catch (err) {
                            datePicker.click();
                        }
                    } else {
                        datePicker.click();
                    }
                }
            });
        }
        
        // NgƒÉn ch·∫∑n nh·∫≠p tay v√†o display input
        if (displayInput) {
            displayInput.addEventListener('keydown', function(e) {
                e.preventDefault();
            });
            
            displayInput.addEventListener('paste', function(e) {
                e.preventDefault();
            });
        }
    });
    
    // √Åp d·ª•ng lock/unlock cho t·∫•t c·∫£ c√°c d√≤ng sau khi bind events
    const rows = sheetData[activeSheetKey] || [];
    rows.forEach((row, idx) => {
        applyStatusLock(idx, row.status || "Onl");
    });
    
    // ƒêi·ªÅu ch·ªânh chi·ªÅu cao cho t·∫•t c·∫£ textarea trong c·ªôt L·ªô tr√¨nh sau khi render
    const itineraryTextareas = document.querySelectorAll('textarea[data-field="itinerary"]');
    itineraryTextareas.forEach(textarea => {
        autoResizeTextarea(textarea);
    });
}

function onCellChange(event) {
    const field = event.target.dataset.field;
    const rowIndex = Number(event.target.dataset.row);
    const value = event.target.value;
    const rows = sheetData[activeSheetKey];
    if (!rows || !rows[rowIndex]) return;

    // X·ª≠ l√Ω thay ƒë·ªïi status
    if (field === "status") {
        rows[rowIndex][field] = value;
        applyStatusLock(rowIndex, value);
        // N·∫øu chuy·ªÉn sang OFF, set revenue v·ªÅ 0
        if (value === "OFF") {
            rows[rowIndex].total_amount = 0;
            updateTotalCell(rowIndex, 0);
        } else if (value === "Onl") {
            // N·∫øu chuy·ªÉn sang Onl, t√≠nh l·∫°i revenue
            rows[rowIndex].total_amount = calculateTotal(rows[rowIndex]);
            updateTotalCell(rowIndex, rows[rowIndex].total_amount);
        }
        return;
    }

    // Ki·ªÉm tra n·∫øu status l√† OFF th√¨ kh√¥ng cho ch·ªânh s·ª≠a
    const currentStatus = rows[rowIndex].status || "Onl";
    if (currentStatus === "OFF") {
        // Kh√¥ng cho ch·ªânh s·ª≠a c√°c field khi status = OFF
        event.target.value = rows[rowIndex][field] || "";
        return;
    }

    if (["distance_km","unit_price","bridge_fee","loading_fee"].includes(field)) {
        rows[rowIndex][field] = parseFloat(value || 0) || 0;
        rows[rowIndex].total_amount = calculateTotal(rows[rowIndex]);
        updateTotalCell(rowIndex, rows[rowIndex].total_amount);
    } else if (field === "route_type") {
        rows[rowIndex][field] = value;
        rows[rowIndex].total_amount = calculateTotal(rows[rowIndex]);
        updateTotalCell(rowIndex, rows[rowIndex].total_amount);
    } else if (field === "date") {
        // X·ª≠ l√Ω ng√†y cho sheet TƒÉng c∆∞·ªùng (date picker tr·∫£ v·ªÅ YYYY-MM-DD tr·ª±c ti·∫øp)
        if (value && value.match(/^\d{4}-\d{2}-\d{2}$/)) {
            // Validate min/max date
            const minDate = timekeepingTable.from_date.includes('T') ? timekeepingTable.from_date.split('T')[0] : timekeepingTable.from_date;
            const maxDate = timekeepingTable.to_date.includes('T') ? timekeepingTable.to_date.split('T')[0] : timekeepingTable.to_date;
            if (value < minDate || value > maxDate) {
                showToast("error", `Ng√†y ph·∫£i n·∫±m trong kho·∫£ng ${formatDateToDDMMYYYY(minDate)} - ${formatDateToDDMMYYYY(maxDate)}`);
                // Kh√¥i ph·ª•c gi√° tr·ªã c≈©
                const oldDate = rows[rowIndex][field] || dateRange[0] || minDate;
                event.target.value = oldDate;
                // C·∫≠p nh·∫≠t display
                const displayInput = document.querySelector(`input[data-field="date-display"][data-row="${rowIndex}"]`);
                if (displayInput) {
                    displayInput.value = formatDateToDDMMYYYY(oldDate);
                }
                return;
            }
            rows[rowIndex][field] = value; // L∆∞u d·∫°ng YYYY-MM-DD
            // C·∫≠p nh·∫≠t display input
            const displayInput = document.querySelector(`input[data-field="date-display"][data-row="${rowIndex}"]`);
            if (displayInput) {
                displayInput.value = formatDateToDDMMYYYY(value);
            }
        }
    } else {
        rows[rowIndex][field] = value;
    }

    // Copy d√≤ng 1 xu·ªëng c√°c d√≤ng d∆∞·ªõi n·∫øu ƒëang ch·ªânh d√≤ng ƒë·∫ßu ti√™n (ch·ªâ cho sheet kh√¥ng ph·∫£i TƒÉng c∆∞·ªùng)
    const isTangCuong = (activeSheetKey || "").toUpperCase().includes("TƒÇNG C∆Ø·ªúNG");
    if (!isTangCuong) {
        const copyableFields = ["license_plate","itinerary","distance_km","unit_price","bridge_fee","loading_fee","driver_name","route_type","trip_code","notes"];
        if (rowIndex === 0 && copyableFields.includes(field)) {
            copyFirstRowDown(field);
        }
    }
}

function updateTotalCell(rowIndex, total) {
    const cell = document.querySelector(`[data-total="${activeSheetKey}-${rowIndex}"]`);
    if (cell) {
        cell.textContent = formatNumber(total || 0);
    }
    // C·∫≠p nh·∫≠t d√≤ng t·ªïng
    updateTotalSummaryRow();
    // N·∫øu ƒëang xem sheet Total, c·∫≠p nh·∫≠t l·∫°i
    if (activeSheetKey === "Total") {
        renderActiveSheet();
    }
}

function updateTotalSummaryRow() {
    // Kh√¥ng c·∫≠p nh·∫≠t n·∫øu ƒëang ·ªü sheet Total
    if (activeSheetKey === "Total") return;
    
    const rows = sheetData[activeSheetKey] || [];
    const totalAmount = rows.reduce((sum, row) => {
        return sum + (parseFloat(row.total_amount || 0) || 0);
    }, 0);
    
    const totalCell = document.querySelector('.total-summary-cell');
    if (totalCell) {
        totalCell.textContent = formatInteger(totalAmount);
    }
}

function applyStatusLock(rowIndex, status) {
    // Ch·ªâ √°p d·ª•ng cho sheet kh√¥ng ph·∫£i TƒÉng c∆∞·ªùng
    const isTangCuong = (activeSheetKey || "").toUpperCase().includes("TƒÇNG C∆Ø·ªúNG");
    if (isTangCuong) return;
    
    const row = document.querySelector(`tr[data-row="${rowIndex}"]`);
    if (!row) return;
    
    // Danh s√°ch c√°c field c·∫ßn lock/unlock
    const fieldsToLock = ["license_plate", "itinerary", "distance_km", "unit_price", "bridge_fee", "loading_fee", "driver_name", "trip_code", "notes"];
    
    fieldsToLock.forEach(field => {
        const input = row.querySelector(`[data-field="${field}"]`);
        if (input) {
            if (status === "OFF") {
                input.disabled = true;
            } else {
                input.disabled = false;
            }
        }
    });
}

function copyFirstRowDown(field) {
    const rows = sheetData[activeSheetKey];
    if (!rows || rows.length === 0) return;
    const first = rows[0];
    const fieldsToCopy = field ? [field] : ["license_plate","itinerary","distance_km","unit_price","bridge_fee","loading_fee","driver_name","route_type","trip_code","notes"];

    rows.forEach((row, idx) => {
        if (idx === 0) return;
        fieldsToCopy.forEach(f => {
            if (row[f] === "" || row[f] === null || row[f] === undefined || row[f] === 0) {
                row[f] = first[f];
                const input = document.querySelector(`[data-field="${f}"][data-row="${idx}"]`);
                if (input) input.value = first[f] ?? '';
            }
        });
        row.total_amount = calculateTotal(row);
        updateTotalCell(idx, row.total_amount);
    });
    // C·∫≠p nh·∫≠t d√≤ng t·ªïng sau khi copy
    updateTotalSummaryRow();
}

function calculateTotal(row) {
    // N·∫øu status l√† OFF, revenue = 0
    if ((row.status || "Onl") === "OFF") {
        return 0;
    }
    // N·∫øu Lo·∫°i tuy·∫øn = "N·ªôi th√†nh" ‚Üí Th√†nh ti·ªÅn = 227273 ƒë (hai trƒÉm hai m∆∞∆°i b·∫£y ngh√¨n hai trƒÉm b·∫£y m∆∞∆°i ba ƒë·ªìng)
    if ((row.route_type || "") === "N·ªôi th√†nh") {
        return 227273;
    }
    // C√°c lo·∫°i tuy·∫øn kh√°c: t√≠nh theo c√¥ng th·ª©c hi·ªán t·∫°i
    const km = parseFloat(row.distance_km || 0) || 0;
    const unit = parseFloat(row.unit_price || 0) || 0;
    const bridge = parseFloat(row.bridge_fee || 0) || 0;
    const loading = parseFloat(row.loading_fee || 0) || 0;
    return km * unit + bridge + loading;
}

function formatNumber(value) {
    return new Intl.NumberFormat('vi-VN').format(value || 0);
}

// Format s·ªë nguy√™n v·ªõi d·∫•u "." ph√¢n t√°ch h√†ng ngh√¨n (kh√¥ng c√≥ ph·∫ßn th·∫≠p ph√¢n)
function formatInteger(value) {
    const num = Math.round(parseFloat(value || 0));
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

async function saveCurrentSheet() {
    if (!activeSheetKey) return;
    // Kh√¥ng l∆∞u sheet Total
    if (activeSheetKey === "Total") {
        showToast("error", "Sheet Total kh√¥ng th·ªÉ l∆∞u. Vui l√≤ng ch·ªçn sheet tuy·∫øn ƒë·ªÉ l∆∞u.");
        return;
    }
    setLoading(true);
    // ƒê·∫£m b·∫£o total_amount = 0 n·∫øu status = OFF
    const entries = sheetData[activeSheetKey].map(row => {
        const entry = {...row};
        if ((entry.status || "Onl") === "OFF") {
            entry.total_amount = 0;
        }
        return entry;
    });
    const payload = {
        scope: "sheet",
        sheet_name: activeSheetKey,
        entries: entries
    };
    await sendSave(payload, `Sheet ${activeSheetKey} ƒë√£ l∆∞u`);
    setLoading(false);
}

async function saveAllSheets() {
    setLoading(true);
    // ƒê·∫£m b·∫£o total_amount = 0 n·∫øu status = OFF
    // B·ªè qua sheet Total
    const allEntries = Object.keys(sheetData)
        .filter(key => key !== "Total")
        .flatMap(key => 
            sheetData[key].map(row => {
                const entry = {...row, sheet_name: key};
                if ((entry.status || "Onl") === "OFF") {
                    entry.total_amount = 0;
                }
                return entry;
            })
        );
    const payload = {
        scope: "all",
        entries: allEntries
    };
    await sendSave(payload, "L∆∞u to√†n b·ªô th√†nh c√¥ng");
    setLoading(false);
}

async function sendSave(payload, successMsg) {
    try {
        const res = await fetch(`/api/timekeeping-v1/${timekeepingTable.id}/save`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) {
            showToast("success", successMsg || "ƒê√£ l∆∞u");
        } else {
            showToast("error", data.message || "L∆∞u th·∫•t b·∫°i");
        }
    } catch (err) {
        showToast("error", "L·ªói m·∫°ng ho·∫∑c m√°y ch·ªß");
    }
}

function setLoading(isLoading) {
    [document.getElementById('saveSheetBtn'), document.getElementById('saveAllBtn')].forEach(btn => {
        if (btn) btn.disabled = isLoading;
    });
}

function showToast(type, message) {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i>${message}`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// H√†m th√™m d√≤ng m·ªõi cho sheet TƒÉng c∆∞·ªùng
function addTangCuongRow() {
    const isTangCuong = (activeSheetKey || "").toUpperCase().includes("TƒÇNG C∆Ø·ªúNG");
    if (!isTangCuong) return;
    
    const rows = sheetData[activeSheetKey] || [];
    // L·∫•y ng√†y m·∫∑c ƒë·ªãnh: ∆∞u ti√™n ng√†y hi·ªán t·∫°i (today), n·∫øu kh√¥ng n·∫±m trong kho·∫£ng h·ª£p l·ªá th√¨ d√πng ng√†y ƒë·∫ßu ti√™n trong dateRange
    let defaultDate = "";
    // L·∫•y ng√†y hi·ªán t·∫°i
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0]; // Format: YYYY-MM-DD
    
    // L·∫•y min v√† max date ƒë·ªÉ validate
    const minDate = timekeepingTable.from_date.includes('T') ? timekeepingTable.from_date.split('T')[0] : timekeepingTable.from_date;
    const maxDate = timekeepingTable.to_date.includes('T') ? timekeepingTable.to_date.split('T')[0] : timekeepingTable.to_date;
    
    // Ki·ªÉm tra n·∫øu ng√†y hi·ªán t·∫°i n·∫±m trong kho·∫£ng h·ª£p l·ªá
    if (todayStr >= minDate && todayStr <= maxDate) {
        defaultDate = todayStr;
    } else if (dateRange && dateRange.length > 0) {
        // N·∫øu ng√†y hi·ªán t·∫°i kh√¥ng h·ª£p l·ªá, d√πng ng√†y ƒë·∫ßu ti√™n trong dateRange
        defaultDate = dateRange[0];
    } else {
        // Fallback: d√πng from_date
        defaultDate = minDate;
    }
    
    // T√¨m route info t·ª´ routes
    const routeInfo = routes.find(r => 
        (r.route_code || "").toUpperCase().includes("TƒÇNG C∆Ø·ªúNG") ||
        (r.route_name || "").toUpperCase().includes("TƒÇNG C∆Ø·ªúNG")
    ) || {};
    
    const newRow = {
        sheet_name: activeSheetKey,
        route_code: routeInfo.route_code || activeSheetKey,
        route_name: routeInfo.route_name || activeSheetKey,
        route_type: routeInfo.route_type || "TƒÉng c∆∞·ªùng",
        itinerary: "",
        date: defaultDate,
        license_plate: "",
        driver_name: "",
        trip_code: "",
        notes: "",
        distance_km: 0,
        unit_price: 0,
        bridge_fee: 0,
        loading_fee: 0,
        total_amount: 0
    };
    
    rows.push(newRow);
    sheetData[activeSheetKey] = rows;
    renderActiveSheet();
    // C·∫≠p nh·∫≠t d√≤ng t·ªïng sau khi render
    setTimeout(() => {
        updateTotalSummaryRow();
        // N·∫øu ƒëang xem sheet Total, c·∫≠p nh·∫≠t l·∫°i
        if (activeSheetKey === "Total") {
            renderActiveSheet();
        }
    }, 100);
}

// H√†m x√≥a d√≤ng cho sheet TƒÉng c∆∞·ªùng
function deleteTangCuongRow(rowIndex) {
    const isTangCuong = (activeSheetKey || "").toUpperCase().includes("TƒÇNG C∆Ø·ªúNG");
    if (!isTangCuong) return;
    
    if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a chuy·∫øn tƒÉng c∆∞·ªùng n√†y?")) {
        const rows = sheetData[activeSheetKey] || [];
        rows.splice(rowIndex, 1);
        sheetData[activeSheetKey] = rows;
        renderActiveSheet();
        // C·∫≠p nh·∫≠t d√≤ng t·ªïng sau khi render
        setTimeout(() => {
            updateTotalSummaryRow();
            // N·∫øu ƒëang xem sheet Total, c·∫≠p nh·∫≠t l·∫°i
            if (activeSheetKey === "Total") {
                renderActiveSheet();
            }
        }, 100);
    }
}
</script>
</div>
{% endblock %}

