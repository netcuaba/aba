{% extends "base.html" %}

{% block title %}S·ª≠a doanh thu - H·ªá th·ªëng qu·∫£n l√Ω v·∫≠n chuy·ªÉn{% endblock %}

{% block content %}
<h2>‚úèÔ∏è S·ª≠a doanh thu</h2>

<div style="background: rgba(52, 152, 219, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 30px;">
    <h3 style="color: #3498db; margin-bottom: 15px;">üìù Th√¥ng tin doanh thu</h3>
    
    <div style="margin-bottom: 15px; padding: 10px; background: rgba(241, 196, 15, 0.1); border-radius: 5px;">
        <strong>M√£ tuy·∫øn:</strong> {{ revenue_record.route.route_code }} <br>
        <strong>L·ªô tr√¨nh:</strong> {{ revenue_record.route.route_name }} <br>
        <strong>Ng√†y:</strong> {{ revenue_record.date.strftime('%d/%m/%Y') }}
    </div>
    
    <form method="post" action="/revenue/edit/{{ revenue_record.id }}" id="edit-revenue-form">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
            
            <div class="form-group">
                <label for="distance_km">Kho·∫£ng c√°ch (km) *</label>
                <input type="number" 
                       id="distance_km" 
                       name="distance_km" 
                       step="0.1" 
                       min="0"
                       value="{{ revenue_record.distance_km if revenue_record.distance_km else '' }}"
                       placeholder="0"
                       required
                       onchange="calculateTotal()">
                <small class="form-help">Kho·∫£ng c√°ch th·ª±c t·∫ø ƒë√£ ch·∫°y</small>
            </div>
            
            <div class="form-group">
                <label for="unit_price">ƒê∆°n gi√° (VNƒê/km) *</label>
                <input type="number" 
                       id="unit_price" 
                       name="unit_price" 
                       min="0"
                       value="{{ revenue_record.unit_price if revenue_record.unit_price else '' }}"
                       placeholder="0"
                       required
                       onchange="calculateTotal()">
                <small class="form-help">S·ªë nguy√™n, kh√¥ng c·∫ßn l√†m tr√≤n ngh√¨n</small>
            </div>
            
            <div class="form-group">
                <label for="bridge_fee">Ph√≠ c·∫ßu ƒë∆∞·ªùng (VNƒê)</label>
                <input type="number" 
                       id="bridge_fee" 
                       name="bridge_fee" 
                       min="0"
                       value="{{ revenue_record.bridge_fee if revenue_record.bridge_fee else '' }}"
                       placeholder="0"
                       onchange="calculateTotal()">
                <small class="form-help">S·ªë nguy√™n</small>
            </div>
            
            <div class="form-group">
                <label for="loading_fee">Ph√≠ d·ª´ng t·∫£i (VNƒê)</label>
                <input type="number" 
                       id="loading_fee" 
                       name="loading_fee" 
                       min="0"
                       value="{{ revenue_record.loading_fee if revenue_record.loading_fee else '' }}"
                       placeholder="0"
                       onchange="calculateTotal()">
                <small class="form-help">S·ªë nguy√™n</small>
            </div>
            
            <div class="form-group">
                <label for="late_penalty">Tr·ªÖ Ontime (VNƒê)</label>
                <input type="number" 
                       id="late_penalty" 
                       name="late_penalty" 
                       min="0"
                       value="{{ revenue_record.late_penalty if revenue_record.late_penalty else '' }}"
                       placeholder="0"
                       onchange="calculateTotal()">
                <small class="form-help">S·ªë nguy√™n - ph√≠ ph·∫°t tr·ªÖ gi·ªù</small>
            </div>
            
            <div class="form-group">
                <label for="status">Tr·∫°ng th√°i</label>
                <select id="status" name="status" required onchange="toggleFieldsBasedOnStatus()">
                    <option value="Online" {{ 'selected' if revenue_record.status == 'Online' else '' }}>Online</option>
                    <option value="Offline" {{ 'selected' if revenue_record.status == 'Offline' else '' }}>Offline</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="manual_total">Th√†nh ti·ªÅn th·ªß c√¥ng (VNƒê)</label>
                <input type="number" 
                       id="manual_total" 
                       name="manual_total" 
                       min="0"
                       value="{{ revenue_record.manual_total if revenue_record.manual_total else '' }}"
                       placeholder="Nh·∫≠p th·ªß c√¥ng khi c·∫ßn"
                       onchange="calculateTotal()">
                <small class="form-help">ƒê·ªÉ tr·ªëng n·∫øu mu·ªën d√πng c√¥ng th·ª©c t·ª± ƒë·ªông</small>
            </div>
        </div>
        
        <div class="form-group" style="margin-bottom: 20px;">
            <label for="notes">Ghi ch√∫</label>
            <textarea id="notes" 
                      name="notes" 
                      rows="3" 
                      placeholder="Nh·∫≠p ghi ch√∫..."
                      style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;">{{ revenue_record.notes if revenue_record.notes else '' }}</textarea>
        </div>
        
        <!-- Hi·ªÉn th·ªã th√†nh ti·ªÅn -->
        <div style="background: rgba(46, 204, 113, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
            <h4 style="color: #27ae60; margin-bottom: 10px;">üí∞ Th√†nh ti·ªÅn</h4>
            <div style="font-size: 24px; font-weight: bold; color: #27ae60;" id="total-amount">
                {{ "{:,.0f}".format(revenue_record.total_amount) }} VNƒê
            </div>
            <small style="color: #7f8c8d; font-style: italic;">
                C√¥ng th·ª©c: (Kho·∫£ng c√°ch √ó ƒê∆°n gi√°) + Ph√≠ c·∫ßu ƒë∆∞·ªùng + Ph√≠ d·ª´ng t·∫£i ‚Äì Tr·ªÖ Ontime
            </small>
        </div>
        
        <div style="text-align: center; display: flex; gap: 15px; justify-content: center;">
            <button type="submit" class="btn btn-success" style="padding: 10px 30px; font-size: 16px;">
                üíæ C·∫≠p nh·∫≠t
            </button>
            <a href="/revenue?selected_date={{ revenue_record.date.strftime('%Y-%m-%d') }}" 
               class="btn btn-secondary" 
               style="padding: 10px 30px; font-size: 16px; text-decoration: none; display: inline-block;">
                ‚Ü©Ô∏è Quay l·∫°i
            </a>
        </div>
    </form>
</div>

<!-- H∆∞·ªõng d·∫´n - ƒê√£ ·∫©n -->
<div style="display: none; margin-top: 30px; padding: 20px; background: rgba(241, 196, 15, 0.1); border-radius: 10px; border-left: 4px solid #f1c40f;">
    <h4 style="color: #f39c12; margin-bottom: 10px;">üí° H∆∞·ªõng d·∫´n:</h4>
    <ul style="color: #2c3e50; line-height: 1.6;">
        <li><strong>Kho·∫£ng c√°ch:</strong> Nh·∫≠p kho·∫£ng c√°ch th·ª±c t·∫ø ƒë√£ ch·∫°y (c√≥ th·ªÉ kh√°c v·ªõi kho·∫£ng c√°ch tuy·∫øn)</li>
        <li><strong>ƒê∆°n gi√°:</strong> Nh·∫≠p ƒë∆°n gi√° VNƒê/km (s·ªë nguy√™n)</li>
        <li><strong>Ph√≠ c·∫ßu ƒë∆∞·ªùng:</strong> C√°c kho·∫£n ph√≠ c·∫ßu ƒë∆∞·ªùng ph√°t sinh</li>
        <li><strong>Ph√≠ d·ª´ng t·∫£i:</strong> Ph√≠ ph√°t sinh khi d·ª´ng t·∫£i h√†ng</li>
        <li><strong>Tr·ªÖ Ontime:</strong> Ph√≠ ph·∫°t khi giao h√†ng tr·ªÖ gi·ªù</li>
        <li><strong>Th√†nh ti·ªÅn:</strong> ƒê∆∞·ª£c t√≠nh t·ª± ƒë·ªông theo c√¥ng th·ª©c</li>
    </ul>
</div>

<script>
// H√†m t√≠nh to√°n th√†nh ti·ªÅn t·ª± ƒë·ªông
function calculateTotal() {
    const statusSelect = document.getElementById('status');
    const manualTotalInput = document.getElementById('manual_total');
    const totalAmountDiv = document.getElementById('total-amount');
    
    // N·∫øu c√≥ nh·∫≠p th·ªß c√¥ng th√†nh ti·ªÅn, ∆∞u ti√™n s·ª≠ d·ª•ng
    if (manualTotalInput.value && parseFloat(manualTotalInput.value) > 0) {
        const manualTotal = parseFloat(manualTotalInput.value) || 0;
        totalAmountDiv.textContent = manualTotal.toLocaleString('vi-VN', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }) + ' VNƒê';
        return;
    }
    
    // N·∫øu tr·∫°ng th√°i l√† Offline v√† kh√¥ng c√≥ manual total, hi·ªÉn th·ªã 0
    if (statusSelect.value === 'Offline') {
        totalAmountDiv.textContent = '0 VNƒê';
        return;
    }
    
    // T√≠nh to√°n t·ª± ƒë·ªông cho tr·∫°ng th√°i Online
    const distanceInput = document.getElementById('distance_km');
    const priceInput = document.getElementById('unit_price');
    const bridgeFeeInput = document.getElementById('bridge_fee');
    const loadingFeeInput = document.getElementById('loading_fee');
    const latePenaltyInput = document.getElementById('late_penalty');
    
    const distance = parseFloat(distanceInput.value) || 0;
    const price = parseFloat(priceInput.value) || 0;
    const bridgeFee = parseFloat(bridgeFeeInput.value) || 0;
    const loadingFee = parseFloat(loadingFeeInput.value) || 0;
    const latePenalty = parseFloat(latePenaltyInput.value) || 0;
    
    // C√¥ng th·ª©c: (Kho·∫£ng c√°ch x ƒê∆°n gi√°) + Ph√≠ c·∫ßu ƒë∆∞·ªùng + Ph√≠ d·ª´ng t·∫£i ‚Äì Tr·ªÖ Ontime
    const total = Math.max(0, (distance * price) + bridgeFee + loadingFee - latePenalty);
    
    // ƒê·ªãnh d·∫°ng s·ªë v·ªõi d·∫•u ph·∫©y
    totalAmountDiv.textContent = total.toLocaleString('vi-VN', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    }) + ' VNƒê';
}

// H√†m x·ª≠ l√Ω khi thay ƒë·ªïi tr·∫°ng th√°i Online/Offline
function toggleFieldsBasedOnStatus() {
    const statusSelect = document.getElementById('status');
    const distanceInput = document.getElementById('distance_km');
    const priceInput = document.getElementById('unit_price');
    const bridgeFeeInput = document.getElementById('bridge_fee');
    const loadingFeeInput = document.getElementById('loading_fee');
    const latePenaltyInput = document.getElementById('late_penalty');
    const notesInput = document.getElementById('notes');
    
    const isOffline = statusSelect.value === 'Offline';
    
    // Kh√≥a/m·ªü c√°c tr∆∞·ªùng nh·∫≠p li·ªáu (tr·ª´ notes - lu√¥n cho ph√©p nh·∫≠p)
    distanceInput.disabled = isOffline;
    priceInput.disabled = isOffline;
    bridgeFeeInput.disabled = isOffline;
    loadingFeeInput.disabled = isOffline;
    latePenaltyInput.disabled = isOffline;
    notesInput.disabled = false; // Lu√¥n cho ph√©p nh·∫≠p ghi ch√∫
    
    // Thay ƒë·ªïi m√†u n·ªÅn ƒë·ªÉ hi·ªÉn th·ªã tr·∫°ng th√°i kh√≥a
    const disabledStyle = 'background-color: #f5f5f5; color: #999;';
    const enabledStyle = 'background-color: white; color: black;';
    
    const style = isOffline ? disabledStyle : enabledStyle;
    distanceInput.style.cssText += style;
    priceInput.style.cssText += style;
    bridgeFeeInput.style.cssText += style;
    loadingFeeInput.style.cssText += style;
    latePenaltyInput.style.cssText += style;
    // Notes lu√¥n c√≥ style enabled
    notesInput.style.cssText += enabledStyle;
    
    // N·∫øu chuy·ªÉn sang Offline, ƒë·∫∑t t·∫•t c·∫£ tr∆∞·ªùng v·ªÅ 0 (tr·ª´ notes)
    if (isOffline) {
        distanceInput.value = '0';
        priceInput.value = '0';
        bridgeFeeInput.value = '0';
        loadingFeeInput.value = '0';
        latePenaltyInput.value = '0';
        document.getElementById('manual_total').value = '0';
        // Kh√¥ng x√≥a notes - cho ph√©p nh·∫≠p l√Ω do offline
    }
    
    // T√≠nh l·∫°i th√†nh ti·ªÅn
    calculateTotal();
}

// Danh s√°ch c√°c tuy·∫øn c√≥ gi√° tr·ªã m·∫∑c ƒë·ªãnh 227,273
const defaultAmountRoutes = ['NA_005', 'NA_005-1', 'NA_013-02', 'NA_013-03', 'NA_013-04', 'NA_013-02-1', 'NA_014'];

// H√†m t·ª± ƒë·ªông ƒëi·ªÅn gi√° tr·ªã m·∫∑c ƒë·ªãnh cho c√°c tuy·∫øn ƒë·∫∑c bi·ªát
function autoFillDefaultAmount(routeCode) {
    if (defaultAmountRoutes.includes(routeCode)) {
        const manualTotalInput = document.getElementById('manual_total');
        if (manualTotalInput && !manualTotalInput.value) {
            manualTotalInput.value = '227273';
            calculateTotal();
        }
    }
}

// T·ª± ƒë·ªông t√≠nh to√°n khi trang load
document.addEventListener('DOMContentLoaded', function() {
    toggleFieldsBasedOnStatus();
    calculateTotal();
    autoFillDefaultAmount('{{ revenue_record.route.route_code }}');
});
</script>

{% endblock %}