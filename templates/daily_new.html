{% extends "base.html" %}

{% block title %}B·∫£ng ch·∫•m c√¥ng - H·ªá th·ªëng qu·∫£n l√Ω v·∫≠n chuy·ªÉn{% endblock %}

{% block content %}
<h2>üìÖ Ng√†y ch·∫•m c√¥ng</h2>

<!-- Date Selector -->
<div style="margin-bottom: 30px; padding: 15px; background: rgba(52, 152, 219, 0.1); border-radius: 8px;">
    <form method="get" action="/daily-new" style="display: inline-block;">
        <label for="selected_date" style="color: #2c3e50; margin-right: 10px; font-weight: bold;">Ch·ªçn ng√†y:</label>
        <input type="date" 
               id="selected_date" 
               name="selected_date" 
               value="{{ selected_date }}" 
               style="padding: 8px; border: 2px solid #3498db; border-radius: 5px; font-size: 14px;"
               onchange="this.form.submit()">
        <button type="submit" style="margin-left: 10px; padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
            üîç Xem
        </button>
    </form>
    <div style="margin-top: 10px; color: #7f8c8d; font-size: 12px;">
        Hi·ªÉn th·ªã chuy·∫øn ng√†y: <strong>{{ selected_date_display }}</strong>
    </div>
</div>

<!-- Ch·∫•m c√¥ng form -->
<div style="background: rgba(243, 156, 18, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 30px;">
    <h3 style="color: #f39c12; margin-bottom: 15px;">üìù B·∫£ng ch·∫•m c√¥ng</h3>
    
    <!-- Th√¥ng b√°o t·ª± ƒë·ªông ƒëi·ªÅn -->
    {% if previous_assignments %}
    <div style="background: rgba(52, 152, 219, 0.1); padding: 10px; border-radius: 5px; margin-bottom: 15px; border-left: 3px solid #3498db;">
        <p style="margin: 0; color: #2c3e50; font-size: 13px;">
            üí° <strong>T·ª± ƒë·ªông ƒëi·ªÅn:</strong> T√™n l√°i xe v√† bi·ªÉn s·ªë xe ƒë√£ ƒë∆∞·ª£c t·ª± ƒë·ªông l·∫•y t·ª´ ng√†y ch·∫•m c√¥ng tr∆∞·ªõc ƒë√≥ cho t·ª´ng tuy·∫øn.
        </p>
    </div>
    {% endif %}
    
    {% if routes %}
    <form method="post" action="/daily-new/add" id="dailyForm">
        <input type="hidden" name="date" value="{{ selected_date }}">
        
        <div class="table-container">
            <table class="table" style="background: white; margin-bottom: 0;">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>M√£ tuy·∫øn</th>
                        <th>S·ªë km th·ª±c t·∫ø</th>
                        <th>T√™n l√°i xe</th>
                        <th>Bi·ªÉn s·ªë xe</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Ghi ch√∫</th>
                    </tr>
                </thead>
                <tbody>
                    {% for route in routes %}
                    <tr {% if route.route_code and route.route_code.strip() == "TƒÉng C∆∞·ªùng" %}style="background-color: rgba(52, 152, 219, 0.05); border-left: 3px solid #3498db;"{% endif %}>
                        <td>{{ loop.index }}</td>
                        <td>
                            <strong>{{ route.route_code }}</strong>
                            {% if route.route_code and route.route_code.strip() == "TƒÉng C∆∞·ªùng" %}
                            <span style="font-size: 10px; background: #3498db; color: white; padding: 2px 6px; border-radius: 10px; margin-left: 5px;">Nhi·ªÅu chuy·∫øn</span>
                            {% endif %}
                        </td>
                        <td>
                            <input type="number" 
                                   name="distance_km_{{ route.id }}" 
                                   step="0.1" 
                                   placeholder="0.0">
                        </td>
                        <td>
                            <select name="driver_name_{{ route.id }}" id="driver_{{ route.id }}">
                                <option value="">Ch·ªçn l√°i xe</option>
                                {% for employee in employees %}
                                <option value="{{ employee.name }}" 
                                        {% if previous_assignments.get(route.id) and previous_assignments[route.id].driver_name == employee.name %}selected{% endif %}>
                                    {{ employee.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <select name="license_plate_{{ route.id }}" id="vehicle_{{ route.id }}">
                                <option value="">Ch·ªçn xe</option>
                                {% for vehicle in vehicles %}
                                <option value="{{ vehicle.license_plate }}"
                                        {% if previous_assignments.get(route.id) and previous_assignments[route.id].license_plate == vehicle.license_plate %}selected{% endif %}>
                                    {{ vehicle.license_plate }}
                                </option>
                                {% endfor %}
                                {% if vehicles|length == 0 %}
                                <option value="" disabled>Kh√¥ng c√≥ xe</option>
                                {% endif %}
                            </select>
                        </td>
                        <td>
                            <select name="status_{{ route.id }}">
                                <option value="Online" selected>Online</option>
                                <option value="OFF">OFF</option>
                            </select>
                        </td>
                        <td>
                            <input type="text" 
                                   name="notes_{{ route.id }}" 
                                   placeholder="Ghi ch√∫">
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div style="text-align: center;">
            <button type="submit" class="btn btn-success" style="padding: 10px 30px; font-size: 16px;">
                üíæ L∆∞u b·∫£ng ch·∫•m c√¥ng
            </button>
        </div>
    </form>
    {% else %}
    <div style="text-align: center; padding: 40px; background: rgba(39, 174, 96, 0.1); border-radius: 10px; border-left: 4px solid #27ae60;">
        <h4 style="color: #27ae60; margin-bottom: 10px;">‚úÖ Ho√†n th√†nh ch·∫•m c√¥ng tuy·∫øn th√¥ng th∆∞·ªùng!</h4>
        <p style="color: #2c3e50; margin: 0;">
            T·∫•t c·∫£ tuy·∫øn th√¥ng th∆∞·ªùng ƒë√£ ƒë∆∞·ª£c ch·∫•m c√¥ng cho ng√†y {{ selected_date_display }}.<br>
            Tuy·∫øn "TƒÉng C∆∞·ªùng" (n·∫øu c√≥) v·∫´n hi·ªÉn th·ªã ƒë·ªÉ c√≥ th·ªÉ th√™m nhi·ªÅu chuy·∫øn.<br>
            B·∫°n c√≥ th·ªÉ xem danh s√°ch chuy·∫øn ƒë√£ ghi nh·∫≠n b√™n d∆∞·ªõi.
        </p>
    </div>
    {% endif %}
</div>

<!-- Chuy·∫øn ƒë√£ ghi nh·∫≠n -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <h3 style="margin: 0;">üìã Chuy·∫øn ƒë√£ ghi nh·∫≠n</h3>
    {% if daily_routes %}
    <button onclick="deleteAllTrips()" 
            class="btn btn-danger" 
            style="background: #e74c3c; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.2s;"
            onmouseover="this.style.background='#c0392b'; this.style.transform='scale(1.05)'"
            onmouseout="this.style.background='#e74c3c'; this.style.transform='scale(1)'"
            title="X√≥a t·∫•t c·∫£ chuy·∫øn trong ng√†y">
        üóëÔ∏è Xo√° t·∫•t c·∫£
    </button>
    {% endif %}
</div>

<!-- Success message for delete all -->
{% if deleted_all == 'true' %}
<div style="background: rgba(39, 174, 96, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #27ae60;">
    <p style="margin: 0; color: #27ae60; font-weight: bold;">
        ‚úÖ ƒê√£ xo√° t·∫•t c·∫£ chuy·∫øn trong ng√†y {{ selected_date_display }}
    </p>
</div>
{% endif %}
{% if daily_routes %}
<div style="background: rgba(39, 174, 96, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
    <p style="margin: 0; color: #27ae60; font-weight: bold;">
        ‚úÖ ƒê√£ ghi nh·∫≠n {{ daily_routes|length }} chuy·∫øn ng√†y {{ selected_date_display }}
    </p>
</div>

<div class="table-container">
    <table class="table">
        <thead>
            <tr>
                <th>STT</th>
                <th>M√£ tuy·∫øn</th>
                <th>Ng√†y ch·∫°y</th>
                <th>S·ªë km</th>
                <th>L√°i xe</th>
                <th>Bi·ªÉn s·ªë xe</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ghi ch√∫</th>
                <th>Thao t√°c</th>
            </tr>
        </thead>
        <tbody>
            {% for daily_route in daily_routes %}
            <tr>
                <td>{{ loop.index }}</td>
                <td><strong>{{ daily_route.route.route_code }}</strong></td>
                <td>{{ daily_route.date.strftime('%d/%m/%Y') }}</td>
                <td>{{ daily_route.distance_km }} km</td>
                <td>{{ daily_route.driver_name }}</td>
                <td>{{ daily_route.license_plate }}</td>
                <td>
                    <span style="padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; 
                                 {% if daily_route.status == 'Online' %}background: #27ae60; color: white;{% else %}background: #e74c3c; color: white;{% endif %}">
                        {{ daily_route.status or 'Online' }}
                    </span>
                </td>
                <td>{{ daily_route.notes or 'Kh√¥ng c√≥' }}</td>
                <td>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <a href="/daily-new/edit/{{ daily_route.id }}" 
                           class="btn btn-sm" 
                           style="background: #3498db; color: white; padding: 3px 8px; font-size: 11px; text-decoration: none; border-radius: 3px; transition: all 0.2s;"
                           onmouseover="this.style.background='#2980b9'; this.style.transform='scale(1.05)'"
                           onmouseout="this.style.background='#3498db'; this.style.transform='scale(1)'"
                           title="S·ª≠a chuy·∫øn">
                            ‚úèÔ∏è S·ª≠a
                        </a>
                        <button onclick="deleteRoute({{ daily_route.id }})" 
                                class="btn btn-sm btn-danger" 
                                style="padding: 3px 8px; font-size: 11px; border: none; border-radius: 3px; transition: all 0.2s;"
                                onmouseover="this.style.transform='scale(1.05)'"
                                onmouseout="this.style.transform='scale(1)'"
                                title="X√≥a chuy·∫øn">
                            üóëÔ∏è X√≥a
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div style="margin-top: 20px; padding: 20px; background: rgba(39, 174, 96, 0.1); border-radius: 10px; border-left: 4px solid #27ae60;">
    <h4 style="color: #27ae60; margin-bottom: 10px;">üìä T·ªïng k·∫øt:</h4>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div>
            <strong>S·ªë chuy·∫øn:</strong> {{ daily_routes|length }}
        </div>
        <div>
            <strong>T·ªïng s·ªë km:</strong> {{ "{:,.1f}".format(daily_routes|sum(attribute='distance_km')) }} km
        </div>
        <div>
            <strong>S·ªë l√°i xe:</strong> {{ daily_routes|map(attribute='driver_name')|unique|list|length }}
        </div>
    </div>
</div>
{% else %}
<div style="text-align: center; padding: 40px; color: #7f8c8d;">
    <h3>üìÖ Ch∆∞a c√≥ chuy·∫øn n√†o ng√†y {{ selected_date_display }}</h3>
    <p>H√£y ghi nh·∫≠n chuy·∫øn ƒë·∫ßu ti√™n b·∫±ng form b√™n tr√™n</p>
</div>
{% endif %}

<!-- H∆∞·ªõng d·∫´n - ƒê√£ ·∫©n -->
<div style="display: none; margin-top: 30px; padding: 20px; background: rgba(241, 196, 15, 0.1); border-radius: 10px; border-left: 4px solid #f1c40f;">
    <h4 style="color: #f39c12; margin-bottom: 10px;">üí° H∆∞·ªõng d·∫´n:</h4>
    <ul style="color: #2c3e50; line-height: 1.6;">
        <li><strong>Ch·ªçn ng√†y:</strong> Ch·ªçn ng√†y c·∫ßn xem/ch·∫•m c√¥ng</li>
        <li><strong>S·ªë km:</strong> Qu√£ng ƒë∆∞·ªùng th·ª±c t·∫ø ƒë√£ ch·∫°y trong chuy·∫øn</li>
        <li><strong>T√™n l√°i xe:</strong> Ch·ªçn nh√¢n vi√™n th·ª±c hi·ªán l√°i xe trong chuy·∫øn</li>
        <li><strong>Bi·ªÉn s·ªë xe:</strong> Ch·ªçn xe t·ª´ danh s√°ch xe c√≥ s·∫µn trong h·ªá th·ªëng</li>
        <li><strong>Tr·∫°ng th√°i:</strong> Online (ho·∫°t ƒë·ªông) ho·∫∑c OFF (kh√¥ng ho·∫°t ƒë·ªông)</li>
        <li><strong>Ghi ch√∫:</strong> Th√¥ng tin b·ªï sung nh∆∞ s·ª± c·ªë, thay ƒë·ªïi, etc.</li>
        <li><strong>T·ª± ƒë·ªông ·∫©n:</strong> Tuy·∫øn th√¥ng th∆∞·ªùng ƒë√£ ch·∫•m c√¥ng s·∫Ω t·ª± ƒë·ªông ·∫©n kh·ªèi b·∫£ng ch·∫•m c√¥ng</li>
        <li><strong>Tuy·∫øn "TƒÉng C∆∞·ªùng":</strong> Lu√¥n hi·ªÉn th·ªã, c√≥ th·ªÉ th√™m nhi·ªÅu chuy·∫øn trong c√πng ng√†y</li>
    </ul>
</div>

{% if not routes and not daily_routes %}
<div style="margin-top: 20px; padding: 20px; background: rgba(231, 76, 60, 0.1); border-radius: 10px; border-left: 4px solid #e74c3c;">
    <h4 style="color: #e74c3c; margin-bottom: 10px;">‚ö†Ô∏è Ch∆∞a c√≥ tuy·∫øn n√†o:</h4>
    <p style="color: #2c3e50;">C·∫ßn t·∫°o tuy·∫øn ƒë∆∞·ªùng tr∆∞·ªõc khi ghi nh·∫≠n chuy·∫øn. <a href="/routes" style="color: #3498db;">T·∫°o tuy·∫øn ngay</a></p>
</div>
{% endif %}

<script>
function deleteRoute(routeId) {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a chuy·∫øn n√†y?')) {
        // T·∫°o form ƒë·ªÉ submit POST request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/daily-new/delete/' + routeId;
        document.body.appendChild(form);
        form.submit();
    }
}

function deleteAllTrips() {
    const selectedDate = '{{ selected_date_display }}';
    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° t·∫•t c·∫£ c√°c chuy·∫øn ƒë√£ ghi nh·∫≠n trong ng√†y ${selectedDate} kh√¥ng?`)) {
        // T·∫°o form ƒë·ªÉ submit DELETE request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/daily-new/delete-all';
        
        // Th√™m input hidden cho ng√†y
        const dateInput = document.createElement('input');
        dateInput.type = 'hidden';
        dateInput.name = 'date';
        dateInput.value = '{{ selected_date }}';
        form.appendChild(dateInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}

