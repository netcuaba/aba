{% extends "base.html" %}

{% block title %}Qu·∫£n l√Ω doanh thu - H·ªá th·ªëng qu·∫£n l√Ω v·∫≠n chuy·ªÉn{% endblock %}

{% block content %}
{# ƒê·∫£m b·∫£o c√°c bi·∫øn lu√¥n ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a #}
{% set vehicles = vehicles | default([]) %}
{% set employees = employees | default([]) %}
{% set all_routes = all_routes | default([]) %}

<h2>üí∞ Qu·∫£n l√Ω doanh thu</h2>

<!-- Date Selector -->
<div style="margin-bottom: 30px; padding: 15px; background: rgba(52, 152, 219, 0.1); border-radius: 8px;">
    <form method="get" action="/revenue" style="display: inline-block;">
        <label for="selected_date" style="color: #2c3e50; margin-right: 10px; font-weight: bold;">Ch·ªçn ng√†y:</label>
        <input type="date" 
               id="selected_date" 
               name="selected_date" 
               value="{{ filter_date.strftime('%Y-%m-%d') }}" 
               style="padding: 8px; border: 2px solid #3498db; border-radius: 5px; font-size: 14px;"
               onchange="this.form.submit()">
        <button type="submit" style="margin-left: 10px; padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
            üîç Xem
        </button>
    </form>
    <div style="margin-top: 10px; color: #7f8c8d; font-size: 12px;">
        Hi·ªÉn th·ªã doanh thu ng√†y: <strong>{{ filter_date.strftime('%d/%m/%Y') }}</strong>
        {% if filter_date == today %}
            (H√¥m nay)
        {% endif %}
    </div>
</div>

<!-- Th√¥ng b√°o v·ªÅ t√≠nh nƒÉng t·ª± ƒë·ªông -->
<div style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #3498db;">
    <p style="margin: 0; color: #2c3e50; font-size: 14px;">
        üí° <strong>Doanh thu t·ª± ƒë·ªông:</strong> Doanh thu ƒë∆∞·ª£c t·ª± ƒë·ªông t√≠nh t·ª´ d·ªØ li·ªáu ch·∫•m c√¥ng ·ªü trang daily-new. 
        Tuy·∫øn n√†o c√≥ ph√°t sinh ch·∫•m c√¥ng s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t doanh thu t∆∞∆°ng ·ª©ng.
    </p>
</div>

<!-- Form nh·∫≠p doanh thu cho tuy·∫øn TƒÉng c∆∞·ªùng (nh·∫≠p theo t·ª´ng chuy·∫øn) -->
{# L·∫•y tuy·∫øn tƒÉng c∆∞·ªùng t·ª´ all_routes ƒë·ªÉ ƒë·∫£m b·∫£o lu√¥n c√≥ #}
{% set tang_cuong_routes = all_routes | selectattr('route_code', 'equalto', 'TƒÉng C∆∞·ªùng') | list %}
{% if tang_cuong_routes|length > 0 %}
<div style="background: rgba(243, 156, 18, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 30px;">
    <h3 style="color: #5dade2; margin-bottom: 15px;">üìù Nh·∫≠p doanh thu tuy·∫øn TƒÉng c∆∞·ªùng</h3>
    <p style="color: #7f8c8d; font-size: 13px; margin-bottom: 15px;">
        Nh·∫≠p doanh thu theo t·ª´ng chuy·∫øn. N·∫øu trong ng√†y c√≥ nhi·ªÅu chuy·∫øn tƒÉng c∆∞·ªùng th√¨ nh·∫≠p nhi·ªÅu d√≤ng, m·ªói d√≤ng l√† 1 chuy·∫øn.
    </p>
    
    <form method="post" action="/revenue/add" id="revenue-form">
        <input type="hidden" name="date" value="{{ filter_date.strftime('%Y-%m-%d') }}">
        {% set tang_cuong_route = tang_cuong_routes[0] if tang_cuong_routes else None %}
        <input type="hidden" name="route_id" value="{{ tang_cuong_route.id if tang_cuong_route else '' }}">
        
        <div class="table-container">
            <table class="table" style="background: white; margin-bottom: 0;">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>T√™n tuy·∫øn</th>
                        <th>L·ªô tr√¨nh</th>
                        <th>S·ªë km</th>
                        <th>ƒê∆°n gi√° (VNƒê/km)</th>
                        <th>Ph√≠ c·∫ßu ƒë∆∞·ªùng (VNƒê)</th>
                        <th>Ph√≠ ch·ªù t·∫£i (VNƒê)</th>
                        <th>Th√†nh ti·ªÅn (VNƒê)</th>
                        <th>Bi·ªÉn s·ªë xe</th>
                        <th>T√†i x·∫ø</th>
                        <th>Ghi ch√∫</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="revenue-tbody">
                    <!-- D√≤ng m·∫´u s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                </tbody>
            </table>
        </div>
        
        <div style="text-align: center; margin-top: 15px;">
            <button type="button" onclick="addRevenueRow()" class="btn" style="padding: 8px 20px; font-size: 14px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                ‚ûï Th√™m chuy·∫øn
            </button>
            <button type="submit" class="btn btn-success" style="padding: 10px 30px; font-size: 16px;">
                üíæ L∆∞u doanh thu TƒÉng c∆∞·ªùng
            </button>
        </div>
    </form>
</div>
{% endif %}

<!-- B·∫£ng doanh thu ƒë√£ t·ª± ƒë·ªông t√≠nh -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <h3 style="margin: 0;">üìä Doanh thu ƒë√£ ghi nh·∫≠n</h3>
    {% if revenue_dict %}
    <button onclick="deleteAllRevenue()" 
            class="btn btn-danger" 
            style="background: #e74c3c; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.2s;"
            onmouseover="this.style.background='#c0392b'; this.style.transform='scale(1.05)'"
            onmouseout="this.style.background='#e74c3c'; this.style.transform='scale(1)'"
            title="X√≥a t·∫•t c·∫£ doanh thu trong ng√†y">
        üóëÔ∏è Xo√° t·∫•t c·∫£
    </button>
    {% endif %}
</div>

<!-- Success message for delete all -->
{% if deleted_all == 'true' %}
<div style="background: rgba(39, 174, 96, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #27ae60;">
    <p style="margin: 0; color: #27ae60; font-weight: bold;">
        ‚úÖ ƒê√£ xo√° t·∫•t c·∫£ doanh thu trong ng√†y {{ filter_date.strftime('%d/%m/%Y') }}
    </p>
</div>
{% endif %}

{% if revenue_dict %}
<div style="background: rgba(39, 174, 96, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
    <p style="margin: 0; color: #27ae60; font-weight: bold;">
        ‚úÖ ƒê√£ ghi nh·∫≠n {{ revenue_dict|length }} tuy·∫øn doanh thu ng√†y {{ filter_date.strftime('%d/%m/%Y') }}
    </p>
</div>

<div class="table-container">
    <table class="table">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>M√£ tuy·∫øn</th>
                        <th>Lo·∫°i tuy·∫øn</th>
                        <th>L·ªô tr√¨nh</th>
                        <th>S·ªë km m·∫∑c ƒë·ªãnh</th>
                        <th>S·ªë km th·ª±c t·∫ø</th>
                        <th>ƒê∆°n gi√° (VNƒê/km)</th>
                        <th>Ph√≠ c·∫ßu ƒë∆∞·ªùng (VNƒê)</th>
                        <th>Ph√≠ ch·ªù t·∫£i (VNƒê)</th>
                        <th>Th√†nh ti·ªÅn (VNƒê)</th>
                        <th>Bi·ªÉn s·ªë xe</th>
                        <th>T√†i x·∫ø</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Ghi ch√∫</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
        <tbody>
            {% set revenue_list = [] %}
            {% for route in all_routes %}
                {% if revenue_dict.get(route.id) %}
                    {% set records = revenue_dict[route.id] %}
                    {% if records is iterable and records is not string %}
                        {# Nhi·ªÅu records cho "TƒÉng c∆∞·ªùng" #}
                        {% for record in records %}
                            {% set _ = revenue_list.append((route, record, loop.index)) %}
                        {% endfor %}
                    {% else %}
                        {# M·ªôt record cho tuy·∫øn th∆∞·ªùng #}
                        {% set _ = revenue_list.append((route, records, 1)) %}
                    {% endif %}
                {% endif %}
            {% endfor %}
            
            {% for route, record, tang_cuong_index in revenue_list %}
            <tr>
                <td style="text-align: center; font-weight: bold;">{{ loop.index }}</td>
                <td style="white-space: nowrap;">
                    {% if route.route_code and route.route_code.strip() == "TƒÉng C∆∞·ªùng" and tang_cuong_index > 1 %}
                        <strong>{{ route.route_code }} #{{ tang_cuong_index }}</strong>
                    {% else %}
                        <strong>{{ route.route_code }}</strong>
                    {% endif %}
                </td>
                <td>
                    {% set route_type_value = record|safe_getattr('route_type') or route.route_type or 'TƒÉng c∆∞·ªùng N·ªôi T·ªânh' %}
                    <span style="padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; 
                                 background-color: {% if route_type_value == 'N·ªôi th√†nh' %}#e3f2fd{% elif route_type_value == 'TƒÉng c∆∞·ªùng N·ªôi T·ªânh' %}#f3e5f5{% elif route_type_value == 'TƒÉng c∆∞·ªùng Li√™n T·ªânh' %}#fff3e0{% else %}#f3e5f5{% endif %};
                                 color: {% if route_type_value == 'N·ªôi th√†nh' %}#1976d2{% elif route_type_value == 'TƒÉng c∆∞·ªùng N·ªôi T·ªânh' %}#7b1fa2{% elif route_type_value == 'TƒÉng c∆∞·ªùng Li√™n T·ªânh' %}#e65100{% else %}#7b1fa2{% endif %};">
                        {{ route_type_value }}
                    </span>
                </td>
                <td>
                    {{ record|safe_getattr('route_name') or '-' }}
                </td>
                <td class="number">
                    {% set route_type_check = record|safe_getattr('route_type') or route.route_type or '' %}
                    {% if route_type_check == 'N·ªôi th√†nh' %}
                        -
                    {% else %}
                        <span style="color: #7f8c8d; font-size: 0.9em;" title="S·ªë km m·∫∑c ƒë·ªãnh c·ªßa tuy·∫øn">
                            {{ "{:,.1f}".format(route.distance) if route.distance else "-" }}
                        </span>
                    {% endif %}
                </td>
                <td class="number">
                    {% set route_type_check = record|safe_getattr('route_type') or route.route_type or '' %}
                    {% if route_type_check == 'N·ªôi th√†nh' %}
                        -
                    {% else %}
                        {% set actual_km = record.distance_km if record.distance_km else (route.distance if route.distance else 0) %}
                        {% set default_km = route.distance if route.distance else 0 %}
                        {% if actual_km != default_km %}
                            <span style="color: #e67e22; font-weight: bold;" title="S·ªë km th·ª±c t·∫ø ƒë√£ ch·ªânh s·ª≠a (kh√°c s·ªë km m·∫∑c ƒë·ªãnh)">
                                {{ "{:,.1f}".format(actual_km) }}
                            </span>
                        {% else %}
                            <span style="color: #27ae60;" title="S·ªë km th·ª±c t·∫ø (b·∫±ng s·ªë km m·∫∑c ƒë·ªãnh)">
                                {{ "{:,.1f}".format(actual_km) }}
                            </span>
                        {% endif %}
                    {% endif %}
                </td>
                <td class="number">
                    {% set route_type_check = record|safe_getattr('route_type') or route.route_type or '' %}
                    {% if route_type_check == 'N·ªôi th√†nh' %}
                        {{ "{:,.0f}".format(227273) }} (c·ªë ƒë·ªãnh/chuy·∫øn)
                    {% else %}
                        {{ "{:,.0f}".format(record.unit_price) if record.unit_price else "-" }}
                    {% endif %}
                </td>
                <td class="number">{{ "{:,.0f}".format(record.bridge_fee) if record.bridge_fee else "-" }}</td>
                <td class="number">{{ "{:,.0f}".format(record.loading_fee) if record.loading_fee else "-" }}</td>
                <td class="number" style="font-weight: bold; {% if record.status and record.status.upper() in ['ONLINE', 'ON'] %}color: #27ae60;{% else %}color: #e74c3c;{% endif %}">
                    {# Chuy·∫øn OFF: doanh thu lu√¥n = 0 #}
                    {% if record.status and record.status.upper() not in ['ONLINE', 'ON'] %}
                        0
                    {% elif record.manual_total > 0 %}
                        {{ "{:,.0f}".format(record.manual_total) }}
                    {% else %}
                        {{ "{:,.0f}".format(record.total_amount) }}
                    {% endif %}
                </td>
                <td>
                    {{ record|safe_getattr('license_plate') or '-' }}
                </td>
                <td>
                    {{ record|safe_getattr('driver_name') or '-' }}
                </td>
                <td style="text-align: center;">
                    <span style="padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; 
                                 background-color: {{ '#d4edda' if record.status and record.status.upper() in ['ONLINE', 'ON'] else '#f8d7da' }};
                                 color: {{ '#155724' if record.status and record.status.upper() in ['ONLINE', 'ON'] else '#721c24' }};">
                        {{ record.status }}
                    </span>
                </td>
                <td>{{ record.notes if record.notes else "Kh√¥ng c√≥" }}</td>
                <td>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <a href="/revenue/edit/{{ record.id }}" 
                           class="btn btn-sm" 
                           style="background: #3498db; color: white; padding: 3px 8px; font-size: 11px; text-decoration: none; border-radius: 3px; transition: all 0.2s;"
                           onmouseover="this.style.background='#2980b9'; this.style.transform='scale(1.05)'"
                           onmouseout="this.style.background='#3498db'; this.style.transform='scale(1)'"
                           title="S·ª≠a doanh thu">
                            ‚úèÔ∏è S·ª≠a
                        </a>
                        <button onclick="deleteRevenue({{ record.id }})" 
                                class="btn btn-sm btn-danger" 
                                style="padding: 3px 8px; font-size: 11px; border: none; border-radius: 3px; transition: all 0.2s;"
                                onmouseover="this.style.transform='scale(1.05)'"
                                onmouseout="this.style.transform='scale(1)'"
                                title="X√≥a doanh thu">
                            üóëÔ∏è X√≥a
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
            
        </tbody>
    </table>
</div>

<div style="margin-top: 20px; padding: 20px; background: rgba(39, 174, 96, 0.1); border-radius: 10px; border-left: 4px solid #27ae60;">
    <h4 style="color: #27ae60; margin-bottom: 10px;">üìä T·ªïng k·∫øt:</h4>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div>
            <strong>S·ªë tuy·∫øn:</strong> {{ revenue_list|length }}
        </div>
        <div>
            <strong>T·ªïng doanh thu:</strong> 
            {% set revenue_amounts = [] %}
            {% for route, record, tang_cuong_index in revenue_list %}
                {# Ch·ªâ t√≠nh doanh thu cho c√°c chuy·∫øn c√≥ tr·∫°ng th√°i ON (Online) #}
                {% if record.status and record.status.upper() in ['ONLINE', 'ON'] %}
                    {% if record.manual_total > 0 %}
                        {% set _ = revenue_amounts.append(record.manual_total) %}
                    {% else %}
                        {% set _ = revenue_amounts.append(record.total_amount) %}
                    {% endif %}
                {% endif %}
            {% endfor %}
            <span style="font-size: 18px; font-weight: bold; color: #27ae60;">{{ "{:,.0f}".format(revenue_amounts | sum) }} VNƒê</span>
        </div>
        <div>
            <strong>Tr·∫°ng th√°i Online:</strong> {{ revenue_list|selectattr('1.status', 'equalto', 'Online')|list|length }}
        </div>
        <div>
            <strong>Tr·∫°ng th√°i OFF:</strong> {{ revenue_list|selectattr('1.status', 'equalto', 'OFF')|list|length }}
        </div>
    </div>
</div>
{% else %}
<div style="text-align: center; padding: 40px; color: #7f8c8d;">
    <h3>üìä Ch∆∞a c√≥ d·ªØ li·ªáu doanh thu ng√†y {{ filter_date.strftime('%d/%m/%Y') }}</h3>
    <p>Doanh thu s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c t√≠nh khi c√≥ d·ªØ li·ªáu ch·∫•m c√¥ng ·ªü trang daily-new</p>
</div>
{% endif %}

<script>
// Bi·∫øn ƒë·∫øm s·ªë d√≤ng
let revenueRowCount = 0;

// D·ªØ li·ªáu t·ª´ backend (ƒë·ªÉ t·∫°o dropdown)
const vehiclesData = {{ vehicles | tojson }} || [];
const employeesData = {{ employees | tojson }} || [];

// H√†m helper ƒë·ªÉ escape HTML
function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.toString().replace(/[&<>"']/g, m => map[m]);
}

// H√†m t·∫°o options cho dropdown xe
function createVehicleOptions() {
    if (!vehiclesData || vehiclesData.length === 0) {
        return '<option value="">Kh√¥ng c√≥ xe</option>';
    }
    return vehiclesData.map(vehicle => {
        const licensePlate = vehicle.license_plate || '';
        return `<option value="${escapeHtml(licensePlate)}">${escapeHtml(licensePlate)}</option>`;
    }).join('');
}

// H√†m t·∫°o options cho dropdown t√†i x·∫ø
function createEmployeeOptions() {
    if (!employeesData || employeesData.length === 0) {
        return '<option value="">Kh√¥ng c√≥ t√†i x·∫ø</option>';
    }
    return employeesData.map(employee => {
        const name = employee.name || '';
        return `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`;
    }).join('');
}

// H√†m t√≠nh to√°n th√†nh ti·ªÅn: ƒê∆°n gi√° √ó S·ªë km + Ph√≠ c·∫ßu ƒë∆∞·ªùng + Ph√≠ ch·ªù t·∫£i
function calculateTotal(rowIndex) {
    const distanceInput = document.getElementById(`distance_km_${rowIndex}`);
    const unitPriceInput = document.getElementById(`unit_price_${rowIndex}`);
    const bridgeFeeInput = document.getElementById(`bridge_fee_${rowIndex}`);
    const loadingFeeInput = document.getElementById(`loading_fee_${rowIndex}`);
    const totalSpan = document.getElementById(`total_${rowIndex}`);
    const totalAmountInput = document.getElementById(`total_amount_${rowIndex}`);
    
    if (!distanceInput || !unitPriceInput || !bridgeFeeInput || !loadingFeeInput || !totalSpan || !totalAmountInput) {
        return;
    }
    
    const distance = parseFloat(distanceInput.value) || 0;
    const unitPrice = parseFloat(unitPriceInput.value) || 0;
    const bridgeFee = parseFloat(bridgeFeeInput.value) || 0;
    const loadingFee = parseFloat(loadingFeeInput.value) || 0;
    
    // C√¥ng th·ª©c: ƒê∆°n gi√° √ó S·ªë km + Ph√≠ c·∫ßu ƒë∆∞·ªùng + Ph√≠ ch·ªù t·∫£i
    const total = Math.max(0, (distance * unitPrice) + bridgeFee + loadingFee);
    
    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
    totalSpan.textContent = total.toLocaleString('vi-VN', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    });
    totalAmountInput.value = Math.round(total);
}

// H√†m th√™m d√≤ng m·ªõi
function addRevenueRow() {
    revenueRowCount++;
    const tbody = document.getElementById('revenue-tbody');
    if (!tbody) return;
    
    const row = document.createElement('tr');
    row.setAttribute('data-row-index', revenueRowCount);
    
    // T·∫°o HTML cho d√≤ng m·ªõi
    row.innerHTML = `
        <td style="text-align: center; font-weight: bold;">${revenueRowCount}</td>
        <td style="font-weight: bold; color: #2c3e50;">TƒÉng c∆∞·ªùng</td>
        <td>
            <input type="text" 
                   name="route_name_${revenueRowCount}" 
                   id="route_name_${revenueRowCount}"
                   placeholder="Nh·∫≠p l·ªô tr√¨nh..."
                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
        </td>
        <td>
            <input type="number" 
                   name="distance_km_${revenueRowCount}" 
                   id="distance_km_${revenueRowCount}"
                   step="0.1" 
                   min="0"
                   placeholder="0"
                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;"
                   onchange="calculateTotal(${revenueRowCount})"
                   oninput="calculateTotal(${revenueRowCount})">
        </td>
        <td>
            <input type="number" 
                   name="unit_price_${revenueRowCount}" 
                   id="unit_price_${revenueRowCount}"
                   min="0"
                   placeholder="0"
                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;"
                   onchange="calculateTotal(${revenueRowCount})"
                   oninput="calculateTotal(${revenueRowCount})">
        </td>
        <td>
            <input type="number" 
                   name="bridge_fee_${revenueRowCount}" 
                   id="bridge_fee_${revenueRowCount}"
                   min="0"
                   value="0"
                   placeholder="0"
                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;"
                   onchange="calculateTotal(${revenueRowCount})"
                   oninput="calculateTotal(${revenueRowCount})">
        </td>
        <td>
            <input type="number" 
                   name="loading_fee_${revenueRowCount}" 
                   id="loading_fee_${revenueRowCount}"
                   min="0"
                   value="0"
                   placeholder="0"
                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;"
                   onchange="calculateTotal(${revenueRowCount})"
                   oninput="calculateTotal(${revenueRowCount})">
        </td>
        <td>
            <span id="total_${revenueRowCount}" style="font-weight: bold; color: #27ae60; font-size: 14px;">0</span>
            <input type="hidden" 
                   name="total_amount_${revenueRowCount}" 
                   id="total_amount_${revenueRowCount}"
                   value="0">
        </td>
        <td>
            <select name="license_plate_${revenueRowCount}" 
                    id="license_plate_${revenueRowCount}"
                    style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                <option value="">Ch·ªçn xe</option>
                ${createVehicleOptions()}
            </select>
        </td>
        <td>
            <select name="driver_name_${revenueRowCount}" 
                    id="driver_name_${revenueRowCount}"
                    style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                <option value="">Ch·ªçn t√†i x·∫ø</option>
                ${createEmployeeOptions()}
            </select>
        </td>
        <td>
            <input type="text" 
                   name="notes_${revenueRowCount}" 
                   id="notes_${revenueRowCount}"
                   placeholder="Ghi ch√∫..."
                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
        </td>
        <td>
            <button type="button" 
                    onclick="removeRevenueRow(${revenueRowCount})" 
                    class="btn btn-sm btn-danger" 
                    style="padding: 3px 8px; font-size: 11px; border: none; border-radius: 3px; cursor: pointer; background: #e74c3c; color: white;"
                    title="X√≥a d√≤ng">
                üóëÔ∏è
            </button>
        </td>
    `;
    
    tbody.appendChild(row);
}

// H√†m x√≥a d√≤ng
function removeRevenueRow(rowIndex) {
    const row = document.querySelector(`tr[data-row-index="${rowIndex}"]`);
    if (row) {
        row.remove();
        // C·∫≠p nh·∫≠t l·∫°i STT
        updateRowNumbers();
    }
}

// H√†m c·∫≠p nh·∫≠t s·ªë th·ª© t·ª±
function updateRowNumbers() {
    const rows = document.querySelectorAll('#revenue-tbody tr[data-row-index]');
    rows.forEach((row, index) => {
        const newIndex = index + 1;
        const sttCell = row.querySelector('td:first-child');
        if (sttCell) {
            sttCell.textContent = newIndex;
        }
    });
}

// Kh·ªüi t·∫°o: Th√™m d√≤ng ƒë·∫ßu ti√™n khi trang load
document.addEventListener('DOMContentLoaded', function() {
    // Th√™m 1 d√≤ng m·∫∑c ƒë·ªãnh
    addRevenueRow();
});

// H√†m x√≥a m·ªôt doanh thu
function deleteRevenue(revenueId) {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a doanh thu n√†y?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/revenue/delete/' + revenueId;
        document.body.appendChild(form);
        form.submit();
    }
}

// H√†m x√≥a t·∫•t c·∫£ doanh thu trong ng√†y
function deleteAllRevenue() {
    const selectedDate = '{{ filter_date.strftime('%d/%m/%Y') }}';
    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° t·∫•t c·∫£ doanh thu ƒë√£ ghi nh·∫≠n trong ng√†y ${selectedDate} kh√¥ng?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/revenue/delete-all';
        
        const dateInput = document.createElement('input');
        dateInput.type = 'hidden';
        dateInput.name = 'date';
        dateInput.value = '{{ filter_date.strftime('%Y-%m-%d') }}';
        form.appendChild(dateInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>

{% endblock %}
