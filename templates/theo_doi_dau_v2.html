{% extends "base.html" %}

{% block title %}Theo d√µi d·∫ßu V2 - H·ªá th·ªëng qu·∫£n l√Ω v·∫≠n chuy·ªÉn{% endblock %}

{% block content %}
<div class="theo-doi-dau-v2-page">
    <div class="page-header">
        <div class="header-content">
            <h2>‚õΩ Theo d√µi d·∫ßu V2</h2>
            <button type="button" class="btn btn-primary" onclick="showAddModal()">
                ‚ûï Th√™m m·ªõi
            </button>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="sheet-tabs">
        <button class="sheet-tab active" onclick="switchSheet('total')" id="tabTotal">
            üìä Total
        </button>
        <button class="sheet-tab" onclick="switchSheet('khoan-dau')" id="tabKhoanDau">
            ‚õΩ Kho√°n d·∫ßu
        </button>
        <button class="sheet-tab" onclick="switchSheet('danh-sach')" id="tabDanhSach">
            üìã Danh s√°ch ƒë·ªï d·∫ßu
        </button>
        <button class="sheet-tab" onclick="switchSheet('gia-dau')" id="tabGiaDau">
            üí∞ Gi√° d·∫ßu
        </button>
    </div>

    <!-- Sheet Total -->
    <div class="card sheet-content" id="sheetTotal">
        <div class="section-header">
            <h3>üìä Total</h3>
        </div>
        
        <!-- B·ªô l·ªçc t√¨m ki·∫øm -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="filterFromDate">T·ª´ ng√†y <span class="required">*</span></label>
                    <input type="date" id="filterFromDate" class="filter-input" onchange="loadTotals()">
                </div>
                <div class="filter-group">
                    <label for="filterToDate">ƒê·∫øn ng√†y <span class="required">*</span></label>
                    <input type="date" id="filterToDate" class="filter-input" onchange="loadTotals()">
                </div>
                <div class="filter-group">
                    <label for="filterLicensePlate">Bi·ªÉn s·ªë xe</label>
                    <select id="filterLicensePlate" class="filter-input" onchange="loadTotals()">
                        <option value="T·∫•t c·∫£">T·∫•t c·∫£</option>
                        {% for vehicle in vehicles %}
                        <option value="{{ vehicle.license_plate }}">{{ vehicle.license_plate }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <button type="button" class="btn btn-primary" onclick="loadTotals()">
                        üîç T√¨m ki·∫øm
                    </button>
                </div>
            </div>
        </div>
        
        <!-- B·∫£ng t·ªïng h·ª£p -->
        <div class="table-container-scroll">
            <table class="fuel-totals-table" id="fuelTotalsTable">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Bi·ªÉn s·ªë xe</th>
                        <th>T·ªïng s·ªë l√≠t d·∫ßu ƒë·ªï</th>
                        <th>T·ªïng s·ªë ti·ªÅn d·∫ßu ƒë·ªï</th>
                        <th>Chi ti·∫øt</th>
                    </tr>
                </thead>
                <tbody id="fuelTotalsBody">
                    <tr>
                        <td colspan="5" class="text-center">Vui l√≤ng ch·ªçn kho·∫£ng th·ªùi gian v√† nh·∫•n "T√¨m ki·∫øm"</td>
                    </tr>
                </tbody>
                <tfoot id="fuelTotalsFooter" style="display: none;">
                    <tr class="summary-row">
                        <td colspan="2"><strong>T·ªïng c·ªông</strong></td>
                        <td class="number"><strong id="totalLitersFooter">0.00 l√≠t</strong></td>
                        <td class="number"><strong id="totalCostFooter">0 ƒë</strong></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Sheet Kho√°n d·∫ßu -->
    <div class="card sheet-content" id="sheetKhoanDau" style="display: none;">
        <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0;">‚õΩ Kho√°n d·∫ßu (Xe nh√†)</h3>
            <button type="button" class="btn btn-success" id="exportQuotaExcelBtn" onclick="exportFuelQuotaExcel()" style="display: none;">
                <i class="fas fa-file-excel"></i> Xu·∫•t Excel
            </button>
        </div>
        
        <!-- B·ªô l·ªçc kho√°n d·∫ßu -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="quotaFromDate">T·ª´ ng√†y <span class="required">*</span></label>
                    <input type="date" id="quotaFromDate" class="filter-input">
                </div>
                <div class="filter-group">
                    <label for="quotaToDate">ƒê·∫øn ng√†y <span class="required">*</span></label>
                    <input type="date" id="quotaToDate" class="filter-input">
                </div>
                <div class="filter-group">
                    <label for="quotaLicensePlate">Bi·ªÉn s·ªë xe (ch·ªâ Xe nh√†) <span class="required">*</span></label>
                    <select id="quotaLicensePlate" class="filter-input">
                        <option value="">-- Ch·ªçn bi·ªÉn s·ªë xe (Xe Nh√†) --</option>
                        {% for vehicle in vehicles %}
                            {% if vehicle.vehicle_type == 'Xe Nh√†' %}
                            <option value="{{ vehicle.license_plate }}">{{ vehicle.license_plate }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <button type="button" class="btn btn-primary" onclick="loadFuelQuotaComparison()">
                        üîç T√¨m ki·∫øm
                    </button>
                </div>
            </div>
            <p class="info-text" style="margin-top: 10px;">Ngu·ªìn d·ªØ li·ªáu: ch·∫•m c√¥ng chi ti·∫øt (timekeeping-v1) + gi√° d·∫ßu theo ng√†y. Ch·ªâ t√≠nh chuy·∫øn c√≥ Km > 0 v√† c√≥ gi√° d·∫ßu √°p d·ª•ng.</p>
        </div>
        
        <!-- B·∫£ng kho√°n d·∫ßu -->
        <div class="table-container-scroll">
            <table class="fuel-records-table" id="fuelQuotaTable">
                <thead>
                    <tr>
                        <th>Ng√†y</th>
                        <th>Bi·ªÉn s·ªë xe</th>
                        <th>M√£ tuy·∫øn</th>
                        <th>Km chuy·∫øn</th>
                        <th>DK</th>
                        <th>Ti·ªÅn d·∫ßu</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>L√°i xe</th>
                    </tr>
                </thead>
                <tbody id="fuelQuotaBody">
                    <tr>
                        <td colspan="8" class="text-center">Ch·ªçn kho·∫£ng ng√†y, bi·ªÉn s·ªë r·ªìi b·∫•m "T√¨m ki·∫øm" ƒë·ªÉ xem kho√°n d·∫ßu.</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr class="summary-row">
                        <td colspan="4"><strong>T·ªïng kho√°n</strong></td>
                        <td class="number"><strong id="quotaTotalLiters">0.00 l√≠t</strong></td>
                        <td class="number"><strong id="quotaTotalCost">0 ƒë</strong></td>
                        <td colspan="2"></td>
                    </tr>
                    <tr class="summary-row">
                        <td colspan="4"><strong>D·∫ßu th·ª±c t·∫ø</strong></td>
                        <td class="number"><strong id="actualTotalLiters">0.00 l√≠t</strong></td>
                        <td class="number"><strong id="actualTotalCost">0 ƒë</strong></td>
                        <td colspan="2"></td>
                    </tr>
                    <tr class="summary-row">
                        <td colspan="4"><strong>Ch√™nh l·ªách (Kho√°n - Th·ª±c t·∫ø)</strong></td>
                        <td class="number"><strong id="diffLiters">0.00 l√≠t</strong></td>
                        <td class="number"><strong id="diffCost">0 ƒë</strong></td>
                        <td colspan="2"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <p class="info-text" id="fuelQuotaNote" style="margin-top: 12px;"></p>
    </div>

    <!-- Sheet Danh s√°ch ƒë·ªï d·∫ßu -->
    <div class="card sheet-content" id="sheetDanhSach" style="display: none;">
        <div class="section-header">
            <h3>üìã Danh s√°ch ƒë·ªï d·∫ßu</h3>
        </div>
        
        <!-- B·ªô l·ªçc theo th√°ng -->
        <div class="month-filter-section" style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;">
            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <label for="filterMonthYear" style="font-weight: 600; color: #2c3e50;">Th√°ng/NƒÉm:</label>
                    <input type="month" id="filterMonthYear" name="month_year" value="{{ '%04d-%02d'|format(selected_year, selected_month) }}" min="2000-01" max="2100-12" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; min-width: 150px;">
                </div>
                
                <button type="button" class="btn btn-primary" onclick="applyMonthFilter()" style="padding: 8px 20px;">
                    <i class="fas fa-filter"></i> L·ªçc
                </button>
                
                <button type="button" class="btn btn-secondary" onclick="resetMonthFilter()" style="padding: 8px 20px;">
                    <i class="fas fa-redo"></i> Reset
                </button>
            </div>
        </div>
        
        <!-- T·ªïng h·ª£p th√°ng -->
        <div class="month-summary" style="margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
            <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px;">
                <div style="text-align: center;">
                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">Th√°ng ƒëang xem</div>
                    <div style="font-size: 20px; font-weight: 700;">Th√°ng {{ selected_month }}/{{ selected_year }}</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">T·ªïng s·ªë l√≠t d·∫ßu</div>
                    <div style="font-size: 20px; font-weight: 700;" id="summaryTotalLiters">{{ "{:,.2f}".format(total_liters) }} l√≠t</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 12px; opacity: 0.9; margin-bottom: 5px;">T·ªïng s·ªë ti·ªÅn d·∫ßu</div>
                    <div style="font-size: 20px; font-weight: 700;" id="summaryTotalCost">{{ "{:,.0f}".format(total_cost) }} ƒë</div>
                </div>
            </div>
        </div>
        
        <div class="table-container-scroll">
            <table class="fuel-records-table" id="fuelRecordsTable">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Ng√†y</th>
                        <th>Bi·ªÉn s·ªë xe</th>
                        <th>ƒê∆°n gi√° d·∫ßu</th>
                        <th>S·ªë l√≠t d·∫ßu ƒë·ªï</th>
                        <th>Th√†nh ti·ªÅn</th>
                        <th>Ghi ch√∫</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="fuelRecordsBody">
                    {% if fuel_records %}
                        {% for record in fuel_records %}
                        <tr data-record-id="{{ record.id }}">
                            <td>{{ loop.index }}</td>
                            <td>{{ record.date.strftime('%d/%m/%Y') }}</td>
                            <td><strong>{{ record.license_plate }}</strong></td>
                            <td class="number">{{ "{:,.0f}".format(record.fuel_price_per_liter) }} ƒë</td>
                            <td class="number">{{ "{:,.2f}".format(record.liters_pumped) }} l√≠t</td>
                            <td class="number"><strong>{{ "{:,.0f}".format(record.cost_pumped) }} ƒë</strong></td>
                            <td>{{ record.notes or '' }}</td>
                            <td class="actions">
                                <button class="btn btn-warning btn-sm" onclick="editRecord({{ record.id }})" title="S·ª≠a">
                                    ‚úèÔ∏è S·ª≠a
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteRecord({{ record.id }})" title="X√≥a">
                                    üóëÔ∏è X√≥a
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="8" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªï d·∫ßu trong th√°ng {{ selected_month }}/{{ selected_year }}.</td>
                        </tr>
                    {% endif %}
                </tbody>
                <tfoot id="summaryRow">
                    {% if fuel_records %}
                    <tr class="summary-row" style="background-color: #f8f9fa; font-weight: 700;">
                        <td colspan="3"><strong>T·ªïng th√°ng {{ selected_month }}/{{ selected_year }}</strong></td>
                        <td></td>
                        <td class="number"><strong id="totalLiters">{{ "{:,.2f}".format(total_liters) }} l√≠t</strong></td>
                        <td class="number"><strong id="totalCost">{{ "{:,.0f}".format(total_cost) }} ƒë</strong></td>
                        <td></td>
                        <td></td>
                    </tr>
                    {% endif %}
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Sheet Gi√° d·∫ßu -->
    <div class="card sheet-content" id="sheetGiaDau" style="display: none;">
        <div class="section-header">
            <h3>üí∞ Gi√° d·∫ßu Diesel 0.05S</h3>
        </div>
        
        <div style="margin-bottom: 20px;">
            <button type="button" class="btn btn-primary" onclick="showAddPriceModal()">
                ‚ûï C·∫≠p nh·∫≠t gi√° xƒÉng d·∫ßu h√¥m nay
            </button>
        </div>
        
        <div class="table-container-scroll">
            <table class="fuel-records-table" id="dieselPriceTable">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>Ng√†y √°p d·ª•ng</th>
                        <th>ƒê∆°n gi√° d·∫ßu</th>
                        <th>Ng√†y t·∫°o</th>
                        <th>Thao t√°c</th>
                    </tr>
                </thead>
                <tbody id="dieselPriceBody">
                    {% if diesel_prices %}
                        {% for price in diesel_prices %}
                        <tr data-price-id="{{ price.id }}">
                            <td>{{ loop.index }}</td>
                            <td>{{ price.application_date.strftime('%d/%m/%Y') }}</td>
                            <td class="number"><strong>{{ "{:,.0f}".format(price.unit_price) }} ƒë</strong></td>
                            <td>{{ price.created_at.strftime('%d/%m/%Y %H:%M') if price.created_at else '' }}</td>
                            <td class="actions">
                                <button class="btn btn-warning btn-sm" onclick="editPrice({{ price.id }})" title="S·ª≠a">
                                    ‚úèÔ∏è S·ª≠a
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="5" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu gi√° d·∫ßu. Nh·∫•n n√∫t "C·∫≠p nh·∫≠t gi√° xƒÉng d·∫ßu h√¥m nay" ƒë·ªÉ th√™m m·ªõi.</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Th√™m m·ªõi / S·ª≠a -->
<div id="recordModal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 id="modalTitle">‚ûï Th√™m b·∫£n ghi m·ªõi</h3>
            <button class="modal-close" onclick="closeModal()" title="ƒê√≥ng">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Form ƒë∆°n (cho s·ª≠a) -->
            <form id="recordForm" onsubmit="saveRecord(event)" style="display: none;">
                <input type="hidden" id="recordId" name="record_id">
                
                <div class="form-group">
                    <label for="date">Ng√†y <span class="required">*</span></label>
                    <input type="date" id="date" name="date" required>
                </div>
                
                <div class="form-group">
                    <label for="license_plate">Bi·ªÉn s·ªë xe <span class="required">*</span></label>
                    <select id="license_plate" name="license_plate" required>
                        <option value="">-- Ch·ªçn bi·ªÉn s·ªë xe --</option>
                        {% for vehicle in vehicles %}
                        <option value="{{ vehicle.license_plate }}">{{ vehicle.license_plate }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="unit_price">ƒê∆°n gi√° d·∫ßu (ƒë·ªìng/l√≠t) <span class="required">*</span></label>
                    <input type="number" id="unit_price" name="unit_price" step="0.01" min="0" required oninput="calculateTotal()">
                </div>
                
                <div class="form-group">
                    <label for="liters">S·ªë l√≠t d·∫ßu ƒë·ªï <span class="required">*</span></label>
                    <input type="number" id="liters" name="liters" step="0.01" min="0" required oninput="calculateTotal()">
                </div>
                
                <div class="form-group">
                    <label for="total_amount">Th√†nh ti·ªÅn</label>
                    <input type="text" id="total_amount" name="total_amount" readonly>
                </div>
                
                <div class="form-group">
                    <label for="notes">Ghi ch√∫</label>
                    <textarea id="notes" name="notes" rows="3" placeholder="Nh·∫≠p ghi ch√∫ (n·∫øu c√≥)"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">üíæ L∆∞u</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">‚ùå H·ªßy</button>
                </div>
            </form>
            
            <!-- Form nhi·ªÅu d√≤ng (cho th√™m m·ªõi) -->
            <div id="bulkFormContainer">
                <div class="bulk-form-header">
                    <p class="info-text">B·∫°n c√≥ th·ªÉ th√™m nhi·ªÅu d√≤ng d·ªØ li·ªáu c√πng l√∫c. Nh·∫•n "‚ûï Th√™m d√≤ng" ƒë·ªÉ th√™m d√≤ng m·ªõi.</p>
                    <button type="button" class="btn btn-primary btn-sm" onclick="addBulkRow()">
                        ‚ûï Th√™m d√≤ng
                    </button>
                </div>
                
                <div class="bulk-table-container">
                    <table class="bulk-input-table" id="bulkInputTable">
                        <thead>
                            <tr>
                                <th style="width: 50px; text-align: center;">STT</th>
                                <th style="width: 120px;">Ng√†y <span class="required">*</span></th>
                                <th style="width: 130px;">Bi·ªÉn s·ªë xe <span class="required">*</span></th>
                                <th style="width: 130px;">ƒê∆°n gi√° (ƒë/l√≠t) <span class="required">*</span></th>
                                <th style="width: 100px;">S·ªë l√≠t <span class="required">*</span></th>
                                <th style="width: 130px;">Th√†nh ti·ªÅn</th>
                                <th>Ghi ch√∫</th>
                                <th style="width: 80px; text-align: center;">H√†nh ƒë·ªông</th>
                            </tr>
                        </thead>
                        <tbody id="bulkInputBody">
                            <!-- Rows will be added dynamically -->
                        </tbody>
                    </table>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-success" onclick="saveBulkRecords()">üíæ L∆∞u t·∫•t c·∫£</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">‚ùå H·ªßy</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Chi ti·∫øt ƒë·ªï d·∫ßu -->
<div id="detailModal" class="modal" style="display: none;">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3 id="detailModalTitle">üìã Chi ti·∫øt ƒë·ªï d·∫ßu</h3>
            <button class="modal-close" onclick="closeDetailModal()" title="ƒê√≥ng">&times;</button>
        </div>
        <div class="modal-body">
            <div id="detailModalInfo" style="margin-bottom: 20px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                <p><strong>Bi·ªÉn s·ªë xe:</strong> <span id="detailLicensePlate"></span></p>
                <p><strong>Kho·∫£ng th·ªùi gian:</strong> <span id="detailDateRange"></span></p>
            </div>
            <div class="table-container-scroll" style="max-height: 500px;">
                <table class="fuel-records-table" id="detailRecordsTable">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Ng√†y ƒë·ªï d·∫ßu</th>
                            <th>S·ªë l√≠t</th>
                            <th>ƒê∆°n gi√°</th>
                            <th>S·ªë ti·ªÅn</th>
                            <th>Ghi ch√∫</th>
                            <th>H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="detailRecordsBody">
                        <!-- D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c load ƒë·ªông -->
                    </tbody>
                </table>
            </div>
            <div class="form-actions" style="margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeDetailModal()">‚ùå ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Th√™m/S·ª≠a gi√° d·∫ßu -->
<div id="priceModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="priceModalTitle">‚ûï C·∫≠p nh·∫≠t gi√° xƒÉng d·∫ßu</h3>
            <button class="modal-close" onclick="closePriceModal()" title="ƒê√≥ng">&times;</button>
        </div>
        <div class="modal-body">
            <form id="priceForm" onsubmit="savePrice(event)">
                <input type="hidden" id="priceId" name="price_id">
                
                <div class="form-group">
                    <label for="priceApplicationDate">Ng√†y c·∫≠p nh·∫≠t gi√° <span class="required">*</span></label>
                    <input type="date" id="priceApplicationDate" name="application_date" required>
                </div>
                
                <div class="form-group">
                    <label for="priceUnitPrice">ƒê∆°n gi√° d·∫ßu Diesel 0.05S (VNƒê) <span class="required">*</span></label>
                    <input type="number" id="priceUnitPrice" name="unit_price" step="1" min="1" required placeholder="Nh·∫≠p s·ªë nguy√™n" oninput="validateIntegerInput(this)">
                    <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">Ch·ªâ nh·∫≠p s·ªë nguy√™n, kh√¥ng nh·∫≠p s·ªë th·∫≠p ph√¢n</small>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">üíæ L∆∞u</button>
                    <button type="button" class="btn btn-secondary" onclick="closePriceModal()">‚ùå H·ªßy b·ªè</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Danh s√°ch bi·ªÉn s·ªë xe t·ª´ server -->
<script>
const vehiclesList = [
    {% for vehicle in vehicles %}
    { license_plate: "{{ vehicle.license_plate }}" },
    {% endfor %}
];
</script>

<script>
let allFuelRecords = [];

// Format s·ªë ti·ªÅn
function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN').format(Math.round(amount));
}

// Format ng√†y t·ª´ YYYY-MM-DD sang DD/MM/YYYY
function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr + 'T00:00:00');
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

// Validate input ch·ªâ cho ph√©p s·ªë nguy√™n
function validateIntegerInput(input) {
    // Lo·∫°i b·ªè d·∫•u ch·∫•m v√† s·ªë th·∫≠p ph√¢n
    if (input.value.includes('.')) {
        input.value = Math.floor(parseFloat(input.value) || 0);
    }
    // ƒê·∫£m b·∫£o kh√¥ng c√≥ k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
    input.value = input.value.replace(/[^0-9]/g, '');
}

// T√≠nh th√†nh ti·ªÅn
function calculateTotal() {
    const unitPrice = parseFloat(document.getElementById('unit_price').value) || 0;
    const liters = parseFloat(document.getElementById('liters').value) || 0;
    const totalAmount = Math.round(unitPrice * liters);
    document.getElementById('total_amount').value = formatCurrency(totalAmount) + ' ƒë';
}

// Bi·∫øn ƒë·∫øm s·ªë d√≤ng trong form bulk
let bulkRowCounter = 0;

// Hi·ªÉn th·ªã modal th√™m m·ªõi
function showAddModal() {
    document.getElementById('modalTitle').textContent = '‚ûï Th√™m b·∫£n ghi m·ªõi';
    
    // ·∫®n form ƒë∆°n, hi·ªÉn th·ªã form bulk
    document.getElementById('recordForm').style.display = 'none';
    document.getElementById('bulkFormContainer').style.display = 'block';
    
    // X√≥a t·∫•t c·∫£ d√≤ng c≈© v√† reset counter
    document.getElementById('bulkInputBody').innerHTML = '';
    bulkRowCounter = 0;
    
    // Th√™m d√≤ng ƒë·∫ßu ti√™n
    addBulkRow();
    
    document.getElementById('recordModal').style.display = 'flex';
}

// Hi·ªÉn th·ªã modal s·ª≠a
async function editRecord(recordId) {
    try {
        // T√¨m record trong danh s√°ch hi·ªán t·∫°i
        const record = allFuelRecords.find(r => r.id === recordId);
        if (!record) {
            // N·∫øu kh√¥ng t√¨m th·∫•y, load l·∫°i d·ªØ li·ªáu
            await loadAllRecords();
            const updatedRecord = allFuelRecords.find(r => r.id === recordId);
            if (!updatedRecord) {
                alert('Kh√¥ng t√¨m th·∫•y b·∫£n ghi');
                return;
            }
            fillEditForm(updatedRecord);
        } else {
            fillEditForm(record);
        }
    } catch (error) {
        console.error('Error loading record:', error);
        alert('L·ªói khi t·∫£i th√¥ng tin b·∫£n ghi');
    }
}

// ƒêi·ªÅn form s·ª≠a
function fillEditForm(record) {
    document.getElementById('modalTitle').textContent = '‚úèÔ∏è S·ª≠a b·∫£n ghi';
    
    // ·∫®n form bulk, hi·ªÉn th·ªã form ƒë∆°n
    document.getElementById('bulkFormContainer').style.display = 'none';
    document.getElementById('recordForm').style.display = 'block';
    
    document.getElementById('recordId').value = record.id;
    document.getElementById('date').value = record.date;
    document.getElementById('license_plate').value = record.license_plate;
    document.getElementById('unit_price').value = record.unit_price;
    document.getElementById('liters').value = record.liters;
    document.getElementById('notes').value = record.notes || '';
    calculateTotal();
    document.getElementById('recordModal').style.display = 'flex';
}

// ƒê√≥ng modal
function closeModal() {
    document.getElementById('recordModal').style.display = 'none';
    document.getElementById('recordForm').reset();
    document.getElementById('bulkInputBody').innerHTML = '';
    bulkRowCounter = 0;
}

// Th√™m d√≤ng m·ªõi v√†o b·∫£ng bulk
function addBulkRow() {
    bulkRowCounter++;
    const tbody = document.getElementById('bulkInputBody');
    const rowIndex = bulkRowCounter;
    
    // Set ng√†y m·∫∑c ƒë·ªãnh l√† h√¥m nay
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const defaultDate = `${year}-${month}-${day}`;
    
    // T·∫°o options cho select bi·ªÉn s·ªë xe
    const vehicleOptions = vehiclesList.map(v => 
        `<option value="${v.license_plate}">${v.license_plate}</option>`
    ).join('');
    
    const row = document.createElement('tr');
    row.id = `bulkRow_${rowIndex}`;
    row.innerHTML = `
        <td style="text-align: center;">${rowIndex}</td>
        <td>
            <input type="date" class="bulk-input" data-field="date" value="${defaultDate}" required>
        </td>
        <td>
            <select class="bulk-input" data-field="license_plate" required>
                <option value="">-- Ch·ªçn --</option>
                ${vehicleOptions}
            </select>
        </td>
        <td>
            <input type="number" class="bulk-input" data-field="unit_price" step="0.01" min="0" placeholder="0" required oninput="calculateBulkRowTotal(${rowIndex})">
        </td>
        <td>
            <input type="number" class="bulk-input" data-field="liters" step="0.01" min="0" placeholder="0" required oninput="calculateBulkRowTotal(${rowIndex})">
        </td>
        <td>
            <input type="text" class="bulk-input" data-field="total_amount" readonly value="0 ƒë" style="text-align: right;">
        </td>
        <td>
            <input type="text" class="bulk-input" data-field="notes" placeholder="Ghi ch√∫">
        </td>
        <td style="text-align: center;">
            <button type="button" class="btn btn-danger btn-sm" onclick="removeBulkRow(${rowIndex})" title="X√≥a d√≤ng">
                üóëÔ∏è
            </button>
        </td>
    `;
    
    tbody.appendChild(row);
    updateBulkRowNumbers();
}

// X√≥a d√≤ng kh·ªèi b·∫£ng bulk
function removeBulkRow(rowIndex) {
    const row = document.getElementById(`bulkRow_${rowIndex}`);
    if (row) {
        row.remove();
        updateBulkRowNumbers();
    }
}

// C·∫≠p nh·∫≠t s·ªë th·ª© t·ª± c√°c d√≤ng
function updateBulkRowNumbers() {
    const rows = document.querySelectorAll('#bulkInputBody tr');
    rows.forEach((row, index) => {
        const firstCell = row.querySelector('td:first-child');
        if (firstCell) {
            firstCell.textContent = index + 1;
        }
    });
}

// T√≠nh th√†nh ti·ªÅn cho m·ªôt d√≤ng
function calculateBulkRowTotal(rowIndex) {
    const row = document.getElementById(`bulkRow_${rowIndex}`);
    if (!row) return;
    
    const unitPriceInput = row.querySelector('[data-field="unit_price"]');
    const litersInput = row.querySelector('[data-field="liters"]');
    const totalInput = row.querySelector('[data-field="total_amount"]');
    
    if (!unitPriceInput || !litersInput || !totalInput) return;
    
    const unitPrice = parseFloat(unitPriceInput.value) || 0;
    const liters = parseFloat(litersInput.value) || 0;
    const totalAmount = Math.round(unitPrice * liters);
    
    totalInput.value = formatCurrency(totalAmount) + ' ƒë';
}

// L∆∞u t·∫•t c·∫£ c√°c d√≤ng bulk
async function saveBulkRecords() {
    const rows = document.querySelectorAll('#bulkInputBody tr');
    
    if (rows.length === 0) {
        alert('Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt d√≤ng d·ªØ li·ªáu');
        return;
    }
    
    const records = [];
    let hasError = false;
    let errorMessage = '';
    
    rows.forEach((row, index) => {
        const dateInput = row.querySelector('[data-field="date"]');
        const licensePlateInput = row.querySelector('[data-field="license_plate"]');
        const unitPriceInput = row.querySelector('[data-field="unit_price"]');
        const litersInput = row.querySelector('[data-field="liters"]');
        const notesInput = row.querySelector('[data-field="notes"]');
        
        const date = dateInput ? dateInput.value : '';
        const licensePlate = licensePlateInput ? licensePlateInput.value : '';
        const unitPrice = unitPriceInput ? parseFloat(unitPriceInput.value) : 0;
        const liters = litersInput ? parseFloat(litersInput.value) : 0;
        const notes = notesInput ? notesInput.value : '';
        
        // Validate
        if (!date || !licensePlate) {
            hasError = true;
            errorMessage += `D√≤ng ${index + 1}: Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc\n`;
            return;
        }
        
        if (unitPrice <= 0 || liters <= 0) {
            hasError = true;
            errorMessage += `D√≤ng ${index + 1}: ƒê∆°n gi√° v√† s·ªë l√≠t ph·∫£i l·ªõn h∆°n 0\n`;
            return;
        }
        
        records.push({
            date: date,
            license_plate: licensePlate,
            unit_price: unitPrice,
            liters: liters,
            notes: notes
        });
    });
    
    if (hasError) {
        alert(errorMessage);
        return;
    }
    
    if (records.length === 0) {
        alert('Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá ƒë·ªÉ l∆∞u');
        return;
    }
    
    // X√°c nh·∫≠n tr∆∞·ªõc khi l∆∞u
    if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l∆∞u ${records.length} b·∫£n ghi?`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/do-dau/add-bulk', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ records: records })
        });
        
        const result = await response.json();
        
        if (result.success) {
            let message = `ƒê√£ th√™m th√†nh c√¥ng ${result.added_count}/${result.total_count} b·∫£n ghi`;
            if (result.errors && result.errors.length > 0) {
                message += '\n\nL·ªói:\n' + result.errors.join('\n');
            }
            alert(message);
            closeModal();
            // Reload d·ªØ li·ªáu v·ªõi b·ªô l·ªçc th√°ng/nƒÉm hi·ªán t·∫°i (n·∫øu c√≥)
            const monthYearInput = document.getElementById('filterMonthYear');
            if (monthYearInput && monthYearInput.value) {
                await applyMonthFilter();
            } else {
                await loadAllRecords();
            }
            // Reload totals n·∫øu ƒë√£ c√≥ filter
            const fromDate = document.getElementById('filterFromDate')?.value;
            const toDate = document.getElementById('filterToDate')?.value;
            if (fromDate && toDate) {
                await loadTotals();
            }
        } else {
            alert('L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ l∆∞u b·∫£n ghi'));
        }
    } catch (error) {
        console.error('Error saving bulk records:', error);
        alert('L·ªói khi l∆∞u b·∫£n ghi');
    }
}

// L∆∞u b·∫£n ghi (th√™m m·ªõi ho·∫∑c s·ª≠a)
async function saveRecord(event) {
    event.preventDefault();
    
    const recordId = document.getElementById('recordId').value;
    const date = document.getElementById('date').value;
    const licensePlate = document.getElementById('license_plate').value;
    const unitPrice = parseFloat(document.getElementById('unit_price').value);
    const liters = parseFloat(document.getElementById('liters').value);
    const notes = document.getElementById('notes').value;
    
    // Validate
    if (!date || !licensePlate) {
        alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc');
        return;
    }
    
    if (unitPrice <= 0 || liters <= 0) {
        alert('ƒê∆°n gi√° v√† s·ªë l√≠t ph·∫£i l·ªõn h∆°n 0');
        return;
    }
    
    const data = {
        date: date,
        license_plate: licensePlate,
        unit_price: unitPrice,
        liters: liters,
        notes: notes
    };
    
    const url = recordId ? `/api/do-dau/edit/${recordId}` : '/api/do-dau/add';
    const method = recordId ? 'PUT' : 'POST';
    
    try {
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(recordId ? 'C·∫≠p nh·∫≠t b·∫£n ghi th√†nh c√¥ng' : 'Th√™m b·∫£n ghi th√†nh c√¥ng');
            closeModal();
            // Reload d·ªØ li·ªáu v·ªõi b·ªô l·ªçc th√°ng/nƒÉm hi·ªán t·∫°i (n·∫øu c√≥)
            const monthYearInput = document.getElementById('filterMonthYear');
            if (monthYearInput && monthYearInput.value) {
                await applyMonthFilter();
            } else {
                await loadAllRecords();
            }
            // Reload totals n·∫øu ƒë√£ c√≥ filter
            const fromDate = document.getElementById('filterFromDate')?.value;
            const toDate = document.getElementById('filterToDate')?.value;
            if (fromDate && toDate) {
                await loadTotals();
            }
        } else {
            alert('L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ l∆∞u b·∫£n ghi'));
        }
    } catch (error) {
        console.error('Error saving record:', error);
        alert('L·ªói khi l∆∞u b·∫£n ghi');
    }
}

// X√≥a b·∫£n ghi
async function deleteRecord(recordId) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi n√†y?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/do-dau/delete/${recordId}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('X√≥a b·∫£n ghi th√†nh c√¥ng');
            // Reload d·ªØ li·ªáu v·ªõi b·ªô l·ªçc th√°ng/nƒÉm hi·ªán t·∫°i (n·∫øu c√≥)
            const monthYearInput = document.getElementById('filterMonthYear');
            if (monthYearInput && monthYearInput.value) {
                await applyMonthFilter();
            } else {
                await loadAllRecords();
            }
            // Reload totals n·∫øu ƒë√£ c√≥ filter
            const fromDate = document.getElementById('filterFromDate')?.value;
            const toDate = document.getElementById('filterToDate')?.value;
            if (fromDate && toDate) {
                await loadTotals();
            }
            // Reload detail modal n·∫øu ƒëang m·ªü
            const detailModal = document.getElementById('detailModal');
            if (detailModal && detailModal.style.display !== 'none') {
                const licensePlate = document.getElementById('detailLicensePlate')?.textContent;
                if (licensePlate && fromDate && toDate) {
                    await showDetailModal(licensePlate, fromDate, toDate);
                }
            }
        } else {
            alert('L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ x√≥a b·∫£n ghi'));
        }
    } catch (error) {
        console.error('Error deleting record:', error);
        alert('L·ªói khi x√≥a b·∫£n ghi');
    }
}

// Load t·∫•t c·∫£ b·∫£n ghi
async function loadAllRecords() {
    try {
        const response = await fetch('/api/do-dau/all');
        const data = await response.json();
        
        if (data.success && data.records) {
            allFuelRecords = data.records;
            renderTable();
        }
    } catch (error) {
        console.error('Error loading records:', error);
    }
}

// Render b·∫£ng
function renderTable() {
    const tbody = document.getElementById('fuelRecordsBody');
    
    if (allFuelRecords.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªï d·∫ßu.</td></tr>';
        updateSummary(0, 0);
        return;
    }
    
    tbody.innerHTML = allFuelRecords.map((record, index) => {
        return `
            <tr data-record-id="${record.id}">
                <td>${index + 1}</td>
                <td>${formatDate(record.date)}</td>
                <td><strong>${record.license_plate}</strong></td>
                <td class="number">${formatCurrency(record.unit_price)} ƒë</td>
                <td class="number">${record.liters.toFixed(2)} l√≠t</td>
                <td class="number"><strong>${formatCurrency(record.total_amount)} ƒë</strong></td>
                <td>${record.person || ''}</td>
                <td class="actions">
                    <button class="btn btn-warning btn-sm" onclick="editRecord(${record.id})" title="S·ª≠a">
                        ‚úèÔ∏è S·ª≠a
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord(${record.id})" title="X√≥a">
                        üóëÔ∏è X√≥a
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    // T√≠nh t·ªïng
    const totalLiters = allFuelRecords.reduce((sum, r) => sum + (r.liters || 0), 0);
    const totalCost = allFuelRecords.reduce((sum, r) => sum + (r.total_amount || 0), 0);
    updateSummary(totalLiters, totalCost);
}

// C·∫≠p nh·∫≠t h√†ng t·ªïng
function updateSummary(totalLiters, totalCost) {
    const summaryRow = document.getElementById('summaryRow');
    if (summaryRow) {
        summaryRow.innerHTML = `
            <tr class="summary-row">
                <td colspan="3"><strong>T·ªïng</strong></td>
                <td></td>
                <td class="number"><strong>${totalLiters.toFixed(2)} l√≠t</strong></td>
                <td class="number"><strong>${formatCurrency(totalCost)} ƒë</strong></td>
                <td></td>
                <td></td>
            </tr>
        `;
    }
}

// ƒê√≥ng modal khi click b√™n ngo√†i
window.onclick = function(event) {
    const modal = document.getElementById('recordModal');
    if (event.target === modal) {
        closeModal();
    }
    const detailModal = document.getElementById('detailModal');
    if (event.target === detailModal) {
        closeDetailModal();
    }
    const priceModal = document.getElementById('priceModal');
    if (event.target === priceModal) {
        closePriceModal();
    }
}

// ===== TOTAL SHEET FUNCTIONS =====

// L·∫•y ng√†y ƒë·∫ßu th√°ng hi·ªán t·∫°i
function getFirstDayOfMonth() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    return `${year}-${month}-01`;
}

// L·∫•y ng√†y cu·ªëi th√°ng hi·ªán t·∫°i
function getLastDayOfMonth() {
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth() + 1;
    const lastDay = new Date(year, month, 0).getDate();
    return `${year}-${String(month).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
}

// Load t·ªïng h·ª£p d·ªØ li·ªáu
async function loadTotals() {
    const fromDate = document.getElementById('filterFromDate').value;
    const toDate = document.getElementById('filterToDate').value;
    const licensePlate = document.getElementById('filterLicensePlate').value;
    
    if (!fromDate || !toDate) {
        alert('Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß t·ª´ ng√†y v√† ƒë·∫øn ng√†y');
        return;
    }
    
    try {
        let url = `/api/do-dau/totals?from_date=${fromDate}&to_date=${toDate}`;
        if (licensePlate && licensePlate !== 'T·∫•t c·∫£') {
            url += `&license_plate=${encodeURIComponent(licensePlate)}`;
        }
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success && data.totals) {
            renderTotalsTable(data.totals, fromDate, toDate);
        } else {
            alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu'));
            renderTotalsTable([], fromDate, toDate);
        }
    } catch (error) {
        console.error('Error loading totals:', error);
        alert('L·ªói khi t·∫£i d·ªØ li·ªáu t·ªïng h·ª£p');
        renderTotalsTable([], fromDate, toDate);
    }
}

// Render b·∫£ng t·ªïng h·ª£p
function renderTotalsTable(totals, fromDate, toDate) {
    const tbody = document.getElementById('fuelTotalsBody');
    const footer = document.getElementById('fuelTotalsFooter');
    
    if (!totals || totals.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn</td></tr>';
        // ·∫®n footer khi kh√¥ng c√≥ d·ªØ li·ªáu
        if (footer) {
            footer.style.display = 'none';
        }
        return;
    }
    
    // Hi·ªÉn th·ªã footer khi c√≥ d·ªØ li·ªáu
    if (footer) {
        footer.style.display = '';
    }
    
    tbody.innerHTML = totals.map((item, index) => {
        return `
            <tr>
                <td>${index + 1}</td>
                <td><strong>${item.license_plate}</strong></td>
                <td class="number">${item.total_liters.toFixed(2)} l√≠t</td>
                <td class="number"><strong>${formatCurrency(item.total_cost)} ƒë</strong></td>
                <td class="actions">
                    <button class="btn btn-info btn-sm" onclick="showDetailModal('${item.license_plate}', '${fromDate}', '${toDate}')" title="Xem chi ti·∫øt">
                        üìã Chi ti·∫øt
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    // T√≠nh t·ªïng c·ªông
    const totalLiters = totals.reduce((sum, item) => sum + (item.total_liters || 0), 0);
    const totalCost = totals.reduce((sum, item) => sum + (item.total_cost || 0), 0);
    
    // C·∫≠p nh·∫≠t footer
    const totalLitersElement = document.getElementById('totalLitersFooter');
    const totalCostElement = document.getElementById('totalCostFooter');
    if (totalLitersElement) {
        totalLitersElement.textContent = totalLiters.toFixed(2) + ' l√≠t';
    }
    if (totalCostElement) {
        totalCostElement.textContent = formatCurrency(totalCost) + ' ƒë';
    }
}

// ===== KHO√ÅN D·∫¶U FUNCTIONS =====

function resetFuelQuotaSummary() {
    document.getElementById('quotaTotalLiters').textContent = '0.00 l√≠t';
    document.getElementById('quotaTotalCost').textContent = '0 ƒë';
    document.getElementById('actualTotalLiters').textContent = '0.00 l√≠t';
    document.getElementById('actualTotalCost').textContent = '0 ƒë';
    const diffLitersEl = document.getElementById('diffLiters');
    const diffCostEl = document.getElementById('diffCost');
    if (diffLitersEl) {
        diffLitersEl.textContent = '0.00 l√≠t';
        diffLitersEl.classList.remove('text-positive', 'text-negative');
    }
    if (diffCostEl) {
        diffCostEl.textContent = '0 ƒë';
        diffCostEl.classList.remove('text-positive', 'text-negative');
    }
    // ·∫®n button Xu·∫•t Excel khi reset
    const exportBtn = document.getElementById('exportQuotaExcelBtn');
    if (exportBtn) {
        exportBtn.style.display = 'none';
    }
}

function applyDiffClass(element, value) {
    if (!element) return;
    element.classList.remove('text-positive', 'text-negative');
    if (value > 0) {
        element.classList.add('text-positive');
    } else if (value < 0) {
        element.classList.add('text-negative');
    }
}

function renderFuelQuotaTable(data) {
    const tbody = document.getElementById('fuelQuotaBody');
    const noteEl = document.getElementById('fuelQuotaNote');
    const exportBtn = document.getElementById('exportQuotaExcelBtn');
    const totals = data?.totals || {};
    const actual = data?.actual || {};
    const diff = data?.difference || {};
    const meta = data?.meta || {};
    const trips = data?.trips || [];
    
    noteEl.textContent = '';
    
    // Hi·ªÉn th·ªã/·∫©n button Xu·∫•t Excel
    if (exportBtn) {
        if (trips.length > 0) {
            exportBtn.style.display = 'inline-block';
        } else {
            exportBtn.style.display = 'none';
        }
    }
    
    if (!trips.length) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">Kh√¥ng c√≥ chuy·∫øn h·ª£p l·ªá trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn.</td></tr>';
    } else {
        tbody.innerHTML = trips.map((trip, index) => {
            const statusLabel = (trip.status || '').toString().toLowerCase().startsWith('off') ? 'Offline' : 'Online';
            return `
                <tr>
                    <td>${formatDate(trip.date)}</td>
                    <td><strong>${trip.license_plate || ''}</strong></td>
                    <td>${trip.route_code || ''}</td>
                    <td class="number">${(trip.distance_km ?? 0).toFixed(2)}</td>
                    <td class="number">${(trip.dk_liters ?? 0).toFixed(2)} l√≠t</td>
                    <td class="number"><strong>${formatCurrency(trip.fuel_cost || 0)} ƒë</strong></td>
                    <td>${statusLabel}</td>
                    <td>${trip.driver_name || ''}</td>
                </tr>
            `;
        }).join('');
    }
    
    document.getElementById('quotaTotalLiters').textContent = `${(totals.quota_liters ?? 0).toFixed(2)} l√≠t`;
    document.getElementById('quotaTotalCost').textContent = `${formatCurrency(totals.quota_cost ?? 0)} ƒë`;
    document.getElementById('actualTotalLiters').textContent = `${(actual.liters ?? 0).toFixed(2)} l√≠t`;
    document.getElementById('actualTotalCost').textContent = `${formatCurrency(actual.cost ?? 0)} ƒë`;
    
    const diffLitersEl = document.getElementById('diffLiters');
    const diffCostEl = document.getElementById('diffCost');
    const diffLitersVal = diff.liters ?? 0;
    const diffCostVal = diff.cost ?? 0;
    diffLitersEl.textContent = `${diffLitersVal.toFixed(2)} l√≠t`;
    diffCostEl.textContent = `${formatCurrency(diffCostVal)} ƒë`;
    applyDiffClass(diffLitersEl, diffLitersVal);
    applyDiffClass(diffCostEl, diffCostVal);
    
    const metaNotes = [];
    if (meta.skipped_no_distance) {
        metaNotes.push(`B·ªè qua ${meta.skipped_no_distance} chuy·∫øn kh√¥ng c√≥ Km.`);
    }
    if (meta.skipped_no_price) {
        metaNotes.push(`B·ªè qua ${meta.skipped_no_price} chuy·∫øn ch∆∞a c√≥ gi√° d·∫ßu √°p d·ª•ng.`);
    }
    if (metaNotes.length > 0) {
        noteEl.textContent = metaNotes.join(' ');
    }
}

async function loadFuelQuotaComparison() {
    const fromDate = document.getElementById('quotaFromDate').value;
    const toDate = document.getElementById('quotaToDate').value;
    const licensePlate = document.getElementById('quotaLicensePlate').value;
    const tbody = document.getElementById('fuelQuotaBody');
    const noteEl = document.getElementById('fuelQuotaNote');
    const exportBtn = document.getElementById('exportQuotaExcelBtn');
    
    if (!fromDate || !toDate || !licensePlate) {
        alert('Vui l√≤ng ch·ªçn ƒë·ªß T·ª´ ng√†y, ƒê·∫øn ng√†y v√† Bi·ªÉn s·ªë xe (Xe Nh√†)');
        return;
    }
    
    tbody.innerHTML = '<tr><td colspan="8" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu kho√°n d·∫ßu...</td></tr>';
    noteEl.textContent = '';
    resetFuelQuotaSummary();
    
    // ·∫®n button Xu·∫•t Excel khi ƒëang t·∫£i
    if (exportBtn) {
        exportBtn.style.display = 'none';
    }
    
    try {
        const url = `/api/fuel-quota/compare?from_date=${fromDate}&to_date=${toDate}&license_plate=${encodeURIComponent(licensePlate)}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.message || data.error || 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu kho√°n d·∫ßu');
        }
        
        renderFuelQuotaTable(data);
    } catch (error) {
        console.error('Error loading fuel quota comparison:', error);
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu kho√°n d·∫ßu.</td></tr>';
        noteEl.textContent = error.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh';
        resetFuelQuotaSummary();
    }
}

function exportFuelQuotaExcel() {
    const fromDate = document.getElementById('quotaFromDate').value;
    const toDate = document.getElementById('quotaToDate').value;
    const licensePlate = document.getElementById('quotaLicensePlate').value;
    
    // Ki·ªÉm tra ƒëi·ªÅu ki·ªán b·∫Øt bu·ªôc
    if (!fromDate || !toDate || !licensePlate) {
        alert('Vui l√≤ng ch·ªçn ƒë·ªß T·ª´ ng√†y, ƒê·∫øn ng√†y v√† Bi·ªÉn s·ªë xe tr∆∞·ªõc khi xu·∫•t Excel!');
        return;
    }
    
    // Validate dates
    if (new Date(fromDate) > new Date(toDate)) {
        alert('Ng√†y b·∫Øt ƒë·∫ßu ph·∫£i nh·ªè h∆°n ho·∫∑c b·∫±ng ng√†y k·∫øt th√∫c!');
        return;
    }
    
    // Ki·ªÉm tra xem ƒë√£ c√≥ d·ªØ li·ªáu ch∆∞a
    const tbody = document.getElementById('fuelQuotaBody');
    if (!tbody || tbody.innerHTML.includes('Ch·ªçn kho·∫£ng ng√†y') || tbody.innerHTML.includes('Kh√¥ng c√≥ chuy·∫øn')) {
        alert('Vui l√≤ng th·ª±c hi·ªán t√¨m ki·∫øm tr∆∞·ªõc khi xu·∫•t Excel!');
        return;
    }
    
    // T·∫°o URL v·ªõi c√°c tham s·ªë filter
    const exportUrl = `/api/fuel-quota/export-excel?from_date=${encodeURIComponent(fromDate)}&to_date=${encodeURIComponent(toDate)}&license_plate=${encodeURIComponent(licensePlate)}`;
    
    // M·ªü URL ƒë·ªÉ download file
    window.location.href = exportUrl;
}

// Hi·ªÉn th·ªã modal chi ti·∫øt
async function showDetailModal(licensePlate, fromDate, toDate) {
    try {
        const url = `/api/do-dau/detail/${encodeURIComponent(licensePlate)}?from_date=${fromDate}&to_date=${toDate}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.records) {
            // C·∫≠p nh·∫≠t th√¥ng tin modal
            document.getElementById('detailLicensePlate').textContent = licensePlate;
            document.getElementById('detailDateRange').textContent = 
                `${formatDate(fromDate)} - ${formatDate(toDate)}`;
            
            // Render b·∫£ng chi ti·∫øt
            const tbody = document.getElementById('detailRecordsBody');
            if (data.records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªï d·∫ßu trong kho·∫£ng th·ªùi gian n√†y</td></tr>';
            } else {
                tbody.innerHTML = data.records.map((record, index) => {
                    return `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${formatDate(record.date)}</td>
                            <td class="number">${record.liters.toFixed(2)} l√≠t</td>
                            <td class="number">${formatCurrency(record.unit_price)} ƒë</td>
                            <td class="number"><strong>${formatCurrency(record.total_amount)} ƒë</strong></td>
                            <td>${record.notes || ''}</td>
                            <td class="actions">
                                <button class="btn btn-warning btn-sm" onclick="editRecord(${record.id})" title="S·ª≠a">
                                    ‚úèÔ∏è S·ª≠a
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteRecord(${record.id})" title="X√≥a">
                                    üóëÔ∏è X√≥a
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Hi·ªÉn th·ªã modal
            document.getElementById('detailModal').style.display = 'flex';
        } else {
            alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu chi ti·∫øt');
        }
    } catch (error) {
        console.error('Error loading detail:', error);
        alert('L·ªói khi t·∫£i chi ti·∫øt ƒë·ªï d·∫ßu');
    }
}

// ƒê√≥ng modal chi ti·∫øt
function closeDetailModal() {
    document.getElementById('detailModal').style.display = 'none';
}

// ===== B·ªò L·ªåC TH√ÅNG/NƒÇM CHO DANH S√ÅCH ƒê·ªî D·∫¶U =====

// L∆∞u tr·ªØ tab hi·ªán t·∫°i
let currentActiveTab = 'total'; // M·∫∑c ƒë·ªãnh l√† tab total

// Chuy·ªÉn ƒë·ªïi gi·ªØa c√°c sheet
function switchSheet(sheetName) {
    // L∆∞u tab hi·ªán t·∫°i
    currentActiveTab = sheetName;
    
    // ·∫®n t·∫•t c·∫£ c√°c sheet
    document.querySelectorAll('.sheet-content').forEach(sheet => {
        sheet.style.display = 'none';
    });
    
    // B·ªè active class t·ª´ t·∫•t c·∫£ c√°c tabs
    document.querySelectorAll('.sheet-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Hi·ªÉn th·ªã sheet ƒë∆∞·ª£c ch·ªçn
    if (sheetName === 'total') {
        document.getElementById('sheetTotal').style.display = 'block';
        document.getElementById('tabTotal').classList.add('active');
    } else if (sheetName === 'danh-sach') {
        document.getElementById('sheetDanhSach').style.display = 'block';
        document.getElementById('tabDanhSach').classList.add('active');
        // Kh√¥ng load l·∫°i d·ªØ li·ªáu v√¨ ƒë√£ ƒë∆∞·ª£c render t·ª´ server v·ªõi filter
        // Ch·ªâ load n·∫øu b·∫£ng tr·ªëng (tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát)
    } else if (sheetName === 'khoan-dau') {
        document.getElementById('sheetKhoanDau').style.display = 'block';
        document.getElementById('tabKhoanDau').classList.add('active');
    } else if (sheetName === 'gia-dau') {
        document.getElementById('sheetGiaDau').style.display = 'block';
        document.getElementById('tabGiaDau').classList.add('active');
        loadDieselPrices();
    }
}

async function applyMonthFilter() {
    const monthYearInput = document.getElementById('filterMonthYear');
    const monthYear = monthYearInput.value;
    
    // Validate
    if (!monthYear) {
        alert('Vui l√≤ng ch·ªçn th√°ng/nƒÉm');
        return;
    }
    
    // L·∫•y tab hi·ªán t·∫°i ƒëang m·ªü
    const activeTab = getCurrentActiveTab();
    
    try {
        // Hi·ªÉn th·ªã loading
        const tbody = document.getElementById('fuelRecordsBody');
        const originalContent = tbody.innerHTML;
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';
        
        // G·ªçi API ƒë·ªÉ l·∫•y d·ªØ li·ªáu
        const response = await fetch(`/api/do-dau/filter-by-month?month_year=${encodeURIComponent(monthYear)}`);
        const data = await response.json();
        
        if (data.success) {
            // C·∫≠p nh·∫≠t b·∫£ng
            renderFuelRecordsTable(data.records);
            
            // C·∫≠p nh·∫≠t t·ªïng h·ª£p
            updateMonthSummary(data.selected_month, data.selected_year, data.total_liters, data.total_cost);
            
            // Gi·ªØ nguy√™n tab hi·ªán t·∫°i (kh√¥ng chuy·ªÉn tab)
            // Tab ƒë√£ ƒë∆∞·ª£c gi·ªØ nguy√™n v√¨ kh√¥ng c√≥ page reload
        } else {
            alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu'));
            tbody.innerHTML = originalContent;
        }
    } catch (error) {
        console.error('Error loading fuel records:', error);
        alert('L·ªói khi t·∫£i d·ªØ li·ªáu');
    }
}

function getCurrentActiveTab() {
    // S·ª≠ d·ª•ng bi·∫øn currentActiveTab ƒë√£ ƒë∆∞·ª£c l∆∞u
    return currentActiveTab || 'total';
}

function renderFuelRecordsTable(records) {
    const tbody = document.getElementById('fuelRecordsBody');
    const summaryRow = document.getElementById('summaryRow');
    
    if (!records || records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªï d·∫ßu trong th√°ng ƒë√£ ch·ªçn.</td></tr>';
        if (summaryRow) {
            summaryRow.innerHTML = '';
        }
        return;
    }
    
    // Render b·∫£ng
    tbody.innerHTML = records.map((record, index) => {
        return `
            <tr data-record-id="${record.id}">
                <td>${index + 1}</td>
                <td>${formatDate(record.date)}</td>
                <td><strong>${record.license_plate}</strong></td>
                <td class="number">${formatCurrency(record.unit_price)} ƒë</td>
                <td class="number">${record.liters.toFixed(2)} l√≠t</td>
                <td class="number"><strong>${formatCurrency(record.total_amount)} ƒë</strong></td>
                <td>${record.notes || ''}</td>
                <td class="actions">
                    <button class="btn btn-warning btn-sm" onclick="editRecord(${record.id})" title="S·ª≠a">
                        ‚úèÔ∏è S·ª≠a
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteRecord(${record.id})" title="X√≥a">
                        üóëÔ∏è X√≥a
                    </button>
                </td>
            </tr>
        `;
    }).join('');
    
    // C·∫≠p nh·∫≠t allFuelRecords ƒë·ªÉ c√°c h√†m kh√°c c√≥ th·ªÉ s·ª≠ d·ª•ng
    allFuelRecords = records.map(r => ({
        id: r.id,
        date: r.date,
        license_plate: r.license_plate,
        unit_price: r.unit_price,
        liters: r.liters,
        total_amount: r.total_amount,
        notes: r.notes
    }));
}

function updateMonthSummary(month, year, totalLiters, totalCost) {
    // C·∫≠p nh·∫≠t ph·∫ßn t·ªïng h·ª£p th√°ng
    const summaryMonthEl = document.querySelector('.month-summary div:first-child div:last-child');
    if (summaryMonthEl) {
        summaryMonthEl.textContent = `Th√°ng ${month}/${year}`;
    }
    
    // C·∫≠p nh·∫≠t t·ªïng s·ªë l√≠t
    const totalLitersEl = document.getElementById('summaryTotalLiters');
    if (totalLitersEl) {
        totalLitersEl.textContent = `${totalLiters.toFixed(2)} l√≠t`;
    }
    
    // C·∫≠p nh·∫≠t t·ªïng s·ªë ti·ªÅn
    const totalCostEl = document.getElementById('summaryTotalCost');
    if (totalCostEl) {
        totalCostEl.textContent = `${formatCurrency(totalCost)} ƒë`;
    }
    
    // C·∫≠p nh·∫≠t footer c·ªßa b·∫£ng
    const summaryRow = document.getElementById('summaryRow');
    if (summaryRow) {
        summaryRow.innerHTML = `
            <tr class="summary-row" style="background-color: #f8f9fa; font-weight: 700;">
                <td colspan="3"><strong>T·ªïng th√°ng ${month}/${year}</strong></td>
                <td></td>
                <td class="number"><strong id="totalLiters">${totalLiters.toFixed(2)} l√≠t</strong></td>
                <td class="number"><strong id="totalCost">${formatCurrency(totalCost)} ƒë</strong></td>
                <td></td>
                <td></td>
            </tr>
        `;
    }
}

function resetMonthFilter() {
    // Reset v·ªÅ th√°ng hi·ªán t·∫°i
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const monthYear = `${year}-${month}`;
    
    document.getElementById('filterMonthYear').value = monthYear;
    
    // √Åp d·ª•ng filter
    applyMonthFilter();
}

// ===== GI√Å D·∫¶U FUNCTIONS =====

let allDieselPrices = [];

// Load danh s√°ch gi√° d·∫ßu
async function loadDieselPrices() {
    try {
        const response = await fetch('/api/diesel-price/all');
        const data = await response.json();
        
        if (data.success && data.prices) {
            allDieselPrices = data.prices;
            renderPriceTable();
        }
    } catch (error) {
        console.error('Error loading diesel prices:', error);
    }
}

// Render b·∫£ng gi√° d·∫ßu
function renderPriceTable() {
    const tbody = document.getElementById('dieselPriceBody');
    
    if (allDieselPrices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu gi√° d·∫ßu. Nh·∫•n n√∫t "C·∫≠p nh·∫≠t gi√° xƒÉng d·∫ßu h√¥m nay" ƒë·ªÉ th√™m m·ªõi.</td></tr>';
        return;
    }
    
    tbody.innerHTML = allDieselPrices.map((price, index) => {
        const createdDate = price.created_at ? formatDateTime(price.created_at) : '';
        return `
            <tr data-price-id="${price.id}">
                <td>${index + 1}</td>
                <td>${formatDate(price.application_date)}</td>
                <td class="number"><strong>${formatCurrency(price.unit_price)} ƒë</strong></td>
                <td>${createdDate}</td>
                <td class="actions">
                    <button class="btn btn-warning btn-sm" onclick="editPrice(${price.id})" title="S·ª≠a">
                        ‚úèÔ∏è S·ª≠a
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

// Format datetime
function formatDateTime(dateTimeStr) {
    if (!dateTimeStr) return '';
    try {
        const date = new Date(dateTimeStr);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${day}/${month}/${year} ${hours}:${minutes}`;
    } catch (e) {
        return dateTimeStr;
    }
}

// Hi·ªÉn th·ªã modal th√™m gi√° d·∫ßu
function showAddPriceModal() {
    document.getElementById('priceModalTitle').textContent = '‚ûï C·∫≠p nh·∫≠t gi√° xƒÉng d·∫ßu h√¥m nay';
    document.getElementById('priceId').value = '';
    document.getElementById('priceForm').reset();
    
    // Set ng√†y m·∫∑c ƒë·ªãnh l√† h√¥m nay
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    document.getElementById('priceApplicationDate').value = `${year}-${month}-${day}`;
    
    document.getElementById('priceModal').style.display = 'flex';
}

// Hi·ªÉn th·ªã modal s·ª≠a gi√° d·∫ßu
async function editPrice(priceId) {
    try {
        const price = allDieselPrices.find(p => p.id === priceId);
        if (!price) {
            await loadDieselPrices();
            const updatedPrice = allDieselPrices.find(p => p.id === priceId);
            if (!updatedPrice) {
                alert('Kh√¥ng t√¨m th·∫•y b·∫£n ghi gi√° d·∫ßu');
                return;
            }
            fillEditPriceForm(updatedPrice);
        } else {
            fillEditPriceForm(price);
        }
    } catch (error) {
        console.error('Error loading price:', error);
        alert('L·ªói khi t·∫£i th√¥ng tin gi√° d·∫ßu');
    }
}

// ƒêi·ªÅn form s·ª≠a gi√° d·∫ßu
function fillEditPriceForm(price) {
    document.getElementById('priceModalTitle').textContent = '‚úèÔ∏è S·ª≠a gi√° d·∫ßu';
    document.getElementById('priceId').value = price.id;
    document.getElementById('priceApplicationDate').value = price.application_date;
    document.getElementById('priceUnitPrice').value = price.unit_price;
    document.getElementById('priceModal').style.display = 'flex';
}

// ƒê√≥ng modal gi√° d·∫ßu
function closePriceModal() {
    document.getElementById('priceModal').style.display = 'none';
    document.getElementById('priceForm').reset();
    document.getElementById('priceId').value = '';
}

// L∆∞u gi√° d·∫ßu (th√™m m·ªõi ho·∫∑c s·ª≠a)
async function savePrice(event) {
    event.preventDefault();
    
    const priceId = document.getElementById('priceId').value;
    const applicationDate = document.getElementById('priceApplicationDate').value;
    const unitPrice = document.getElementById('priceUnitPrice').value;
    
    // Validate
    if (!applicationDate) {
        alert('Vui l√≤ng ch·ªçn ng√†y c·∫≠p nh·∫≠t gi√°');
        return;
    }
    
    // Ki·ªÉm tra gi√° ph·∫£i l√† s·ªë nguy√™n
    const unitPriceInt = parseInt(unitPrice);
    if (isNaN(unitPriceInt) || unitPriceInt <= 0) {
        alert('ƒê∆°n gi√° ph·∫£i l√† s·ªë nguy√™n l·ªõn h∆°n 0');
        return;
    }
    
    // Ki·ªÉm tra n·∫øu c√≥ s·ªë th·∫≠p ph√¢n
    if (parseFloat(unitPrice) !== unitPriceInt) {
        alert('ƒê∆°n gi√° ph·∫£i l√† s·ªë nguy√™n, kh√¥ng ƒë∆∞·ª£c nh·∫≠p s·ªë th·∫≠p ph√¢n');
        return;
    }
    
    const data = {
        application_date: applicationDate,
        unit_price: unitPriceInt
    };
    
    const url = priceId ? `/api/diesel-price/edit/${priceId}` : '/api/diesel-price/add';
    const method = priceId ? 'PUT' : 'POST';
    
    try {
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(priceId ? 'C·∫≠p nh·∫≠t gi√° d·∫ßu th√†nh c√¥ng' : 'Th√™m gi√° d·∫ßu th√†nh c√¥ng');
            closePriceModal();
            await loadDieselPrices();
        } else {
            // Ki·ªÉm tra n·∫øu l√† l·ªói tr√πng ng√†y (khi th√™m m·ªõi)
            if (!priceId && result.error && result.error.includes('ƒë√£ c√≥ gi√° d·∫ßu') && result.existing_id) {
                const confirmUpdate = confirm('Ng√†y n√†y ƒë√£ c√≥ gi√° d·∫ßu. B·∫°n c√≥ mu·ªën c·∫≠p nh·∫≠t l·∫°i kh√¥ng?');
                if (confirmUpdate) {
                    // N·∫øu ƒë·ªìng √Ω, s·ª≠a b·∫£n ghi hi·ªán c√≥
                    closePriceModal();
                    // Load l·∫°i danh s√°ch ƒë·ªÉ c√≥ d·ªØ li·ªáu m·ªõi nh·∫•t
                    await loadDieselPrices();
                    // M·ªü modal s·ª≠a v·ªõi gi√° m·ªõi
                    const existingPrice = allDieselPrices.find(p => p.id === result.existing_id);
                    if (existingPrice) {
                        fillEditPriceForm(existingPrice);
                        // C·∫≠p nh·∫≠t gi√° m·ªõi
                        document.getElementById('priceUnitPrice').value = unitPriceInt;
                    }
                }
            } else {
                alert('L·ªói: ' + (result.error || 'Kh√¥ng th·ªÉ l∆∞u gi√° d·∫ßu'));
            }
        }
    } catch (error) {
        console.error('Error saving price:', error);
        alert('L·ªói khi l∆∞u gi√° d·∫ßu');
    }
}

// Kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c load
document.addEventListener('DOMContentLoaded', function() {
    // KH√îNG load l·∫°i d·ªØ li·ªáu v√¨ ƒë√£ ƒë∆∞·ª£c render t·ª´ server v·ªõi filter th√°ng/nƒÉm
    // Ch·ªâ load khi th·ª±c s·ª± c·∫ßn (v√≠ d·ª• khi th√™m/s·ª≠a/x√≥a t·ª´ c√°c tab kh√°c)
    // loadAllRecords(); // ƒê√£ comment ƒë·ªÉ tr√°nh ghi ƒë√® d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c filter
    
    // Kh·ªüi t·∫°o gi√° tr·ªã m·∫∑c ƒë·ªãnh cho b·ªô l·ªçc Total
    const filterFromDate = document.getElementById('filterFromDate');
    const filterToDate = document.getElementById('filterToDate');
    const quotaFromDate = document.getElementById('quotaFromDate');
    const quotaToDate = document.getElementById('quotaToDate');
    
    if (filterFromDate && !filterFromDate.value) {
        filterFromDate.value = getFirstDayOfMonth();
    }
    if (filterToDate && !filterToDate.value) {
        filterToDate.value = getLastDayOfMonth();
    }
    if (quotaFromDate && !quotaFromDate.value) {
        quotaFromDate.value = getFirstDayOfMonth();
    }
    if (quotaToDate && !quotaToDate.value) {
        quotaToDate.value = getLastDayOfMonth();
    }
    
    // ƒê·∫£m b·∫£o sheet Total ƒë∆∞·ª£c hi·ªÉn th·ªã m·∫∑c ƒë·ªãnh v√† c·∫≠p nh·∫≠t currentActiveTab
    switchSheet('total');
    
    // ƒê·∫£m b·∫£o month picker c√≥ gi√° tr·ªã m·∫∑c ƒë·ªãnh l√† th√°ng hi·ªán t·∫°i n·∫øu ch∆∞a c√≥
    const monthYearInput = document.getElementById('filterMonthYear');
    if (monthYearInput && !monthYearInput.value) {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        monthYearInput.value = `${year}-${month}`;
    }
});
</script>

<style>
.theo-doi-dau-v2-page {
    padding: 20px;
    font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', Arial, sans-serif;
}

.page-header {
    margin-bottom: 30px;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.page-header h2 {
    color: #2c3e50;
    margin: 0;
    font-weight: 600;
    letter-spacing: -0.3px;
}

/* Sheet Tabs Navigation */
.sheet-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.sheet-tab {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    background-color: #e9ecef;
    color: #495057;
    font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', Arial, sans-serif;
}

.sheet-tab:hover {
    background-color: #dee2e6;
}

.sheet-tab.active {
    background-color: #3498db;
    color: #ffffff;
    font-weight: 600;
}

.sheet-content {
    display: block;
}

.card {
    background: #ffffff;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
}

.section-header {
    margin-bottom: 20px;
}

.section-header h3 {
    margin-top: 0;
    color: #2c3e50;
    border-bottom: 2px solid #3498db;
    padding-bottom: 10px;
    font-weight: 600;
    letter-spacing: -0.2px;
}

/* Filter section */
.filter-section {
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 6px;
}

.filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: flex-end;
}

.filter-group {
    flex: 1;
    min-width: 150px;
}

.filter-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #2c3e50;
    font-size: 14px;
}

.filter-input {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
    font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', Arial, sans-serif;
}

.filter-input:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

/* Totals table */
.fuel-totals-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0;
}

.fuel-totals-table th,
.fuel-totals-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
    font-weight: 400;
    letter-spacing: 0.1px;
}

.fuel-totals-table th {
    background-color: #34495e;
    color: #ffffff;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
    box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
}

.fuel-totals-table tbody tr:hover {
    background-color: #f5f5f5;
}

.fuel-totals-table .number {
    text-align: right;
    font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    font-weight: 500;
    letter-spacing: 0.3px;
}

.btn-info {
    background-color: #17a2b8;
    color: white;
    padding: 5px 10px;
    font-size: 12px;
}

.btn-info:hover {
    background-color: #138496;
}

/* Table container with scroll */
.table-container-scroll {
    max-height: 600px;
    overflow-y: auto;
    overflow-x: auto;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: #ffffff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    scrollbar-width: thin;
    scrollbar-color: #34495e #ecf0f1;
}

.table-container-scroll::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.table-container-scroll::-webkit-scrollbar-track {
    background: #ecf0f1;
    border-radius: 4px;
}

.table-container-scroll::-webkit-scrollbar-thumb {
    background: #34495e;
    border-radius: 4px;
}

.table-container-scroll::-webkit-scrollbar-thumb:hover {
    background: #2c3e50;
}

.fuel-records-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0;
}

.fuel-records-table th,
.fuel-records-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
    font-weight: 400;
    letter-spacing: 0.1px;
}

.fuel-records-table th {
    background-color: #34495e;
    color: #ffffff;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 10;
    box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
}

.fuel-records-table tbody tr:hover {
    background-color: #f5f5f5;
}

.fuel-records-table .number {
    text-align: right;
    font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', Arial, sans-serif;
    font-weight: 500;
    letter-spacing: 0.3px;
}

.fuel-records-table .actions {
    display: flex;
    gap: 5px;
    justify-content: center;
    white-space: nowrap;
}

.summary-row {
    background-color: #ecf0f1;
    font-weight: 600;
}

.summary-row td {
    border-top: 2px solid #34495e;
}

.text-center {
    text-align: center;
}

.text-positive {
    color: #27ae60;
    font-weight: 600;
}

.text-negative {
    color: #e74c3c;
    font-weight: 600;
}

/* Buttons */
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    letter-spacing: 0.2px;
    transition: background-color 0.3s;
}

.btn-primary {
    background-color: #3498db;
    color: white;
}

.btn-primary:hover {
    background-color: #2980b9;
}

.btn-success {
    background-color: #27ae60;
    color: white;
}

.btn-success:hover {
    background-color: #229954;
}

.btn-secondary {
    background-color: #95a5a6;
    color: white;
}

.btn-secondary:hover {
    background-color: #7f8c8d;
}

.btn-warning {
    background-color: #f39c12;
    color: white;
    padding: 5px 10px;
    font-size: 12px;
}

.btn-warning:hover {
    background-color: #d68910;
}

.btn-danger {
    background-color: #e74c3c;
    color: white;
    padding: 5px 10px;
    font-size: 12px;
}

.btn-danger:hover {
    background-color: #c0392b;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 13px;
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
    align-items: center;
    justify-content: center;
}

.modal-content {
    background-color: #ffffff;
    margin: auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
    animation: slideDown 0.3s ease;
}

.modal-large {
    max-width: 1200px;
}

@keyframes slideDown {
    from {
        transform: translateY(-50px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 2px solid #e0e0e0;
    background-color: #f8f9fa;
    border-radius: 12px 12px 0 0;
}

.modal-header h3 {
    margin: 0;
    color: #2c3e50;
    font-weight: 600;
}

.modal-close {
    background: none;
    border: none;
    font-size: 28px;
    font-weight: bold;
    color: #5a6c7d;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s ease;
}

.modal-close:hover {
    background-color: #e0e0e0;
    color: #2c3e50;
}

.modal-body {
    padding: 24px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #2c3e50;
}

.form-group label .required {
    color: #e74c3c;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
    box-sizing: border-box;
    font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', Arial, sans-serif;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
}

.form-group input[readonly] {
    background-color: #f5f5f5;
    cursor: not-allowed;
}

.form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 24px;
}

/* Bulk form styles */
#bulkFormContainer {
    display: block;
}

.bulk-form-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 6px;
}

.info-text {
    margin: 0;
    color: #5a6c7d;
    font-size: 14px;
}

.bulk-table-container {
    max-height: 500px;
    overflow-y: auto;
    overflow-x: auto;
    border: 1px solid #ddd;
    border-radius: 6px;
    margin-bottom: 20px;
}

.bulk-input-table {
    width: 100%;
    border-collapse: collapse;
    background: #ffffff;
}

.bulk-input-table th {
    background-color: #34495e;
    color: #ffffff;
    padding: 12px 8px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    position: sticky;
    top: 0;
    z-index: 10;
}

.bulk-input-table th .required {
    color: #ffcccc;
}

.bulk-input-table td {
    padding: 8px;
    border-bottom: 1px solid #e0e0e0;
    vertical-align: middle;
}

.bulk-input-table tbody tr:hover {
    background-color: #f5f5f5;
}

.bulk-input-table tbody tr:last-child td {
    border-bottom: none;
}

.bulk-input {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 13px;
    box-sizing: border-box;
    font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, 'Roboto', 'Helvetica Neue', Arial, sans-serif;
}

.bulk-input:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
}

.bulk-input[readonly] {
    background-color: #f5f5f5;
    cursor: not-allowed;
}

.bulk-input-table select.bulk-input {
    padding: 8px 6px;
}

/* Responsive */
@media (max-width: 768px) {
    .theo-doi-dau-v2-page {
        padding: 10px;
    }
    
    .header-content {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .table-container-scroll {
        max-height: 400px;
    }
    
    .fuel-records-table th,
    .fuel-records-table td {
        padding: 8px;
        font-size: 13px;
    }
    
    .fuel-records-table .actions {
        flex-direction: column;
        gap: 3px;
    }
    
    .modal-content {
        width: 95%;
    }
    
    .modal-large {
        max-width: 95%;
    }
    
    .bulk-table-container {
        max-height: 300px;
    }
    
    .bulk-input-table th,
    .bulk-input-table td {
        padding: 6px 4px;
        font-size: 12px;
    }
    
    .bulk-input {
        font-size: 12px;
        padding: 6px;
    }
    
    .bulk-form-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
    }
    
    .filter-row {
        flex-direction: column;
    }
    
    .filter-group {
        min-width: 100%;
    }
    
    .fuel-totals-table th,
    .fuel-totals-table td {
        padding: 8px;
        font-size: 13px;
    }
    
    .fuel-totals-table .actions {
        flex-direction: column;
        gap: 3px;
    }
    
    .sheet-tabs {
        gap: 8px;
    }
    
    .sheet-tab {
        padding: 8px 16px;
        font-size: 13px;
    }
}
</style>
{% endblock %}
