{% extends "base.html" %}

{% block title %}Theo d√µi v·ªè xe - H·ªá th·ªëng qu·∫£n l√Ω v·∫≠n chuy·ªÉn{% endblock %}

{% block content %}
<div class="tire-tracking-page-wrapper">
<h2 class="tire-tracking-page-title">üõû Theo d√µi v·ªè xe</h2>

<h3 class="tire-tracking-section-title">üìã Danh s√°ch xe</h3>
{% if vehicles %}
<div style="overflow-x: auto;">
    <table class="table">
        <thead>
            <tr>
                <th>STT</th>
                <th>Bi·ªÉn s·ªë xe</th>
                <th>Lo·∫°i v·ªè ƒëang s·ª≠ d·ª•ng</th>
                <th>S·ªë km thay g·∫ßn nh·∫•t</th>
                <th>S·ªë km ƒë√£ ch·∫°y</th>
                <th>Tu·ªïi th·ªç d·ª± ki·∫øn (km)</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Chi ti·∫øt</th>
            </tr>
        </thead>
        <tbody>
            {% for vehicle in vehicles %}
            <tr>
                <td>{{ loop.index }}</td>
                <td style="white-space: nowrap;"><strong>{{ vehicle.license_plate }}</strong></td>
                <td>
                    {% if vehicle.current_tire_type %}
                        {{ vehicle.current_tire_type }}
                    {% else %}
                        <span style="color: #95a5a6;">Ch∆∞a c√≥ d·ªØ li·ªáu</span>
                    {% endif %}
                </td>
                <td>
                    {% if vehicle.last_replacement_km %}
                        {{ "{:,.0f}".format(vehicle.last_replacement_km) }} km
                    {% else %}
                        <span style="color: #95a5a6;">Ch∆∞a c√≥ d·ªØ li·ªáu</span>
                    {% endif %}
                </td>
                <td>
                    {% if vehicle.km_run %}
                        {{ "{:,.0f}".format(vehicle.km_run) }} km
                    {% else %}
                        <span style="color: #95a5a6;">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if vehicle.expected_lifespan %}
                        {{ "{:,.0f}".format(vehicle.expected_lifespan) }} km
                    {% else %}
                        <span style="color: #95a5a6;">-</span>
                    {% endif %}
                </td>
                <td>
                    {% if vehicle.tire_status == "B√¨nh th∆∞·ªùng" %}
                        <span class="tire-status-normal">{{ vehicle.tire_status }}</span>
                    {% elif vehicle.tire_status == "S·∫Øp t·ªõi h·∫°n" %}
                        <span class="tire-status-warning">{{ vehicle.tire_status }}</span>
                    {% elif vehicle.tire_status == "Qu√° h·∫°n" %}
                        <span class="tire-status-overdue">{{ vehicle.tire_status }}</span>
                    {% else %}
                        <span style="color: #95a5a6;">-</span>
                    {% endif %}
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-primary" onclick="openDetailModal({{ vehicle.id }}, '{{ vehicle.license_plate }}')" style="padding: 5px 10px; font-size: 12px;">
                        Chi ti·∫øt
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div style="text-align: center; padding: 40px; color: #7f8c8d;">
    <h3>üöö Ch∆∞a c√≥ xe n√†o</h3>
    <p>Ch∆∞a c√≥ xe lo·∫°i "Xe Nh√†" trong h·ªá th·ªëng</p>
</div>
{% endif %}
</div>

<!-- Modal Chi ti·∫øt v·ªè xe -->
<div id="detailModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 1200px;">
        <div class="modal-header">
            <h3 id="detailModalTitle">Chi ti·∫øt v·ªè xe</h3>
            <span class="close" onclick="closeDetailModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div style="margin-bottom: 20px;">
                <button type="button" class="btn btn-success" onclick="openAddTireModal()">
                    ‚ûï Th√™m m·ªõi
                </button>
            </div>
            
            <div id="tireList">
                <!-- Danh s√°ch thay v·ªè s·∫Ω ƒë∆∞·ª£c load b·∫±ng JavaScript -->
                <div style="text-align: center; padding: 20px; color: #7f8c8d;">
                    ƒêang t·∫£i...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Th√™m m·ªõi thay v·ªè -->
<div id="addTireModal" class="modal" style="display: none;">
    <div class="modal-content modal-fullscreen">
        <div class="modal-header">
            <h3>‚ûï Th√™m m·ªõi thay v·ªè</h3>
            <span class="close" onclick="closeAddTireModal()" title="ƒê√≥ng">&times;</span>
        </div>
        <div class="modal-body modal-body-fullscreen">
            <form id="addTireForm">
                <input type="hidden" id="tire_vehicle_id" name="vehicle_id">
                
                <!-- B∆∞·ªõc 1 - Th√¥ng tin b·∫Øt bu·ªôc -->
                <div id="step1Section" style="margin-bottom: 30px;">
                    <h4 style="color: #1976d2; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #42a5f5; background: #e3f2fd; padding: 12px 15px; border-radius: 6px;">
                        B∆∞·ªõc 1 - Th√¥ng tin b·∫Øt bu·ªôc
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label for="replacement_date">Ng√†y thay v·ªè *</label>
                            <input type="date" id="replacement_date" name="replacement_date" required>
                        </div>
                        <div class="form-group">
                            <label for="replacement_km">S·ªë km t·∫°i th·ªùi ƒëi·ªÉm thay *</label>
                            <input type="number" id="replacement_km" name="replacement_km" step="0.1" required placeholder="VD: 120000">
                        </div>
                    </div>
                </div>
                
                <!-- B∆∞·ªõc 2 - Danh s√°ch v·ªè thay (ch·ªâ hi·ªÉn th·ªã sau khi nh·∫≠p xong b∆∞·ªõc 1) -->
                <div id="step2Section" style="display: none; margin-bottom: 30px;">
                    <h4 style="color: #1976d2; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #42a5f5; background: #e3f2fd; padding: 12px 15px; border-radius: 6px;">
                        B∆∞·ªõc 2 - Danh s√°ch v·ªè thay
                    </h4>
                    
                    <div id="tireItemsContainer">
                        <!-- C√°c d√≤ng v·ªè s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                    </div>
                    
                    <button type="button" class="btn btn-info" onclick="addTireItem()" style="margin-top: 15px;">
                        ‚ûï Th√™m d√≤ng +
                    </button>
                    
                    <!-- T·ªïng h·ª£p chi ph√≠ -->
                    <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 10px; border: 2px solid #90caf9;">
                        <h4 style="color: #1565c0; margin-bottom: 15px; font-weight: 600;">T·ªïng h·ª£p chi ph√≠</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="font-weight: 600; color: #1976d2;">T·ªïng c·ªông:</label>
                                <div id="totalAmount" style="font-size: 18px; font-weight: bold; color: #1565c0; margin-top: 5px;">
                                    0 VNƒê
                                </div>
                            </div>
                            <div>
                                <label for="vat_rate" style="font-weight: 600; color: #1976d2;">VAT:</label>
                                <select id="vat_rate" name="vat_rate" onchange="calculateTotal()" style="width: 100%; padding: 8px; border: 2px solid #90caf9; border-radius: 4px; margin-top: 5px; background: white;">
                                    <option value="0">0%</option>
                                    <option value="5">5%</option>
                                    <option value="8">8%</option>
                                    <option value="10">10%</option>
                                </select>
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <label style="font-weight: 600; color: #1976d2;">T·ªïng c·ªông (bao g·ªìm VAT):</label>
                                <div id="totalWithVat" style="font-size: 20px; font-weight: bold; color: #1565c0; margin-top: 5px; padding: 10px; background: white; border-radius: 6px; border: 2px solid #42a5f5;">
                                    0 VNƒê
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="notes">Ghi ch√∫</label>
                        <textarea id="notes" name="notes" rows="3" placeholder="Nh·∫≠p ghi ch√∫ (n·∫øu c√≥)"></textarea>
                    </div>
                </div>
                
                <div class="modal-footer" style="margin-top: 20px; text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeAddTireModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-success" id="submitBtn" disabled>L∆∞u</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal X√°c nh·∫≠n ƒë√≥ng form -->
<div id="confirmCloseModal" class="modal" style="display: none; z-index: 2000;">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">
            <h3>‚ö†Ô∏è X√°c nh·∫≠n ƒë√≥ng form</h3>
            <span class="close" onclick="closeConfirmCloseModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p style="font-size: 16px; margin-bottom: 20px;">
                <strong>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒë√≥ng?</strong>
            </p>
            <p style="color: #e74c3c; margin-bottom: 25px;">
                D·ªØ li·ªáu ƒë√£ nh·∫≠p s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u.
            </p>
            <div class="modal-footer" style="margin-top: 20px; text-align: right; border-top: none; background: transparent;">
                <button type="button" class="btn btn-primary" onclick="continueEditing()" style="margin-right: 10px;">
                    Ti·∫øp t·ª•c nh·∫≠p
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmCloseWithoutSave()">
                    ƒê√≥ng & kh√¥ng l∆∞u
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal S·ª≠a thay v·ªè -->
<div id="editTireModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <h3>‚úèÔ∏è S·ª≠a thay v·ªè</h3>
            <span class="close" onclick="closeEditTireModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="editTireForm">
                <input type="hidden" id="edit_replacement_id" name="replacement_id">
                
                <!-- B∆∞·ªõc 1 - Th√¥ng tin b·∫Øt bu·ªôc -->
                <div id="editStep1Section" style="margin-bottom: 30px;">
                    <h4 style="color: #1976d2; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #42a5f5; background: #e3f2fd; padding: 12px 15px; border-radius: 6px;">
                        B∆∞·ªõc 1 - Th√¥ng tin b·∫Øt bu·ªôc
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div class="form-group">
                            <label for="edit_replacement_date">Ng√†y thay v·ªè *</label>
                            <input type="date" id="edit_replacement_date" name="replacement_date" required>
                        </div>
                        <div class="form-group">
                            <label for="edit_replacement_km">S·ªë km t·∫°i th·ªùi ƒëi·ªÉm thay *</label>
                            <input type="number" id="edit_replacement_km" name="replacement_km" step="0.1" required placeholder="VD: 120000">
                        </div>
                    </div>
                </div>
                
                <!-- B∆∞·ªõc 2 - Danh s√°ch v·ªè thay -->
                <div id="editStep2Section" style="margin-bottom: 30px;">
                    <h4 style="color: #1976d2; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #42a5f5; background: #e3f2fd; padding: 12px 15px; border-radius: 6px;">
                        B∆∞·ªõc 2 - Danh s√°ch v·ªè thay
                    </h4>
                    
                    <div id="editTireItemsContainer">
                        <!-- C√°c d√≤ng v·ªè s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JavaScript -->
                    </div>
                    
                    <button type="button" class="btn btn-info" onclick="addEditTireItem()" style="margin-top: 15px;">
                        ‚ûï Th√™m d√≤ng +
                    </button>
                    
                    <!-- T·ªïng h·ª£p chi ph√≠ -->
                    <div style="margin-top: 30px; padding: 20px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 10px; border: 2px solid #90caf9;">
                        <h4 style="color: #1565c0; margin-bottom: 15px; font-weight: 600;">T·ªïng h·ª£p chi ph√≠</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="font-weight: 600; color: #1976d2;">T·ªïng c·ªông:</label>
                                <div id="editTotalAmount" style="font-size: 18px; font-weight: bold; color: #1565c0; margin-top: 5px;">
                                    0 VNƒê
                                </div>
                            </div>
                            <div>
                                <label for="edit_vat_rate" style="font-weight: 600; color: #1976d2;">VAT:</label>
                                <select id="edit_vat_rate" name="vat_rate" onchange="calculateEditTotal()" style="width: 100%; padding: 8px; border: 2px solid #90caf9; border-radius: 4px; margin-top: 5px; background: white;">
                                    <option value="0">0%</option>
                                    <option value="5">5%</option>
                                    <option value="8">8%</option>
                                    <option value="10">10%</option>
                                </select>
                            </div>
                            <div style="grid-column: 1 / -1;">
                                <label style="font-weight: 600; color: #1976d2;">T·ªïng c·ªông (bao g·ªìm VAT):</label>
                                <div id="editTotalWithVat" style="font-size: 20px; font-weight: bold; color: #1565c0; margin-top: 5px; padding: 10px; background: white; border-radius: 6px; border: 2px solid #42a5f5;">
                                    0 VNƒê
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="edit_notes">Ghi ch√∫</label>
                        <textarea id="edit_notes" name="notes" rows="3" placeholder="Nh·∫≠p ghi ch√∫ (n·∫øu c√≥)"></textarea>
                    </div>
                </div>
                
                <div class="modal-footer" style="margin-top: 20px; text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditTireModal()">H·ªßy</button>
                    <button type="submit" class="btn btn-success">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* ===== TIRE TRACKING PAGE LIGHT BLUE THEME ===== */
.tire-tracking-page-wrapper {
    background: linear-gradient(135deg, #e3f2fd 0%, #f5f7fa 100%);
    padding: 25px;
    border-radius: 12px;
    margin: -25px;
    min-height: calc(100vh - 100px);
}

.tire-tracking-page-title {
    color: #1565c0;
    font-size: 28px;
    font-weight: 600;
    margin-bottom: 20px;
    padding: 15px 20px;
    background: linear-gradient(135deg, #90caf9 0%, #64b5f6 100%);
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(25, 118, 210, 0.2);
    text-align: center;
}

.tire-tracking-section-title {
    color: #1976d2;
    font-size: 20px;
    font-weight: 600;
    margin: 25px 0 15px 0;
    padding: 12px 18px;
    background: #e1f5fe;
    border-left: 4px solid #42a5f5;
    border-radius: 6px;
}

/* Table styling with light blue theme */
.tire-tracking-page-wrapper .table {
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(25, 118, 210, 0.1);
}

.tire-tracking-page-wrapper .table thead {
    background: linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%);
}

.tire-tracking-page-wrapper .table th {
    background: linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%);
    color: white;
    font-weight: 600;
    padding: 14px;
    border: none;
    text-align: center;
}

.tire-tracking-page-wrapper .table tbody tr {
    background: white;
    transition: background-color 0.2s ease;
}

.tire-tracking-page-wrapper .table tbody tr:hover {
    background: #e3f2fd;
}

.tire-tracking-page-wrapper .table td {
    padding: 12px;
    border-bottom: 1px solid #e1f5fe;
    text-align: center;
}

/* Tire status colors */
.tire-status-normal {
    color: #27ae60;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 4px;
    background-color: rgba(39, 174, 96, 0.1);
}

.tire-status-warning {
    color: #f39c12;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 4px;
    background-color: rgba(243, 156, 18, 0.1);
}

.tire-status-overdue {
    color: #e74c3c;
    font-weight: 600;
    padding: 4px 8px;
    border-radius: 4px;
    background-color: rgba(231, 76, 60, 0.1);
    animation: blink-red 1.5s infinite;
}

@keyframes blink-red {
    0%, 100% {
        background-color: rgba(231, 76, 60, 0.2);
        color: #e74c3c;
    }
    50% {
        background-color: rgba(231, 76, 60, 0.5);
        color: #c0392b;
    }
}

/* Button styling */
.tire-tracking-page-wrapper .btn-primary {
    background: linear-gradient(135deg, #42a5f5 0%, #2196f3 100%);
    border: none;
    box-shadow: 0 2px 6px rgba(33, 150, 243, 0.3);
    transition: all 0.3s ease;
}

.tire-tracking-page-wrapper .btn-primary:hover {
    background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
    box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4);
    transform: translateY(-1px);
}

.tire-tracking-page-wrapper .btn-success {
    background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%);
    box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
}

.tire-tracking-page-wrapper .btn-success:hover {
    background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
    box-shadow: 0 4px 10px rgba(76, 175, 80, 0.4);
}

.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    padding: 0;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-fullscreen {
    width: 95vw;
    height: 95vh;
    margin: 2.5vh auto;
    max-width: none;
    max-height: none;
    display: flex;
    flex-direction: column;
}

.modal-body-fullscreen {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #64b5f6 0%, #42a5f5 50%, #2196f3 100%);
    color: white;
    border-radius: 10px 10px 0 0;
    box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
}

.modal-header h3 {
    margin: 0;
    color: white;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid #ddd;
    background: #e3f2fd;
    border-radius: 0 0 10px 10px;
}

.close {
    color: white;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.close:hover {
    opacity: 0.7;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #2c3e50;
}

.form-group input,
.form-group select,
.form-group textarea {
    width: 100%;
    padding: 10px 12px;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #42a5f5;
    box-shadow: 0 0 0 3px rgba(66, 165, 245, 0.15);
}

.tire-item-row {
    display: grid;
    grid-template-columns: 2fr 1.5fr 1.5fr 0.8fr 1.2fr 1.2fr auto;
    gap: 8px;
    align-items: end;
    padding: 10px;
    background: #e3f2fd;
    border-radius: 8px;
    margin-bottom: 5px;
    border: 1px solid #bbdefb;
    transition: background-color 0.2s ease;
}

.tire-item-row:hover {
    background: #bbdefb;
}

.tire-item-row input,
.tire-item-row select {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 13px;
}

.btn-remove-item {
    background: #e74c3c;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.btn-remove-item:hover {
    background: #c0392b;
}

.tire-record {
    border: 2px solid #90caf9;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 15px;
    background: linear-gradient(135deg, #ffffff 0%, #e3f2fd 100%);
    box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
    transition: box-shadow 0.3s ease;
}

.tire-record:hover {
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
}

.tire-record-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #bbdefb;
}

.tire-record-info {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-bottom: 15px;
}

.tire-items-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}

.tire-items-table th,
.tire-items-table td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #e1f5fe;
}

.tire-items-table tbody tr:hover {
    background: #e3f2fd;
}

.tire-items-table th {
    background: linear-gradient(135deg, #90caf9 0%, #64b5f6 100%);
    font-weight: 600;
    color: white;
    border-bottom: 2px solid #42a5f5;
}

.tire-total {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 2px solid #42a5f5;
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    color: #1565c0;
}
</style>

<script>
let currentVehicleId = null;
let currentLicensePlate = null;
let itemCounter = 0;
let tireTypesList = [];
let isFormSaved = false; // Theo d√µi tr·∫°ng th√°i ƒë√£ l∆∞u
let pendingCloseAction = null; // L∆∞u h√†nh ƒë·ªông ƒë√≥ng ƒëang ch·ªù x√°c nh·∫≠n

// Load danh s√°ch lo·∫°i v·ªè t·ª´ server
async function loadTireTypes() {
    try {
        const response = await fetch('/api/tire-types');
        const data = await response.json();
        if (data.success && data.tire_types) {
            tireTypesList = data.tire_types;
        }
    } catch (error) {
        console.error('Error loading tire types:', error);
    }
}

// M·ªü modal chi ti·∫øt
async function openDetailModal(vehicleId, licensePlate) {
    currentVehicleId = vehicleId;
    currentLicensePlate = licensePlate;
    
    document.getElementById('detailModalTitle').textContent = `Chi ti·∫øt v·ªè xe - ${licensePlate}`;
    document.getElementById('detailModal').style.display = 'block';
    
    // Load danh s√°ch thay v·ªè
    await loadTireList(vehicleId);
}

// ƒê√≥ng modal chi ti·∫øt
function closeDetailModal() {
    document.getElementById('detailModal').style.display = 'none';
    currentVehicleId = null;
    currentLicensePlate = null;
}

// Load danh s√°ch thay v·ªè
async function loadTireList(vehicleId) {
    const container = document.getElementById('tireList');
    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #7f8c8d;">ƒêang t·∫£i...</div>';
    
    try {
        const response = await fetch(`/api/tire-replacement/detail/${vehicleId}`);
        const data = await response.json();
        
        if (data.success) {
            if (data.replacements.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #7f8c8d;"><p>Ch∆∞a c√≥ l·∫ßn thay v·ªè n√†o</p></div>';
            } else {
                let html = '<table class="tire-items-table"><thead><tr><th>Ng√†y thay</th><th>Lo·∫°i v·ªè</th><th>H√£ng v·ªè</th><th>Seri v·ªè</th><th>Km l√∫c thay</th><th>Gi√°</th><th>Ghi ch√∫</th><th>Thao t√°c</th></tr></thead><tbody>';
                data.replacements.forEach(replacement => {
                    replacement.items.forEach((item, index) => {
                        html += `
                            <tr>
                                ${index === 0 ? `<td rowspan="${replacement.items.length}">${formatDate(replacement.replacement_date)}</td>` : ''}
                                <td>${item.tire_type || ''}</td>
                                <td>${item.tire_manufacturer || ''}</td>
                                <td>${item.tire_brand || ''}</td>
                                ${index === 0 ? `<td rowspan="${replacement.items.length}">${formatNumber(replacement.replacement_km)} km</td>` : ''}
                                <td>${formatCurrency(item.total_price)}</td>
                                ${index === 0 ? `<td rowspan="${replacement.items.length}">${replacement.notes || ''}</td>` : ''}
                                ${index === 0 ? `<td rowspan="${replacement.items.length}">
                                    <button type="button" class="btn btn-sm btn-warning" onclick="openEditTireModal(${replacement.id})" style="padding: 5px 15px; font-size: 12px;">
                                        ‚úèÔ∏è S·ª≠a
                                    </button>
                                    <button type="button" class="btn btn-sm btn-danger" onclick="confirmDeleteTire(${replacement.id})" style="padding: 5px 15px; font-size: 12px;">
                                        üóëÔ∏è X√≥a
                                    </button>
                                </td>` : ''}
                            </tr>
                        `;
                    });
                });
                html += '</tbody></table>';
                container.innerHTML = html;
            }
        } else {
            container.innerHTML = `<div style="text-align: center; padding: 20px; color: #e74c3c;">L·ªói: ${data.error}</div>`;
        }
    } catch (error) {
        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #e74c3c;">L·ªói khi t·∫£i d·ªØ li·ªáu: ${error.message}</div>`;
    }
}

// M·ªü modal th√™m m·ªõi
function openAddTireModal() {
    if (!currentVehicleId) {
        alert('Vui l√≤ng ch·ªçn xe tr∆∞·ªõc');
        return;
    }
    
    document.getElementById('tire_vehicle_id').value = currentVehicleId;
    document.getElementById('addTireForm').reset();
    document.getElementById('step2Section').style.display = 'none';
    document.getElementById('tireItemsContainer').innerHTML = '';
    document.getElementById('submitBtn').disabled = true;
    itemCounter = 0;
    isFormSaved = false; // Reset tr·∫°ng th√°i ƒë√£ l∆∞u
    pendingCloseAction = null; // Reset h√†nh ƒë·ªông ƒë√≥ng
    calculateTotal();
    
    document.getElementById('addTireModal').style.display = 'block';
    
    // Ki·ªÉm tra khi nh·∫≠p xong b∆∞·ªõc 1
    const dateInput = document.getElementById('replacement_date');
    const kmInput = document.getElementById('replacement_km');
    
    function checkStep1() {
        if (dateInput.value && kmInput.value) {
            document.getElementById('step2Section').style.display = 'block';
            document.getElementById('submitBtn').disabled = false;
            // T·ª± ƒë·ªông t·∫°o 1 d√≤ng m·∫∑c ƒë·ªãnh n·∫øu ch∆∞a c√≥
            if (itemCounter === 0) {
                addTireItem();
            }
        } else {
            document.getElementById('step2Section').style.display = 'none';
            document.getElementById('submitBtn').disabled = true;
        }
    }
    
    dateInput.onchange = checkStep1;
    kmInput.oninput = checkStep1;
}

// Ki·ªÉm tra xem form c√≥ d·ªØ li·ªáu ƒë√£ nh·∫≠p ch∆∞a
function hasFormData() {
    // Ki·ªÉm tra b∆∞·ªõc 1
    const dateInput = document.getElementById('replacement_date');
    const kmInput = document.getElementById('replacement_km');
    
    if (dateInput.value || kmInput.value) {
        return true;
    }
    
    // Ki·ªÉm tra b∆∞·ªõc 2 - c√°c d√≤ng v·ªè
    const rows = document.querySelectorAll('#tireItemsContainer .tire-item-row');
    for (let row of rows) {
        const tireType = row.querySelector('.item-tire-type')?.value.trim();
        const manufacturer = row.querySelector('.item-tire-manufacturer')?.value.trim();
        const brand = row.querySelector('.item-tire-brand')?.value.trim();
        const quantity = row.querySelector('.item-quantity')?.value;
        const unitPrice = row.querySelector('.item-unit-price')?.value;
        
        if (tireType || manufacturer || brand || (quantity && parseFloat(quantity) > 0) || (unitPrice && parseFloat(unitPrice) > 0)) {
            return true;
        }
    }
    
    // Ki·ªÉm tra ghi ch√∫
    const notes = document.getElementById('notes')?.value.trim();
    if (notes) {
        return true;
    }
    
    return false;
}

// ƒê√≥ng modal x√°c nh·∫≠n
function closeConfirmCloseModal() {
    document.getElementById('confirmCloseModal').style.display = 'none';
}

// Ti·∫øp t·ª•c nh·∫≠p li·ªáu
function continueEditing() {
    closeConfirmCloseModal();
    // Kh√¥ng reset pendingCloseAction ƒë·ªÉ gi·ªØ l·∫°i h√†nh ƒë·ªông ƒë√≥ng
}

// X√°c nh·∫≠n ƒë√≥ng v√† kh√¥ng l∆∞u
function confirmCloseWithoutSave() {
    // B∆∞·ªõc 1: ƒê√≥ng modal x√°c nh·∫≠n tr∆∞·ªõc
    closeConfirmCloseModal();
    
    // B∆∞·ªõc 2: Reset tr·∫°ng th√°i form
    document.getElementById('addTireForm').reset();
    document.getElementById('step2Section').style.display = 'none';
    document.getElementById('tireItemsContainer').innerHTML = '';
    itemCounter = 0;
    
    // B∆∞·ªõc 3: T·∫Øt tr·∫°ng th√°i isDirty (isFormSaved)
    isFormSaved = false;
    
    // B∆∞·ªõc 4: ƒê√≥ng form cha
    document.getElementById('addTireModal').style.display = 'none';
    
    // Reset pendingCloseAction
    pendingCloseAction = null;
}

// ƒê√≥ng modal th√™m m·ªõi (c√≥ ki·ªÉm tra d·ªØ li·ªáu ch∆∞a l∆∞u)
function closeAddTireModal(force = false) {
    // N·∫øu ƒë√£ l∆∞u ho·∫∑c force = true, ƒë√≥ng ngay
    if (isFormSaved || force) {
        document.getElementById('addTireModal').style.display = 'none';
        document.getElementById('addTireForm').reset();
        document.getElementById('step2Section').style.display = 'none';
        document.getElementById('tireItemsContainer').innerHTML = '';
        itemCounter = 0;
        isFormSaved = false;
        pendingCloseAction = null;
        return;
    }
    
    // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu ƒë√£ nh·∫≠p ch∆∞a
    if (hasFormData()) {
        // Hi·ªÉn th·ªã popup x√°c nh·∫≠n
        pendingCloseAction = function() {
            document.getElementById('addTireModal').style.display = 'none';
            document.getElementById('addTireForm').reset();
            document.getElementById('step2Section').style.display = 'none';
            document.getElementById('tireItemsContainer').innerHTML = '';
            itemCounter = 0;
            isFormSaved = false;
            pendingCloseAction = null;
        };
        document.getElementById('confirmCloseModal').style.display = 'block';
    } else {
        // Kh√¥ng c√≥ d·ªØ li·ªáu, ƒë√≥ng ngay
        document.getElementById('addTireModal').style.display = 'none';
        document.getElementById('addTireForm').reset();
        document.getElementById('step2Section').style.display = 'none';
        document.getElementById('tireItemsContainer').innerHTML = '';
        itemCounter = 0;
    }
}

// Th√™m d√≤ng v·ªè
function addTireItem() {
    itemCounter++;
    const container = document.getElementById('tireItemsContainer');
    const itemId = `item_${itemCounter}`;
    
    // T·∫°o options cho select lo·∫°i v·ªè
    const tireTypeOptions = tireTypesList.map(t => 
        `<option value="${t.tire_type}">${t.tire_type}</option>`
    ).join('');
    
    const row = document.createElement('div');
    row.className = 'tire-item-row';
    row.id = itemId;
    row.innerHTML = `
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">Lo·∫°i v·ªè *</label>
            <input type="text" class="item-tire-type" placeholder="Nh·∫≠p lo·∫°i v·ªè" list="tireTypesList" required>
            <datalist id="tireTypesList">
                ${tireTypeOptions}
            </datalist>
        </div>
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">H√£ng v·ªè *</label>
            <input type="text" class="item-tire-manufacturer" placeholder="Nh·∫≠p h√£ng v·ªè" required>
        </div>
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">Seri v·ªè *</label>
            <input type="text" class="item-tire-brand" placeholder="Nh·∫≠p seri v·ªè" required>
        </div>
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">S·ªë l∆∞·ª£ng *</label>
            <input type="number" class="item-quantity" step="0.01" value="1" min="0" oninput="calculateItemTotal('${itemId}')" required>
        </div>
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">ƒê∆°n gi√° *</label>
            <input type="number" class="item-unit-price" step="0.01" value="0" min="0" oninput="calculateItemTotal('${itemId}')" required>
        </div>
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">Th√†nh ti·ªÅn</label>
            <input type="text" class="item-total" readonly style="background: #f8f9fa;">
        </div>
        <div>
            <button type="button" class="btn-remove-item" onclick="removeTireItem('${itemId}')">X√≥a</button>
        </div>
    `;
    
    container.appendChild(row);
    calculateItemTotal(itemId);
}

// X√≥a d√≤ng v·ªè
function removeTireItem(itemId) {
    const row = document.getElementById(itemId);
    if (row) {
        row.remove();
        calculateTotal();
    }
}

// T√≠nh th√†nh ti·ªÅn cho m·ªôt v·ªè
function calculateItemTotal(itemId) {
    const row = document.getElementById(itemId);
    if (!row) return;
    
    const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
    const unitPrice = parseFloat(row.querySelector('.item-unit-price').value) || 0;
    const total = quantity * unitPrice;
    
    row.querySelector('.item-total').value = formatCurrency(total);
    calculateTotal();
}

// T√≠nh t·ªïng
function calculateTotal() {
    let total = 0;
    const rows = document.querySelectorAll('.tire-item-row');
    
    rows.forEach(row => {
        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const unitPrice = parseFloat(row.querySelector('.item-unit-price').value) || 0;
        const itemTotal = quantity * unitPrice;
        total += itemTotal;
    });
    
    const vatRate = parseFloat(document.getElementById('vat_rate').value) || 0;
    const vatAmount = total * (vatRate / 100);
    const totalWithVat = total + vatAmount;
    
    document.getElementById('totalAmount').textContent = formatCurrency(total);
    document.getElementById('totalWithVat').textContent = formatCurrency(totalWithVat);
}

// Submit form
document.getElementById('addTireForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const vehicleId = parseInt(document.getElementById('tire_vehicle_id').value);
    const replacementDate = document.getElementById('replacement_date').value;
    const replacementKm = parseFloat(document.getElementById('replacement_km').value);
    const vatRate = parseFloat(document.getElementById('vat_rate').value) || 0;
    const notes = document.getElementById('notes').value;
    
    // Thu th·∫≠p items
    const items = [];
    const rows = document.querySelectorAll('.tire-item-row');
    
    rows.forEach(row => {
        const tireType = row.querySelector('.item-tire-type').value.trim();
        if (!tireType) return;
        
        items.push({
            tire_type: tireType,
            tire_manufacturer: row.querySelector('.item-tire-manufacturer').value.trim(),
            tire_brand: row.querySelector('.item-tire-brand').value.trim(),
            quantity: parseFloat(row.querySelector('.item-quantity').value) || 0,
            unit_price: parseFloat(row.querySelector('.item-unit-price').value) || 0
        });
    });
    
    if (items.length === 0) {
        alert('Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt v·ªè');
        return;
    }
    
    // T·∫°o FormData
    const formData = new FormData();
    formData.append('vehicle_id', vehicleId);
    formData.append('replacement_date', replacementDate);
    formData.append('replacement_km', replacementKm);
    formData.append('vat_rate', vatRate);
    formData.append('notes', notes);
    formData.append('items', JSON.stringify(items));
    
    try {
        const response = await fetch('/api/tire-replacement/add', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('ƒê√£ th√™m thay v·ªè th√†nh c√¥ng!');
            isFormSaved = true; // ƒê√°nh d·∫•u ƒë√£ l∆∞u th√†nh c√¥ng
            closeAddTireModal(true); // Force close v√¨ ƒë√£ l∆∞u
            await loadTireList(vehicleId);
            // Reload trang ƒë·ªÉ c·∫≠p nh·∫≠t th√¥ng tin
            location.reload();
        } else {
            alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ th√™m thay v·ªè'));
        }
    } catch (error) {
        alert('L·ªói khi th√™m thay v·ªè: ' + error.message);
    }
});

// ƒê√≥ng modal khi click b√™n ngo√†i
window.onclick = function(event) {
    const detailModal = document.getElementById('detailModal');
    const addModal = document.getElementById('addTireModal');
    const editModal = document.getElementById('editTireModal');
    const confirmModal = document.getElementById('confirmCloseModal');
    
    // N·∫øu modal x√°c nh·∫≠n ƒëang m·ªü, ch·ªâ x·ª≠ l√Ω click v√†o n√≥
    if (confirmModal && confirmModal.style.display === 'block') {
        if (event.target === confirmModal) {
            // Click v√†o overlay c·ªßa modal x√°c nh·∫≠n - ƒë√≥ng modal x√°c nh·∫≠n
            closeConfirmCloseModal();
        }
        // Kh√¥ng x·ª≠ l√Ω c√°c click kh√°c khi modal x√°c nh·∫≠n ƒëang m·ªü
        return;
    }
    
    if (event.target === detailModal) {
        closeDetailModal();
    }
    if (event.target === addModal) {
        // Ki·ªÉm tra d·ªØ li·ªáu ch∆∞a l∆∞u tr∆∞·ªõc khi ƒë√≥ng
        closeAddTireModal();
    }
    if (event.target === editModal) {
        closeEditTireModal();
    }
}

// X·ª≠ l√Ω ph√≠m ESC
document.addEventListener('keydown', function(event) {
    // Ch·ªâ x·ª≠ l√Ω khi modal th√™m m·ªõi ƒëang m·ªü
    const addModal = document.getElementById('addTireModal');
    const confirmModal = document.getElementById('confirmCloseModal');
    
    if (event.key === 'Escape' || event.keyCode === 27) {
        // N·∫øu modal x√°c nh·∫≠n ƒëang m·ªü, ƒë√≥ng n√≥
        if (confirmModal && confirmModal.style.display === 'block') {
            closeConfirmCloseModal();
            return;
        }
        
        // N·∫øu modal th√™m m·ªõi ƒëang m·ªü, ki·ªÉm tra d·ªØ li·ªáu ch∆∞a l∆∞u
        if (addModal && addModal.style.display === 'block') {
            closeAddTireModal();
        }
    }
});

// M·ªü modal s·ª≠a thay v·ªè
async function openEditTireModal(replacementId) {
    try {
        const response = await fetch(`/api/tire-replacement/get/${replacementId}`);
        const data = await response.json();
        
        if (!data.success) {
            alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin thay v·ªè'));
            return;
        }
        
        const replacement = data.replacement;
        
        // ƒêi·ªÅn th√¥ng tin v√†o form
        document.getElementById('edit_replacement_id').value = replacement.id;
        document.getElementById('edit_replacement_date').value = replacement.replacement_date;
        document.getElementById('edit_replacement_km').value = replacement.replacement_km;
        document.getElementById('edit_vat_rate').value = replacement.vat_rate;
        document.getElementById('edit_notes').value = replacement.notes || '';
        
        // X√≥a c√°c items c≈©
        document.getElementById('editTireItemsContainer').innerHTML = '';
        editItemCounter = 0;
        
        // Th√™m c√°c items
        replacement.items.forEach(item => {
            addEditTireItemWithData(item);
        });
        
        // T√≠nh t·ªïng
        calculateEditTotal();
        
        // Hi·ªÉn th·ªã modal
        document.getElementById('editTireModal').style.display = 'block';
    } catch (error) {
        alert('L·ªói khi t·∫£i th√¥ng tin thay v·ªè: ' + error.message);
    }
}

// ƒê√≥ng modal s·ª≠a thay v·ªè
function closeEditTireModal() {
    document.getElementById('editTireModal').style.display = 'none';
    document.getElementById('editTireForm').reset();
    document.getElementById('editTireItemsContainer').innerHTML = '';
    editItemCounter = 0;
}

let editItemCounter = 0;

// Th√™m d√≤ng v·ªè cho form s·ª≠a
function addEditTireItem() {
    addEditTireItemWithData(null);
}

// Th√™m d√≤ng v·ªè v·ªõi d·ªØ li·ªáu (d√πng khi load form s·ª≠a)
function addEditTireItemWithData(itemData) {
    editItemCounter++;
    const container = document.getElementById('editTireItemsContainer');
    const itemId = `edit_item_${editItemCounter}`;
    
    const tireTypeOptions = tireTypesList.map(t => 
        `<option value="${t.tire_type}">${t.tire_type}</option>`
    ).join('');
    
    const row = document.createElement('div');
    row.className = 'tire-item-row';
    row.id = itemId;
    row.innerHTML = `
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">Lo·∫°i v·ªè *</label>
            <input type="text" class="item-tire-type" placeholder="Nh·∫≠p lo·∫°i v·ªè" list="editTireTypesList" value="${itemData ? (itemData.tire_type || '') : ''}" required>
            <datalist id="editTireTypesList">
                ${tireTypeOptions}
            </datalist>
        </div>
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">H√£ng v·ªè *</label>
            <input type="text" class="item-tire-manufacturer" placeholder="Nh·∫≠p h√£ng v·ªè" value="${itemData ? (itemData.tire_manufacturer || '') : ''}" required>
        </div>
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">Seri v·ªè *</label>
            <input type="text" class="item-tire-brand" placeholder="Nh·∫≠p seri v·ªè" value="${itemData ? (itemData.tire_brand || '') : ''}" required>
        </div>
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">S·ªë l∆∞·ª£ng *</label>
            <input type="number" class="item-quantity" step="0.01" value="${itemData ? (itemData.quantity || 1) : 1}" min="0" oninput="calculateEditItemTotal('${itemId}')" required>
        </div>
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">ƒê∆°n gi√° *</label>
            <input type="number" class="item-unit-price" step="0.01" value="${itemData ? (itemData.unit_price || 0) : 0}" min="0" oninput="calculateEditItemTotal('${itemId}')" required>
        </div>
        <div>
            <label style="font-size: 12px; color: #7f8c8d;">Th√†nh ti·ªÅn</label>
            <input type="text" class="item-total" readonly style="background: #f8f9fa;" value="${itemData ? formatCurrency(itemData.total_price || 0) : '0 VNƒê'}">
        </div>
        <div>
            <button type="button" class="btn-remove-item" onclick="removeEditTireItem('${itemId}')">X√≥a</button>
        </div>
    `;
    
    container.appendChild(row);
    calculateEditItemTotal(itemId);
}

// X√≥a d√≤ng v·ªè trong form s·ª≠a
function removeEditTireItem(itemId) {
    const row = document.getElementById(itemId);
    if (row) {
        row.remove();
        calculateEditTotal();
    }
}

// T√≠nh th√†nh ti·ªÅn cho m·ªôt v·ªè trong form s·ª≠a
function calculateEditItemTotal(itemId) {
    const row = document.getElementById(itemId);
    if (!row) return;
    
    const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
    const unitPrice = parseFloat(row.querySelector('.item-unit-price').value) || 0;
    const total = quantity * unitPrice;
    
    row.querySelector('.item-total').value = formatCurrency(total);
    calculateEditTotal();
}

// T√≠nh t·ªïng cho form s·ª≠a
function calculateEditTotal() {
    let total = 0;
    const rows = document.querySelectorAll('#editTireItemsContainer .tire-item-row');
    
    rows.forEach(row => {
        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const unitPrice = parseFloat(row.querySelector('.item-unit-price').value) || 0;
        const itemTotal = quantity * unitPrice;
        total += itemTotal;
    });
    
    const vatRate = parseFloat(document.getElementById('edit_vat_rate').value) || 0;
    const vatAmount = total * (vatRate / 100);
    const totalWithVat = total + vatAmount;
    
    document.getElementById('editTotalAmount').textContent = formatCurrency(total);
    document.getElementById('editTotalWithVat').textContent = formatCurrency(totalWithVat);
}

// X√°c nh·∫≠n x√≥a thay v·ªè
function confirmDeleteTire(replacementId) {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·∫£n ghi thay v·ªè n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
        deleteTire(replacementId);
    }
}

// X√≥a thay v·ªè
async function deleteTire(replacementId) {
    try {
        const response = await fetch(`/api/tire-replacement/delete/${replacementId}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('ƒê√£ x√≥a thay v·ªè th√†nh c√¥ng!');
            await loadTireList(currentVehicleId);
            // Reload trang ƒë·ªÉ c·∫≠p nh·∫≠t th√¥ng tin
            location.reload();
        } else {
            alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ x√≥a thay v·ªè'));
        }
    } catch (error) {
        alert('L·ªói khi x√≥a thay v·ªè: ' + error.message);
    }
}

// Submit form s·ª≠a
document.getElementById('editTireForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const replacementId = parseInt(document.getElementById('edit_replacement_id').value);
    const replacementDate = document.getElementById('edit_replacement_date').value;
    const replacementKm = parseFloat(document.getElementById('edit_replacement_km').value);
    const vatRate = parseFloat(document.getElementById('edit_vat_rate').value) || 0;
    const notes = document.getElementById('edit_notes').value;
    
    // Thu th·∫≠p items
    const items = [];
    const rows = document.querySelectorAll('#editTireItemsContainer .tire-item-row');
    
    rows.forEach(row => {
        const tireType = row.querySelector('.item-tire-type').value.trim();
        if (!tireType) return;
        
        items.push({
            tire_type: tireType,
            tire_manufacturer: row.querySelector('.item-tire-manufacturer').value.trim(),
            tire_brand: row.querySelector('.item-tire-brand').value.trim(),
            quantity: parseFloat(row.querySelector('.item-quantity').value) || 0,
            unit_price: parseFloat(row.querySelector('.item-unit-price').value) || 0
        });
    });
    
    if (items.length === 0) {
        alert('Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt v·ªè');
        return;
    }
    
    // T·∫°o FormData
    const formData = new FormData();
    formData.append('replacement_date', replacementDate);
    formData.append('replacement_km', replacementKm);
    formData.append('vat_rate', vatRate);
    formData.append('notes', notes);
    formData.append('items', JSON.stringify(items));
    
    try {
        const response = await fetch(`/api/tire-replacement/edit/${replacementId}`, {
            method: 'PUT',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('ƒê√£ c·∫≠p nh·∫≠t thay v·ªè th√†nh c√¥ng!');
            closeEditTireModal();
            await loadTireList(currentVehicleId);
            // Reload trang ƒë·ªÉ c·∫≠p nh·∫≠t th√¥ng tin
            location.reload();
        } else {
            alert('L·ªói: ' + (data.error || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t thay v·ªè'));
        }
    } catch (error) {
        alert('L·ªói khi c·∫≠p nh·∫≠t thay v·ªè: ' + error.message);
    }
});

// Helper functions
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('vi-VN');
}

function formatNumber(num) {
    return new Intl.NumberFormat('vi-VN').format(num);
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN').format(amount) + ' VNƒê';
}

// Kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c load
document.addEventListener('DOMContentLoaded', function() {
    loadTireTypes();
});
</script>
{% endblock %}

