{% extends "base.html" %}

{% block title %}B·∫£ng L∆∞∆°ng T·ªïng Theo Th√°ng - H·ªá th·ªëng qu·∫£n l√Ω v·∫≠n chuy·ªÉn{% endblock %}

{% block content %}
<div class="page-wrapper" style="margin: 0; padding: {% if request.query_params.get('embed') %}15px{% else %}20px{% endif %}; position: relative; min-height: auto;">
    {% if not request.query_params.get('embed') %}
    <div class="page-header" style="margin-bottom: 20px;">
        <div>
            <h2>üí∞ B·∫£ng L∆∞∆°ng T·ªïng Theo Th√°ng</h2>
            <p>T·ªïng h·ª£p l∆∞∆°ng, ng√†y c√¥ng, s·ªë chuy·∫øn v√† d·∫ßu kho√°n theo th√°ng</p>
        </div>
    </div>
    {% endif %}

    <!-- Filter Form -->
    <div class="card" style="padding: 20px; margin-bottom: 20px;">
        <form method="GET" action="/salary-summary" id="filterForm">
            {% if request.query_params.get('embed') %}
            <input type="hidden" name="embed" value="1">
            {% endif %}
            <div style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap;">
                <div class="form-group" style="flex: 0 0 auto;">
                    <label for="month">Ch·ªçn th√°ng <span class="required">*</span></label>
                    <input type="month" id="month" name="month" value="{{ month }}" required class="form-control" style="width: 170px;">
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Xem b·∫£ng l∆∞∆°ng
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Results Table -->
    <div class="card" style="padding: 20px; position: relative; clear: both;">
        {% if salary_data %}
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; padding-bottom: 15px; border-bottom: 2px solid #e1e8ed;">
            <h3 style="margin: 0;">
                {% set month_parts = month.split('-') %}
                {% if month_parts|length == 2 %}
                    üìä B·∫£ng l∆∞∆°ng Th√°ng {{ month_parts[1] }}/{{ month_parts[0] }}
                {% else %}
                    üìä B·∫£ng l∆∞∆°ng Th√°ng {{ month }}
                {% endif %}
                <span style="font-size: 14px; font-weight: normal; color: #666;">
                    ({{ salary_data|length }} nh√¢n vi√™n)
                </span>
            </h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button type="button" class="btn btn-primary" onclick="saveSalaryData()" id="saveBtn">
                    <i class="fas fa-save"></i> L∆∞u
                </button>
                <button type="button" class="btn btn-success" onclick="exportToExcel()" id="exportBtn">
                    <i class="fas fa-file-excel"></i> Xu·∫•t Excel
                </button>
            </div>
        </div>
        <div style="overflow-x: auto;">
            <table class="data-table" id="salaryTable">
                <thead>
                    <tr>
                        <th style="width: 50px;">STT</th>
                        <th style="width: 120px; max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">H·ªç t√™n</th>
                        <th style="width: 100px; text-align: center;">Ng√†y c√¥ng</th>
                        <th style="width: 100px; text-align: center;">S·ªë chuy·∫øn</th>
                        <th style="width: 130px; text-align: right;">L∆∞∆°ng chuy·∫øn (VNƒê)</th>
                        <th style="width: 130px; text-align: right;">B·∫£o hi·ªÉm XH (VNƒê)</th>
                        <th style="width: 100px; text-align: right;">R·ª≠a xe (VNƒê)</th>
                        <th style="width: 140px; text-align: right;">Ti·ªÅn tr√°ch nhi·ªám (VNƒê)</th>
                        <th style="width: 120px; text-align: right;">·ª®ng l∆∞∆°ng (VNƒê)</th>
                        <th style="width: 120px; text-align: right;">S·ª≠a xe (VNƒê)</th>
                        <th style="width: 130px; text-align: right;">C√≤n l·∫°i (VNƒê)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in salary_data %}
                    {% set bao_hiem_xh = item.bao_hiem_xh|default(0) %}
                    {% set rua_xe = item.rua_xe|default(0) %}
                    {% set tien_trach_nhiem = item.tien_trach_nhiem|default(0) %}
                    {% set ung_luong = item.ung_luong|default(0) %}
                    {% set sua_xe = item.sua_xe|default(0) %}
                    <tr data-row-index="{{ loop.index0 }}" data-trip-salary="{{ item.trip_salary }}" data-user-id="{{ item.user_id }}">
                        <td style="text-align: center;">{{ loop.index }}</td>
                        <td style="max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="{{ item.full_name }}">
                            <strong>{{ item.full_name }}</strong>
                        </td>
                        <td style="text-align: center;">{{ item.working_days }}</td>
                        <td style="text-align: center;">{{ item.total_trips }}</td>
                        <td style="text-align: right; font-family: 'Courier New', monospace;">
                            {{ "{:,.0f}".format(item.trip_salary) }}
                        </td>
                        <td style="text-align: right; padding: 4px;">
                            <input type="text" 
                                   class="salary-input" 
                                   data-field="bao_hiem_xh"
                                   data-row="{{ loop.index0 }}"
                                   data-value="{{ bao_hiem_xh }}"
                                   style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; text-align: right; font-family: 'Courier New', monospace; font-size: 13px;">
                        </td>
                        <td style="text-align: right; padding: 4px;">
                            <input type="text" 
                                   class="salary-input" 
                                   data-field="rua_xe"
                                   data-row="{{ loop.index0 }}"
                                   data-value="{{ rua_xe }}"
                                   style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; text-align: right; font-family: 'Courier New', monospace; font-size: 13px;">
                        </td>
                        <td style="text-align: right; padding: 4px;">
                            <input type="text" 
                                   class="salary-input" 
                                   data-field="tien_trach_nhiem"
                                   data-row="{{ loop.index0 }}"
                                   data-value="{{ tien_trach_nhiem }}"
                                   style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; text-align: right; font-family: 'Courier New', monospace; font-size: 13px;">
                        </td>
                        <td style="text-align: right; padding: 4px;">
                            <input type="text" 
                                   class="salary-input" 
                                   data-field="ung_luong"
                                   data-row="{{ loop.index0 }}"
                                   data-value="{{ ung_luong }}"
                                   style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; text-align: right; font-family: 'Courier New', monospace; font-size: 13px;">
                        </td>
                        <td style="text-align: right; padding: 4px;">
                            <input type="text" 
                                   class="salary-input" 
                                   data-field="sua_xe"
                                   data-row="{{ loop.index0 }}"
                                   data-value="{{ sua_xe }}"
                                   style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; text-align: right; font-family: 'Courier New', monospace; font-size: 13px;">
                        </td>
                        <td style="text-align: right; font-family: 'Courier New', monospace; font-weight: bold; color: #1976d2; padding: 10px 8px;" class="con-lai-cell">
                            <span class="con-lai-value">{{ "{:,.0f}".format(item.trip_salary - bao_hiem_xh - tien_trach_nhiem - ung_luong + rua_xe + sua_xe) }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                    <!-- Total Row -->
                    <tr style="background: #f8f9fa; font-weight: bold;" id="totalRow">
                        <td colspan="2" style="text-align: right; padding-right: 20px;">T·ªîNG C·ªòNG:</td>
                        <td style="text-align: center;">{{ totals.working_days }}</td>
                        <td style="text-align: center;">{{ totals.total_trips }}</td>
                        <td style="text-align: right; font-family: 'Courier New', monospace;">
                            {{ "{:,.0f}".format(totals.trip_salary) }}
                        </td>
                        <td style="text-align: right; font-family: 'Courier New', monospace;" class="total-bao-hiem-xh">
                            0
                        </td>
                        <td style="text-align: right; font-family: 'Courier New', monospace;" class="total-rua-xe">
                            0
                        </td>
                        <td style="text-align: right; font-family: 'Courier New', monospace;" class="total-tien-trach-nhiem">
                            0
                        </td>
                        <td style="text-align: right; font-family: 'Courier New', monospace;" class="total-ung-luong">
                            0
                        </td>
                        <td style="text-align: right; font-family: 'Courier New', monospace;" class="total-sua-xe">
                            0
                        </td>
                        <td style="text-align: right; font-family: 'Courier New', monospace; font-weight: bold; color: #1976d2;" class="total-con-lai">
                            0
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% else %}
        <h3 style="margin-top: 0; margin-bottom: 20px;">
            {% set month_parts = month.split('-') %}
            {% if month_parts|length == 2 %}
                üìä B·∫£ng l∆∞∆°ng Th√°ng {{ month_parts[1] }}/{{ month_parts[0] }}
            {% else %}
                üìä B·∫£ng l∆∞∆°ng Th√°ng {{ month }}
            {% endif %}
        </h3>
        <div style="text-align: center; padding: 60px 20px; color: #666;">
            <i class="fas fa-inbox" style="font-size: 48px; color: #ccc; margin-bottom: 16px;"></i>
            {% set month_parts = month.split('-') %}
            {% set year = month_parts[0] %}
            {% set month_num = month_parts[1] %}
            <p style="font-size: 16px; margin: 0;">Kh√¥ng c√≥ d·ªØ li·ªáu cho th√°ng {{ month_num }}/{{ year }}</p>
            <p style="font-size: 14px; color: #999; margin-top: 8px;">Vui l√≤ng ch·ªçn th√°ng kh√°c ho·∫∑c ki·ªÉm tra d·ªØ li·ªáu ch·∫•m c√¥ng</p>
        </div>
        {% endif %}
    </div>
</div>

<style>
/* ƒê·∫£m b·∫£o layout kh√¥ng b·ªã ch·ªìng */
.page-wrapper {
    position: relative !important;
    clear: both !important;
    min-height: auto !important;
    overflow: visible !important;
}

.page-wrapper .card {
    position: relative !important;
    clear: both !important;
    margin-bottom: 20px !important;
}

.page-wrapper .card:last-child {
    margin-bottom: 0 !important;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.data-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.data-table thead th {
    padding: 12px 8px;
    text-align: left;
    font-weight: 600;
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.data-table tbody tr {
    border-bottom: 1px solid #e1e8ed;
    transition: background-color 0.2s;
}

.data-table tbody tr:hover {
    background-color: #f8f9fa;
}

.data-table tbody td {
    padding: 10px 8px;
    vertical-align: middle;
}

.salary-input {
    transition: border-color 0.2s, box-shadow 0.2s;
}

.salary-input:focus {
    outline: none;
    border-color: #42a5f5 !important;
    box-shadow: 0 0 0 2px rgba(66, 165, 245, 0.2);
}

.salary-input:hover {
    border-color: #bbb;
}

@media (max-width: 1200px) {
    .data-table {
        font-size: 12px;
    }
    
    .data-table thead th,
    .data-table tbody td {
        padding: 8px 6px;
    }
}
</style>

<script>
// ƒê·∫£m b·∫£o layout ƒë∆∞·ª£c reset ƒë√∫ng khi trang load
(function() {
    // Scroll v·ªÅ ƒë·∫ßu trang khi load (ƒë·∫∑c bi·ªát quan tr·ªçng trong iframe)
    if (window.parent !== window) {
        // ƒêang trong iframe
        window.scrollTo(0, 0);
        // ƒê·∫£m b·∫£o body v√† html c√≥ height auto
        document.documentElement.style.height = 'auto';
        document.body.style.height = 'auto';
        document.body.style.overflow = 'visible';
    }
    
    // Clear any potential duplicate content
    const pageWrapper = document.querySelector('.page-wrapper');
    if (pageWrapper) {
        pageWrapper.style.position = 'relative';
        pageWrapper.style.clear = 'both';
        pageWrapper.style.minHeight = 'auto';
    }
})();

// X·ª≠ l√Ω form submit ƒë·ªÉ ƒë·∫£m b·∫£o gi·ªØ l·∫°i embed parameter
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filterForm');
    if (filterForm) {
        // Ki·ªÉm tra n·∫øu ƒëang trong iframe v√† ch∆∞a c√≥ embed parameter
        const urlParams = new URLSearchParams(window.location.search);
        if (!urlParams.has('embed') && window.parent !== window) {
            // ƒêang trong iframe nh∆∞ng thi·∫øu embed parameter
            // Th√™m hidden input n·∫øu ch∆∞a c√≥
            if (!filterForm.querySelector('input[name="embed"]')) {
                const embedInput = document.createElement('input');
                embedInput.type = 'hidden';
                embedInput.name = 'embed';
                embedInput.value = '1';
                filterForm.insertBefore(embedInput, filterForm.firstChild);
            }
        }
        
        // X·ª≠ l√Ω submit ƒë·ªÉ scroll v·ªÅ ƒë·∫ßu trang
        filterForm.addEventListener('submit', function() {
            // Scroll v·ªÅ ƒë·∫ßu trang tr∆∞·ªõc khi submit
            window.scrollTo(0, 0);
            // ƒê·∫£m b·∫£o kh√¥ng c√≥ layout overlap
            const resultsCard = document.querySelector('.card:last-of-type');
            if (resultsCard) {
                resultsCard.style.position = 'relative';
                resultsCard.style.clear = 'both';
            }
        });
    }
});

// H√†m parse s·ªë t·ª´ text ƒë√£ format (lo·∫°i b·ªè d·∫•u ch·∫•m v√† kho·∫£ng tr·∫Øng)
function parseFormattedNumber(text) {
    if (!text || text.trim() === '') return 0;
    // Lo·∫°i b·ªè t·∫•t c·∫£ d·∫•u ch·∫•m, kho·∫£ng tr·∫Øng v√† k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
    const cleaned = text.toString().replace(/\./g, '').replace(/\s/g, '').replace(/[^\d]/g, '');
    const num = parseFloat(cleaned);
    return isNaN(num) ? 0 : num;
}

// H√†m format s·ªë th√†nh ti·ªÅn VNƒê (th√™m d·∫•u ch·∫•m ph√¢n c√°ch h√†ng ngh√¨n)
function formatVND(number) {
    if (isNaN(number) || number === null || number === undefined) return '0';
    const num = Math.round(parseFloat(number));
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}

// T√≠nh "C√≤n l·∫°i" cho m·ªôt d√≤ng
function calculateConLai(row) {
    const tripSalary = parseFloat(row.getAttribute('data-trip-salary')) || 0;
    
    // Parse gi√° tr·ªã t·ª´ input (ƒë√£ format)
    const baoHiemXHInput = row.querySelector('input[data-field="bao_hiem_xh"]');
    const ruaXeInput = row.querySelector('input[data-field="rua_xe"]');
    const tienTrachNhiemInput = row.querySelector('input[data-field="tien_trach_nhiem"]');
    const ungLuongInput = row.querySelector('input[data-field="ung_luong"]');
    const suaXeInput = row.querySelector('input[data-field="sua_xe"]');
    
    const baoHiemXH = parseFormattedNumber(baoHiemXHInput ? baoHiemXHInput.value : '0');
    const ruaXe = parseFormattedNumber(ruaXeInput ? ruaXeInput.value : '0');
    const tienTrachNhiem = parseFormattedNumber(tienTrachNhiemInput ? tienTrachNhiemInput.value : '0');
    const ungLuong = parseFormattedNumber(ungLuongInput ? ungLuongInput.value : '0');
    const suaXe = parseFormattedNumber(suaXeInput ? suaXeInput.value : '0');
    
    // L∆∞u gi√° tr·ªã th·ª±c v√†o data attribute
    if (baoHiemXHInput) baoHiemXHInput.setAttribute('data-value', baoHiemXH);
    if (ruaXeInput) ruaXeInput.setAttribute('data-value', ruaXe);
    if (tienTrachNhiemInput) tienTrachNhiemInput.setAttribute('data-value', tienTrachNhiem);
    if (ungLuongInput) ungLuongInput.setAttribute('data-value', ungLuong);
    if (suaXeInput) suaXeInput.setAttribute('data-value', suaXe);
    
    // C√¥ng th·ª©c: C√≤n l·∫°i = L∆∞∆°ng chuy·∫øn - B·∫£o hi·ªÉm XH - Ti·ªÅn tr√°ch nhi·ªám - ·ª®ng l∆∞∆°ng + R·ª≠a xe + S·ª≠a xe
    const conLai = tripSalary - baoHiemXH - tienTrachNhiem - ungLuong + ruaXe + suaXe;
    
    // C·∫≠p nh·∫≠t gi√° tr·ªã hi·ªÉn th·ªã
    const conLaiCell = row.querySelector('.con-lai-value');
    if (conLaiCell) {
        conLaiCell.textContent = formatVND(conLai);
    }
    
    return {
        baoHiemXH,
        ruaXe,
        tienTrachNhiem,
        ungLuong,
        suaXe,
        conLai
    };
}

// C·∫≠p nh·∫≠t t·ªïng c·ªông
function updateTotals() {
    const rows = document.querySelectorAll('#salaryTable tbody tr:not(#totalRow)');
    let totalBaoHiemXH = 0;
    let totalRuaXe = 0;
    let totalTienTrachNhiem = 0;
    let totalUngLuong = 0;
    let totalSuaXe = 0;
    let totalConLai = 0;
    
    rows.forEach(row => {
        const values = calculateConLai(row);
        totalBaoHiemXH += values.baoHiemXH;
        totalRuaXe += values.ruaXe;
        totalTienTrachNhiem += values.tienTrachNhiem;
        totalUngLuong += values.ungLuong;
        totalSuaXe += values.suaXe;
        totalConLai += values.conLai;
    });
    
    // C·∫≠p nh·∫≠t t·ªïng c·ªông
    const totalRow = document.getElementById('totalRow');
    if (totalRow) {
        totalRow.querySelector('.total-bao-hiem-xh').textContent = formatVND(totalBaoHiemXH);
        totalRow.querySelector('.total-rua-xe').textContent = formatVND(totalRuaXe);
        totalRow.querySelector('.total-tien-trach-nhiem').textContent = formatVND(totalTienTrachNhiem);
        totalRow.querySelector('.total-ung-luong').textContent = formatVND(totalUngLuong);
        totalRow.querySelector('.total-sua-xe').textContent = formatVND(totalSuaXe);
        totalRow.querySelector('.total-con-lai').textContent = formatVND(totalConLai);
    }
}

// X·ª≠ l√Ω s·ª± ki·ªán khi user thay ƒë·ªïi input
document.addEventListener('DOMContentLoaded', function() {
    const salaryInputs = document.querySelectorAll('.salary-input');
    
    // Kh·ªüi t·∫°o gi√° tr·ªã format cho t·∫•t c·∫£ input
    salaryInputs.forEach(input => {
        const initialValue = parseFloat(input.getAttribute('data-value')) || 0;
        input.value = formatVND(initialValue);
        input.setAttribute('data-value', initialValue);
    });
    
    salaryInputs.forEach(input => {
        // X·ª≠ l√Ω khi user nh·∫≠p (realtime formatting)
        input.addEventListener('input', function(e) {
            const cursorPosition = this.selectionStart;
            const oldValue = this.value;
            
            // Parse gi√° tr·ªã hi·ªán t·∫°i
            const numericValue = parseFormattedNumber(this.value);
            
            // ƒê·∫£m b·∫£o kh√¥ng cho nh·∫≠p s·ªë √¢m
            const safeValue = Math.max(0, numericValue);
            
            // Format l·∫°i gi√° tr·ªã
            const formattedValue = formatVND(safeValue);
            this.value = formattedValue;
            
            // L∆∞u gi√° tr·ªã th·ª±c v√†o data attribute
            this.setAttribute('data-value', safeValue);
            
            // Kh√¥i ph·ª•c v·ªã tr√≠ cursor (t√≠nh to√°n l·∫°i v√¨ ƒë√£ th√™m d·∫•u ch·∫•m)
            const newLength = formattedValue.length;
            const oldLength = oldValue.length;
            const diff = newLength - oldLength;
            let newCursorPos = cursorPosition + diff;
            
            // ƒê·∫£m b·∫£o cursor kh√¥ng v∆∞·ª£t qu√° ƒë·ªô d√†i
            if (newCursorPos < 0) newCursorPos = 0;
            if (newCursorPos > newLength) newCursorPos = newLength;
            
            // Set cursor position (s·ª≠ d·ª•ng setTimeout ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ update)
            setTimeout(() => {
                this.setSelectionRange(newCursorPos, newCursorPos);
            }, 0);
            
            // T√¨m d√≤ng ch·ª©a input n√†y v√† t√≠nh to√°n
            const row = this.closest('tr');
            if (row) {
                calculateConLai(row);
                updateTotals();
            }
        });
        
        // X·ª≠ l√Ω khi user blur (r·ªùi kh·ªèi √¥) - ƒë·∫£m b·∫£o format ƒë√∫ng
        input.addEventListener('blur', function() {
            const numericValue = parseFormattedNumber(this.value);
            const safeValue = Math.max(0, numericValue);
            this.value = formatVND(safeValue);
            this.setAttribute('data-value', safeValue);
        });
        
        // X·ª≠ l√Ω khi user focus - cho ph√©p x√≥a v√† nh·∫≠p l·∫°i d·ªÖ d√†ng
        input.addEventListener('focus', function() {
            // C√≥ th·ªÉ gi·ªØ nguy√™n format ho·∫∑c x√≥a format khi focus
            // ·ªû ƒë√¢y gi·ªØ nguy√™n ƒë·ªÉ user th·∫•y r√µ gi√° tr·ªã
        });
    });
    
    // T√≠nh t·ªïng ban ƒë·∫ßu
    updateTotals();
});

// H√†m l∆∞u d·ªØ li·ªáu l∆∞∆°ng
function saveSalaryData() {
    const month = document.getElementById('month').value;
    if (!month) {
        alert('Vui l√≤ng ch·ªçn th√°ng tr∆∞·ªõc khi l∆∞u');
        return;
    }
    
    // Thu th·∫≠p d·ªØ li·ªáu t·ª´ b·∫£ng
    const rows = document.querySelectorAll('#salaryTable tbody tr:not(#totalRow)');
    const salaryData = [];
    
    rows.forEach((row) => {
        const user_id = parseInt(row.getAttribute('data-user-id')) || 0;
        if (!user_id) return; // Skip n·∫øu kh√¥ng c√≥ user_id
        
        // Parse t·ª´ data-value ho·∫∑c t·ª´ value ƒë√£ format
        const baoHiemXHInput = row.querySelector('input[data-field="bao_hiem_xh"]');
        const ruaXeInput = row.querySelector('input[data-field="rua_xe"]');
        const tienTrachNhiemInput = row.querySelector('input[data-field="tien_trach_nhiem"]');
        const ungLuongInput = row.querySelector('input[data-field="ung_luong"]');
        const suaXeInput = row.querySelector('input[data-field="sua_xe"]');
        
        const baoHiemXH = baoHiemXHInput ? (parseFloat(baoHiemXHInput.getAttribute('data-value')) || parseFormattedNumber(baoHiemXHInput.value)) : 0;
        const ruaXe = ruaXeInput ? (parseFloat(ruaXeInput.getAttribute('data-value')) || parseFormattedNumber(ruaXeInput.value)) : 0;
        const tienTrachNhiem = tienTrachNhiemInput ? (parseFloat(tienTrachNhiemInput.getAttribute('data-value')) || parseFormattedNumber(tienTrachNhiemInput.value)) : 0;
        const ungLuong = ungLuongInput ? (parseFloat(ungLuongInput.getAttribute('data-value')) || parseFormattedNumber(ungLuongInput.value)) : 0;
        const suaXe = suaXeInput ? (parseFloat(suaXeInput.getAttribute('data-value')) || parseFormattedNumber(suaXeInput.value)) : 0;
        
        salaryData.push({
            user_id: user_id,
            bao_hiem_xh: Math.round(baoHiemXH),
            rua_xe: Math.round(ruaXe),
            tien_trach_nhiem: Math.round(tienTrachNhiem),
            ung_luong: Math.round(ungLuong),
            sua_xe: Math.round(suaXe)
        });
    });
    
    // Disable button v√† hi·ªÉn th·ªã loading
    const saveBtn = document.getElementById('saveBtn');
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang l∆∞u...';
    
    // G·ª≠i d·ªØ li·ªáu ƒë·∫øn endpoint save
    fetch('/api/salary-summary/save', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            month: month,
            salary_data: salaryData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message || 'ƒê√£ l∆∞u th√†nh c√¥ng!');
            // Reload trang ƒë·ªÉ hi·ªÉn th·ªã d·ªØ li·ªáu ƒë√£ l∆∞u
            window.location.reload();
        } else {
            alert('L·ªói: ' + (data.message || 'Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu'));
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('C√≥ l·ªói x·∫£y ra khi l∆∞u: ' + error.message);
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
    });
}

// H√†m xu·∫•t Excel
function exportToExcel() {
    const month = document.getElementById('month').value;
    if (!month) {
        alert('Vui l√≤ng ch·ªçn th√°ng tr∆∞·ªõc khi xu·∫•t Excel');
        return;
    }
    
    // Thu th·∫≠p d·ªØ li·ªáu t·ª´ b·∫£ng
    const rows = document.querySelectorAll('#salaryTable tbody tr:not(#totalRow)');
    const salaryData = [];
    
    rows.forEach((row, index) => {
        const fullName = row.querySelector('td:nth-child(2) strong').textContent.trim();
        const workingDays = parseInt(row.querySelector('td:nth-child(3)').textContent.trim()) || 0;
        const totalTrips = parseInt(row.querySelector('td:nth-child(4)').textContent.trim()) || 0;
        const tripSalary = parseFloat(row.getAttribute('data-trip-salary')) || 0;
        
        // Parse t·ª´ data-value ho·∫∑c t·ª´ value ƒë√£ format
        const baoHiemXHInput = row.querySelector('input[data-field="bao_hiem_xh"]');
        const ruaXeInput = row.querySelector('input[data-field="rua_xe"]');
        const tienTrachNhiemInput = row.querySelector('input[data-field="tien_trach_nhiem"]');
        const ungLuongInput = row.querySelector('input[data-field="ung_luong"]');
        const suaXeInput = row.querySelector('input[data-field="sua_xe"]');
        
        const baoHiemXH = baoHiemXHInput ? (parseFloat(baoHiemXHInput.getAttribute('data-value')) || parseFormattedNumber(baoHiemXHInput.value)) : 0;
        const ruaXe = ruaXeInput ? (parseFloat(ruaXeInput.getAttribute('data-value')) || parseFormattedNumber(ruaXeInput.value)) : 0;
        const tienTrachNhiem = tienTrachNhiemInput ? (parseFloat(tienTrachNhiemInput.getAttribute('data-value')) || parseFormattedNumber(tienTrachNhiemInput.value)) : 0;
        const ungLuong = ungLuongInput ? (parseFloat(ungLuongInput.getAttribute('data-value')) || parseFormattedNumber(ungLuongInput.value)) : 0;
        const suaXe = suaXeInput ? (parseFloat(suaXeInput.getAttribute('data-value')) || parseFormattedNumber(suaXeInput.value)) : 0;
        
        // Parse conLai t·ª´ text (ƒë√£ format)
        const conLaiText = row.querySelector('.con-lai-value') ? row.querySelector('.con-lai-value').textContent.trim() : '0';
        const conLai = parseFormattedNumber(conLaiText);
        
        salaryData.push({
            full_name: fullName,
            working_days: workingDays,
            total_trips: totalTrips,
            trip_salary: tripSalary,
            bao_hiem_xh: baoHiemXH,
            rua_xe: ruaXe,
            tien_trach_nhiem: tienTrachNhiem,
            ung_luong: ungLuong,
            sua_xe: suaXe,
            con_lai: conLai
        });
    });
    
    // G·ª≠i d·ªØ li·ªáu ƒë·∫øn endpoint export
    fetch('/api/salary-summary/export-excel', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            month: month,
            salary_data: salaryData
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('L·ªói khi xu·∫•t Excel');
        }
        return response.blob();
    })
    .then(blob => {
        // T·∫°o URL t·∫°m v√† download file
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Bang_Luong_Tong_${month}.xlsx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('C√≥ l·ªói x·∫£y ra khi xu·∫•t Excel: ' + error.message);
    });
}
</script>
{% endblock %}

