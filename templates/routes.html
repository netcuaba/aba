{% extends "base.html" %}

{% block title %}Qu·∫£n l√Ω tuy·∫øn ƒë∆∞·ªùng - H·ªá th·ªëng qu·∫£n l√Ω v·∫≠n chuy·ªÉn{% endblock %}

{% block content %}
<div class="page-wrapper">
<h2 class="page-title">üõ£Ô∏è Qu·∫£n l√Ω tuy·∫øn ƒë∆∞·ªùng</h2>

<!-- Th√¥ng b√°o th√†nh c√¥ng/l·ªói -->
{% if request.query_params.get('success') == 'price_updated' %}
<div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #c3e6cb;">
    <strong>‚úì Th√†nh c√¥ng!</strong> 
    {% if request.query_params.get('count') %}
        ƒê√£ c·∫≠p nh·∫≠t gi√° cho {{ request.query_params.get('count') }} tuy·∫øn.
    {% else %}
        Gi√° tuy·∫øn ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t.
    {% endif %}
</div>
{% endif %}
{% if request.query_params.get('success') == 'price_update_edited' %}
<div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #c3e6cb;">
    <strong>‚úì Th√†nh c√¥ng!</strong> B·∫£n c·∫≠p nh·∫≠t gi√° tuy·∫øn ƒë√£ ƒë∆∞·ª£c s·ª≠a.
</div>
{% endif %}
{% if request.query_params.get('error') %}
<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #f5c6cb;">
    <strong>‚úó L·ªói!</strong> 
    {% if request.query_params.get('error') == 'route_not_found' %}
        Kh√¥ng t√¨m th·∫•y tuy·∫øn ƒë∆∞·ªùng.
    {% elif request.query_params.get('error') == 'invalid_route' %}
        Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t gi√° cho tuy·∫øn "TƒÉng C∆∞·ªùng".
    {% elif request.query_params.get('error') == 'invalid_date' %}
        Ng√†y √°p gi√° kh√¥ng h·ª£p l·ªá.
    {% elif request.query_params.get('error') == 'update_failed' %}
        C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t gi√° tuy·∫øn. Vui l√≤ng th·ª≠ l·∫°i.
    {% elif request.query_params.get('error') == 'invalid_data' %}
        D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i.
    {% elif request.query_params.get('error') == 'no_routes_updated' %}
        Kh√¥ng c√≥ tuy·∫øn n√†o ƒë∆∞·ª£c c·∫≠p nh·∫≠t. Vui l√≤ng ki·ªÉm tra l·∫°i d·ªØ li·ªáu.
    {% elif request.query_params.get('error') == 'missing_data' %}
        Thi·∫øu th√¥ng tin b·∫Øt bu·ªôc. Vui l√≤ng ki·ªÉm tra l·∫°i.
    {% elif request.query_params.get('error') == 'edit_failed' %}
        C√≥ l·ªói x·∫£y ra khi s·ª≠a b·∫£n c·∫≠p nh·∫≠t gi√° tuy·∫øn. Vui l√≤ng th·ª≠ l·∫°i.
    {% elif request.query_params.get('error') == 'unauthorized' %}
        B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y.
    {% else %}
        {{ request.query_params.get('error') }}
    {% endif %}
</div>
{% endif %}

<div class="card" style="padding: 20px; margin-bottom: 30px;">
    <h3 class="section-title" style="margin-bottom: 15px;">‚ûï Th√™m tuy·∫øn m·ªõi</h3>
    <form method="post" action="/routes/add" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
        <div class="form-group">
            <label for="route_code">M√£ tuy·∫øn *</label>
            <input type="text" id="route_code" name="route_code" required placeholder="VD: NA_002">
        </div>
        <div class="form-group">
            <label for="route_name">L·ªô tr√¨nh *</label>
            <input type="text" id="route_name" name="route_name" required placeholder="VD: Kho Trung Chuy·ªÉn -> B∆∞u C·ª•c">
        </div>
        <div class="form-group">
            <label for="route_type">Lo·∫°i tuy·∫øn *</label>
            <select id="route_type" name="route_type" required onchange="updateUnitPrice()">
                <option value="">-- Ch·ªçn lo·∫°i tuy·∫øn --</option>
                <option value="N·ªôi th√†nh">N·ªôi th√†nh</option>
                <option value="N·ªôi T·ªânh">N·ªôi T·ªânh</option>
                <option value="Li√™n T·ªânh">Li√™n T·ªânh</option>
            </select>
        </div>
        <div class="form-group">
            <label for="unit_price">ƒê∆°n gi√° (VNƒê) *</label>
            <input type="number" id="unit_price" name="unit_price" min="0" step="0.01" required placeholder="VD: 227273" 
                   oninput="formatNumberInput(this)" onblur="validateIntegerInput(this)">
            <small class="form-help" id="unit_price_help">Nh·∫≠p ƒë∆°n gi√° (v√≠ d·ª•: 227,273 ho·∫∑c 227273)</small>
        </div>
        <div class="form-group" id="bridge_fee_group" style="display: none;">
            <label for="bridge_fee">Ph√≠ c·∫ßu ƒë∆∞·ªùng (VNƒê)</label>
            <input type="number" id="bridge_fee" name="bridge_fee" min="0" step="0.01" placeholder="VD: 50000" 
                   oninput="formatNumberInput(this)" onblur="validateIntegerInput(this)">
            <small class="form-help">Nh·∫≠p ph√≠ c·∫ßu ƒë∆∞·ªùng (kh√¥ng b·∫Øt bu·ªôc)</small>
        </div>
        <div class="form-group" id="loading_fee_group" style="display: none;">
            <label for="loading_fee">Ph√≠ ch·ªù t·∫£i (VNƒê)</label>
            <input type="number" id="loading_fee" name="loading_fee" min="0" step="0.01" placeholder="VD: 30000" 
                   oninput="formatNumberInput(this)" onblur="validateIntegerInput(this)">
            <small class="form-help">Nh·∫≠p ph√≠ ch·ªù t·∫£i (kh√¥ng b·∫Øt bu·ªôc)</small>
        </div>
        <div class="form-group">
            <label for="distance">Kho·∫£ng c√°ch (km)</label>
            <input type="number" id="distance" name="distance" step="0.1" placeholder="VD: 178">
        </div>
        <div class="form-group">
            <label for="monthly_salary">L∆∞∆°ng tuy·∫øn/th√°ng (VNƒê)</label>
            <input type="number" id="monthly_salary" name="monthly_salary" min="0" placeholder="VD: 10500000" 
                   oninput="formatNumberInput(this)" onblur="validateIntegerInput(this)">
            <small class="form-help">Nh·∫≠p s·ªë nguy√™n (v√≠ d·ª•: 10,500,000 ho·∫∑c 10500000)</small>
        </div>
        <div class="form-group" style="display: flex; align-items: end;">
            <button type="submit" class="btn btn-success">Th√™m tuy·∫øn</button>
        </div>
    </form>
    
    <script>
    function updateUnitPrice() {
        const routeType = document.getElementById('route_type').value;
        const unitPriceInput = document.getElementById('unit_price');
        const unitPriceHelp = document.getElementById('unit_price_help');
        const bridgeFeeGroup = document.getElementById('bridge_fee_group');
        const loadingFeeGroup = document.getElementById('loading_fee_group');
        
        if (routeType === 'N·ªôi th√†nh') {
            // T·ª± ƒë·ªông set gi√° m·∫∑c ƒë·ªãnh cho N·ªôi th√†nh
            unitPriceInput.value = '227273';
            unitPriceHelp.textContent = 'Gi√° m·∫∑c ƒë·ªãnh: 227,273 ƒë/chuy·∫øn (c√≥ th·ªÉ ch·ªânh s·ª≠a)';
            unitPriceInput.readOnly = false; // Cho ph√©p s·ª≠a
            // ·∫®n c√°c tr∆∞·ªùng ph√≠ cho N·ªôi th√†nh
            bridgeFeeGroup.style.display = 'none';
            loadingFeeGroup.style.display = 'none';
        } else if (routeType === 'N·ªôi T·ªânh' || routeType === 'Li√™n T·ªânh') {
            // X√≥a gi√° v√† y√™u c·∫ßu nh·∫≠p th·ªß c√¥ng
            if (!unitPriceInput.value || unitPriceInput.value === '227273') {
                unitPriceInput.value = '';
            }
            unitPriceHelp.textContent = 'Nh·∫≠p ƒë∆°n gi√° b·∫Øt bu·ªôc (v√≠ d·ª•: 227,273 ho·∫∑c 227273)';
            unitPriceInput.readOnly = false;
            unitPriceInput.required = true;
            // Hi·ªÉn th·ªã c√°c tr∆∞·ªùng ph√≠ cho N·ªôi T·ªânh/Li√™n T·ªânh
            bridgeFeeGroup.style.display = 'block';
            loadingFeeGroup.style.display = 'block';
        } else {
            unitPriceInput.value = '';
            unitPriceHelp.textContent = 'Nh·∫≠p ƒë∆°n gi√° (v√≠ d·ª•: 227,273 ho·∫∑c 227273)';
            // ·∫®n c√°c tr∆∞·ªùng ph√≠ khi ch∆∞a ch·ªçn lo·∫°i tuy·∫øn
            bridgeFeeGroup.style.display = 'none';
            loadingFeeGroup.style.display = 'none';
        }
    }
    </script>
</div>

<h3>üìã Danh s√°ch tuy·∫øn ƒë∆∞·ªùng</h3>
{% if routes %}
<table class="table">
    <thead>
        <tr>
            <th>STT</th>
            <th style="width: 150px;">M√£ tuy·∫øn</th>
            <th>L·ªô tr√¨nh</th>
            <th>Lo·∫°i tuy·∫øn</th>
            <th>ƒê∆°n gi√° (VNƒê)</th>
            <th>Kho·∫£ng c√°ch (KM)</th>
            <th>L∆∞∆°ng tuy·∫øn/th√°ng</th>
            <th>Thao t√°c</th>
        </tr>
    </thead>
    <tbody>
        {% for route in routes %}
        <tr>
            <td>{{ loop.index }}</td>
            <td style="white-space: nowrap;"><strong>{{ route.route_code }}</strong></td>
            <td>{{ route.route_name }}</td>
            <td>{{ route.route_type or "-" }}</td>
            <td class="number">{{ "{:,.0f}".format(route.unit_price) if route.unit_price else "-" }}</td>
            <td>{{ "{:,.0f}".format(route.distance) if route.distance else "-" }}</td>
            <td class="number">{{ "{:,.0f}".format(route.monthly_salary) if route.monthly_salary else "-" }}</td>
            <td>
                <div style="display: flex; gap: 5px;">
                    <a href="/routes/edit/{{ route.id }}" class="btn btn-sm btn-primary" style="padding: 5px 10px; font-size: 12px;">S·ª≠a</a>
                    <form method="post" action="/routes/delete/{{ route.id }}" style="display: inline;" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a tuy·∫øn n√†y?')">
                        <button type="submit" class="btn btn-sm btn-danger" style="padding: 5px 10px; font-size: 12px;">X√≥a</button>
                    </form>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div style="text-align: center; padding: 40px; color: #7f8c8d;">
    <h3>üõ£Ô∏è Ch∆∞a c√≥ tuy·∫øn n√†o</h3>
    <p>H√£y th√™m tuy·∫øn ƒë·∫ßu ti√™n b·∫±ng form b√™n tr√™n</p>
</div>
{% endif %}

<!-- Button C·∫≠p nh·∫≠t gi√° tuy·∫øn -->
<div style="margin-top: 30px; margin-bottom: 20px;">
    <button type="button" class="btn btn-primary" onclick="openUpdatePriceModal()" style="padding: 10px 20px; font-size: 14px;">
        <i class="fas fa-dollar-sign"></i> C·∫≠p nh·∫≠t gi√° tuy·∫øn
    </button>
</div>

<!-- B·∫£ng l·ªãch s·ª≠ c·∫≠p nh·∫≠t gi√° tuy·∫øn -->
<h3 style="margin-top: 40px; margin-bottom: 20px;">üìã L·ªãch s·ª≠ c·∫≠p nh·∫≠t gi√° tuy·∫øn</h3>
{% if price_updates %}
<table class="table" style="margin-top: 20px;">
    <thead>
        <tr>
            <th style="width: 60px;">STT</th>
            <th>T√™n b·∫£n c·∫≠p nh·∫≠t</th>
            <th style="width: 150px;">Ng√†y √°p gi√°</th>
            <th style="width: 120px;">S·ªë l∆∞·ª£ng tuy·∫øn</th>
            <th style="width: 200px;">Thao t√°c</th>
        </tr>
    </thead>
    <tbody>
        {% for update in price_updates %}
        <tr>
            <td>{{ loop.index }}</td>
            <td><strong>{{ update.update_name }}</strong></td>
            <td>{{ update.application_date.strftime("%d/%m/%Y") if update.application_date else "-" }}</td>
            <td class="number">{{ update.route_count }}</td>
            <td>
                <div style="display: flex; gap: 5px;">
                    <button type="button" class="btn btn-sm btn-info" onclick="viewPriceUpdateDetail('{{ update.update_name }}', '{{ update.application_date.strftime('%Y-%m-%d') if update.application_date else '' }}')" style="padding: 5px 10px; font-size: 12px;">
                        <i class="fas fa-eye"></i> Xem chi ti·∫øt
                    </button>
                    <button type="button" class="btn btn-sm btn-warning" onclick="editPriceUpdate('{{ update.update_name }}', '{{ update.application_date.strftime('%Y-%m-%d') if update.application_date else '' }}')" style="padding: 5px 10px; font-size: 12px;">
                        <i class="fas fa-edit"></i> S·ª≠a
                    </button>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<div style="text-align: center; padding: 40px; color: #7f8c8d;">
    <h4>üìã Ch∆∞a c√≥ b·∫£n c·∫≠p nh·∫≠t gi√° tuy·∫øn n√†o</h4>
    <p>H√£y t·∫°o b·∫£n c·∫≠p nh·∫≠t ƒë·∫ßu ti√™n b·∫±ng n√∫t "C·∫≠p nh·∫≠t gi√° tuy·∫øn" b√™n tr√™n</p>
</div>
{% endif %}

<!-- Modal C·∫≠p nh·∫≠t gi√° tuy·∫øn -->
<div id="updatePriceModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #ddd; background: #9b59b6; color: white;">
            <h3 style="margin: 0; color: white;">üí∞ C·∫≠p nh·∫≠t gi√° tuy·∫øn</h3>
            <span class="close" onclick="closeUpdatePriceModal()" style="color: white; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1;">&times;</span>
        </div>
        
        <!-- B∆∞·ªõc 1: Form ch·ªçn th√¥ng tin b·∫£n c·∫≠p nh·∫≠t -->
        <div id="step1Form" style="padding: 20px;">
            <h4 style="margin-bottom: 20px; color: #9b59b6;">B∆∞·ªõc 1 - Ch·ªçn th√¥ng tin b·∫£n c·∫≠p nh·∫≠t</h4>
            <div style="display: grid; gap: 15px;">
                <div class="form-group">
                    <label for="price_application_date">Ng√†y √°p gi√° *</label>
                    <input type="date" id="price_application_date" required>
                    <small class="form-help">Ch·ªçn ng√†y √°p d·ª•ng gi√° m·ªõi</small>
                </div>
                <div class="form-group">
                    <label for="price_update_name">T√™n b·∫£n c·∫≠p nh·∫≠t gi√° tuy·∫øn *</label>
                    <input type="text" id="price_update_name" required placeholder="VD: C·∫≠p nh·∫≠t b·∫£ng gi√° ng√†y 18/12/2025">
                    <small class="form-help">Nh·∫≠p t√™n m√¥ t·∫£ cho b·∫£n c·∫≠p nh·∫≠t n√†y</small>
                </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeUpdatePriceModal()" style="padding: 10px 20px;">H·ªßy</button>
                <button type="button" class="btn btn-primary" onclick="showStep2()" style="padding: 10px 20px;">Ti·∫øp theo</button>
            </div>
        </div>
        
        <!-- B∆∞·ªõc 2: B·∫£ng c·∫≠p nh·∫≠t gi√° tuy·∫øn -->
        <div id="step2Form" style="display: none; padding: 20px;">
            <h4 style="margin-bottom: 20px; color: #9b59b6;">B∆∞·ªõc 2 - C·∫≠p nh·∫≠t gi√° tuy·∫øn</h4>
            <form id="updatePriceForm" method="post" action="/routes/update-price" enctype="application/x-www-form-urlencoded">
                <input type="hidden" id="form_application_date" name="application_date">
                <input type="hidden" id="form_update_name" name="update_name">
                
                <div style="max-height: 500px; overflow-y: auto; margin-bottom: 20px;">
                    <table class="table" style="width: 100%;">
                        <thead style="position: sticky; top: 0; background: #9b59b6; color: white; z-index: 10;">
                            <tr>
                                <th style="width: 60px;">STT</th>
                                <th>M√£ tuy·∫øn</th>
                                <th style="width: 200px;">ƒê∆°n gi√° (VNƒê) *</th>
                            </tr>
                        </thead>
                        <tbody id="priceTableBody">
                            {% set route_index = 0 %}
                            {% for route in routes %}
                                {% if route.route_code and route.route_code.strip() != "TƒÉng C∆∞·ªùng" %}
                                {% set route_index = route_index + 1 %}
                                <tr>
                                    <td>{{ route_index }}</td>
                                    <td><strong>{{ route.route_code }}</strong> - {{ route.route_name }}</td>
                                    <td>
                                        <input type="hidden" name="route_ids" value="{{ route.id }}">
                                        <input type="number" 
                                               name="unit_prices" 
                                               min="0" 
                                               step="1" 
                                               required 
                                               placeholder="VD: 227273"
                                               class="price-input"
                                               oninput="validateInteger(this)" 
                                               onblur="validateInteger(this)"
                                               style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                    </td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="backToStep1()" style="padding: 10px 20px;">Quay l·∫°i</button>
                    <button type="button" class="btn btn-secondary" onclick="closeUpdatePriceModal()" style="padding: 10px 20px;">H·ªßy</button>
                    <button type="submit" class="btn btn-success" style="padding: 10px 20px;">L∆∞u</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function openUpdatePriceModal() {
    document.getElementById('updatePriceModal').style.display = 'block';
    // Set ng√†y m·∫∑c ƒë·ªãnh l√† h√¥m nay
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('price_application_date').value = today;
    // Reset form v√† hi·ªÉn th·ªã b∆∞·ªõc 1
    document.getElementById('step1Form').style.display = 'block';
    document.getElementById('step2Form').style.display = 'none';
    document.getElementById('price_application_date').value = today;
    document.getElementById('price_update_name').value = '';
    // Reset t·∫•t c·∫£ input gi√° trong b·∫£ng
    const priceInputs = document.querySelectorAll('.price-input');
    priceInputs.forEach(input => input.value = '');
}

function closeUpdatePriceModal() {
    document.getElementById('updatePriceModal').style.display = 'none';
    // Reset form
    document.getElementById('step1Form').style.display = 'block';
    document.getElementById('step2Form').style.display = 'none';
    document.getElementById('price_application_date').value = '';
    document.getElementById('price_update_name').value = '';
    const priceInputs = document.querySelectorAll('.price-input');
    priceInputs.forEach(input => input.value = '');
}

function showStep2() {
    // Ki·ªÉm tra ƒë√£ nh·∫≠p ƒë·ªß th√¥ng tin b∆∞·ªõc 1
    const applicationDate = document.getElementById('price_application_date').value;
    const updateName = document.getElementById('price_update_name').value.trim();
    
    if (!applicationDate) {
        alert('Vui l√≤ng ch·ªçn ng√†y √°p gi√°');
        return;
    }
    
    if (!updateName) {
        alert('Vui l√≤ng nh·∫≠p t√™n b·∫£n c·∫≠p nh·∫≠t gi√° tuy·∫øn');
        return;
    }
    
    // L∆∞u gi√° tr·ªã v√†o hidden inputs c·ªßa form
    document.getElementById('form_application_date').value = applicationDate;
    document.getElementById('form_update_name').value = updateName;
    
    // Hi·ªÉn th·ªã b∆∞·ªõc 2 v√† ·∫©n b∆∞·ªõc 1
    document.getElementById('step1Form').style.display = 'none';
    document.getElementById('step2Form').style.display = 'block';
}

function backToStep1() {
    document.getElementById('step1Form').style.display = 'block';
    document.getElementById('step2Form').style.display = 'none';
}

function validateInteger(input) {
    // Ch·ªâ cho ph√©p s·ªë nguy√™n, kh√¥ng cho ph√©p s·ªë th·∫≠p ph√¢n
    if (input.value.includes('.')) {
        input.value = Math.floor(parseFloat(input.value) || 0);
    }
    // ƒê·∫£m b·∫£o gi√° tr·ªã l√† s·ªë nguy√™n
    if (input.value && !Number.isInteger(parseFloat(input.value))) {
        input.value = Math.floor(parseFloat(input.value) || 0);
    }
}

// ƒê√≥ng modal khi click b√™n ngo√†i
window.onclick = function(event) {
    const modal = document.getElementById('updatePriceModal');
    if (event.target == modal) {
        closeUpdatePriceModal();
    }
    const detailModal = document.getElementById('priceUpdateDetailModal');
    if (event.target == detailModal) {
        closePriceUpdateDetailModal();
    }
    const editModal = document.getElementById('priceUpdateEditModal');
    if (event.target == editModal) {
        closePriceUpdateEditModal();
    }
}

// Xem chi ti·∫øt b·∫£n c·∫≠p nh·∫≠t gi√° tuy·∫øn
async function viewPriceUpdateDetail(updateName, applicationDate) {
    try {
        const response = await fetch(`/routes/price-update-detail?update_name=${encodeURIComponent(updateName)}&application_date=${applicationDate}`);
        const data = await response.json();
        
        if (!response.ok) {
            alert('L·ªói khi t·∫£i chi ti·∫øt: ' + (data.error || 'Unknown error'));
            return;
        }
        
        // Hi·ªÉn th·ªã modal chi ti·∫øt
        document.getElementById('detailUpdateName').textContent = data.update_name;
        document.getElementById('detailApplicationDate').textContent = new Date(data.application_date).toLocaleDateString('vi-VN');
        
        // T·∫°o b·∫£ng chi ti·∫øt
        const tbody = document.getElementById('detailTableBody');
        tbody.innerHTML = '';
        
        data.details.forEach((detail, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td><strong>${detail.route_code}</strong> - ${detail.route_name}</td>
                <td class="number">${detail.unit_price.toLocaleString('vi-VN')}</td>
            `;
            tbody.appendChild(row);
        });
        
        document.getElementById('priceUpdateDetailModal').style.display = 'block';
    } catch (error) {
        console.error('Error loading detail:', error);
        alert('L·ªói khi t·∫£i chi ti·∫øt b·∫£n c·∫≠p nh·∫≠t');
    }
}

function closePriceUpdateDetailModal() {
    document.getElementById('priceUpdateDetailModal').style.display = 'none';
}

// S·ª≠a b·∫£n c·∫≠p nh·∫≠t gi√° tuy·∫øn
async function editPriceUpdate(updateName, applicationDate) {
    try {
        const response = await fetch(`/routes/price-update-detail?update_name=${encodeURIComponent(updateName)}&application_date=${applicationDate}`);
        const data = await response.json();
        
        if (!response.ok) {
            alert('L·ªói khi t·∫£i d·ªØ li·ªáu: ' + (data.error || 'Unknown error'));
            return;
        }
        
        // ƒêi·ªÅn th√¥ng tin v√†o form s·ª≠a
        document.getElementById('editUpdateName').value = data.update_name;
        document.getElementById('editApplicationDate').value = data.application_date;
        document.getElementById('editNewUpdateName').value = data.update_name;
        document.getElementById('editFormApplicationDate').value = data.application_date;
        document.getElementById('editFormUpdateName').value = data.update_name;
        
        // T·∫°o b·∫£ng s·ª≠a
        const tbody = document.getElementById('editTableBody');
        tbody.innerHTML = '';
        
        data.details.forEach((detail, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${index + 1}</td>
                <td><strong>${detail.route_code}</strong> - ${detail.route_name}</td>
                <td>
                    <input type="hidden" name="route_price_ids" value="${detail.id}">
                    <input type="number" 
                           name="unit_prices" 
                           value="${detail.unit_price}"
                           min="0" 
                           step="1" 
                           required 
                           class="edit-price-input"
                           oninput="validateInteger(this)" 
                           onblur="validateInteger(this)"
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </td>
            `;
            tbody.appendChild(row);
        });
        
        document.getElementById('priceUpdateEditModal').style.display = 'block';
    } catch (error) {
        console.error('Error loading edit data:', error);
        alert('L·ªói khi t·∫£i d·ªØ li·ªáu ƒë·ªÉ s·ª≠a');
    }
}

function closePriceUpdateEditModal() {
    document.getElementById('priceUpdateEditModal').style.display = 'none';
}
</script>

<style>
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 5% auto;
    border: 1px solid #888;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.close:hover,
.close:focus {
    color: #f0f0f0;
    text-decoration: none;
    cursor: pointer;
}
</style>

<!-- Modal Xem chi ti·∫øt b·∫£n c·∫≠p nh·∫≠t gi√° tuy·∫øn -->
<div id="priceUpdateDetailModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #ddd; background: #17a2b8; color: white;">
            <h3 style="margin: 0; color: white;">üëÅÔ∏è Chi ti·∫øt b·∫£n c·∫≠p nh·∫≠t gi√° tuy·∫øn</h3>
            <span class="close" onclick="closePriceUpdateDetailModal()" style="color: white; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1;">&times;</span>
        </div>
        <div style="padding: 20px;">
            <div style="margin-bottom: 20px;">
                <p><strong>T√™n b·∫£n c·∫≠p nh·∫≠t:</strong> <span id="detailUpdateName"></span></p>
                <p><strong>Ng√†y √°p gi√°:</strong> <span id="detailApplicationDate"></span></p>
            </div>
            <div style="max-height: 500px; overflow-y: auto;">
                <table class="table" style="width: 100%;">
                    <thead style="position: sticky; top: 0; background: #17a2b8; color: white; z-index: 10;">
                        <tr>
                            <th style="width: 60px;">STT</th>
                            <th>M√£ tuy·∫øn</th>
                            <th style="width: 200px;">ƒê∆°n gi√° (VNƒê)</th>
                        </tr>
                    </thead>
                    <tbody id="detailTableBody">
                        <!-- S·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
                    </tbody>
                </table>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closePriceUpdateDetailModal()" style="padding: 10px 20px;">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal S·ª≠a b·∫£n c·∫≠p nh·∫≠t gi√° tuy·∫øn -->
<div id="priceUpdateEditModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid #ddd; background: #ffc107; color: #333;">
            <h3 style="margin: 0; color: #333;">‚úèÔ∏è S·ª≠a b·∫£n c·∫≠p nh·∫≠t gi√° tuy·∫øn</h3>
            <span class="close" onclick="closePriceUpdateEditModal()" style="color: #333; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1;">&times;</span>
        </div>
        <form id="editPriceUpdateForm" method="post" action="/routes/price-update-edit" enctype="application/x-www-form-urlencoded">
            <input type="hidden" id="editFormApplicationDate" name="application_date">
            <input type="hidden" id="editFormUpdateName" name="update_name">
            
            <div style="padding: 20px;">
                <div style="display: grid; gap: 15px; margin-bottom: 20px;">
                    <div class="form-group">
                        <label for="editUpdateName">T√™n b·∫£n c·∫≠p nh·∫≠t hi·ªán t·∫°i</label>
                        <input type="text" id="editUpdateName" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                    </div>
                    <div class="form-group">
                        <label for="editNewUpdateName">T√™n b·∫£n c·∫≠p nh·∫≠t m·ªõi (n·∫øu mu·ªën ƒë·ªïi)</label>
                        <input type="text" id="editNewUpdateName" name="new_update_name" placeholder="ƒê·ªÉ tr·ªëng n·∫øu kh√¥ng mu·ªën ƒë·ªïi t√™n">
                    </div>
                    <div class="form-group">
                        <label for="editApplicationDate">Ng√†y √°p gi√°</label>
                        <input type="date" id="editApplicationDate" readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                    </div>
                </div>
                
                <h4 style="margin-bottom: 15px; color: #ffc107;">C·∫≠p nh·∫≠t gi√° tuy·∫øn</h4>
                <div style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                    <table class="table" style="width: 100%;">
                        <thead style="position: sticky; top: 0; background: #ffc107; color: #333; z-index: 10;">
                            <tr>
                                <th style="width: 60px;">STT</th>
                                <th>M√£ tuy·∫øn</th>
                                <th style="width: 200px;">ƒê∆°n gi√° (VNƒê) *</th>
                            </tr>
                        </thead>
                        <tbody id="editTableBody">
                            <!-- S·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closePriceUpdateEditModal()" style="padding: 10px 20px;">H·ªßy</button>
                    <button type="submit" class="btn btn-success" style="padding: 10px 20px;">L∆∞u thay ƒë·ªïi</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- L∆∞u √Ω - ƒê√£ ·∫©n -->
<div style="display: none; margin-top: 30px; padding: 20px; background: rgba(241, 196, 15, 0.1); border-radius: 10px; border-left: 4px solid #f1c40f;">
    <h4 style="color: #5dade2; margin-bottom: 10px;">üí° L∆∞u √Ω:</h4>
    <ul style="color: #2c3e50; line-height: 1.6;">
        <li>M√£ tuy·∫øn ph·∫£i l√† duy nh·∫•t trong h·ªá th·ªëng</li>
        <li>L·ªô tr√¨nh m√¥ t·∫£ chi ti·∫øt tuy·∫øn ƒë∆∞·ªùng v·∫≠n chuy·ªÉn</li>
        <li>Kho·∫£ng c√°ch gi√∫p t√≠nh to√°n chi ph√≠ v·∫≠n chuy·ªÉn ch√≠nh x√°c</li>
        <li>L∆∞∆°ng tuy·∫øn/th√°ng l√† m·ª©c l∆∞∆°ng c·ªë ƒë·ªãnh cho tuy·∫øn n√†y m·ªói th√°ng</li>
        <li>Nh√¢n vi√™n s·∫Ω ƒë∆∞·ª£c ph√¢n c√¥ng khi ghi nh·∫≠n chuy·∫øn h√†ng ng√†y</li>
    </ul>
</div>
</div>

{% endblock %}
