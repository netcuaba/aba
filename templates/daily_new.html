{% extends "base.html" %}

{% block title %}B·∫£ng ch·∫•m c√¥ng - H·ªá th·ªëng qu·∫£n l√Ω v·∫≠n chuy·ªÉn{% endblock %}

{% block content %}
<h2>üìÖ B·∫£ng ch·∫•m c√¥ng</h2>

<!-- Tab chuy·ªÉn ƒë·ªïi gi·ªØa 2 h√¨nh th·ª©c ch·∫•m c√¥ng -->
<div style="margin-bottom: 30px; border-bottom: 2px solid #e0e0e0;">
    <div style="display: flex; gap: 10px;">
        <button id="tab-by-date" 
                onclick="switchTab('by-date')" 
                class="tab-button active"
                style="padding: 12px 24px; font-size: 16px; font-weight: bold; border: none; background: #3498db; color: white; border-radius: 8px 8px 0 0; cursor: pointer; transition: all 0.3s;">
            üìÖ Ch·∫•m c√¥ng theo ng√†y
        </button>
        <button id="tab-by-route" 
                onclick="switchTab('by-route')" 
                class="tab-button"
                style="padding: 12px 24px; font-size: 16px; font-weight: bold; border: none; background: #95a5a6; color: white; border-radius: 8px 8px 0 0; cursor: pointer; transition: all 0.3s;">
            üõ£Ô∏è Ch·∫•m c√¥ng theo tuy·∫øn
        </button>
    </div>
</div>

<!-- Ph·∫ßn ch·∫•m c√¥ng theo ng√†y -->
<div id="content-by-date" class="tab-content">
<!-- Date Selector -->
<div style="margin-bottom: 30px; padding: 15px; background: rgba(52, 152, 219, 0.1); border-radius: 8px;">
    <form method="get" action="/daily-new" style="display: inline-block;">
        <input type="hidden" name="mode" value="by-date">
        <label for="selected_date" style="color: #2c3e50; margin-right: 10px; font-weight: bold;">Ch·ªçn ng√†y:</label>
        <input type="date" 
               id="selected_date" 
               name="selected_date" 
               value="{{ selected_date }}" 
               style="padding: 8px; border: 2px solid #3498db; border-radius: 5px; font-size: 14px;"
               onchange="this.form.submit()">
        <button type="submit" style="margin-left: 10px; padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
            üîç Xem
        </button>
    </form>
    <div style="margin-top: 10px; color: #7f8c8d; font-size: 12px;">
        Hi·ªÉn th·ªã chuy·∫øn ng√†y: <strong>{{ selected_date_display }}</strong>
    </div>
</div>

<!-- Ch·∫•m c√¥ng form -->
<div style="background: rgba(243, 156, 18, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 30px;">
    <h3 style="color: #5dade2; margin-bottom: 15px;">üìù B·∫£ng ch·∫•m c√¥ng</h3>
    
    <!-- Th√¥ng b√°o t·ª± ƒë·ªông ƒëi·ªÅn -->
    {% if previous_assignments %}
    <div style="background: rgba(52, 152, 219, 0.1); padding: 10px; border-radius: 5px; margin-bottom: 15px; border-left: 3px solid #3498db;">
        <p style="margin: 0; color: #2c3e50; font-size: 13px;">
            üí° <strong>T·ª± ƒë·ªông ƒëi·ªÅn:</strong> T√™n l√°i xe v√† bi·ªÉn s·ªë xe ƒë√£ ƒë∆∞·ª£c t·ª± ƒë·ªông l·∫•y t·ª´ ng√†y ch·∫•m c√¥ng tr∆∞·ªõc ƒë√≥ cho t·ª´ng tuy·∫øn.
        </p>
    </div>
    {% endif %}
    
    {% if routes %}
    <form method="post" action="/daily-new/add" id="dailyForm">
        <input type="hidden" name="date" value="{{ selected_date }}">
        
        <div class="table-container">
            <table class="table" style="background: white; margin-bottom: 0;">
                <thead>
                    <tr>
                        <th>STT</th>
                        <th>M√£ tuy·∫øn</th>
                        <th>S·ªë km th·ª±c t·∫ø</th>
                        <th>T√™n l√°i xe</th>
                        <th>Bi·ªÉn s·ªë xe</th>
                        <th>Tr·∫°ng th√°i</th>
                        <th>Ghi ch√∫</th>
                    </tr>
                </thead>
                <tbody>
                    {% for route in routes %}
                    <tr {% if route.route_code and route.route_code.strip() == "TƒÉng C∆∞·ªùng" %}style="background-color: rgba(52, 152, 219, 0.05); border-left: 3px solid #3498db;"{% endif %}>
                        <td>{{ loop.index }}</td>
                        <td>
                            <strong>{{ route.route_code }}</strong>
                            {% if route.route_code and route.route_code.strip() == "TƒÉng C∆∞·ªùng" %}
                            <span style="font-size: 10px; background: #3498db; color: white; padding: 2px 6px; border-radius: 10px; margin-left: 5px;">Nhi·ªÅu chuy·∫øn</span>
                            {% endif %}
                        </td>
                        <td>
                            <input type="number" 
                                   name="distance_km_{{ route.id }}" 
                                   step="0.1" 
                                   placeholder="0.0">
                        </td>
                        <td>
                            <select name="driver_name_{{ route.id }}" id="driver_{{ route.id }}">
                                <option value="">Ch·ªçn l√°i xe</option>
                                {% for employee in employees %}
                                <option value="{{ employee.name }}" 
                                        {% if previous_assignments.get(route.id) and previous_assignments[route.id].driver_name == employee.name %}selected{% endif %}>
                                    {{ employee.name }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <select name="license_plate_{{ route.id }}" id="vehicle_{{ route.id }}">
                                <option value="">Ch·ªçn xe</option>
                                {% for vehicle in vehicles %}
                                <option value="{{ vehicle.license_plate }}"
                                        {% if previous_assignments.get(route.id) and previous_assignments[route.id].license_plate == vehicle.license_plate %}selected{% endif %}>
                                    {{ vehicle.license_plate }}
                                </option>
                                {% endfor %}
                                {% if vehicles|length == 0 %}
                                <option value="" disabled>Kh√¥ng c√≥ xe</option>
                                {% endif %}
                            </select>
                        </td>
                        <td>
                            <select name="status_{{ route.id }}">
                                <option value="Online" selected>Online</option>
                                <option value="OFF">OFF</option>
                            </select>
                        </td>
                        <td>
                            <input type="text" 
                                   name="notes_{{ route.id }}" 
                                   placeholder="Ghi ch√∫">
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div style="text-align: center;">
            <button type="submit" class="btn btn-success" style="padding: 10px 30px; font-size: 16px;">
                üíæ L∆∞u b·∫£ng ch·∫•m c√¥ng
            </button>
        </div>
    </form>
    {% else %}
    <div style="text-align: center; padding: 40px; background: rgba(39, 174, 96, 0.1); border-radius: 10px; border-left: 4px solid #27ae60;">
        <h4 style="color: #27ae60; margin-bottom: 10px;">‚úÖ Ho√†n th√†nh ch·∫•m c√¥ng tuy·∫øn th√¥ng th∆∞·ªùng!</h4>
        <p style="color: #2c3e50; margin: 0;">
            T·∫•t c·∫£ tuy·∫øn th√¥ng th∆∞·ªùng ƒë√£ ƒë∆∞·ª£c ch·∫•m c√¥ng cho ng√†y {{ selected_date_display }}.<br>
            Tuy·∫øn "TƒÉng C∆∞·ªùng" (n·∫øu c√≥) v·∫´n hi·ªÉn th·ªã ƒë·ªÉ c√≥ th·ªÉ th√™m nhi·ªÅu chuy·∫øn.<br>
            B·∫°n c√≥ th·ªÉ xem danh s√°ch chuy·∫øn ƒë√£ ghi nh·∫≠n b√™n d∆∞·ªõi.
        </p>
    </div>
    {% endif %}
</div>

<!-- Chuy·∫øn ƒë√£ ghi nh·∫≠n -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <h3 style="margin: 0;">üìã Chuy·∫øn ƒë√£ ghi nh·∫≠n</h3>
    {% if daily_routes %}
    <button onclick="deleteAllTrips()" 
            class="btn btn-danger" 
            style="background: #e74c3c; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; transition: all 0.2s;"
            onmouseover="this.style.background='#c0392b'; this.style.transform='scale(1.05)'"
            onmouseout="this.style.background='#e74c3c'; this.style.transform='scale(1)'"
            title="X√≥a t·∫•t c·∫£ chuy·∫øn trong ng√†y">
        üóëÔ∏è Xo√° t·∫•t c·∫£
    </button>
    {% endif %}
</div>

<!-- Success message for delete all -->
{% if deleted_all == 'true' %}
<div style="background: rgba(39, 174, 96, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #27ae60;">
    <p style="margin: 0; color: #27ae60; font-weight: bold;">
        ‚úÖ ƒê√£ xo√° t·∫•t c·∫£ chuy·∫øn trong ng√†y {{ selected_date_display }}
    </p>
</div>
{% endif %}
{% if daily_routes %}
<div style="background: rgba(39, 174, 96, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
    <p style="margin: 0; color: #27ae60; font-weight: bold;">
        ‚úÖ ƒê√£ ghi nh·∫≠n {{ daily_routes|length }} chuy·∫øn ng√†y {{ selected_date_display }}
    </p>
</div>

<div class="table-container">
    <table class="table">
        <thead>
            <tr>
                <th>STT</th>
                <th>M√£ tuy·∫øn</th>
                <th>Ng√†y ch·∫°y</th>
                <th>S·ªë km</th>
                <th>L√°i xe</th>
                <th>Bi·ªÉn s·ªë xe</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ghi ch√∫</th>
                <th>Thao t√°c</th>
            </tr>
        </thead>
        <tbody>
            {% for daily_route in daily_routes %}
            <tr>
                <td>{{ loop.index }}</td>
                <td><strong>{{ daily_route.route.route_code }}</strong></td>
                <td>{{ daily_route.date.strftime('%d/%m/%Y') }}</td>
                <td>{{ daily_route.distance_km }} km</td>
                <td>{{ daily_route.driver_name }}</td>
                <td>{{ daily_route.license_plate }}</td>
                <td>
                    <span style="padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; 
                                 {% if daily_route.status == 'Online' %}background: #27ae60; color: white;{% else %}background: #e74c3c; color: white;{% endif %}">
                        {{ daily_route.status or 'Online' }}
                    </span>
                </td>
                <td>{{ daily_route.notes or 'Kh√¥ng c√≥' }}</td>
                <td>
                    <div style="display: flex; gap: 5px; align-items: center;">
                        <a href="/daily-new/edit/{{ daily_route.id }}" 
                           class="btn btn-sm" 
                           style="background: #3498db; color: white; padding: 3px 8px; font-size: 11px; text-decoration: none; border-radius: 3px; transition: all 0.2s;"
                           onmouseover="this.style.background='#2980b9'; this.style.transform='scale(1.05)'"
                           onmouseout="this.style.background='#3498db'; this.style.transform='scale(1)'"
                           title="S·ª≠a chuy·∫øn">
                            ‚úèÔ∏è S·ª≠a
                        </a>
                        <button onclick="deleteRoute({{ daily_route.id }})" 
                                class="btn btn-sm btn-danger" 
                                style="padding: 3px 8px; font-size: 11px; border: none; border-radius: 3px; transition: all 0.2s;"
                                onmouseover="this.style.transform='scale(1.05)'"
                                onmouseout="this.style.transform='scale(1)'"
                                title="X√≥a chuy·∫øn">
                            üóëÔ∏è X√≥a
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div style="margin-top: 20px; padding: 20px; background: rgba(39, 174, 96, 0.1); border-radius: 10px; border-left: 4px solid #27ae60;">
    <h4 style="color: #27ae60; margin-bottom: 10px;">üìä T·ªïng k·∫øt:</h4>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
        <div>
            <strong>S·ªë chuy·∫øn:</strong> {{ daily_routes|length }}
        </div>
        <div>
            <strong>T·ªïng s·ªë km:</strong> {{ "{:,.1f}".format(daily_routes|sum(attribute='distance_km')) }} km
        </div>
        <div>
            <strong>S·ªë l√°i xe:</strong> {{ daily_routes|map(attribute='driver_name')|unique|list|length }}
        </div>
    </div>
</div>
{% else %}
<div style="text-align: center; padding: 40px; color: #7f8c8d;">
    <h3>üìÖ Ch∆∞a c√≥ chuy·∫øn n√†o ng√†y {{ selected_date_display }}</h3>
    <p>H√£y ghi nh·∫≠n chuy·∫øn ƒë·∫ßu ti√™n b·∫±ng form b√™n tr√™n</p>
</div>
{% endif %}

<!-- H∆∞·ªõng d·∫´n - ƒê√£ ·∫©n -->
<div style="display: none; margin-top: 30px; padding: 20px; background: rgba(241, 196, 15, 0.1); border-radius: 10px; border-left: 4px solid #f1c40f;">
    <h4 style="color: #5dade2; margin-bottom: 10px;">üí° H∆∞·ªõng d·∫´n:</h4>
    <ul style="color: #2c3e50; line-height: 1.6;">
        <li><strong>Ch·ªçn ng√†y:</strong> Ch·ªçn ng√†y c·∫ßn xem/ch·∫•m c√¥ng</li>
        <li><strong>S·ªë km:</strong> Qu√£ng ƒë∆∞·ªùng th·ª±c t·∫ø ƒë√£ ch·∫°y trong chuy·∫øn</li>
        <li><strong>T√™n l√°i xe:</strong> Ch·ªçn nh√¢n vi√™n th·ª±c hi·ªán l√°i xe trong chuy·∫øn</li>
        <li><strong>Bi·ªÉn s·ªë xe:</strong> Ch·ªçn xe t·ª´ danh s√°ch xe c√≥ s·∫µn trong h·ªá th·ªëng</li>
        <li><strong>Tr·∫°ng th√°i:</strong> Online (ho·∫°t ƒë·ªông) ho·∫∑c OFF (kh√¥ng ho·∫°t ƒë·ªông)</li>
        <li><strong>Ghi ch√∫:</strong> Th√¥ng tin b·ªï sung nh∆∞ s·ª± c·ªë, thay ƒë·ªïi, etc.</li>
        <li><strong>T·ª± ƒë·ªông ·∫©n:</strong> Tuy·∫øn th√¥ng th∆∞·ªùng ƒë√£ ch·∫•m c√¥ng s·∫Ω t·ª± ƒë·ªông ·∫©n kh·ªèi b·∫£ng ch·∫•m c√¥ng</li>
        <li><strong>Tuy·∫øn "TƒÉng C∆∞·ªùng":</strong> Lu√¥n hi·ªÉn th·ªã, c√≥ th·ªÉ th√™m nhi·ªÅu chuy·∫øn trong c√πng ng√†y</li>
    </ul>
</div>

{% if not routes and not daily_routes %}
<div style="margin-top: 20px; padding: 20px; background: rgba(231, 76, 60, 0.1); border-radius: 10px; border-left: 4px solid #e74c3c;">
    <h4 style="color: #e74c3c; margin-bottom: 10px;">‚ö†Ô∏è Ch∆∞a c√≥ tuy·∫øn n√†o:</h4>
    <p style="color: #2c3e50;">C·∫ßn t·∫°o tuy·∫øn ƒë∆∞·ªùng tr∆∞·ªõc khi ghi nh·∫≠n chuy·∫øn. <a href="/routes" style="color: #3498db;">T·∫°o tuy·∫øn ngay</a></p>
</div>
{% endif %}
</div>

<!-- Ph·∫ßn ch·∫•m c√¥ng theo tuy·∫øn -->
<div id="content-by-route" class="tab-content" style="display: none;">
    <!-- B·ªô l·ªçc th√°ng v√† tuy·∫øn -->
    <div style="margin-bottom: 30px; padding: 15px; background: rgba(52, 152, 219, 0.1); border-radius: 8px;">
        <form method="get" action="/daily-new" id="route-filter-form" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
            <input type="hidden" name="mode" value="by-route">
            <div>
                <label for="selected_month" style="color: #2c3e50; margin-right: 10px; font-weight: bold;">Ch·ªçn th√°ng ch·∫•m c√¥ng:</label>
                <input type="month" 
                       id="selected_month" 
                       name="selected_month" 
                       value="{{ selected_month or current_month }}" 
                       style="padding: 8px; border: 2px solid #3498db; border-radius: 5px; font-size: 14px;"
                       onchange="updateRouteTable()">
            </div>
            <div>
                <label for="selected_route_id" style="color: #2c3e50; margin-right: 10px; font-weight: bold;">Ch·ªçn tuy·∫øn ch·∫•m c√¥ng:</label>
                <select id="selected_route_id" 
                        name="selected_route_id"
                        style="padding: 8px; border: 2px solid #3498db; border-radius: 5px; font-size: 14px; min-width: 200px;"
                        onchange="updateRouteTable()">
                    <option value="">-- Ch·ªçn tuy·∫øn --</option>
                    {% for route in all_routes %}
                    <option value="{{ route.id }}" {% if selected_route_id and selected_route_id|string == route.id|string %}selected{% endif %}>
                        {{ route.route_code }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <button type="button" 
                    onclick="updateRouteTable()" 
                    style="padding: 8px 15px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                üîç Xem
            </button>
        </form>
        <div style="margin-top: 10px; color: #7f8c8d; font-size: 12px;">
            <span>Hi·ªÉn th·ªã ch·∫•m c√¥ng th√°ng: <strong>{{ selected_month_display or current_month_display }}</strong></span>
            {% if selected_route_id %}
            <span style="margin-left: 20px;">Tuy·∫øn: <strong id="selected-route-name">{{ selected_route_name or '' }}</strong></span>
            {% endif %}
        </div>
    </div>

    <!-- B·∫£ng ch·∫•m c√¥ng theo tuy·∫øn -->
    <div id="route-attendance-section" style="background: rgba(243, 156, 18, 0.1); padding: 20px; border-radius: 10px; margin-bottom: 30px; display: none;">
        <h3 style="color: #5dade2; margin-bottom: 15px;">üìù B·∫£ng ch·∫•m c√¥ng theo tuy·∫øn</h3>
        
        {% if all_routes %}
        <form method="post" action="/daily-new/add-by-route" id="routeForm">
            <input type="hidden" name="selected_month" id="form_selected_month" value="{{ selected_month or current_month }}">
            <input type="hidden" name="selected_route_id" id="form_selected_route_id" value="{{ selected_route_id or '' }}">
            
            <div class="table-container" style="max-height: 600px; overflow-y: auto;">
                <table class="table" style="background: white; margin-bottom: 0;">
                    <thead style="position: sticky; top: 0; background: #3498db; color: white; z-index: 10;">
                        <tr>
                            <th>STT</th>
                            <th>M√£ tuy·∫øn</th>
                            <th>Ng√†y ch·∫•m c√¥ng</th>
                            <th>Km th·ª±c t·∫ø</th>
                            <th>T√™n l√°i xe</th>
                            <th>Bi·ªÉn s·ªë xe</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Ghi ch√∫</th>
                        </tr>
                    </thead>
                    <tbody id="route-attendance-tbody">
                        <!-- S·∫Ω ƒë∆∞·ª£c ƒëi·ªÅn b·∫±ng JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button type="submit" class="btn btn-success" style="padding: 10px 30px; font-size: 16px;">
                    üíæ L∆∞u b·∫£ng ch·∫•m c√¥ng
                </button>
            </div>
        </form>
        {% else %}
        <div style="text-align: center; padding: 40px; background: rgba(231, 76, 60, 0.1); border-radius: 10px; border-left: 4px solid #e74c3c;">
            <h4 style="color: #e74c3c; margin-bottom: 10px;">‚ö†Ô∏è Ch∆∞a c√≥ tuy·∫øn n√†o:</h4>
            <p style="color: #2c3e50;">C·∫ßn t·∫°o tuy·∫øn ƒë∆∞·ªùng tr∆∞·ªõc khi ghi nh·∫≠n chuy·∫øn. <a href="/routes" style="color: #3498db;">T·∫°o tuy·∫øn ngay</a></p>
        </div>
        {% endif %}
    </div>
    
    <!-- Th√¥ng b√°o ch∆∞a ch·ªçn tuy·∫øn -->
    <div id="route-select-message" style="text-align: center; padding: 40px; background: rgba(241, 196, 15, 0.1); border-radius: 10px; border-left: 4px solid #f1c40f; display: none;">
        <h4 style="color: #5dade2; margin-bottom: 10px;">üí° Vui l√≤ng ch·ªçn tuy·∫øn ch·∫•m c√¥ng</h4>
        <p style="color: #2c3e50;">Ch·ªçn th√°ng v√† tuy·∫øn ch·∫•m c√¥ng ·ªü tr√™n ƒë·ªÉ hi·ªÉn th·ªã b·∫£ng ch·∫•m c√¥ng.</p>
    </div>

    <!-- Chuy·∫øn ƒë√£ ghi nh·∫≠n theo tuy·∫øn -->
    <div id="monthly-routes-section" style="display: {% if selected_route_id %}block{% else %}none{% endif %};">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">üìã Chuy·∫øn ƒë√£ ghi nh·∫≠n theo tuy·∫øn</h3>
        </div>

        {% if monthly_daily_routes %}
        <div style="background: rgba(39, 174, 96, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
            <p style="margin: 0; color: #27ae60; font-weight: bold;">
                ‚úÖ ƒê√£ ghi nh·∫≠n {{ monthly_daily_routes|length }} chuy·∫øn trong th√°ng {{ selected_month_display or current_month_display }}
                {% if selected_route_id %}
                - Tuy·∫øn: <strong>{{ selected_route_name or '' }}</strong>
                {% endif %}
            </p>
        </div>

    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>M√£ tuy·∫øn</th>
                    <th>Ng√†y ch·∫°y</th>
                    <th>S·ªë km</th>
                    <th>L√°i xe</th>
                    <th>Bi·ªÉn s·ªë xe</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Ghi ch√∫</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody>
                {% for daily_route in monthly_daily_routes %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td><strong>{{ daily_route.route.route_code }}</strong></td>
                    <td>{{ daily_route.date.strftime('%d/%m/%Y') }}</td>
                    <td>{{ daily_route.distance_km }} km</td>
                    <td>{{ daily_route.driver_name }}</td>
                    <td>{{ daily_route.license_plate }}</td>
                    <td>
                        <span style="padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; 
                                     {% if daily_route.status == 'Online' %}background: #27ae60; color: white;{% else %}background: #e74c3c; color: white;{% endif %}">
                            {{ daily_route.status or 'Online' }}
                        </span>
                    </td>
                    <td>{{ daily_route.notes or 'Kh√¥ng c√≥' }}</td>
                    <td>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <a href="/daily-new/edit/{{ daily_route.id }}" 
                               class="btn btn-sm" 
                               style="background: #3498db; color: white; padding: 3px 8px; font-size: 11px; text-decoration: none; border-radius: 3px; transition: all 0.2s;"
                               onmouseover="this.style.background='#2980b9'; this.style.transform='scale(1.05)'"
                               onmouseout="this.style.background='#3498db'; this.style.transform='scale(1)'"
                               title="S·ª≠a chuy·∫øn">
                                ‚úèÔ∏è S·ª≠a
                            </a>
                            <button onclick="deleteRoute({{ daily_route.id }})" 
                                    class="btn btn-sm btn-danger" 
                                    style="padding: 3px 8px; font-size: 11px; border: none; border-radius: 3px; transition: all 0.2s;"
                                    onmouseover="this.style.transform='scale(1.05)'"
                                    onmouseout="this.style.transform='scale(1)'"
                                    title="X√≥a chuy·∫øn">
                                üóëÔ∏è X√≥a
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
        {% else %}
        <div style="text-align: center; padding: 40px; color: #7f8c8d;">
            <h3>üìÖ Ch∆∞a c√≥ chuy·∫øn n√†o trong th√°ng {{ selected_month_display or current_month_display }}</h3>
            <p>H√£y ghi nh·∫≠n chuy·∫øn ƒë·∫ßu ti√™n b·∫±ng form b√™n tr√™n</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Chuy·ªÉn ƒë·ªïi tab
function switchTab(mode) {
    // ·∫®n t·∫•t c·∫£ n·ªôi dung
    document.getElementById('content-by-date').style.display = 'none';
    document.getElementById('content-by-route').style.display = 'none';
    
    // Reset style c·ªßa t·∫•t c·∫£ tab buttons
    document.getElementById('tab-by-date').style.background = '#95a5a6';
    document.getElementById('tab-by-route').style.background = '#95a5a6';
    
    // Hi·ªÉn th·ªã n·ªôi dung t∆∞∆°ng ·ª©ng
    if (mode === 'by-date') {
        document.getElementById('content-by-date').style.display = 'block';
        document.getElementById('tab-by-date').style.background = '#3498db';
        // C·∫≠p nh·∫≠t URL
        const url = new URL(window.location);
        url.searchParams.set('mode', 'by-date');
        window.history.pushState({}, '', url);
    } else if (mode === 'by-route') {
        document.getElementById('content-by-route').style.display = 'block';
        document.getElementById('tab-by-route').style.background = '#3498db';
        // C·∫≠p nh·∫≠t URL
        const url = new URL(window.location);
        url.searchParams.set('mode', 'by-route');
        window.history.pushState({}, '', url);
        // Ki·ªÉm tra v√† hi·ªÉn th·ªã b·∫£ng n·∫øu ƒë√£ ch·ªçn tuy·∫øn
        updateRouteTable();
    }
}

// C·∫≠p nh·∫≠t b·∫£ng ch·∫•m c√¥ng theo tuy·∫øn
function updateRouteTable() {
    const routeSelect = document.getElementById('selected_route_id');
    const monthInput = document.getElementById('selected_month');
    const attendanceSection = document.getElementById('route-attendance-section');
    const selectMessage = document.getElementById('route-select-message');
    const monthlyRoutesSection = document.getElementById('monthly-routes-section');
    
    if (!routeSelect || !monthInput) return;
    
    const selectedRouteId = routeSelect.value;
    const selectedMonth = monthInput.value;
    
    // C·∫≠p nh·∫≠t form hidden fields
    const formMonth = document.getElementById('form_selected_month');
    const formRouteId = document.getElementById('form_selected_route_id');
    if (formMonth) formMonth.value = selectedMonth;
    if (formRouteId) formRouteId.value = selectedRouteId;
    
    // Ch·ªâ hi·ªÉn th·ªã b·∫£ng khi ƒë√£ ch·ªçn tuy·∫øn
    if (selectedRouteId && selectedMonth) {
        attendanceSection.style.display = 'block';
        selectMessage.style.display = 'none';
        monthlyRoutesSection.style.display = 'block';
        initRouteAttendanceTable(selectedRouteId, selectedMonth);
    } else {
        attendanceSection.style.display = 'none';
        selectMessage.style.display = 'block';
        monthlyRoutesSection.style.display = 'none';
    }
}

// Kh·ªüi t·∫°o b·∫£ng ch·∫•m c√¥ng theo tuy·∫øn
function initRouteAttendanceTable(selectedRouteId, selectedMonth) {
    const tbody = document.getElementById('route-attendance-tbody');
    if (!tbody) return;
    
    if (!selectedRouteId || !selectedMonth) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #7f8c8d;">Vui l√≤ng ch·ªçn tuy·∫øn v√† th√°ng</td></tr>';
        return;
    }
    
    const [year, month] = selectedMonth.split('-');
    
    // L·∫•y s·ªë ng√†y trong th√°ng
    const daysInMonth = new Date(parseInt(year), parseInt(month), 0).getDate();
    
    // L·∫•y danh s√°ch tuy·∫øn v√† nh√¢n vi√™n, xe t·ª´ backend (JSON)
    let routes = [];
    let employees = [];
    let vehicles = [];
    let existingData = [];
    
    try {
        // Parse JSON data t·ª´ backend - filter tojson ƒë√£ x·ª≠ l√Ω escape
        routes = {{ routes_json|tojson }} || [];
        employees = {{ employees_json|tojson }} || [];
        vehicles = {{ vehicles_json|tojson }} || [];
        existingData = {{ monthly_daily_routes_json|tojson }} || [];
        
        // ƒê·∫£m b·∫£o l√† array
        if (!Array.isArray(routes)) routes = [];
        if (!Array.isArray(employees)) employees = [];
        if (!Array.isArray(vehicles)) vehicles = [];
        if (!Array.isArray(existingData)) existingData = [];
        
        // Debug log ƒë·ªÉ ki·ªÉm tra
        console.log('Loaded data:', {
            routesCount: routes.length,
            employeesCount: employees.length,
            vehiclesCount: vehicles.length,
            existingDataCount: existingData.length
        });
    } catch (e) {
        console.error('Error loading JSON data:', e);
        console.error('Error message:', e.message);
        // ƒê·∫£m b·∫£o √≠t nh·∫•t l√† empty arrays
        routes = [];
        employees = [];
        vehicles = [];
        existingData = [];
    }
    
    // T√¨m tuy·∫øn ƒë∆∞·ª£c ch·ªçn
    const selectedRoute = routes.find(r => r.id == selectedRouteId);
    if (!selectedRoute) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #e74c3c;">Kh√¥ng t√¨m th·∫•y tuy·∫øn ƒë∆∞·ª£c ch·ªçn</td></tr>';
        return;
    }
    
    // T·∫°o map ƒë·ªÉ tra c·ª©u d·ªØ li·ªáu ƒë√£ ch·∫•m c√¥ng (ch·ªâ cho tuy·∫øn ƒë√£ ch·ªçn)
    const existingDataMap = {};
    existingData.forEach(item => {
        if (item.route_id == selectedRouteId) {
            existingDataMap[item.date] = item;
        }
    });
    
    tbody.innerHTML = '';
    let rowIndex = 0;
    
    // Ch·ªâ t·∫°o d√≤ng cho c√°c ng√†y CH∆ØA ƒë∆∞·ª£c ch·∫•m c√¥ng trong th√°ng
    for (let day = 1; day <= daysInMonth; day++) {
        const dayStr = day.toString().padStart(2, '0');
        const monthStr = month.padStart(2, '0');
        const currentDate = `${year}-${monthStr}-${dayStr}`;
        
        // B·ªè qua n·∫øu ng√†y n√†y ƒë√£ ƒë∆∞·ª£c ch·∫•m c√¥ng
        if (existingDataMap[currentDate]) {
            continue;
        }
        
        const dateObj = new Date(parseInt(year), parseInt(month) - 1, day);
        const dayOfWeek = dateObj.getDay();
        const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
        
        rowIndex++;
        
        const row = document.createElement('tr');
        if (isWeekend) {
            row.style.backgroundColor = 'rgba(241, 196, 15, 0.1)';
        }
        
        const dayNames = ['CN', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7'];
        
        row.innerHTML = `
            <td>${rowIndex}</td>
            <td>
                <strong>${selectedRoute.route_code || ''}</strong>
                <input type="hidden" name="route_id_${rowIndex}" value="${selectedRouteId}">
            </td>
            <td>
                <input type="date" 
                       name="date_${rowIndex}" 
                       value="${currentDate}" 
                       readonly
                       style="padding: 5px; width: 100%; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
                <div style="font-size: 11px; color: #7f8c8d; margin-top: 2px;">
                    ${dayNames[dayOfWeek]}
                </div>
            </td>
            <td>
                <input type="number" 
                       name="distance_km_${rowIndex}" 
                       step="0.1" 
                       value=""
                       placeholder="0.0"
                       style="padding: 5px; width: 100%; border: 1px solid #ddd; border-radius: 4px;">
            </td>
            <td>
                <select name="driver_name_${rowIndex}" 
                        id="driver_name_${rowIndex}"
                        class="driver-select"
                        data-row-index="${rowIndex}"
                        style="padding: 5px; width: 100%; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">Ch·ªçn l√°i xe</option>
                    ${employees.map(emp => `<option value="${(emp.name || '').replace(/"/g, '&quot;')}">${emp.name || ''}</option>`).join('')}
                </select>
            </td>
            <td>
                <select name="license_plate_${rowIndex}" 
                        id="license_plate_${rowIndex}"
                        class="license-select"
                        data-row-index="${rowIndex}"
                        style="padding: 5px; width: 100%; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">Ch·ªçn xe</option>
                    ${vehicles.map(veh => `<option value="${(veh.license_plate || '').replace(/"/g, '&quot;')}">${veh.license_plate || ''}</option>`).join('')}
                </select>
            </td>
            <td>
                <select name="status_${rowIndex}" style="padding: 5px; width: 100%; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="ƒê√£ ch·∫°y">ƒê√£ ch·∫°y</option>
                    <option value="Ngh·ªâ">Ngh·ªâ</option>
                    <option value="B·∫£o tr√¨">B·∫£o tr√¨</option>
                    <option value="Kh√¥ng ch·∫°y">Kh√¥ng ch·∫°y</option>
                    <option value="Online" selected>Online</option>
                    <option value="OFF">OFF</option>
                </select>
            </td>
            <td>
                <input type="text" 
                       name="notes_${rowIndex}" 
                       value=""
                       placeholder="Ghi ch√∫"
                       style="padding: 5px; width: 100%; border: 1px solid #ddd; border-radius: 4px;">
            </td>
        `;
        
        tbody.appendChild(row);
    }
    
    // N·∫øu kh√¥ng c√≥ ng√†y n√†o c·∫ßn ch·∫•m c√¥ng
    if (rowIndex === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #27ae60; font-weight: bold;">‚úÖ T·∫•t c·∫£ c√°c ng√†y trong th√°ng ƒë√£ ƒë∆∞·ª£c ch·∫•m c√¥ng cho tuy·∫øn n√†y!</td></tr>';
        return;
    }
    
    // Th√™m event listener cho d√≤ng ƒë·∫ßu ti√™n ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn c√°c d√≤ng ti·∫øp theo
    setupAutoFillFromFirstRow();
}

// Thi·∫øt l·∫≠p t·ª± ƒë·ªông ƒëi·ªÅn t·ª´ d√≤ng ƒë·∫ßu ti√™n
function setupAutoFillFromFirstRow() {
    const firstDriverSelect = document.getElementById('driver_name_1');
    const firstLicenseSelect = document.getElementById('license_plate_1');
    
    if (!firstDriverSelect || !firstLicenseSelect) return;
    
    // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi c·ªßa d√≤ng ƒë·∫ßu ti√™n
    firstDriverSelect.addEventListener('change', function() {
        const selectedDriver = this.value;
        if (selectedDriver) {
            // T·ª± ƒë·ªông ƒëi·ªÅn v√†o t·∫•t c·∫£ c√°c d√≤ng ti·∫øp theo (n·∫øu ch∆∞a c√≥ gi√° tr·ªã)
            const allDriverSelects = document.querySelectorAll('.driver-select');
            allDriverSelects.forEach(select => {
                const rowIndex = parseInt(select.getAttribute('data-row-index'));
                if (rowIndex > 1 && !select.value) {
                    // Ch·ªâ ƒëi·ªÅn n·∫øu d√≤ng ƒë√≥ ch∆∞a c√≥ gi√° tr·ªã
                    select.value = selectedDriver;
                }
            });
        }
    });
    
    firstLicenseSelect.addEventListener('change', function() {
        const selectedLicense = this.value;
        if (selectedLicense) {
            // T·ª± ƒë·ªông ƒëi·ªÅn v√†o t·∫•t c·∫£ c√°c d√≤ng ti·∫øp theo (n·∫øu ch∆∞a c√≥ gi√° tr·ªã)
            const allLicenseSelects = document.querySelectorAll('.license-select');
            allLicenseSelects.forEach(select => {
                const rowIndex = parseInt(select.getAttribute('data-row-index'));
                if (rowIndex > 1 && !select.value) {
                    // Ch·ªâ ƒëi·ªÅn n·∫øu d√≤ng ƒë√≥ ch∆∞a c√≥ gi√° tr·ªã
                    select.value = selectedLicense;
                }
            });
        }
    });
    
    // T·ª± ƒë·ªông ƒëi·ªÅn khi c·∫£ hai ƒë·ªÅu ƒë√£ ƒë∆∞·ª£c ch·ªçn ·ªü d√≤ng ƒë·∫ßu ti√™n
    function checkAndAutoFill() {
        const firstDriver = firstDriverSelect.value;
        const firstLicense = firstLicenseSelect.value;
        
        if (firstDriver && firstLicense) {
            // T·ª± ƒë·ªông ƒëi·ªÅn v√†o t·∫•t c·∫£ c√°c d√≤ng ti·∫øp theo (n·∫øu ch∆∞a c√≥ gi√° tr·ªã)
            const allDriverSelects = document.querySelectorAll('.driver-select');
            const allLicenseSelects = document.querySelectorAll('.license-select');
            
            allDriverSelects.forEach(select => {
                const rowIndex = parseInt(select.getAttribute('data-row-index'));
                if (rowIndex > 1 && !select.value) {
                    select.value = firstDriver;
                }
            });
            
            allLicenseSelects.forEach(select => {
                const rowIndex = parseInt(select.getAttribute('data-row-index'));
                if (rowIndex > 1 && !select.value) {
                    select.value = firstLicense;
                }
            });
        }
    }
    
    // Ki·ªÉm tra v√† t·ª± ƒë·ªông ƒëi·ªÅn khi c·∫£ hai ƒë√£ ƒë∆∞·ª£c ch·ªçn
    firstDriverSelect.addEventListener('change', checkAndAutoFill);
    firstLicenseSelect.addEventListener('change', checkAndAutoFill);
}

// Kh·ªüi t·∫°o tab m·∫∑c ƒë·ªãnh khi trang load
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode') || 'by-date';
    switchTab(mode);
    
    // N·∫øu ·ªü ch·∫ø ƒë·ªô by-route, c·∫≠p nh·∫≠t t√™n tuy·∫øn ƒë∆∞·ª£c ch·ªçn
    if (mode === 'by-route') {
        const routeSelect = document.getElementById('selected_route_id');
        if (routeSelect && routeSelect.value) {
            const selectedOption = routeSelect.options[routeSelect.selectedIndex];
            const routeNameElement = document.getElementById('selected-route-name');
            if (routeNameElement) {
                routeNameElement.textContent = selectedOption.text;
            }
        }
    }
});

function deleteRoute(routeId) {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a chuy·∫øn n√†y?')) {
        // T·∫°o form ƒë·ªÉ submit POST request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/daily-new/delete/' + routeId;
        document.body.appendChild(form);
        form.submit();
    }
}

function deleteAllTrips() {
    const selectedDate = '{{ selected_date_display }}';
    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° t·∫•t c·∫£ c√°c chuy·∫øn ƒë√£ ghi nh·∫≠n trong ng√†y ${selectedDate} kh√¥ng?`)) {
        // T·∫°o form ƒë·ªÉ submit DELETE request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/daily-new/delete-all';
        
        // Th√™m input hidden cho ng√†y
        const dateInput = document.createElement('input');
        dateInput.type = 'hidden';
        dateInput.name = 'date';
        dateInput.value = '{{ selected_date }}';
        form.appendChild(dateInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}

